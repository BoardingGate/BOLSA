<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>BoardingGate - Gestor de Cartera iA</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <script src="//cdn.jsdelivr.net/npm/eruda"></script>
    <script>eruda.init();</script>

    <style>
      html, body { margin: 0; padding: 0; width: 100%; height: 100dvh; overflow: hidden; background-color: #0a0a0a; font-family: 'Inter', sans-serif; color: #e5e5e5; }
      #root { height: 100%; width: 100%; display: flex; flex-direction: column; }
      .font-display { font-family: 'Orbitron', sans-serif; }
      .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: #111; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background: #444; border-radius: 10px; }
      .glass-panel { background: rgba(30, 41, 59, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); }
      .fade-in { animation: fadeIn 0.4s ease-out; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
      .table-row-hover:hover { background-color: rgba(59, 130, 246, 0.1); cursor: pointer; }
      input, select, textarea { background: #1e293b; border: 1px solid #334155; color: white; border-radius: 6px; padding: 8px; transition: all 0.2s; font-size: 14px; }
      input:focus, select:focus, textarea:focus { border-color: #3b82f6; outline: none; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }
      .custom-checkbox { accent-color: #3b82f6; width: 18px; height: 18px; cursor: pointer; }
      
      /* ESTILOS INFORME IA */
      .prose-content h3 { font-size: 1.1rem; font-weight: 700; color: #60a5fa; margin-top: 1.2rem; margin-bottom: 0.5rem; text-transform: uppercase; border-bottom: 1px solid #334155; }
      .prose-content p { font-size: 0.9rem; line-height: 1.5; color: #cbd5e1; margin-bottom: 0.8rem; text-align: justify; }
      .prose-content ul { padding-left: 0; margin-bottom: 1rem; }
      .prose-content li { list-style: none; padding-left: 1rem; margin-bottom: 0.3rem; font-size: 0.9rem; position: relative; }
      .prose-content li::before { content: "►"; position: absolute; left: 0; color: #3b82f6; font-size: 0.7rem; top: 3px; }

      /* CARRUSEL SNAP */
      .snap-x { scroll-snap-type: x mandatory; }
      .snap-center { scroll-snap-align: center; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useMemo, useRef } = React;
      const { createRoot } = ReactDOM;

      const _0x7a2=k=>{let x=Object.values(new Intl.DateTimeFormat('es').formatToParts(new Date())).filter(p=>['year','month','day'].includes(p.type)).reduce((a,c)=>a+~~c.value,0)*new Date().getDate();return k==x||k==x.toString(16).toUpperCase()};

      const formatN = (v, dec = 2) => {
          let n = parseFloat(v) || 0;
          let parts = n.toFixed(dec).split('.');
          parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ".");
          return parts.join(',');
      };

      const formatMoney = (v, c = 'EUR') => {
          let n = parseFloat(v) || 0;
          let base = n.toFixed(2).replace('.', ','); 
          while (base.match(/\d{4,}/)) { 
             base = base.replace(/(\d)(\d{3}[,.])/, '$1.$2');
          }
          let parts = base.split(',');
          parts[0] = parts[0].replace(/\./g, '').replace(/\B(?=(\d{3})+(?!\d))/g, ".");
          base = parts.join(',');
          if (c === 'USD') return `$ ${base}`; if (c === 'GBP') return `£ ${base}`; if (c === 'JPY') return `¥ ${base}`; if (c === 'CHF') return `Fr ${base}`;
          return `${base} €`;
      };
      
      const calculateDays = (d1, d2 = new Date()) => Math.max(1, Math.ceil(Math.abs(new Date(d2) - new Date(d1)) / (1000 * 60 * 60 * 24)));
      const extractJSON = (t) => { try { const m = t.match(/(\{[\s\S]*\}|\[[\s\S]*\])/); return m ? JSON.parse(m[0]) : null; } catch { return null; } };
      const usePersistentState = (key, initialValue) => {
        const [state, setState] = useState(() => { try { const item = window.localStorage.getItem(key); return item ? JSON.parse(item) : initialValue; } catch { return initialValue; } });
        useEffect(() => { window.localStorage.setItem(key, JSON.stringify(state)); }, [key, state]); return [state, setState];
      };

      // Funciones para Backup Drive
      const simpleEncrypt = (text) => { if(!text) return ''; try { return btoa(text.split('').map((c, i) => String.fromCharCode(c.charCodeAt(0) + (i % 5))).join('')); } catch { return text; } };
      const simpleDecrypt = (text) => { if(!text) return ''; try { return atob(text).split('').map((c, i) => String.fromCharCode(c.charCodeAt(0) - (i % 5))).join(''); } catch { return text; } };

      // Lector PDF
      const readPdfText = async (file) => {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        let fullText = "";
        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const textContent = await page.getTextContent();
            const pageText = textContent.items.map(item => item.str).join(' ');
            fullText += pageText + "\n";
        }
        return fullText;
      };

      const CURRENCIES = [{ code: 'EUR', name: 'Euro' }, { code: 'USD', name: 'Dólar USA' }, { code: 'GBP', name: 'Libra Est.' }, { code: 'CHF', name: 'Franco Suizo' }, { code: 'JPY', name: 'Yen Jap.' }, { code: 'CAD', name: 'Dólar Can.' }];
      const MONTHS = ["ENERO", "FEBRE", "MARZO", "ABRIL", "MAYO", "JUNIO", "JULIO", "AGOST", "SEPTIE", "OCTUB", "NOVIEM", "DICIE"];

      // --- ICONOS ---
      const Icons = {
        Copy: (p) => <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18" {...p}><path d="M16 2H8C6.9 2 6 2.9 6 4V16C6 17.1 6.9 18 8 18H16C17.1 18 18 17.1 18 16V4C18 2.9 17.1 2 16 2ZM16 16H8V4H16V16ZM4 6H2V20C2 21.1 2.9 22 4 22H18V20H4V6Z" /></svg>,
        Briefcase: (p) => <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18" {...p}><path d="M7.5 3.375c0-1.036.84-1.875 1.875-1.875h5.25c1.036 0 1.875.84 1.875 1.875v2.25h3.75a3 3 0 0 1 3 3v8.25a3 3 0 0 1-3 3h-16.5a3 3 0 0 1-3-3V8.625a3 3 0 0 1 3-3h3.75V3.375Zm1.5 0v2.25h6v-2.25h-6Z"/></svg>,
        DollarSign: (p) => <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18" {...p}><path d="M10.464 8.746c.227-.18.497-.311.786-.394v2.795a2.252 2.252 0 0 1-.786-.393c-.394-.313-.546-.681-.546-1.004 0-.314.168-.611.546-.999Zm2.91 3.25a2.251 2.251 0 0 1 .787.393c.394.313.546.683.546 1.004 0 .315-.168.611-.546.999a2.25 2.25 0 0 1-.786.394v-2.79Zm-3.875 6.42a1.8 1.8 0 0 0 .61 1.258 2.022 2.022 0 0 0 1.151.49v.986c0 .414.336.75.75.75h1.5a.75.75 0 0 0 .75-.75v-.973c.563-.09 1.107-.3 1.579-.652a3.756 3.756 0 0 0 1.403-2.616l.006-.073a.75.75 0 0 0-.663-.822l-.76-.074a.75.75 0 0 0-.806.517 2.256 2.256 0 0 1-1.127 1.408c-.287.127-.611.205-.96.223v-2.853c.94-.287 1.766-.78 2.302-1.42.67-.799.982-1.78.808-2.784a3.752 3.752 0 0 0-2.87-3.033v-.784a.75.75 0 0 0-.75-.75h-1.5a.75.75 0 0 0-.75.75v.8a3.754 3.754 0 0 0-1.895 1.17 3.757 3.757 0 0 0-.332 3.655l.04.092a.75.75 0 0 0 .807.41l.766-.176a.75.75 0 0 0 .548-.827 2.254 2.254 0 0 1 .59-1.92 2.25 2.25 0 0 1 1.253-.59v2.793c-.934.282-1.758.775-2.296 1.415-.67.8-.985 1.786-.81 2.794Z" fillRule="evenodd" clipRule="evenodd" /><path d="M12 2.25A9.75 9.75 0 1 0 21.75 12 9.75 9.75 0 0 0 12 2.25Z" opacity="0.2" /></svg>,
        Search: (p) => <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18" {...p}><path fillRule="evenodd" d="M10.5 3.75a6.75 6.75 0 1 0 0 13.5 6.75 6.75 0 0 0 0-13.5ZM2.25 10.5a8.25 8.25 0 1 1 14.59 5.28l4.69 4.69a.75.75 0 1 1-1.06 1.06l-4.69-4.69A8.25 8.25 0 0 1 2.25 10.5Z" clipRule="evenodd" /></svg>,
        Settings: (p) => <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18" {...p}><path fillRule="evenodd" d="M11.078 2.25c-.917 0-1.699.663-1.85 1.567L9.05 4.889c-.02.12-.115.26-.297.348a7.493 7.493 0 0 0-.986.57c-.166.115-.334.126-.45.083L6.3 5.508a1.875 1.875 0 0 0-2.282.819l-.922 1.597a1.875 1.875 0 0 0 .432 2.385l.84.692c.095.078.17.229.154.43a7.598 7.598 0 0 0 0 1.139c.015.2-.059.352-.153.43l-.841.692a1.875 1.875 0 0 0-.432 2.385l.922 1.597a1.875 1.875 0 0 0 2.282.818l1.019-.382c.115-.043.283-.031.45.082.312.214.641.405.985.57.182.088.277.228.297.35l.178 1.071c.151.904.933 1.567 1.85 1.567h1.844c.916 0 1.699-.663 1.85-1.567l.178-1.072c.02-.12.114-.26.297-.349.344-.165.673-.356.985-.57.167-.114.335-.125.45-.082l1.02.382a1.875 1.875 0 0 0 2.28-.819l.923-1.597a1.875 1.875 0 0 0-.432-2.385l-.84-.692c-.095-.078-.17-.229-.154-.43a7.614 7.614 0 0 0 0-1.139c-.016-.2.059-.352.153-.43l.84-.692c.708-.582.891-1.59.433-2.385l-.922-1.597a1.875 1.875 0 0 0-2.282-.818l-1.02.382c-.114.043-.282.031-.449-.083a7.49 7.49 0 0 0-.985-.57c-.183-.087-.277-.227-.297-.348l-.179-1.072a1.875 1.875 0 0 0-1.85-1.567h-1.843ZM12 15.75a3.75 3.75 0 1 0 0-7.5 3.75 3.75 0 0 0 0 7.5Z" clipRule="evenodd" /></svg>,
        Plus: (p) => <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18" {...p}><path fillRule="evenodd" d="M12 3.75a.75.75 0 0 1 .75.75v6.75h6.75a.75.75 0 0 1 0 1.5h-6.75v6.75a.75.75 0 0 1-1.5 0v-6.75H4.5a.75.75 0 0 1 0-1.5h6.75V4.5a.75.75 0 0 1 .75-.75Z" clipRule="evenodd" /></svg>,
        Edit: (p) => <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18" {...p}><path d="M21.731 2.269a2.625 2.625 0 0 0-3.712 0l-1.157 1.157 3.712 3.712 1.157-1.157a2.625 2.625 0 0 0 0-3.712ZM19.513 8.199l-3.712-3.712-12.15 12.15a5.25 5.25 0 0 0-1.32 2.214l-.8 2.685a.75.75 0 0 0 .933.933l2.685-.8a5.25 5.25 0 0 0 2.214-1.32L19.513 8.2Z" /></svg>,
        Trash2: (p) => <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18" {...p}><path fillRule="evenodd" d="M16.5 4.478v.227a48.816 48.816 0 0 1 3.878.512.75.75 0 1 1-.256 1.478l-.209-.035-1.005 13.07a3 3 0 0 1-2.991 2.77H8.084a3 3 0 0 1-2.991-2.77L4.087 6.66l-.209.035a.75.75 0 0 1-.256-1.478A48.567 48.567 0 0 1 7.5 4.705v-.227c0-1.564 1.213-2.9 2.816-2.951a52.662 52.662 0 0 1 3.369 0c1.603.051 2.815 1.387 2.815 2.951Zm-6.136-1.452a51.196 51.196 0 0 1 3.273 0C14.39 3.05 15 3.684 15 4.478v.113a49.488 49.488 0 0 0-6 0v-.113c0-.794.609-1.428 1.364-1.452Zm-.355 5.945a.75.75 0 1 0-1.5.058l.347 9a.75.75 0 1 0 1.499-.058l-.346-9Zm5.48.058a.75.75 0 1 0-1.498-.058l-.347 9a.75.75 0 0 0 1.5.058l.345-9Z" clipRule="evenodd" /></svg>,
        Refresh: (p) => <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18" className={p.className}><path fillRule="evenodd" d="M4.755 10.059a7.5 7.5 0 0 1 12.548-3.364l1.903 1.903h-3.183a.75.75 0 1 0 0 1.5h5.5a.75.75 0 0 0 .75-.75v-5.5a.75.75 0 0 0-1.5 0v3.18l-1.9-1.9A9 9 0 0 0 3.306 9.67a.75.75 0 1 0 1.45.388Zm15.408 3.352a.75.75 0 0 0-.919.53 7.5 7.5 0 0 1-12.548 3.364l-1.902-1.903h3.183a.75.75 0 0 0 0-1.5h-5.5a.75.75 0 0 0-.75.75v5.5a.75.75 0 0 0 1.5 0v-3.18l1.9 1.9a9 9 0 0 0 14.494-4.57.75.75 0 0 0-.53-.919Z" clipRule="evenodd" /></svg>,
        Loader: (p) => <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className="animate-spin" width="18" height="18"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>,
        Wand: (p) => <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18" {...p}><path fillRule="evenodd" d="M9 4.5a.75.75 0 0 1 .721.544l.813 2.846a3.75 3.75 0 0 0 2.576 2.576l2.846.813a.75.75 0 0 1 0 1.442l-2.846.813a3.75 3.75 0 0 0-2.576 2.576l-.813 2.846a.75.75 0 0 1-1.442 0l-.813-2.846a3.75 3.75 0 0 0-2.576-2.576l-2.846-.813a.75.75 0 0 1 0-1.442l2.846-.813a3.75 3.75 0 0 0 2.576-2.576l.813-2.846A.75.75 0 0 1 9 4.5ZM9 7.13l-.16.56a5.25 5.25 0 0 1-3.65 3.65l-.56.16.56.16a5.25 5.25 0 0 1 3.65 3.65l.16.56.16-.56a5.25 5.25 0 0 1 3.65-3.65l.56-.16-.56-.16a5.25 5.25 0 0 1-3.65-3.65l-.16-.56Z" clipRule="evenodd" /><path d="M19.78 3.32a.75.75 0 1 0-1.06-1.06l-6.363 6.364a.75.75 0 1 0 1.06 1.06L19.78 3.32ZM20.68 19.46c.305.815-.525 1.646-1.34 1.341l-1.92-.72a1.5 1.5 0 0 0-1.066 0l-1.92.72c-.815.305-1.646-.525-1.34-1.34l.72-1.92a1.5 1.5 0 0 0 0-1.066l-.72-1.92c-.305-.815.525-1.646 1.34-1.34l1.92.72a1.5 1.5 0 0 0 1.066 0l1.92-.72c.815-.305 1.646.525 1.34 1.34l-.72 1.92a1.5 1.5 0 0 0 0 1.066l.72 1.92Z" /></svg>,
        Target: (p) => <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18" {...p}><path fillRule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12Zm11.378-3.917c-.89-.777-2.366-.777-3.255 0a.75.75 0 0 1-.988-1.129c1.454-1.272 3.765-1.272 5.219 0a.75.75 0 0 1-.976 1.13ZM12 9a3 3 0 1 0 0 6 3 3 0 0 0 0-6Zm-1.5 3a1.5 1.5 0 1 1 3 0 1.5 1.5 0 0 1-3 0Z" clipRule="evenodd" /></svg>,
        X: (p) => <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18" {...p}><path fillRule="evenodd" d="M5.47 5.47a.75.75 0 0 1 1.06 0L12 10.94l5.47-5.47a.75.75 0 1 1 1.06 1.06L13.06 12l5.47 5.47a.75.75 0 1 1-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 0 1-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 0 1 0-1.06Z" clipRule="evenodd" /></svg>,
        EyeOff: (p) => <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18" {...p}><path fillRule="evenodd" d="M3.28 2.22a.75.75 0 0 0-1.06 1.06l14.5 14.5a.75.75 0 1 0 1.06-1.06l-1.745-1.745a10.029 10.029 0 0 0 3.3-4.38 1.651 1.651 0 0 0 0-1.185A10.004 10.004 0 0 0 9.935 3.248L3.28 2.22ZM6.03 6.952l1.814 1.814a3 3 0 0 0 4.318 4.318l1.814 1.814a10.094 10.094 0 0 1-4.869.487 10.019 10.019 0 0 1-6.908-6.018 1.651 1.651 0 0 1 0-1.185 10.029 10.029 0 0 1 3.83-3.23Z" clipRule="evenodd" /></svg>,
        Eye: (p) => <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18" {...p}><path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" /><path fillRule="evenodd" d="M1.323 11.447C2.811 6.976 7.028 3.75 12.001 3.75c4.97 0 9.185 3.223 10.675 7.69.12.362.12.752 0 1.113-1.487 4.471-5.705 7.697-10.677 7.697-4.97 0-9.186-3.223-10.675-7.69a1.762 1.762 0 0 1 0-1.113ZM17.25 12a5.25 5.25 0 1 1-10.5 0 5.25 5.25 0 0 1 10.5 0Z" clipRule="evenodd" /></svg>,
        HelpCircle: (p) => <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18" {...p}><path fillRule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12Zm11.378-3.917c-.89-.777-2.366-.777-3.255 0a.75.75 0 0 1-.988-1.129c1.454-1.272 3.765-1.272 5.219 0a.75.75 0 0 1-.976 1.13ZM12 18a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm0-7.5a.75.75 0 0 0-.75.75v1.5a.75.75 0 0 0 1.5 0v-1.5A.75.75 0 0 0 12 10.5Z" clipRule="evenodd" /></svg>,
        CheckCircle: (p) => <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18" {...p}><path fillRule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12Zm13.36-1.814a.75.75 0 1 0-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 0 0-1.06 1.06l2.25 2.25a.75.75 0 0 0 1.14-.094l3.75-5.25Z" clipRule="evenodd" /></svg>,
        ChartBar: (p) => <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18" {...p}><path fillRule="evenodd" d="M2.25 13.5a8.25 8.25 0 0 1 8.25-8.25.75.75 0 0 1 .75.75v6.75H18a.75.75 0 0 1 .75.75 8.25 8.25 0 0 1-16.5 0Z" clipRule="evenodd" /><path fillRule="evenodd" d="M12.75 3a.75.75 0 0 1 .75-.75 8.25 8.25 0 0 1 8.25 8.25.75.75 0 0 1-.75.75h-7.5a.75.75 0 0 1-.75-.75V3Z" clipRule="evenodd" /></svg>,
        PieChart: (p) => <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18" {...p}><path fillRule="evenodd" d="M12 2.25a.75.75 0 0 1 .75.75v2.25a3 3 0 0 0 3 3h2.25a.75.75 0 0 1 .75.75A9.009 9.009 0 0 1 13.5 17.893v-2.143a.75.75 0 0 0-1.5 0v2.143A9.01 9.01 0 0 1 7.25 13.5h2.143a.75.75 0 0 0 0-1.5H7.25A9.009 9.009 0 0 1 12 3.03V5.25a.75.75 0 0 0 1.5 0V3a.75.75 0 0 1 .75-.75ZM13.5 13.5h2.25A9.01 9.01 0 0 1 13.5 19.393v-5.893Z" clipRule="evenodd" /></svg>,
        TrendingUp: (p) => <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18" {...p}><path fillRule="evenodd" d="M15.22 6.268a.75.75 0 0 1 .968-.432l5.942 2.28a.75.75 0 0 1 .431.97l-2.28 5.941a.75.75 0 1 1-1.4-.537l1.63-4.251-1.086.483a6 6 0 0 0-2.745 2.745l-1.021 2.596a.75.75 0 0 1-1.352.091l-2.73-6.824-3.666 9.164a.75.75 0 1 1-1.392-.558l4.25-10.625a.75.75 0 0 1 1.348-.106l2.375 5.938 1.48-3.718a.75.75 0 0 1 .971-.24Z" clipRule="evenodd" /></svg>,
        Hash: (p) => <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18" {...p}><path fillRule="evenodd" d="M11.097 1.515a.75.75 0 0 1 .589.882L10.666 7.5h4.47l1.019-5.103a.75.75 0 0 1 1.47.293L16.607 7.5h3.893a.75.75 0 0 1 0 1.5h-4.193l-1.336 6.681h4.029a.75.75 0 0 1 0 1.5h-4.329l-1.02 5.104a.75.75 0 0 1-1.47-.294l1.02-5.103H9.406l-1.02 5.103a.75.75 0 0 1-1.47-.294l1.02-5.104H3.5a.75.75 0 0 1 0-1.5h4.72l1.336-6.681H5a.75.75 0 0 1 0-1.5h4.907l1.306-6.527a.75.75 0 0 1 .883-.589Zm-1.63 7.485-.75 3.75h1.5a.75.75 0 0 1 0 1.5h-1.8l-.78 3.9h1.5a.75.75 0 0 1 0 1.5h-1.8l-.75 3.75a.75.75 0 1 1-1.47-.294l.75-3.75H4.25a.75.75 0 0 1 0-1.5h5.084l.78-3.9H8.5a.75.75 0 0 1 0-1.5h1.933l.75-3.75a.75.75 0 1 1 1.47.294l-.75 3.75h4.633a.75.75 0 0 1 0 1.5h-4.933l-.78 3.9h1.617a.75.75 0 0 1 0 1.5h-1.917l-.75 3.75a.75.75 0 1 1-1.47-.294l.75-3.75h-4.633l.78-3.9H8.5a.75.75 0 0 1 0-1.5h1.933l.75-3.75a.75.75 0 1 1 1.47.294l-.75 3.75h3.633l.78-3.9h-3.933Z" clipRule="evenodd" /></svg>, // Generic hash
        Award: (p) => <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18" {...p}><path fillRule="evenodd" d="M9 4.5a.75.75 0 0 1 .721.544l.813 2.846a3.75 3.75 0 0 0 2.576 2.576l2.846.813a.75.75 0 0 1 0 1.442l-2.846.813a3.75 3.75 0 0 0-2.576 2.576l-.813 2.846a.75.75 0 0 1-1.442 0l-.813-2.846a3.75 3.75 0 0 0-2.576-2.576l-2.846-.813a.75.75 0 0 1 0-1.442l2.846-.813a3.75 3.75 0 0 0 2.576-2.576l.813-2.846A.75.75 0 0 1 9 4.5ZM12 1.5a.75.75 0 0 1 .75.75V3a.75.75 0 0 1-1.5 0v-.75A.75.75 0 0 1 12 1.5ZM3 12a.75.75 0 0 1 .75-.75h.75a.75.75 0 0 1 0 1.5h-.75A.75.75 0 0 1 3 12ZM19.5 12a.75.75 0 0 1 .75-.75h.75a.75.75 0 0 1 0 1.5h-.75a.75.75 0 0 1-.75-.75ZM12 19.5a.75.75 0 0 1 .75.75v.75a.75.75 0 0 1-1.5 0v-.75a.75.75 0 0 1 .75-.75Z" clipRule="evenodd" /></svg>,
        Upload: (p) => <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18" {...p}><path fillRule="evenodd" d="M11.47 2.47a.75.75 0 0 1 1.06 0l4.5 4.5a.75.75 0 0 1-1.06 1.06l-3.22-3.22V16.5a.75.75 0 0 1-1.5 0V4.81L8.03 8.03a.75.75 0 0 1-1.06-1.06l4.5-4.5ZM3 15.75a.75.75 0 0 1 .75.75v2.25a1.5 1.5 0 0 0 1.5 1.5h13.5a1.5 1.5 0 0 0 1.5-1.5V16.5a.75.75 0 0 1 1.5 0v2.25a3 3 0 0 1-3 3H5.25a3 3 0 0 1-3-3V16.5a.75.75 0 0 1 .75-.75Z" clipRule="evenodd" /></svg>,
        AlertCircle: (p) => <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18" {...p}><path fillRule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12ZM12 8.25a.75.75 0 0 1 .75.75v3.75a.75.75 0 0 1-1.5 0V9a.75.75 0 0 1 .75-.75Zm0 8.25a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Z" clipRule="evenodd" /></svg>,
        ExternalLink: (p) => <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18" {...p}><path fillRule="evenodd" d="M15.75 2.25H21a.75.75 0 0 1 .75.75v5.25a.75.75 0 0 1-1.5 0V4.81L8.03 17.03a.75.75 0 0 1-1.06-1.06L19.19 3.75h-3.44a.75.75 0 0 1 0-1.5Zm-10.5 4.5a1.5 1.5 0 0 0-1.5 1.5v10.5a1.5 1.5 0 0 0 1.5 1.5h10.5a1.5 1.5 0 0 0 1.5-1.5V10.5a.75.75 0 0 1 1.5 0v8.25a3 3 0 0 1-3 3H5.25a3 3 0 0 1-3-3V8.25a3 3 0 0 1 3-3h8.25a.75.75 0 0 1 0 1.5H5.25Z" clipRule="evenodd" /></svg>,
        ThumbsUp: (p) => <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18" {...p}><path d="M12.378 1.602a.75.75 0 0 0-.756 0L3 6.632l9 5.25 9-5.25-8.622-5.03ZM21.75 7.93l-9 5.25v9l8.628-5.032a.75.75 0 0 0 .372-.648V7.93ZM11.25 22.18v-9l-9-5.25v8.57a.75.75 0 0 0 .372.648l8.628 5.033Z" /></svg>, // Box style for verdict
        ThumbsDown: (p) => <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18" {...p}><path d="M11.622 22.398a.75.75 0 0 0 .756 0l8.622-5.03-9-5.25-9 5.25 8.622 5.03ZM2.25 16.07l9-5.25v-9L2.622 6.852a.75.75 0 0 0-.372.648v8.57ZM12.75 1.82v9l9 5.25v-8.57a.75.75 0 0 0-.372-.648l-8.628-5.033Z" /></svg>,
        MessageCircle: (p) => <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18" {...p}><path fillRule="evenodd" d="M4.804 21.644A6.707 6.707 0 0 0 6 21.75a6.721 6.721 0 0 0 3.583-1.029c.774.182 1.584.279 2.417.279 5.322 0 9.75-3.97 9.75-9 0-5.03-4.428-9-9.75-9s-9.75 3.97-9.75 9c0 2.409 1.025 4.587 2.674 6.192.232.226.277.428.254.543a3.73 3.73 0 0 1-.814 1.686.75.75 0 0 0 .44 1.223ZM8.25 9.75a.75.75 0 0 1 .75-.75h.008a.75.75 0 0 1 .75.75v.008a.75.75 0 0 1-.75.75H9a.75.75 0 0 1-.75-.75V9.75ZM12 9.75a.75.75 0 0 1 .75-.75h.008a.75.75 0 0 1 .75.75v.008a.75.75 0 0 1-.75.75H12.75a.75.75 0 0 1-.75-.75V9.75ZM15.75 9.75a.75.75 0 0 1 .75-.75h.008a.75.75 0 0 1 .75.75v.008a.75.75 0 0 1-.75.75H16.5a.75.75 0 0 1-.75-.75V9.75Z" clipRule="evenodd" /></svg>,
        Globe: (p) => <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18" {...p}><path fillRule="evenodd" d="M12 2.25c5.385 0 9.75 4.365 9.75 9.75s-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12 6.615 2.25 12 2.25ZM8.547 4.505a8.25 8.25 0 0 0-1.672 1.638c-.35.45-.66.924-.926 1.415-.402.735-.724 1.503-.956 2.296h3.403c.102-1.92.748-3.702 1.777-5.187-.557-.07-1.107-.123-1.626-.162Zm4.906 0a24.341 24.341 0 0 1 1.777 5.187h3.403c-.232-.793-.554-1.56-.956-2.296-.266-.49-.576-.965-.926-1.415a8.25 8.25 0 0 0-1.672-1.638 23.332 23.332 0 0 0-1.626.162ZM3.813 11.25c.01.705.083 1.393.212 2.062a.75.75 0 0 0 .193.385c.448.452.924.871 1.42 1.25.752.574 1.554 1.077 2.392 1.493a.75.75 0 0 0 .34.081h.008c.552.052 1.11.088 1.669.109.52.019 1.042.029 1.564.029s1.044-.01 1.564-.029c.558-.02 1.117-.057 1.669-.11a.75.75 0 0 0 .349-.08c.837-.417 1.64-.92 2.392-1.494.496-.38.972-.798 1.42-1.25a.75.75 0 0 0 .193-.385c.13-.67.202-1.357.212-2.062H3.813Zm1.18 5.103a8.232 8.232 0 0 1-1.353-2.016 8.256 8.256 0 0 1-.362-2.337h3.916c.153 1.627.536 3.19 1.115 4.653a23.167 23.167 0 0 0-3.316-.3ZM12 14.25c-1.335 0-2.586-.5-3.535-1.33-.56-.49-1.025-1.066-1.38-1.705a5.216 5.216 0 0 1-.504-1.196c-.156-.525-.246-1.085-.246-1.665 0-2.9 2.35-5.25 5.25-5.25s5.25 2.35 5.25 5.25-2.35 5.25-5.25 5.25Z" clipRule="evenodd" /></svg>,
        CursorClick: (p) => <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18" {...p}><path fillRule="evenodd" d="M14.25 2.25a.75.75 0 0 1 .75.75v3.21l1.9-1.9a.75.75 0 1 1 1.06 1.06l-3.21 3.21h3.21a.75.75 0 0 1 .75.75v3.21l1.9-1.9a.75.75 0 1 1 1.06 1.06l-3.21 3.21h3.21a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1-.75-.75v-4.5a.75.75 0 0 1 .75-.75h3.21l-1.9-1.9a.75.75 0 0 1-.22-.53V5.46L14.78 4.06a.75.75 0 0 1 .53-.22H17.46l-1.9-1.9a.75.75 0 0 1-.22-.53V2.25Z" clipRule="evenodd" /><path d="M5.47 8.53a.75.75 0 0 1 0-1.06l3.5-3.5a.75.75 0 0 1 1.06 1.06L8.06 7.5h11.19a.75.75 0 0 1 0 1.5H8.06l1.97 1.97a.75.75 0 1 1-1.06 1.06l-3.5-3.5Z" /></svg> // Simplified
      };

    
      const askGemini = async (apiKey, prompt) => {
          if (!apiKey) throw new Error("Falta API Key");
          const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=${apiKey}`, {
              method: 'POST', headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], tools: [{ google_search: {} }] })
          });
          const data = await response.json();
          if (data.error) throw new Error(data.error.message);
          return data.candidates?.[0]?.content?.parts?.[0]?.text || "";
      };

      const Modal = ({ isOpen, title, onClose, children, size = "md" }) => {
          if (!isOpen) return null;
          return (
              <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4 fade-in backdrop-blur-sm" onClick={onClose}>
                  <div className={`bg-slate-900 border border-slate-700 w-full ${size === 'lg' ? 'max-w-6xl' : 'max-w-xl'} rounded-2xl flex flex-col max-h-[90vh] shadow-2xl fade-in`} onClick={e => e.stopPropagation()}>
                      <div className="p-4 border-b border-slate-800 flex justify-between items-center bg-slate-900/50 rounded-t-2xl">
                          <h3 className="text-lg font-bold font-display text-white">{title}</h3>
                          <button onClick={onClose} className="text-slate-400 hover:text-white"><Icons.X size={22}/></button>
                      </div>
                      <div className="p-6 overflow-y-auto custom-scrollbar flex-1">{children}</div>
                  </div>
              </div>
          );
      };


      const _0x8f = (k) => {
            try {
                const _d = new Date();
                const _v = Object.values(new Intl.DateTimeFormat('es').formatToParts(_d))
                                .filter(p => ['day', 'month', 'year'].includes(p.type))
                    .reduce((a, b) => a + parseInt(b.value), 0) * _d.getDate();
                return k === _v.toString(16).toUpperCase();
            } catch { return false; } }; const _0xL = '__sys_reg_st';const _0xT = 'ACTIVATED_V3_SECURE';


    const calcReturns = (startVal, endVal, days) => { 
          if (startVal === 0) return { simple: 0, annual: 0 }; 
          const simple = ((endVal - startVal) / startVal) * 100; 
          const d = Math.max(days, 1); 
          const annual = (simple / d) * 365; 
          return { simple, annual }; 
      };


      // --- COMPONENTE GRAFICOS AVANZADO (Ejes y Escalas) ---
const SimpleChart = ({ type, data, title, height = 400, color = "#3b82f6" }) => {
          if (!data || data.length === 0) return <div className="text-center text-xs text-slate-500 py-4">Sin datos suficientes</div>;
          const values = data.map(d => d.value);
          const minVal = Math.min(0, ...values); 
          const maxVal = Math.max(0, ...values);
          const padding = { top: 40, right: 30, bottom: 50, left: 50 }; 
          const chartH = height; 
          const chartW = 1000; 
          const innerH = chartH - padding.top - padding.bottom;
          const getY = (val) => {
              const effectiveMin = minVal < 0 ? minVal * 1.1 : 0;
              const effectiveRange = (maxVal * 1.1) - effectiveMin;
              const pct = (val - effectiveMin) / effectiveRange; 
              return padding.top + innerH - (pct * innerH);
          };
          const zeroY = getY(0);
          const gridLines = [];
          const steps = 4;
          for(let i=0; i<=steps; i++){
              const effectiveMin = minVal < 0 ? minVal * 1.1 : 0;
              const effectiveRange = (maxVal * 1.1) - effectiveMin;
              const val = effectiveMin + (effectiveRange * (i/steps));
              gridLines.push({ y: getY(val), val });
          }
          const gradId = `grad-${title.replace(/[^a-zA-Z0-9]/g, '')}`;
          const finalStop = Math.max(0, Math.min(100, ( (minVal < 0 ? (maxVal * 1.1) : (maxVal * 1.1)) / ((minVal < 0 ? (maxVal * 1.1) : (maxVal * 1.1)) - (minVal < 0 ? minVal * 1.1 : 0)) ) * 100)); // Simplified for brevity

          return (
              <div className="bg-slate-900/50 p-4 rounded-xl border border-slate-800 flex flex-col h-full overflow-hidden relative">
                  <h4 className="text-[10px] uppercase font-bold text-slate-400 mb-2">{title}</h4>
                  <div className="flex-1 w-full relative">
                      {type === 'pie' ? (
                          <div className="flex items-center justify-center h-full gap-8">
                             <svg viewBox="0 0 32 32" className="w-48 h-48 rotate-[-90deg]">
                                {(() => {
                                    const total = data.reduce((a, b) => a + Math.abs(b.value), 0) || 1;
                                    let acc = 0;
                                    return data.map((d, i) => {
                                        const val = Math.abs(d.value);
                                        const pct = val / total;
                                        const dash = pct * 100;
                                        const c = ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#a855f7', '#06b6d4', '#f43f5e'][i % 8];
                                        const seg = <circle key={i} r="16" cx="16" cy="16" fill="transparent" stroke={c} strokeWidth="32" strokeDasharray={`${dash} 100`} strokeDashoffset={-1 * acc} className="hover:opacity-80 transition-all" />;
                                        acc += dash; return seg;
                                    });
                                })()}
                             </svg>
                             <div className="flex flex-col gap-1 max-h-[250px] overflow-y-auto custom-scrollbar min-w-[150px]">
                                {data.map((d, i) => {
                                    const total = data.reduce((a, b) => a + Math.abs(b.value), 0) || 1;
                                    const pct = (Math.abs(d.value) / total) * 100;
                                    return (
                                        <div key={i} className="flex items-center gap-2 text-[9px] text-slate-300 border-b border-slate-800/50 pb-1">
                                            <span className="w-2 h-2 rounded-full shrink-0" style={{backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#a855f7', '#06b6d4', '#f43f5e'][i % 8]}}></span>
                                            <div className="flex flex-col w-full"><span className="font-bold">{d.label}</span><div className="flex justify-between w-full opacity-60 font-mono text-[8px]"><span>{formatN(d.value)}</span><span>{pct.toFixed(1)}%</span></div></div>
                                        </div>
                                    );
                                })}
                             </div>
                          </div>
                      ) : (
                          <svg viewBox={`0 0 ${chartW} ${chartH}`} className="w-full h-full" preserveAspectRatio="none">
                              {gridLines.map((g, i) => (<g key={i}><line x1={padding.left} y1={g.y} x2={chartW} y2={g.y} stroke="#334155" strokeWidth="1" strokeDasharray="4" opacity="0.5" /><text x={padding.left - 5} y={g.y + 3} textAnchor="end" fill="#64748b" fontSize="10" fontFamily="monospace">{formatN(g.val, 0)}</text></g>))}
                              <line x1={padding.left} y1={zeroY} x2={chartW} y2={zeroY} stroke="#94a3b8" strokeWidth="1" />
                              {type === 'bar' && data.map((d, i) => {
                                  const barW = (chartW - padding.left) / data.length;
                                  const x = padding.left + (i * barW) + (barW * 0.1); 
                                  const y = getY(Math.max(0, d.value));
                                  const h = Math.abs(getY(d.value) - zeroY);
                                  const finalY = d.value >= 0 ? y : zeroY;
                                  return (<g key={i} className="group"><rect x={x} y={finalY} width={barW * 0.8} height={Math.max(1, h)} fill={d.value >=0 ? color : '#ef4444'} rx="2" className="hover:opacity-80 transition-all" /><text x={x + (barW * 0.4)} y={d.value >=0 ? finalY - 5 : finalY + h + 5} textAnchor={d.value >= 0 ? "start" : "end"} fill="white" fontSize="10" fontWeight="bold" transform={`rotate(-90, ${x + (barW * 0.4)}, ${d.value >=0 ? finalY - 5 : finalY + h + 5})`} style={{textShadow: '0px 1px 2px black'}}>{d.label} ({formatN(d.value)})</text></g>);
                              })}
                              {type === 'line' && (() => {
                                  if (data.length < 2) return null;
                                  const stepX = (chartW - padding.left - padding.right) / (data.length - 1);
                                  const points = data.map((d, i) => `${padding.left + (i * stepX)},${getY(d.value)}`).join(' ');
                                  const areaPoints = `${padding.left},${zeroY} ${points} ${padding.left + ((data.length - 1) * stepX)},${zeroY}`;
                                  return (
                                      <g>
                                          <defs><linearGradient id={gradId} x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stopColor="#22c55e" stopOpacity="0.4"/> <stop offset={`${finalStop}%`} stopColor="#22c55e" stopOpacity="0.1"/> <stop offset={`${finalStop}%`} stopColor="#ef4444" stopOpacity="0.1"/> <stop offset="100%" stopColor="#ef4444" stopOpacity="0.4"/></linearGradient><linearGradient id={`${gradId}-stroke`} x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stopColor="#22c55e" /> <stop offset={`${finalStop}%`} stopColor="#22c55e" /> <stop offset={`${finalStop}%`} stopColor="#ef4444" /> <stop offset="100%" stopColor="#ef4444" /></linearGradient></defs>
                                          <polygon points={areaPoints} fill={`url(#${gradId})`} />
                                          <polyline points={points} fill="none" stroke={`url(#${gradId}-stroke)`} strokeWidth="2" vectorEffect="non-scaling-stroke" />
                                          {data.map((d, i) => (<g key={i}><circle cx={padding.left + (i * stepX)} cy={getY(d.value)} r="3" fill={d.value >= 0 ? "#22c55e" : "#ef4444"} className="hover:r-5 transition-all" />{d.extraPct !== undefined && (<text x={padding.left + (i * stepX)} y={getY(d.value) - 10} textAnchor="start" fill="#fff" fontSize="7" fontWeight="bold" style={{textShadow: '0px 1px 2px black'}} transform={`rotate(-90, ${padding.left + (i * stepX)}, ${getY(d.value) - 10})`}>{formatN(d.extraPct)}%</text>)}{(i % Math.max(1, Math.floor(data.length / 8)) === 0 || i === data.length - 1) && (() => { const dateObj = new Date(d.label); return (<text x={padding.left + (i * stepX)} y={chartH - 25} textAnchor="middle" fill="#94a3b8" fontSize="9" fontWeight="bold"><tspan x={padding.left + (i * stepX)} dy="0">{dateObj.getDate().toString().padStart(2,'0')}/{ (dateObj.getMonth()+1).toString().padStart(2,'0')}</tspan><tspan x={padding.left + (i * stepX)} dy="10">{dateObj.getFullYear().toString().slice(-2)}</tspan></text>); })()}</g>))}
                                      </g>
                                  );
                              })()}
                          </svg>
                      )}
                  </div>
              </div>
          );
      };


      // --- COMPONENTE ESTADÍSTICAS ---
      const StatsBlock = ({ title, data, color, baseCurrency, type }) => {
          const yieldPct = data.inv > 0 ? (data.divN / data.inv) * 100 : 0;
          let titleColorClass = "text-slate-500";
          if (type === 'active') titleColorClass = "text-green-500";
          if (type === 'sold') titleColorClass = "text-orange-500";
          if (type === 'total') titleColorClass = "text-purple-500";

          return (
              <div className="glass-panel p-3 rounded-xl border-t-4 flex-1 min-w-[280px]" style={{borderTopColor: color}}>
                  <div className="flex justify-between items-center mb-1">
                     <span className={`text-[9px] font-black uppercase ${titleColorClass}`}>{title}</span>
                     <span className="text-[8px] bg-slate-800 px-1.5 py-0.5 rounded text-slate-400 font-bold">{formatN(data.num, 0)} VALORES</span>
                  </div>
                  <div className="grid grid-cols-2 gap-2 mb-2">
                      <div className="text-left"><div className="text-[8px] text-slate-500 uppercase font-black">Invertido</div><div className="text-sm font-black text-slate-300">{formatMoney(data.inv, baseCurrency)}</div></div>
                      <div className="text-right"><div className="text-[8px] text-slate-500 uppercase font-black">Valor Actual</div><div className="text-sm font-black text-white">{formatMoney(data.cur, baseCurrency)}</div></div>
                  </div>
                  <div className="text-center bg-slate-900/60 rounded-lg py-1 border border-slate-700/50 mb-2">
                      <div className="text-[8px] text-slate-400 uppercase font-bold tracking-widest">BALANCE</div>
                      <div className={`text-base font-black ${data.plPrice >= 0 ? 'text-green-400' : 'text-red-400'}`}>{formatMoney(data.plPrice, baseCurrency)}</div>
                      <div className="text-[10px] text-slate-300 mt-1">Simple: <span className="font-bold text-white">{formatN(data.plP_S)}%</span> | Anual: <span className="font-bold text-white">{formatN(data.plP_A)}%</span></div>
                  </div>
                  <div className="grid grid-cols-2 gap-2 border-t border-slate-800/50 pt-2">
                      <div><div className="text-[8px] text-blue-400 uppercase font-bold">Dividendos</div><div className="text-xs font-bold text-blue-300">{formatMoney(data.divN, baseCurrency)} <span className="text-[9px] text-slate-400 font-mono ml-1">[{formatN(yieldPct)}%]</span></div><div className="text-[7px] text-slate-500 mt-1">FX: <span className={data.fX >= 0 ? 'text-green-500' : 'text-red-500'}>{formatMoney(data.fX, baseCurrency)}</span></div></div>
                      <div className="text-right"><div className="text-[8px] text-purple-400 uppercase font-bold">Total Retorno</div><div className="text-xs font-bold text-white">{formatMoney(data.plTotal, baseCurrency)}</div><div className="text-[8px] text-slate-500">Total: <span className={`font-bold text-sm ${data.plTotal>=0?'text-green-400':'text-red-400'}`}>{formatN(data.plT_S)}%</span></div></div>
                  </div>
              </div>
          );
      };

     

      // --- CARRUSEL DE GRÁFICAS ---
      const CarouselCharts = ({ chartsData }) => {
          return (
             <div className="flex overflow-x-auto snap-x snap-mandatory gap-4 pb-4 custom-scrollbar">
                <div className="snap-center min-w-full lg:min-w-[95%] h-[400px]">
                    <SimpleChart type="line" data={chartsData.evolution} title="Evolución Rendimiento Acumulado" height={400} color="#10b981" />
                </div>
                <div className="snap-center min-w-full lg:min-w-[95%] h-[400px]">
                    <SimpleChart type="pie" data={chartsData.distribution} title="Distribución de Valor (Activos)" height={400} />
                </div>
                <div className="snap-center min-w-full lg:min-w-[95%] h-[400px]">
                    <SimpleChart type="pie" data={chartsData.geoDiversification} title="Diversificación Geográfica (Bolsa)" height={400} />
                </div>
             </div>
          );
      };


const ResultsTab = ({ portfolio, resultsData, setResultsData, baseCurrency, syncStatus, onManualSync }) => {
    const r2 = (num) => Math.round((parseFloat(num) || 0) * 100) / 100;
    
    // Obtener rango de años
    const getDisplayYears = () => { 
        const yearsSet = new Set(); 
        if (portfolio.length === 0) return [new Date().getFullYear()-1, new Date().getFullYear(), new Date().getFullYear()+1]; 
        
        portfolio.forEach(p => { 
            if (p.buyDate) yearsSet.add(new Date(p.buyDate).getFullYear()); 
            if (p.sellDate) yearsSet.add(new Date(p.sellDate).getFullYear()); 
            if (p.dividends) p.dividends.forEach(d => yearsSet.add(d.year)); 
        }); 
        
        if (yearsSet.size === 0) return [new Date().getFullYear()-1, new Date().getFullYear(), new Date().getFullYear()+1]; 
        
        const sorted = Array.from(yearsSet).sort((a, b) => a - b); 
        const minYear = sorted[0]; 
        const maxYear = sorted[sorted.length - 1]; 
        const range = []; 
        for (let y = minYear - 1; y <= maxYear + 1; y++) range.push(y); 
        return range; 
    };

    // LÓGICA DE RECALCULO MASIVO (Botón Recalcular)
    const handleRecalculate = () => { 
        const newData = { ...resultsData }; 
        const yearsToCalc = getDisplayYears(); 
        let runningAccum = 0; 

        yearsToCalc.forEach(y => { 
            if (!newData[y]) {
                newData[y] = { locked:false, soldCount:0, uniqueCount:0, profitPrice:0, dividends:0, lossPrice:0, fees:0, resNoDiv:0, resWithDiv:0, tax:0, accumulated:0, rentaResNoDiv:0, rentaFees:0, rentaAdj:0, rentaBase:0, comp1: 0, comp2: 0, comp3: 0, comp4: 0, compRest: 0 }; 
            }
            
            const currentData = newData[y];

            // Si está bloqueado, se respeta el valor existente para el acumulado y se salta el cálculo
            if (currentData.locked) { 
                runningAccum = r2(runningAccum + (parseFloat(currentData.resWithDiv) || 0)); 
                newData[y].accumulated = runningAccum; 
                return; 
            } 

            let yearProfitPrice = 0;
            let yearLossPrice = 0;
            let yearFees = 0;
            let lotesTotal = 0;
            let yearDivs = 0;
            const uniqueTickers = new Set(); 

            const sales = portfolio.filter(p => {
                if (!p.sellDate) return false;
                const sYear = new Date(p.sellDate).getFullYear();
                return sYear === y;
            }); 

            lotesTotal = sales.length; 

            sales.forEach(p => { 
                uniqueTickers.add(p.ticker); 
                const shares = parseFloat(p.shares) || 0;
                const buyP = parseFloat(p.buyPrice) || 0; const buyF = parseFloat(p.buyFx) || 1;
                const sellP = parseFloat(p.sellPrice) || 0; const sellF = parseFloat(p.sellFx) || 1;
                
                const buyFees = p.feesIncludedInPrice ? 0 : (parseFloat(p.fees) || 0);
                const buyAdj = parseFloat(p.adjustments) || 0;
                const sellFees = p.sellFeesIncludedInPrice ? 0 : (parseFloat(p.sellFees) || 0);
                const sellAdj = parseFloat(p.sellAdjustments) || 0;

                const cost = r2((buyP * shares * buyF) + buyFees + buyAdj); 
                const revenueNet = r2((sellP * shares * sellF) - sellFees - sellAdj); 
                const pl = r2(revenueNet - cost); 

                if (pl >= 0) yearProfitPrice += pl; 
                else yearLossPrice += Math.abs(pl); 
                
                yearFees += r2(buyFees + buyAdj + sellFees + sellAdj); 
            }); 

            portfolio.forEach(p => { 
                if (p.dividends && Array.isArray(p.dividends)) { 
                    p.dividends.forEach(d => { 
                        if (d.year === y) yearDivs += (parseFloat(d.net) || 0); 
                    }); 
                } 
            }); 

            yearProfitPrice = r2(yearProfitPrice); 
            yearLossPrice = r2(yearLossPrice); 
            yearDivs = r2(yearDivs); 
            yearFees = r2(yearFees); 

            const resNoDiv = r2(yearProfitPrice - yearLossPrice); 
            const resWithDiv = r2(resNoDiv + yearDivs); 
            const tax = resNoDiv > 0 ? r2(resNoDiv * 0.19) : 0; 
            
            // En modo Recalcular Automático, 'Accumulated' es el acumulado histórico (Running Total)
            runningAccum = r2(runningAccum + resWithDiv); 

            // Renta
            const rentaResNoDiv = resNoDiv; // Copia por defecto
            const rentaAdj = parseFloat(currentData.rentaAdj) || 0;
            const rentaBase = r2(rentaResNoDiv + rentaAdj); // Base = Res + Ajustes

            let finalCompRest = parseFloat(currentData.compRest) || 0; 
            if (rentaBase < 0) { 
                const c1 = parseFloat(currentData.comp1) || 0; 
                const c2 = parseFloat(currentData.comp2) || 0; 
                const c3 = parseFloat(currentData.comp3) || 0; 
                const c4 = parseFloat(currentData.comp4) || 0; 
                finalCompRest = r2(rentaBase + c1 + c2 + c3 + c4); 
            } else {
                finalCompRest = 0; 
            }

            newData[y] = { 
                ...newData[y], 
                soldCount: lotesTotal, 
                uniqueCount: uniqueTickers.size, 
                profitPrice: yearProfitPrice, 
                dividends: yearDivs, 
                lossPrice: yearLossPrice, 
                fees: yearFees, 
                resNoDiv: resNoDiv, 
                resWithDiv: resWithDiv, 
                tax: tax, 
                accumulated: runningAccum, 
                rentaResNoDiv: rentaResNoDiv, 
                rentaFees: yearFees, 
                rentaAdj: rentaAdj, 
                rentaBase: rentaBase,
                comp1: parseFloat(currentData.comp1) || 0, 
                comp2: parseFloat(currentData.comp2) || 0, 
                comp3: parseFloat(currentData.comp3) || 0, 
                comp4: parseFloat(currentData.comp4) || 0, 
                compRest: finalCompRest 
            }; 
        }); 
        
        setResultsData(newData); 
    };

    useEffect(() => { handleRecalculate(); }, [portfolio.length, portfolio]);

    // LÓGICA DE EDICIÓN MANUAL (Cálculos en vivo)
    const handleEdit = (year, field, val) => { 
        if (resultsData[year]?.locked && !field.startsWith('renta') && !field.startsWith('comp')) return; 
        
        const v = parseFloat(val); 
        const safeVal = isNaN(v) ? 0 : r2(v); 
        
        setResultsData(prev => { 
            // Copiamos el objeto del año para manipularlo
            const d = { ...prev[year], [field]: safeVal }; 
            
            // 1. Si cambian Beneficios o Pérdidas -> Recalcular Res Sin Div
            if (field === 'profitPrice' || field === 'lossPrice') {
                d.resNoDiv = r2(d.profitPrice - d.lossPrice);
                
                // Actualizar Impuestos (19% s/ Sin Div positivo)
                d.tax = d.resNoDiv > 0 ? r2(d.resNoDiv * 0.19) : 0;
                
                // Actualizar Con Div
                d.resWithDiv = r2(d.resNoDiv + d.dividends);

                // Actualizar "Resultado" (Columna Acumulado en modo manual = Sin Div - Impuestos)
                d.accumulated = r2(d.resNoDiv - d.tax);

                // Actualizar Renta (Copia automática)
                d.rentaResNoDiv = d.resNoDiv;
                d.rentaBase = r2(d.rentaResNoDiv + (d.rentaAdj || 0));
            }

            // 2. Si cambian Dividendos -> Recalcular Res Con Div
            if (field === 'dividends') {
                d.resWithDiv = r2(d.resNoDiv + d.dividends);
            }

            // 3. Si cambia Res Sin Div (directamente) -> Recalcular Impuestos y Con Div
            if (field === 'resNoDiv') {
                d.tax = d.resNoDiv > 0 ? r2(d.resNoDiv * 0.19) : 0;
                d.resWithDiv = r2(d.resNoDiv + d.dividends);
                d.accumulated = r2(d.resNoDiv - d.tax); // Neto manual
                d.rentaResNoDiv = d.resNoDiv;
                d.rentaBase = r2(d.rentaResNoDiv + (d.rentaAdj || 0));
            }

            // 4. Si cambian Ajustes Renta -> Recalcular Base Imp
            if (field === 'rentaAdj' || field === 'rentaResNoDiv') {
                d.rentaBase = r2(d.rentaResNoDiv + d.rentaAdj);
            }

            // 5. Lógica Compensaciones (Si Base < 0)
            if (['comp1', 'comp2', 'comp3', 'comp4', 'rentaBase', 'profitPrice', 'lossPrice', 'resNoDiv', 'rentaAdj'].includes(field)) { 
                if (d.rentaBase < 0) { 
                    const c1 = parseFloat(d.comp1) || 0; 
                    const c2 = parseFloat(d.comp2) || 0; 
                    const c3 = parseFloat(d.comp3) || 0; 
                    const c4 = parseFloat(d.comp4) || 0; 
                    d.compRest = r2(d.rentaBase + c1 + c2 + c3 + c4); 
                } else {
                    d.compRest = 0;
                }
            } 

            return { ...prev, [year]: d }; 
        }); 
    };

    const toggleLock = (year) => { 
        setResultsData(prev => ({ ...prev, [year]: { ...prev[year], locked: !prev[year].locked } })); 
    };

    const yearsToShow = getDisplayYears();
    const totals = yearsToShow.reduce((acc, year) => { 
        const curr = resultsData[year] || {}; 
        return { 
            soldCount: acc.soldCount + (curr.soldCount || 0), 
            profitPrice: acc.profitPrice + (curr.profitPrice || 0), 
            dividends: acc.dividends + (curr.dividends || 0), 
            lossPrice: acc.lossPrice + (curr.lossPrice || 0), 
            fees: acc.fees + (curr.fees || 0), 
            resNoDiv: acc.resNoDiv + (curr.resNoDiv || 0), 
            resWithDiv: acc.resWithDiv + (curr.resWithDiv || 0), 
            tax: acc.tax + (curr.tax || 0), 
            rentaBase: acc.rentaBase + (curr.rentaBase || 0),
            accumulated: acc.accumulated + (curr.accumulated || 0) // Simple sum for total row
        }; 
    }, { soldCount: 0, profitPrice: 0, dividends: 0, lossPrice: 0, fees: 0, resNoDiv: 0, resWithDiv: 0, tax: 0, rentaBase: 0, accumulated: 0 });

    const chartData = useMemo(() => { 
        return yearsToShow.map(y => ({ label: y.toString(), value: (resultsData[y]?.resWithDiv || 0) })); 
    }, [resultsData, yearsToShow]);

    const handlePrint = () => { 
        const printWindow = window.open('', '', 'height=800,width=1200'); 
        const emissionTime = new Date().toLocaleString(); 
        let html = `<html><head><title>Resultados Anuales</title><style>@page{size:landscape;margin:10mm;} body{font-family:sans-serif;font-size:9px;} h1{font-size:10px;margin-bottom:2px;text-transform:uppercase;} h2{font-size:9px;margin-top:15px;margin-bottom:2px;color:#d97706;} table{width:100%;border-collapse:collapse;margin-bottom:10px;} th{background:#f1f5f9;text-align:center;padding:2px;border:1px solid #94a3b8;font-size:7px;text-transform:uppercase;} td{padding:2px;border:1px solid #e2e8f0;text-align:right;font-family:monospace;font-size:7px;} .gray-bg{background:#f1f5f9;} .dark-bg{background:#e2e8f0;font-weight:bold;} .orange-bg{background:#fff7ed;color:#ea580c;font-weight:bold;} .info-box{border:1px solid #ccc; background:#f9f9f9; padding:5px; font-size:7px; text-align:justify; margin-top:10px;}</style></head><body>`; 
        html += `<div style="display:flex;justify-content:space-between;border-bottom:2px solid #ccc;padding-bottom:5px;"><div><h1>INFORME DE RESULTADOS ANUALES CARTERA</h1></div><div style="font-size:8px;font-weight:bold;">EMISIÓN: ${emissionTime}</div></div>`; 
        html += `<h2>1. Rendimiento y Fiscalidad Base</h2>`; 
        // MODIFICADO: Orden Columnas Impresión
        html += `<table><thead><tr><th>Año</th><th>Lotes</th><th>Beneficio</th><th>Pérdida</th><th>Res. SIN Div</th><th>Dividendos</th><th>Res. CON Div</th><th>Impuestos</th><th>Neto/Acum</th><th style="border-left:2px solid #333;">Res. SIN Div (R)</th><th>Gtos Broker</th><th>Ajustes</th><th>Base Imp. 19%</th></tr></thead><tbody>`; 
        yearsToShow.forEach(year => { 
            const d = resultsData[year] || {}; 
            html += `<tr><td style="text-align:center;"><b>${year}</b></td><td style="text-align:center;">${formatN(d.soldCount, 0)}</td><td>${formatMoney(d.profitPrice, baseCurrency)}</td><td style="color:#dc2626;">${formatMoney(d.lossPrice, baseCurrency)}</td><td class="gray-bg">${formatMoney(d.resNoDiv, baseCurrency)}</td><td>${formatMoney(d.dividends, baseCurrency)}</td><td class="gray-bg">${formatMoney(d.resWithDiv, baseCurrency)}</td><td>${formatMoney(d.tax, baseCurrency)}</td><td>${formatMoney(d.accumulated, baseCurrency)}</td><td style="border-left:2px solid #333;">${formatMoney(d.rentaResNoDiv, baseCurrency)}</td><td>${formatMoney(d.rentaFees, baseCurrency)}</td><td>${formatMoney(d.rentaAdj, baseCurrency)}</td><td class="dark-bg">${formatMoney(d.rentaBase, baseCurrency)}</td></tr>`; 
        }); 
        html += `</tbody></table>`; 
        html += `<h2>2. Cuadro de Seguimiento de Compensación de Pérdidas (4 Años)</h2>`; 
        html += `<table><thead><tr><th style="width:10%;">Año Origen</th><th style="width:15%;">Base Imponible (G/P)</th><th>Compensado 1er Año</th><th>Compensado 2do Año</th><th>Compensado 3er Año</th><th>Compensado 4to Año</th><th style="border-left:2px solid #ea580c; background:#fff7ed; color:#ea580c;">PENDIENTE COMPENSAR</th></tr></thead><tbody>`; 
        yearsToShow.forEach(year => { 
            const d = resultsData[year] || {}; 
            if (d.rentaBase < 0 || d.compRest !== 0 || d.comp1 !==0) { 
                html += `<tr><td style="text-align:center;"><b>${year}</b></td><td style="font-weight:bold; color:${d.rentaBase<0?'red':'black'}">${formatMoney(d.rentaBase, baseCurrency)}</td><td>${formatMoney(d.comp1, baseCurrency)}</td><td>${formatMoney(d.comp2, baseCurrency)}</td><td>${formatMoney(d.comp3, baseCurrency)}</td><td>${formatMoney(d.comp4, baseCurrency)}</td><td class="orange-bg" style="border-left:2px solid #ea580c;">${formatMoney(d.compRest, baseCurrency)}</td></tr>`; 
            } 
        }); 
        html += `</tbody></table>`; 
        html += `<div class="info-box"><strong>NORMATIVA COMPENSACIÓN (Base del Ahorro IRPF):</strong> Si el saldo de Ganancias y Pérdidas Patrimoniales (ventas) es negativo, se compensa en los 4 años siguientes en este orden:<br/>1. Contra el saldo positivo de <strong>Ganancias Patrimoniales</strong> (otras ventas) de esos años (Sin límite).<br/>2. Si aún queda pérdida, contra el saldo positivo de <strong>Rendimientos de Capital Mobiliario</strong> (dividendos/intereses) de esos años (Con límite del 25% de dicho saldo).<br/><i>(*) Verificar anualmente Casillas de "Pendiente de compensación ejercicios anteriores" en la sección Base Imponible del Ahorro del Modelo 100.</i></div>`; 
        html += `</body></html>`; 
        printWindow.document.write(html); printWindow.document.close(); printWindow.focus(); setTimeout(()=>printWindow.print(),500); 
    };

    return (
        <div className="w-full p-4 md:p-6 flex flex-col gap-6">
             <div className="flex justify-between items-center bg-slate-900/80 p-4 rounded-xl border border-slate-800 shrink-0">
                <div><h2 className="text-xl font-display font-bold text-white">Resultados y Fiscalidad</h2><p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Consolidación Anual de Rendimiento</p></div>
                <div className="flex gap-2">
                    <button onClick={onManualSync} className={`px-4 py-2 rounded-lg text-xs font-bold uppercase transition-colors shadow-lg border flex items-center gap-2 ${syncStatus === 'unsaved' ? 'bg-orange-600 border-orange-500 text-white' : 'bg-slate-800 border-slate-600 text-green-400'}`}>
                        <Icons.Upload size={14}/> {syncStatus === 'unsaved' ? 'SINCRONIZAR' : 'SYNC OK'}
                    </button>
                    <button onClick={handleRecalculate} className="bg-blue-600 hover:bg-blue-500 px-6 py-2 rounded-lg text-xs font-bold uppercase transition-colors shadow-lg border border-blue-400 flex items-center gap-2"><Icons.Refresh size={14}/> Recalcular Datos</button>
                    <button onClick={handlePrint} className="bg-slate-700 px-3 py-2 rounded-lg text-[10px] font-bold border border-slate-600 hover:bg-slate-600 transition-colors flex items-center gap-2 text-white"><Icons.ExternalLink size={14} className="rotate-0"/> IMPRIMIR</button>
                </div>
             </div>
             <div className="w-full overflow-x-auto bg-slate-900/50 border border-slate-800 rounded-xl">
                 <table className="w-full text-sm border-collapse min-w-[2000px]">
                     <thead className="bg-slate-800 text-[10px] uppercase font-bold text-slate-400">
                         <tr>
                             {/* COLUMNAS FIJAS (STICKY) EN CABECERA */}
                             <th className="p-2 text-center border-b border-slate-700 w-10 bg-slate-900 sticky left-0 z-30 border-r border-slate-800"><Icons.CheckCircle size={12}/></th>
                             <th className="p-2 text-center border-b border-slate-700 w-16 bg-slate-900 sticky left-10 z-30 border-r border-slate-800">Año</th>
                             
                             <th className="p-2 text-center border-b border-slate-700 w-24">Lotes<br/><span className="text-[7px] opacity-60 font-normal">(Tot / Únicos)</span></th>
                             <th className="p-2 text-right border-b border-slate-700 border-l border-slate-700/50 text-green-400">Beneficio<br/><span className="text-[7px] opacity-60 font-normal">(Precio)</span></th>
                             <th className="p-2 text-right border-b border-slate-700 text-red-400">Pérdida<br/><span className="text-[7px] opacity-60 font-normal">(Precio)</span></th>
                             <th className="p-2 text-right border-b border-slate-700 border-l border-slate-700/50 bg-slate-800/30 font-bold text-slate-200">Res. SIN Div<br/><span className="text-[7px] opacity-60 font-normal">(Ing - Pérd)</span></th>
                             
                             {/* COLUMNA DIVIDENDOS MOVIDA AQUÍ */}
                             <th className="p-2 text-right border-b border-slate-700 text-blue-400">Dividendos<br/><span className="text-[7px] opacity-60 font-normal">(Cobrados)</span></th>
                             
                             <th className="p-2 text-right border-b border-slate-700 bg-slate-800/30 font-bold text-white">Res. CON Div<br/><span className="text-[7px] opacity-60 font-normal">(+ Divs)</span></th>
                             <th className="p-2 text-right border-b border-slate-700 text-purple-400">Impuestos<br/><span className="text-[7px] opacity-60 font-normal">(19% s/ Sin Div)</span></th>
                             <th className="p-2 text-right border-b border-slate-700 font-bold text-yellow-500">Neto / Acum<br/><span className="text-[7px] opacity-60 font-normal">(Res - Imp)</span></th>
                             
                             <th className="p-2 text-right border-b border-slate-700 border-l-4 border-slate-900 bg-[#1e2330] text-slate-300">Res. SIN Div<br/><span className="text-[7px] opacity-60 font-normal">(Renta)</span></th>
                             <th className="p-2 text-right border-b border-slate-700 bg-[#1e2330] text-slate-400">Gtos Broker<br/><span className="text-[7px] opacity-60 font-normal">(Total)</span></th>
                             <th className="p-2 text-right border-b border-slate-700 bg-[#1e2330] text-slate-300">Ajustes<br/><span className="text-[7px] opacity-60 font-normal">(Manual)</span></th>
                             <th className="p-2 text-right border-b border-slate-700 bg-[#1e2330] text-blue-200 font-bold">Base Imp. 19%<br/><span className="text-[7px] opacity-60 font-normal">(Res + Adj)</span></th>
                             
                             <th className="p-2 text-right border-b border-slate-700 border-l-4 border-slate-900 bg-orange-900/10 text-orange-400 w-24">1er AÑO<br/><span className="text-[7px] opacity-60 font-normal">(Compensa)</span></th>
                             <th className="p-2 text-right border-b border-slate-700 bg-orange-900/10 text-orange-400 w-24">2do AÑO<br/><span className="text-[7px] opacity-60 font-normal">(Compensa)</span></th>
                             <th className="p-2 text-right border-b border-slate-700 bg-orange-900/10 text-orange-400 w-24">3er AÑO<br/><span className="text-[7px] opacity-60 font-normal">(Compensa)</span></th>
                             <th className="p-2 text-right border-b border-slate-700 bg-orange-900/10 text-orange-400 w-24">4do AÑO<br/><span className="text-[7px] opacity-60 font-normal">(Compensa)</span></th>
                             <th className="p-2 text-right border-b border-slate-700 bg-orange-600/20 text-yellow-500 font-black border-l border-orange-500/30 w-32">PENDIENTE<br/><span className="text-[7px] opacity-60 font-normal">(Resta)</span></th>
                         </tr>
                     </thead>
                     <tbody className="divide-y divide-slate-800 font-mono text-xs">{yearsToShow.map(year => { 
                         const d = resultsData[year] || { locked:false, soldCount:0, uniqueCount:0, profitPrice:0, dividends:0, lossPrice:0, resNoDiv:0, resWithDiv:0, tax:0, accumulated:0, fees:0, rentaResNoDiv:0, rentaFees:0, rentaAdj:0, rentaBase:0, comp1:0, comp2:0, comp3:0, comp4:0, compRest:0 }; 
                         return ( 
                             <tr key={year} className={`hover:bg-slate-900/40 transition-colors ${d.locked ? 'opacity-70' : ''}`}>
                                 {/* COLUMNAS FIJAS (STICKY) EN BODY */}
                                 <td className="p-2 text-center bg-slate-900 sticky left-0 z-20 border-r border-slate-800"><input type="checkbox" checked={d.locked} onChange={()=>toggleLock(year)} className="w-3 h-3 accent-red-500 cursor-pointer" /></td>
                                 <td className="p-2 text-center font-bold text-white bg-slate-900 sticky left-10 z-20 border-r border-slate-800">{year}</td>
                                 
                                 <td className="p-2 text-center text-slate-400 text-[10px]">{formatN(d.soldCount, 0)} <span className="text-slate-600">/</span> <span className="text-slate-300 font-bold">{formatN(d.uniqueCount, 0)}</span></td>
                                 <td className="p-2 border-l border-slate-800/50"><input type="number" step="0.01" value={d.profitPrice} onChange={e=>handleEdit(year, 'profitPrice', e.target.value)} disabled={d.locked} className="w-full bg-transparent text-right font-bold text-green-500 outline-none" /></td>
                                 <td className="p-2"><input type="number" step="0.01" value={d.lossPrice} onChange={e=>handleEdit(year, 'lossPrice', e.target.value)} disabled={d.locked} className="w-full bg-transparent text-right font-bold text-red-500 outline-none" /></td>
                                 <td className="p-2 border-l border-slate-800/50 bg-slate-900/20"><input type="number" step="0.01" value={d.resNoDiv} onChange={e=>handleEdit(year, 'resNoDiv', e.target.value)} disabled={d.locked} className={`w-full bg-transparent text-right font-bold outline-none ${d.resNoDiv >=0 ? 'text-slate-200':'text-red-400'}`} /></td>
                                 
                                 {/* DIVIDENDOS MOVIDOS AQUI */}
                                 <td className="p-2"><input type="number" step="0.01" value={d.dividends} onChange={e=>handleEdit(year, 'dividends', e.target.value)} disabled={d.locked} className="w-full bg-transparent text-right font-bold text-blue-400 outline-none" /></td>
                                 
                                 <td className="p-2 bg-slate-900/20"><input type="number" step="0.01" value={d.resWithDiv} onChange={e=>handleEdit(year, 'resWithDiv', e.target.value)} disabled={d.locked} className={`w-full bg-transparent text-right font-bold outline-none ${d.resWithDiv >=0 ? 'text-white':'text-red-400'}`} /></td>
                                 <td className="p-2"><input type="number" step="0.01" value={d.tax} onChange={e=>handleEdit(year, 'tax', e.target.value)} disabled={d.locked} className="w-full bg-transparent text-right text-purple-400 font-bold outline-none" /></td>
                                 <td className="p-2 border-r border-slate-800 bg-slate-900/10"><input type="number" step="0.01" value={d.accumulated} onChange={e=>handleEdit(year, 'accumulated', e.target.value)} disabled={d.locked} className={`w-full bg-transparent text-right font-bold outline-none ${d.accumulated >= 0 ? 'text-yellow-500' : 'text-red-500'}`} /></td>
                                 
                                 <td className="p-2 border-l-4 border-slate-900 bg-[#161b25]"><input type="number" step="0.01" value={d.rentaResNoDiv} onChange={e=>handleEdit(year, 'rentaResNoDiv', e.target.value)} disabled={d.locked} className="w-full bg-transparent text-right text-slate-300 outline-none font-bold" /></td>
                                 <td className="p-2 bg-[#161b25]"><input type="number" step="0.01" value={d.rentaFees} onChange={e=>handleEdit(year, 'rentaFees', e.target.value)} disabled={d.locked} className="w-full bg-transparent text-right text-slate-500 outline-none" /></td>
                                 <td className="p-2 bg-[#161b25]"><input type="number" step="0.01" value={d.rentaAdj} onChange={e=>handleEdit(year, 'rentaAdj', e.target.value)} disabled={d.locked} className="w-full bg-transparent text-right text-slate-300 outline-none border-b border-slate-700/50 focus:border-blue-500" /></td>
                                 <td className="p-2 bg-[#161b25]"><input type="number" step="0.01" value={d.rentaBase} onChange={e=>handleEdit(year, 'rentaBase', e.target.value)} disabled={d.locked} className="w-full bg-transparent text-right text-blue-200 font-bold outline-none" /></td>
                                 
                                 <td className="p-2 border-l-4 border-slate-900 bg-orange-900/5"><input type="number" step="0.01" value={d.comp1} onChange={e=>handleEdit(year, 'comp1', e.target.value)} className="w-full bg-transparent text-right text-orange-200 outline-none" placeholder="0.00" /></td>
                                 <td className="p-2 bg-orange-900/5"><input type="number" step="0.01" value={d.comp2} onChange={e=>handleEdit(year, 'comp2', e.target.value)} className="w-full bg-transparent text-right text-orange-200 outline-none" placeholder="0.00" /></td>
                                 <td className="p-2 bg-orange-900/5"><input type="number" step="0.01" value={d.comp3} onChange={e=>handleEdit(year, 'comp3', e.target.value)} className="w-full bg-transparent text-right text-orange-200 outline-none" placeholder="0.00" /></td>
                                 <td className="p-2 bg-orange-900/5"><input type="number" step="0.01" value={d.comp4} onChange={e=>handleEdit(year, 'comp4', e.target.value)} className="w-full bg-transparent text-right text-orange-200 outline-none" placeholder="0.00" /></td>
                                 <td className="p-2 border-l border-orange-500/20 bg-orange-600/10"><input type="number" step="0.01" value={d.compRest} onChange={e=>handleEdit(year, 'compRest', e.target.value)} className="w-full bg-transparent text-right text-yellow-400 font-bold outline-none" placeholder="0.00" /></td>
                             </tr> 
                         ); 
                     })}
                     <tr className="bg-slate-900 border-t-2 border-slate-700 text-white font-bold text-xs shadow-xl"><td colSpan="3" className="p-3 text-right text-[10px] uppercase text-slate-500 tracking-widest bg-slate-900 sticky left-0 border-r border-slate-800">Total Global: <span className="text-white ml-2">{formatN(totals.soldCount, 0)} Op.</span></td><td className="p-3 text-right text-green-500">{formatMoney(totals.profitPrice, baseCurrency)}</td><td className="p-3 text-right text-red-500">{formatMoney(totals.lossPrice, baseCurrency)}</td><td className="p-3 text-right text-slate-300">{formatMoney(totals.resNoDiv, baseCurrency)}</td><td className="p-3 text-right text-blue-400">{formatMoney(totals.dividends, baseCurrency)}</td><td className="p-3 text-right text-white text-sm">{formatMoney(totals.resWithDiv, baseCurrency)}</td><td className="p-3 text-right text-purple-400">{formatMoney(totals.tax, baseCurrency)}</td><td className="p-3 bg-slate-950"></td><td className="p-3 bg-[#11151d]"></td><td className="p-3 text-right text-slate-500 bg-[#11151d]">{formatMoney(totals.fees, baseCurrency)}</td><td className="p-3 bg-[#11151d]"></td><td className="p-3 text-right text-blue-200 bg-[#11151d]">{formatMoney(totals.rentaBase, baseCurrency)}</td><td colSpan="5" className="bg-[#11151d]"></td></tr></tbody></table>
             </div>
             <div className="bg-slate-900/50 border border-slate-800 rounded-xl p-6 flex flex-col md:flex-row gap-6">
                 <div className="flex-1"><h4 className="text-sm font-bold text-orange-400 mb-3 flex items-center gap-2"><Icons.HelpCircle size={16}/> Información Fiscal: Compensación de Pérdidas (España)</h4><div className="text-[11px] text-slate-400 space-y-3 leading-relaxed text-justify"><p><strong className="text-white">Regla 1: Año en Curso.</strong> Las pérdidas por ventas de acciones (Ganancias y Pérdidas Patrimoniales - GPP) se compensan primero con las ganancias del mismo tipo. Si el saldo sigue siendo negativo, se puede compensar con hasta el <strong>25%</strong> del saldo positivo de dividendos e intereses (Rendimientos Capital Mobiliario - RCM).</p><p><strong className="text-white">Regla 2: 4 Años Siguientes.</strong> Si tras lo anterior queda un saldo negativo (pérdida pendiente), se lleva a los 4 años siguientes para compensarse en este orden obligatorio:</p><ul className="list-disc list-inside pl-2 space-y-1"><li><strong className="text-blue-400">1º Contra Ganancias Patrimoniales:</strong> Se resta de los beneficios de futuras ventas de acciones de esos años (Sin límite).</li><li><strong className="text-blue-400">2º Contra Capital Mobiliario:</strong> Si aún sobra pérdida, se resta de los dividendos de esos años (Límite 25%).</li></ul><p className="mt-2 text-slate-500 italic border-t border-slate-800 pt-2">(*) Verificar casilla "Pendiente de compensación ejercicios anteriores" en el apartado <strong>Base Imponible del Ahorro</strong> del Modelo 100.</p></div></div>
                 <div className="md:w-1/3 border-l border-slate-800 md:pl-6 pt-4 md:pt-0 flex flex-col justify-center"><div className="bg-orange-900/10 p-4 rounded-xl border border-orange-500/20 text-center"><Icons.AlertCircle className="mx-auto text-orange-500 mb-2" size={24}/><div className="text-xs font-bold text-orange-200 mb-1">Estrategia Fiscal</div><p className="text-[10px] text-slate-400">Aprovecha las caídas de fin de año para aflorar minusvalías y compensar beneficios fiscales ("Tax Loss Harvesting").</p></div><a href="https://sede.agenciatributaria.gob.es/" target="_blank" className="mt-4 text-center block text-[10px] text-blue-400 hover:text-blue-300 font-bold border border-blue-500/30 rounded py-2 hover:bg-blue-900/20 transition-colors">Consultar Normativa AEAT <Icons.ExternalLink size={10} className="inline"/></a></div>
             </div>
             <div className="h-[400px] shrink-0"><SimpleChart type="bar" data={chartData} title="Beneficio/Pérdida Neto Total (Precio + Divs) por Año" height={400} /></div>
        </div>
    );
};


      // --- COMPONENTE: GRÁFICO BARRAS DIVERGENTES (DINÁMICO) ---
     const DivergingBarChart = ({ data, baseCurrency }) => {
          if (!data || data.length === 0) return null;
          
          const maxAbsVal = Math.max(...data.map(d => Math.abs(d.value)), 1);
          const ticks = [-maxAbsVal, -maxAbsVal/2, 0, maxAbsVal/2, maxAbsVal];
          const rowHeight = 35;
          const containerHeight = 70 + (data.length * rowHeight);

          return (
              <div className="bg-slate-900/50 p-4 rounded-xl border border-slate-800 flex flex-col relative transition-all duration-300" style={{ height: `${containerHeight}px` }}>
                  <h4 className="text-[10px] uppercase font-bold text-slate-400 mb-2 h-6">Rendimiento por Posición (Excl. Dividendos)</h4>
                  <div className="flex-1 w-full text-[9px] relative">
                      {data.map((item, idx) => {
                          const widthPct = (Math.abs(item.value) / maxAbsVal) * 50; 
                          const isPositive = item.value >= 0;
                          return (
                              <div key={idx} className="flex items-center w-full h-[28px] mb-[7px] hover:bg-slate-800/30 rounded px-1 transition-colors group">
                                  <div className="w-[30%] flex flex-col justify-center leading-none border-r border-slate-700 pr-2">
                                      <div className="font-bold text-white truncate">{item.ticker}</div>
                                      <div className="flex justify-between text-[7px] text-slate-500 font-mono"><span>{item.shares} acc.</span><span className="text-slate-600">{item.dates}</span></div>
                                  </div>
                                  <div className="w-[70%] flex relative h-full items-center overflow-visible">
                                      <div className="absolute left-1/2 top-0 bottom-0 w-px bg-slate-600 z-10 opacity-50"></div>
                                      <div className="w-1/2 flex justify-end pr-0.5">
                                          {!isPositive && (
                                              <div className="h-4 bg-red-500/80 rounded-l flex items-center justify-end pr-1 gap-2 min-w-[2px] relative" style={{ width: `${widthPct}%` }}>
                                                  <span className="text-[8px] font-bold text-white drop-shadow-md whitespace-nowrap absolute right-1 z-20 flex gap-2"><span>{formatMoney(item.value, baseCurrency)}</span><span>({formatN(item.pct)}%)</span></span>
                                              </div>
                                          )}
                                      </div>
                                      <div className="w-1/2 flex justify-start pl-0.5">
                                          {isPositive && (
                                              <div className="h-4 bg-green-500/80 rounded-r flex items-center justify-start pl-1 gap-2 min-w-[2px] relative" style={{ width: `${widthPct}%` }}>
                                                   <span className="text-[8px] font-bold text-white drop-shadow-md whitespace-nowrap absolute left-1 z-20 flex gap-2"><span>{formatMoney(item.value, baseCurrency)}</span><span>({formatN(item.pct)}%)</span></span>
                                              </div>
                                          )}
                                      </div>
                                  </div>
                              </div>
                          );
                      })}
                  </div>
                  <div className="absolute bottom-2 left-0 right-0 flex w-full text-[8px] text-slate-500 font-mono h-6">
                      <div className="w-[30%]"></div>
                      <div className="w-[70%] flex justify-between px-2 relative border-t border-slate-700/50 pt-1">
                          {ticks.map((t, i) => (<div key={i} className="flex flex-col items-center w-[20px] text-center"><div className="h-1 w-px bg-slate-600 mb-0.5 absolute top-0"></div><span>{formatN(t, 0)}</span></div>))}
                      </div>
                  </div>
              </div>
          );
      };

      // --- COMPONENTE: DASHBOARD ESTADÍSTICO (ACTUALIZADO) ---
const StatsDashboard = ({ portfolio, baseCurrency, taxTotal }) => {
          const [view, setView] = useState(0); 

          const metrics = useMemo(() => {
              // Filtrar solo los activos para los cálculos
              const active = portfolio.filter(p => !p.sellDate && p.isActive !== false);
              const closed = portfolio.filter(p => !!p.sellDate && p.isActive !== false);
              const r2 = (n) => Math.round((parseFloat(n) || 0) * 100) / 100;

              const calcGroup = (items) => {
                  let totalInv = 0, totalCur = 0, divTotal = 0;
                  let winCount = 0, lossCount = 0, winAmt = 0, lossAmt = 0;
                  let daysTotal = 0, maxDays = 0, minDays = Infinity;
                  let maxInv = 0, minInv = Infinity;

                  items.forEach(p => {
                      const cost = r2((p.buyPrice * p.shares * p.buyFx) + (p.feesIncludedInPrice?0:(p.fees||0)) + (p.adjustments||0));
                      const isS = !!p.sellDate;
                      const curP = isS ? p.sellPrice : (p.isIndex ? p.currentPrice/(p.indexDivisor||1) : p.currentPrice);
                      const curF = isS ? p.sellFx : (p.isIndex ? p.buyFx : p.currentFx);
                      const val = r2((curP * p.shares * curF) - (isS ? (p.sellFeesIncludedInPrice?0:(p.sellFees||0)) + (p.sellAdjustments||0) : 0));
                      const divs = (p.dividends || []).reduce((acc,d) => acc+d.net, 0);
                      const plTotal = r2((val + divs) - cost);
                      const days = calculateDays(p.buyDate, p.sellDate || new Date());

                      totalInv += cost; totalCur += val; divTotal += divs; daysTotal += days;
                      maxInv = Math.max(maxInv, cost); minInv = Math.min(minInv, cost);
                      maxDays = Math.max(maxDays, days); minDays = Math.min(minDays, days);

                      if(plTotal >= 0) { winCount++; winAmt += plTotal; } else { lossCount++; lossAmt += plTotal; }
                  });
                  if(minInv === Infinity) minInv = 0; if(minDays === Infinity) minDays = 0;
                  const finalValuation = totalCur + divTotal;
                  const ratio = totalInv > 0 ? finalValuation / totalInv : 0;
                  const yieldPct = totalInv > 0 ? (divTotal / totalInv) * 100 : 0;
                  return { count: items.length, winCount, lossCount, winAmt, lossAmt, avgDays: items.length ? daysTotal/items.length : 0, maxDays, minDays, avgCap: items.length ? totalInv/items.length : 0, maxInv, minInv, balance: (totalCur - totalInv), divs: divTotal, yieldPct, accum: (totalCur - totalInv + divTotal), ratio, totalInv, finalValuation };
              };
              const openM = calcGroup(active); const closedM = calcGroup(closed);
              const globalInv = openM.totalInv + closedM.totalInv; const globalVal = openM.finalValuation + closedM.finalValuation; const totalRatio = globalInv > 0 ? globalVal / globalInv : 0;
              
              // RANKING LOGIC (SEPARADO)
              const processItem = (p) => {
                  const cost = r2((p.buyPrice * p.shares * p.buyFx) + (p.feesIncludedInPrice?0:(p.fees||0)) + (p.adjustments||0));
                  const isS = !!p.sellDate;
                  const curP = isS ? p.sellPrice : (p.isIndex ? p.currentPrice/(p.indexDivisor||1) : p.currentPrice);
                  const curF = isS ? p.sellFx : (p.isIndex ? p.buyFx : p.currentFx);
                  const val = r2((curP * p.shares * curF) - (isS ? (p.sellFeesIncludedInPrice?0:(p.sellFees||0)) + (p.sellAdjustments||0) : 0));
                  const divs = (p.dividends || []).reduce((acc,d) => acc+d.net, 0);
                  const plTotal = r2((val + divs) - cost);
                  const days = calculateDays(p.buyDate, p.sellDate || new Date());
                  const ret = calcReturns(cost, val + divs, days);
                  return { ...p, cost, val, divs, plTotal, days, ret, isS };
              };

              const activeList = active.map(processItem).sort((a,b) => b.plTotal - a.plTotal);
              const closedList = closed.map(processItem).sort((a,b) => b.plTotal - a.plTotal);

              return { 
                  openM, closedM, totalRatio, globalInv, globalVal,
                  activeTop4: activeList.slice(0, 4),
                  activeBottom4: activeList.slice(-4).reverse(),
                  closedTop4: closedList.slice(0, 4),
                  closedBottom4: closedList.slice(-4).reverse()
              };
          }, [portfolio]);

          const Row = ({ label, leftVal, rightVal, isHeader = false, highlight = false, heightClass = '' }) => ( <div className={`grid grid-cols-3 text-[10px] border-b border-slate-700/50 ${isHeader ? 'bg-slate-700/50 font-bold text-slate-300' : 'hover:bg-slate-800/30'} ${highlight ? 'bg-yellow-900/10' : ''} ${heightClass}`}> <div className="p-1 pl-2 text-slate-400 uppercase font-bold flex items-center">{label}</div> <div className="p-1 text-right border-l border-slate-800 pr-2 font-mono text-slate-200 flex flex-col justify-center">{leftVal}</div> <div className="p-1 text-right border-l border-slate-800 pr-2 font-mono text-slate-200 flex flex-col justify-center">{rightVal}</div> </div> );
          const fK = (v) => { if (Math.abs(v) >= 1000) return (v/1000).toFixed(1) + 'k'; return v.toFixed(0); };

          const RankRow = ({ item }) => (
              <div className="flex justify-between items-center border-b border-slate-800/50 pb-1 mb-1 last:border-0 last:mb-0">
                  <div className="flex flex-col w-[40%]">
                      <span className={`font-bold text-[10px] truncate ${item.isS ? 'text-orange-300' : 'text-blue-300'}`}>{item.name.substring(0,15)}</span>
                      <span className="text-[8px] text-slate-500 font-mono">{item.ticker} | {item.days}d</span>
                  </div>
                  <div className="flex flex-col w-[30%] text-right">
                       <span className={`font-bold text-[10px] ${item.plTotal>=0?'text-green-400':'text-red-400'}`}>{formatMoney(item.plTotal, baseCurrency)}</span>
                       <span className="text-[8px] text-slate-500">Tot. (inc Div)</span>
                  </div>
                  <div className="flex flex-col w-[30%] text-right">
                       <span className={`font-bold text-[10px] ${item.ret.simple>=0?'text-green-400':'text-red-400'}`}>{formatN(item.ret.simple)}%</span>
                       <span className="text-[8px] text-slate-500">{formatN(item.ret.annual)}% Anual</span>
                  </div>
              </div>
          );

          return (
              <div className="w-full bg-slate-900 border border-slate-700 rounded-sm mb-6 shadow-2xl overflow-hidden font-sans relative group">
                  <div className="bg-gray-600 text-white text-[10px] font-bold p-1 px-2 uppercase tracking-wider flex justify-between items-center">
                      <span>Estadísticas sobre operaciones abiertas y cerradas</span>
                      <div className="flex gap-4 items-center">
                          <button onClick={()=>setView(prev => Math.max(0, prev-1))} disabled={view===0} className={`text-white hover:text-blue-400 disabled:opacity-30 transition-colors font-bold text-lg`}>{'◄'}</button>
                          <span className="text-[9px] text-slate-300">{view===0?'Resumen':'Ranking'}</span>
                          <button onClick={()=>setView(prev => Math.min(1, prev+1))} disabled={view===1} className={`text-white hover:text-blue-400 disabled:opacity-30 transition-colors font-bold text-lg`}>{'►'}</button>
                      </div>
                  </div>
                  <div className="flex transition-transform duration-500 ease-in-out" style={{ transform: `translateX(-${view * 100}%)` }}>
                      <div className="min-w-full">
                          <div className="flex flex-col lg:flex-row"><div className="flex-1">
                              <div className="grid grid-cols-3 bg-gray-500/20 text-[9px] uppercase font-bold text-slate-400 border-b border-slate-700"><div className="p-1 pl-2">Total y media histórica</div><div className="p-1 text-right pr-2 text-yellow-100">Abiertas</div><div className="p-1 text-right pr-2 text-red-100">Cerradas</div></div>
                              <Row label="Número Operaciones" leftVal={<span className="text-yellow-400 font-bold text-sm">{metrics.openM.count}</span>} rightVal={<span className="text-yellow-400 font-bold text-sm">{metrics.closedM.count}</span>} />
                              <Row label="Con Ganancia (Tot)" leftVal={<div>{Math.round((metrics.openM.winCount/metrics.openM.count||0)*100)}% : {metrics.openM.winCount}<br/><span className="text-green-400">{formatMoney(metrics.openM.winAmt, baseCurrency)}</span></div>} rightVal={<div>{metrics.closedM.winCount} : {Math.round((metrics.closedM.winCount/metrics.closedM.count||0)*100)}%<br/><span className="text-green-400">{formatMoney(metrics.closedM.winAmt, baseCurrency)}</span></div>} />
                              <Row label="Con Pérdida (Tot)" leftVal={<div>{Math.round((metrics.openM.lossCount/metrics.openM.count||0)*100)}% : {metrics.openM.lossCount}<br/><span className="text-red-400">{formatMoney(metrics.openM.lossAmt, baseCurrency)}</span></div>} rightVal={<div>{metrics.closedM.lossCount} : {Math.round((metrics.closedM.lossCount/metrics.closedM.count||0)*100)}%<br/><span className="text-red-400">{formatMoney(metrics.closedM.lossAmt, baseCurrency)}</span></div>} />
                              <div className="grid grid-cols-3 text-[10px] border-b border-slate-700/50 bg-green-900/10 py-1"><div className="pl-2 text-green-400 uppercase font-bold flex flex-col justify-center"><div className="flex items-center gap-1"><span className="bg-yellow-400 text-black px-0.5 rounded text-[8px] w-4 text-center">R</span> Ratio (€/Inv)</div></div><div className="text-right border-l border-slate-800 pr-2 font-mono flex flex-col justify-center"><div className={`${metrics.openM.ratio >= 1 ? 'text-green-400' : 'text-red-400'} font-bold text-lg leading-none`}>{formatN(metrics.openM.ratio)}</div><div className="text-[7px] text-slate-400 mt-0.5">{fK(metrics.openM.totalInv)} / {fK(metrics.openM.finalValuation)}</div></div><div className="text-right border-l border-slate-800 pr-2 font-mono flex flex-col justify-center"><div className={`${metrics.closedM.ratio >= 1 ? 'text-green-400' : 'text-red-400'} font-bold text-lg leading-none`}>{formatN(metrics.closedM.ratio)}</div><div className="text-[7px] text-slate-400 mt-0.5">{fK(metrics.closedM.totalInv)} / {fK(metrics.closedM.finalValuation)}</div></div></div>
                              <div className="bg-slate-800 border-b border-slate-700 py-1.5 flex flex-col items-center justify-center"><div className="flex items-center gap-2"><span className="text-[9px] text-slate-400 uppercase font-bold">Media Total:</span><span className={`${metrics.totalRatio >= 1 ? 'text-green-400' : 'text-red-400'} font-bold text-sm bg-slate-700 px-2 rounded border border-slate-600`}>{formatN(metrics.totalRatio)}</span><span className="text-[8px] text-slate-500 font-mono">({fK(metrics.globalInv)} / {fK(metrics.globalVal)})</span></div></div>
                              
                              <Row label="Media Días Abierta" leftVal={`${formatN(metrics.openM.avgDays,0)} días`} rightVal={`${formatN(metrics.closedM.avgDays,0)} días`} />
                              <Row label="Máx Días Abierta" leftVal={`${formatN(metrics.openM.maxDays,0)} días`} rightVal={`${formatN(metrics.closedM.maxDays,0)} días`} />
                              <Row label="Mín Días Abierta" leftVal={`${formatN(metrics.openM.minDays,0)} días`} rightVal={`${formatN(metrics.closedM.minDays,0)} días`} />
                              <Row label="Media Capital Op." leftVal={formatMoney(metrics.openM.avgCap, baseCurrency)} rightVal={formatMoney(metrics.closedM.avgCap, baseCurrency)} />
                              <Row label="Máx Capital Inv." leftVal={formatMoney(metrics.openM.maxInv, baseCurrency)} rightVal={formatMoney(metrics.closedM.maxInv, baseCurrency)} />
                              <Row label="Mín Capital Inv." leftVal={formatMoney(metrics.openM.minInv, baseCurrency)} rightVal={formatMoney(metrics.closedM.minInv, baseCurrency)} />

                              <Row label="Saldo (Sin Divs)" leftVal={<span className={metrics.openM.balance>=0?'text-green-400 font-bold':'text-red-400 font-bold'}>{formatMoney(metrics.openM.balance, baseCurrency)}</span>} rightVal={<span className={metrics.closedM.balance>=0?'text-green-400 font-bold':'text-red-400 font-bold'}>{formatMoney(metrics.closedM.balance, baseCurrency)}</span>} highlight={true} />
                              <Row label="Dividendos (%Yield)" leftVal={<span className="text-green-400 font-bold">{formatMoney(metrics.openM.divs, baseCurrency)} <span className="text-[8px] text-slate-400">({formatN(metrics.openM.yieldPct)}%)</span></span>} rightVal={<span className="text-green-400 font-bold">{formatMoney(metrics.closedM.divs, baseCurrency)} <span className="text-[8px] text-slate-400">({formatN(metrics.closedM.yieldPct)}%)</span></span>} />
                              <Row label="Acumulado Ventas" leftVal={<span className={metrics.openM.accum>=0?'text-green-400 font-bold':'text-red-400 font-bold'}>{formatMoney(metrics.openM.accum, baseCurrency)}</span>} rightVal={<span className={metrics.closedM.accum>=0?'text-green-400 font-bold':'text-red-400 font-bold'}>{formatMoney(metrics.closedM.accum, baseCurrency)}</span>} />
                              <div className="p-3 bg-slate-950 border-t border-slate-700 flex justify-between items-center"><div className="text-[10px] text-blue-300 font-bold uppercase">Saldo Histórico Cartera [Total]</div><div className="text-right flex items-baseline gap-3"><div className="text-xl font-black text-white">{formatMoney(metrics.openM.accum + metrics.closedM.accum, baseCurrency)}</div><div className="text-[9px] text-slate-500 font-mono">[ <span className="text-red-400">Imp: {formatMoney(taxTotal, baseCurrency)}</span> | <span className="text-green-400 font-bold">Neto: {formatMoney((metrics.openM.accum + metrics.closedM.accum) - taxTotal, baseCurrency)}</span> ]</div></div></div>
                          </div></div>
                      </div>
                      <div className="min-w-full p-4 flex flex-col gap-4 bg-slate-900">
                          {/* PANEL ABIERTAS */}
                          <div className="flex gap-4">
                              <div className="flex-1 bg-slate-800/40 border border-slate-700 rounded-xl p-3">
                                  <h4 className="text-[10px] uppercase font-bold text-green-400 mb-3 border-b border-green-500/30 pb-1 flex justify-between"><span>Top Rentabilidad</span> <span className="bg-blue-600 text-white px-1.5 rounded text-[8px]">ABIERTAS</span></h4>
                                  <div className="space-y-2">{metrics.activeTop4.map((item, i) => <RankRow key={i} item={item} />)}</div>
                              </div>
                              <div className="flex-1 bg-slate-800/40 border border-slate-700 rounded-xl p-3">
                                  <h4 className="text-[10px] uppercase font-bold text-red-400 mb-3 border-b border-red-500/30 pb-1 flex justify-between"><span>Menor Rentabilidad</span> <span className="bg-blue-600 text-white px-1.5 rounded text-[8px]">ABIERTAS</span></h4>
                                  <div className="space-y-2">{metrics.activeBottom4.map((item, i) => <RankRow key={i} item={item} />)}</div>
                              </div>
                          </div>
                          {/* PANEL CERRADAS */}
                          <div className="flex gap-4">
                              <div className="flex-1 bg-slate-800/40 border border-slate-700 rounded-xl p-3">
                                  <h4 className="text-[10px] uppercase font-bold text-green-400 mb-3 border-b border-green-500/30 pb-1 flex justify-between"><span>Top Rentabilidad</span> <span className="bg-orange-600 text-white px-1.5 rounded text-[8px]">CERRADAS</span></h4>
                                  <div className="space-y-2">{metrics.closedTop4.map((item, i) => <RankRow key={i} item={item} />)}</div>
                              </div>
                              <div className="flex-1 bg-slate-800/40 border border-slate-700 rounded-xl p-3">
                                  <h4 className="text-[10px] uppercase font-bold text-red-400 mb-3 border-b border-red-500/30 pb-1 flex justify-between"><span>Menor Rentabilidad</span> <span className="bg-orange-600 text-white px-1.5 rounded text-[8px]">CERRADAS</span></h4>
                                  <div className="space-y-2">{metrics.closedBottom4.map((item, i) => <RankRow key={i} item={item} />)}</div>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
          );
      };








const DividendTab = ({ portfolio, setPortfolio, baseCurrency, syncStatus, onManualSync }) => {
    const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());
    const [showAllHistory, setShowAllHistory] = useState(false);

    const r2 = (n) => Math.round((parseFloat(n) || 0) * 100) / 100;

    const formatDateSimple = (d) => {
        if(!d) return '';
        const date = new Date(d);
        return `${date.getDate().toString().padStart(2,'0')}/${(date.getMonth()+1).toString().padStart(2,'0')}/${date.getFullYear().toString().slice(-2)}`;
    };

    const filtered = useMemo(() => {
        return portfolio.filter(p => { 
            if (showAllHistory) return (p.dividends && p.dividends.length > 0) || p.annualDividend > 0;
            const paysDiv = p.annualDividend > 0;
            const hasDivsInYear = (p.dividends || []).some(d => d.year === selectedYear && d.net !== 0);
            const bY = new Date(p.buyDate).getFullYear(); 
            const sY = p.sellDate ? new Date(p.sellDate).getFullYear() : 9999; 
            return (paysDiv || hasDivsInYear) && bY <= selectedYear && sY >= selectedYear; 
        }).sort((a,b) => {
            const aClosed = !!a.sellDate; const bClosed = !!b.sellDate;
            if(aClosed !== bClosed) return aClosed ? 1 : -1;
            return a.name.localeCompare(b.name);
        });
    }, [portfolio, selectedYear, showAllHistory]);

    const handleDivChange = (id, month, field, val) => { 
        if (showAllHistory) return;
        const numVal = r2(val); 
        setPortfolio(prev => prev.map(p => { 
            if (p.id !== id) return p; 
            let divs = [...(p.dividends || [])]; 
            const idx = divs.findIndex(d => d.year === selectedYear && d.month === month); 
            if (idx >= 0) divs[idx][field] = numVal; 
            else divs.push({ id: Date.now() + Math.random(), year: selectedYear, month, net: field === 'net' ? numVal : 0, taxOrigin: field === 'taxOrigin' ? numVal : 0, taxDest: field === 'taxDest' ? numVal : 0 }); 
            return { ...p, dividends: divs }; 
        })); 
    };
    
    const stats = useMemo(() => {
        let tNet = 0, tOrg = 0, tDest = 0, tBruto = 0, tDIB = 0, tDI15 = 0;
        const monthlyT = Array.from({ length: 12 }, () => ({ n: 0, o: 0, d: 0 }));
        
        const rows = filtered.map(p => {
            const ds = (p.dividends || []).filter(d => showAllHistory ? true : d.year === selectedYear);
            const n = r2(ds.reduce((a, b) => a + (b.net || 0), 0));
            const o = r2(ds.reduce((a, b) => a + (b.taxOrigin || 0), 0));
            const d = r2(ds.reduce((a, b) => a + (b.taxDest || 0), 0));
            const b = r2(n + o + d);
            const diBruto = o > 0 ? b : 0; 
            const di15 = r2(o > 0 ? b * 0.15 : 0); 
            
            tNet = r2(tNet + n); tOrg = r2(tOrg + o); tDest = r2(tDest + d); 
            tBruto = r2(tBruto + b); tDIB = r2(tDIB + diBruto); tDI15 = r2(tDI15 + di15);
            
            const rowMonths = Array.from({ length: 12 }, () => ({ n: 0, o: 0, d: 0 }));
            ds.forEach(div => { 
                if (div.month >= 0 && div.month < 12) { 
                    rowMonths[div.month].n = r2(rowMonths[div.month].n + (div.net || 0)); 
                    rowMonths[div.month].o = r2(rowMonths[div.month].o + (div.taxOrigin || 0)); 
                    rowMonths[div.month].d = r2(rowMonths[div.month].d + (div.taxDest || 0)); 
                    monthlyT[div.month].n = r2(monthlyT[div.month].n + (div.net || 0)); 
                    monthlyT[div.month].o = r2(monthlyT[div.month].o + (div.taxOrigin || 0)); 
                    monthlyT[div.month].d = r2(monthlyT[div.month].d + (div.taxDest || 0)); 
                } 
            });
            return { id: p.id, name: p.name, ticker: p.ticker, n, o, d, b, diBruto, di15, rowMonths };
        });
        
        const tickerChartData = rows.filter(r => r.n > 0).map(r => ({ label: r.ticker, value: r.n })).sort((a,b) => b.value - a.value);
        const annualHistoryMap = {};
        portfolio.forEach(p => {
            (p.dividends || []).forEach(d => {
                annualHistoryMap[d.year] = r2((annualHistoryMap[d.year] || 0) + d.net);
            });
        });
        const annualChartData = Object.keys(annualHistoryMap).sort((a,b) => a - b).map(year => ({ label: year, value: annualHistoryMap[year] }));

        return { rows, tNet, tOrg, tDest, tBruto, tDIB, tDI15, monthlyT, tickerChartData, annualChartData };
    }, [filtered, selectedYear, showAllHistory, portfolio]);

    const chartDataMonthly = useMemo(() => stats.monthlyT.map((m, i) => ({ label: MONTHS[i].substring(0,3), value: m.n })), [stats]);
const handlePrint = () => {
        const printWindow = window.open('', '', 'height=800,width=1200');
        const emissionTime = new Date().toLocaleString();
        const reportTitle = showAllHistory ? `INFORME HISTÓRICO ACUMULADO DE DIVIDENDOS` : `INFORME DE DIVIDENDOS AÑO: ${selectedYear}`;
        
        // Helper interno para formato de fecha dd-mm-aaaa
        const fDate = (d) => {
            if(!d) return '';
            const date = new Date(d);
            return `${date.getDate().toString().padStart(2,'0')}-${(date.getMonth()+1).toString().padStart(2,'0')}-${date.getFullYear()}`;
        };

        let html = `<html><head><title>Print</title><style>
            @page { size: landscape; margin: 5mm; } 
            body { font-family: sans-serif; color: #000; -webkit-print-color-adjust: exact; margin:0; padding:0; } 
            h1 { font-size: 10px; border-bottom: 1px solid #000; text-transform: uppercase; margin-bottom: 4px; } 
            table { width: 100%; border-collapse: collapse; table-layout: fixed; } 
            
            /* Cabeceras ultra pequeñas */
            th { background: #f1f5f9; border: 0.1pt solid #94a3b8; font-size: 3.2px; text-transform: uppercase; padding: 1px; } 
            
            /* Cifras del cuerpo y totales: tamaño reducido para que quepan importes grandes */
            td { border: 0.1pt solid #cbd5e1; text-align: right; font-size: 3.5px; font-family: monospace; white-space: nowrap; padding: 1px; } 
            
            /* Columna Nombre (Grande) / Ticker y Fecha (Pequeña debajo) */
            .name-col { text-align: left; font-weight: bold; width: 90px; white-space: normal; font-size: 4px; line-height: 1; } 
            .ticker-sub { font-size: 3.2px; font-weight: normal; color: #555; display: block; font-family: monospace; }
            
            /* Columna Acumulados */
            .acum-col { width: 100px; text-align: center; font-weight: bold; background: #fafafa; font-size: 3.2px; letter-spacing: -0.2px; }
            
            /* Casillas de los meses: Ancho ajustado a 65px */
            .month-cell { width: 65px; } 
            
            /* Sombreado alterno para diferenciar meses visualmente */
            .alt-col { background: #f0f3f5 !important; }
            
            /* Fila de Totales */
            .total-row { background: #e2e8f0; font-weight: bold; }
            .total-row td { border-top: 0.5px solid #000; font-size: 3.4px; font-family: monospace; }
            
            .footer-box { margin-top: 8px; border: 1px solid #333; padding: 5px; background: #f9f9f9; width: 45%; }
            .footer-box table td { font-size: 5.5px; font-family: sans-serif; }
        </style></head><body>`;
        
        html += `<h1>${reportTitle} (EMISIÓN: ${emissionTime})</h1>`;
        
        html += `<table><thead><tr><th rowspan="2" style="width:90px;">Nombre / Ticker</th><th rowspan="2" style="width:100px;">ACUMULADO<br/>(N|O|D|B)</th>`;
        
        // Cabecera de meses con clase de ancho 65px y sombreado
        MONTHS.forEach((m, i) => {
            html += `<th colspan="3" class="month-cell ${i % 2 === 0 ? 'alt-col' : ''}">${m.substring(0,3)}</th>`;
        });
        
        html += `<th rowspan="2" style="width:35px;">BDI</th><th rowspan="2" style="width:35px;">15%</th></tr><tr>`;
        
        // Sub-cabeceras N|O|D con sombreado
        MONTHS.forEach((_, i) => {
            const c = i % 2 === 0 ? 'alt-col' : '';
            html += `<th style="font-size:2.8px;" class="${c}">N</th><th style="font-size:2.8px;" class="${c}">O</th><th style="font-size:2.8px;" class="${c}">D</th>`;
        });
        
        html += `</tr></thead><tbody>`;
        
        stats.rows.forEach(r => {
            const p = portfolio.find(x => x.id === r.id);
            const isS = !!p.sellDate;
            const dateStr = isS ? `V:${fDate(p.sellDate)}` : `C:${fDate(p.buyDate)}`;
            
            html += `<tr>
                <td class="name-col"><span>${r.name}</span><span class="ticker-sub">${r.ticker} | ${dateStr}</span></td>
                <td class="acum-col">${formatN(r.n)}|${formatN(r.o)}|${formatN(r.d)}|${formatN(r.b)}</td>`;
            
            r.rowMonths.forEach((m, i) => {
                const c = i % 2 === 0 ? 'alt-col' : '';
                html += `<td class="${c}">${m.n ? formatN(m.n) : ''}</td><td class="${c}">${m.o ? formatN(m.o) : ''}</td><td class="${c}">${m.d ? formatN(m.d) : ''}</td>`;
            });
            
            html += `<td>${formatN(r.diBruto)}</td><td>${formatN(r.di15)}</td></tr>`;
        });
        
        // Fila de totales
        html += `<tr class="total-row"><td colspan="2" style="text-align:right; padding-right:4px;">TOTALES GENERALES →</td>`;
        stats.monthlyT.forEach((m, i) => {
            const c = i % 2 === 0 ? 'alt-col' : '';
            html += `<td class="${c}">${formatN(m.n)}</td><td class="${c}">${formatN(m.o)}</td><td class="${c}">${formatN(m.d)}</td>`;
        });
        
        html += `<td>${formatN(stats.tDIB)}</td><td>${formatN(stats.tDI15)}</td></tr></tbody></table>`;
        
        // Caja de resumen fiscal con desglose de retenciones
        html += `<div class="footer-box">
            <div style="font-size:7px; font-weight:bold; border-bottom:0.5px solid #ccc; margin-bottom:3px; text-transform:uppercase;">Resumen Fiscal Consolidado ${showAllHistory ? '(Histórico)' : ''}</div>
            <table style="width:100%; border:none; margin:0; table-layout: auto;">
                <tr><td style="border:none; text-align:left;">Dividendos Brutos Totales:</td><td style="border:none; font-weight:bold;">${formatMoney(stats.tBruto, baseCurrency)}</td></tr>
                <tr><td style="border:none; text-align:left;">Retenciones en Origen:</td><td style="border:none; color:#dc2626;">${formatMoney(stats.tOrg, baseCurrency)}</td></tr>
                <tr><td style="border:none; text-align:left;">Retenciones en Destino (España):</td><td style="border:none; color:#dc2626;">${formatMoney(stats.tDest, baseCurrency)}</td></tr>
                <tr style="border-top: 0.2px dashed #666;"><td style="border:none; text-align:left; font-weight:bold;">Total Retenciones:</td><td style="border:none; color:#dc2626; font-weight:bold;">${formatMoney(stats.tOrg + stats.tDest, baseCurrency)}</td></tr>
                <tr><td style="border:none; text-align:left; border-top:0.8px solid #333; padding-top:2px;"><b>Líquido Neto Percibido:</b></td><td style="border:none; border-top:0.8px solid #333; color:#16a34a; font-size:8px; padding-top:2px;"><b>${formatMoney(stats.tNet, baseCurrency)}</b></td></tr>
            </table>
        </div></body></html>`;
        
        printWindow.document.write(html); 
        printWindow.document.close();
        setTimeout(() => { 
            printWindow.focus(); 
            printWindow.print(); 
        }, 500);
    };
   
    return (
        <div className="w-full p-4 md:p-6 flex flex-col gap-6">
            <div className="flex justify-between items-center bg-slate-900/80 p-4 rounded-xl border border-slate-800 shrink-0">
                <div className="flex items-center gap-6">
                    <div className={`flex items-center gap-4 transition-opacity ${showAllHistory ? 'opacity-20 pointer-events-none' : ''}`}>
                        <button onClick={() => setSelectedYear(y => y - 1)} className="p-2 bg-slate-800 rounded hover:bg-slate-700 transition-colors">←</button>
                        <span className="text-xl font-bold font-display text-blue-400">{selectedYear}</span>
                        <button onClick={() => setSelectedYear(y => y + 1)} className="p-2 bg-slate-800 rounded hover:bg-slate-700 transition-colors">→</button>
                    </div>
                    <label className="flex items-center gap-3 cursor-pointer bg-slate-800/50 px-4 py-2 rounded-lg border border-slate-700 hover:border-blue-500">
                        <input type="checkbox" checked={showAllHistory} onChange={(e) => setShowAllHistory(e.target.checked)} className="custom-checkbox w-5 h-5 accent-blue-600"/>
                        <div className="flex flex-col"><span className="text-[9px] font-black text-white uppercase leading-none">Todos</span><span className="text-[7px] text-slate-500 font-bold">(Histórico)</span></div>
                    </label>
                </div>
                <div className="flex gap-4 items-center">
                    <button onClick={onManualSync} className={`px-2 py-1.5 rounded-lg text-[9px] font-bold border flex items-center gap-1.5 transition-all ${syncStatus === 'unsaved' ? 'bg-orange-600 border-orange-500 text-white' : 'bg-slate-800 border-slate-600 text-green-400'}`}><Icons.Upload size={12}/> {syncStatus === 'unsaved' ? 'GUARDAR' : 'SYNC OK'}</button>
                    
                    <div className="flex gap-4 mr-2">
                        <div className="text-right">
                            <div className="text-[8px] text-slate-500 uppercase font-bold">Bruto {showAllHistory ? 'Hist.' : ''}</div>
                            <div className="text-sm font-bold text-white">{formatMoney(stats.tBruto, baseCurrency)}</div>
                        </div>
                        <div className="text-right border-l border-slate-700 pl-4">
                            <div className="text-[8px] text-red-400 uppercase font-bold">Retenciones</div>
                            <div className="text-sm font-bold text-red-400">{formatMoney(stats.tOrg + stats.tDest, baseCurrency)}</div>
                            <div className="text-[7px] text-slate-500 font-mono leading-none mt-0.5">
                                (O: {formatMoney(stats.tOrg, baseCurrency)} | D: {formatMoney(stats.tDest, baseCurrency)})
                            </div>
                        </div>
                        <div className="text-right border-l border-slate-700 pl-4">
                            <div className="text-[8px] text-green-400 uppercase font-bold">Neto {showAllHistory ? 'Acum.' : ''}</div>
                            <div className="text-sm font-bold text-green-400">{formatMoney(stats.tNet, baseCurrency)}</div>
                        </div>
                    </div>

                    <button onClick={handlePrint} className="bg-slate-700 px-3 py-1.5 rounded-lg text-[9px] font-bold border border-slate-600 hover:bg-slate-600 transition-colors flex items-center gap-2 text-white"><Icons.ExternalLink size={14}/> IMPRIMIR</button>
                </div>
            </div>
            
            <div className="w-full overflow-x-auto custom-scrollbar border border-slate-800 rounded-xl bg-slate-950">
                <table className="w-full text-[9px] border-collapse min-w-[2400px]">
                    <thead className="bg-slate-900 border-b border-slate-700 uppercase sticky top-0 z-20">
                        <tr>
                            <th className="p-2 w-[220px] text-left sticky left-0 bg-slate-900 z-30 border-r border-slate-800">NOMBRE (TICKER)</th>
                            <th className="p-2 w-[140px] bg-yellow-900/20 text-yellow-500 text-center">ACUMULADO</th>
                            {MONTHS.map((m, i) => (
                                <th key={m} className={`p-1 border-l border-slate-800 w-[155px] ${i % 2 === 0 ? 'bg-slate-800/60' : 'bg-slate-900'}`}>
                                    <div className="text-blue-300 mb-1 text-center">{m}</div>
                                    <div className="grid grid-cols-3 gap-0.5 text-[7px] text-slate-500 text-center"><span>NETO</span><span>ORIG</span><span>DEST</span></div>
                                </th>
                            ))}
                            <th className="p-2 w-[90px] bg-purple-900/30 border-l border-slate-800">B.D.I.</th>
                            <th className="p-2 w-[90px] bg-purple-900/30 border-l border-slate-800">15%</th>
                        </tr>
                    </thead>
                    <tbody>
                        {stats.rows.map(r => { 
                            const p = portfolio.find(x => x.id === r.id); const isS = !!p.sellDate; 
                            return ( 
                                <tr key={r.id} className="hover:bg-white/5 border-b border-slate-800">
                                    <td className="p-2 sticky left-0 bg-slate-950 border-r border-slate-800">
                                        <div className={`font-bold text-xs ${isS ? 'text-red-400' : 'text-green-400'}`}>{r.name}</div>
                                        <div className="text-[8px] text-slate-500 font-mono mt-0.5">{r.ticker} <span className="opacity-60">({formatDateSimple(isS?p.sellDate:p.buyDate)})</span></div>
                                    </td>
                                    <td className="p-2 bg-yellow-900/5 text-right font-mono space-x-1.5 text-[9px]">
                                        <span className="text-green-300">{formatN(r.n)}</span>|<span className="text-slate-400">{formatN(r.o)}</span>|<span className="text-slate-400">{formatN(r.d)}</span>|<span className="text-white font-bold">{formatN(r.b)}</span>
                                    </td>
                                    {r.rowMonths.map((m, i) => ( 
                                        <td key={i} className={`p-1 border-l border-slate-800 ${i % 2 === 0 ? 'bg-white/[0.04]' : ''} ${showAllHistory ? 'bg-slate-900/30' : ''}`}>
                                            <div className="grid grid-cols-3 gap-1">
                                                <input type="number" step="0.01" value={m.n || ''} onChange={e => handleDivChange(r.id, i, 'net', e.target.value)} disabled={showAllHistory} className={`w-full text-center text-green-400 bg-transparent border-none p-0 focus:ring-1 focus:ring-green-500 ${showAllHistory ? 'opacity-30 cursor-not-allowed' : ''}`} />
                                                <input type="number" step="0.01" value={m.o || ''} onChange={e => handleDivChange(r.id, i, 'taxOrigin', e.target.value)} disabled={showAllHistory} className={`w-full text-center text-slate-400 bg-transparent border-none p-0 focus:ring-1 focus:ring-slate-500 ${showAllHistory ? 'opacity-30 cursor-not-allowed' : ''}`} />
                                                <input type="number" step="0.01" value={m.d || ''} onChange={e => handleDivChange(r.id, i, 'taxDest', e.target.value)} disabled={showAllHistory} className={`w-full text-center text-slate-400 bg-transparent border-none p-0 focus:ring-1 focus:ring-slate-500 ${showAllHistory ? 'opacity-30 cursor-not-allowed' : ''}`} />
                                            </div>
                                        </td> 
                                    ))}
                                    <td className="p-2 text-center bg-purple-900/10 font-bold text-purple-300">{formatN(r.diBruto)}</td>
                                    <td className="p-2 text-center bg-purple-900/10 border-l border-slate-800 font-bold text-purple-300">{formatN(r.di15)}</td>
                                </tr> 
                            ); 
                        })}
                        <tr className="bg-slate-900 font-black text-white text-xs border-t-2 border-slate-700 sticky bottom-0 z-30 shadow-2xl">
                            <td colSpan="2" className="p-3 text-right sticky left-0 bg-slate-900 uppercase tracking-widest border-r border-slate-700">TOTALES →</td>
                            {MONTHS.map((_, i) => ( 
                                <td key={i} className={`p-1 border-l border-slate-800 ${i % 2 === 0 ? 'bg-slate-800/90' : 'bg-[#0f121a]'}`}>
                                    <div className="grid grid-cols-3 gap-0.5 text-[7px] font-mono text-center">
                                        <span className="text-green-400">{formatN(stats.monthlyT[i].n)}</span>
                                        <span className="text-slate-500">{formatN(stats.monthlyT[i].o)}</span>
                                        <span className="text-slate-500">{formatN(stats.monthlyT[i].d)}</span>
                                    </div>
                                </td> 
                            ))}
                            <td className="p-3 text-center bg-purple-600/20 text-purple-300 border-l border-purple-500/30">{formatN(stats.tDIB)}</td>
                            <td className="p-3 text-center bg-purple-800/20 text-purple-300 border-l border-slate-700">{formatN(stats.tDI15)}</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div className="flex flex-col gap-6 shrink-0 mb-6">
                <div className="bg-blue-900/20 p-4 rounded-xl border border-blue-500/30">
                    <div className="flex justify-between items-center border-b border-blue-500/30 pb-2 mb-2">
                        <div className="text-blue-400 font-display font-bold text-xs uppercase tracking-widest">Resumen Dividendos ({showAllHistory ? 'Histórico' : `Ejercicio ${selectedYear}`})</div>
                    </div>
                    <div className="grid grid-cols-3 gap-4 text-center">
                        <div><div className="text-[9px] uppercase font-bold text-blue-300">Total Bruto</div><div className="text-lg font-bold text-white">{formatMoney(stats.tBruto, baseCurrency)}</div></div>
                        <div><div className="text-[9px] uppercase font-bold text-blue-300">Total Retenciones</div><div className="text-lg font-bold text-white">{formatMoney(stats.tOrg + stats.tDest, baseCurrency)}</div></div>
                        <div className="bg-blue-600 rounded-lg shadow-lg shadow-blue-900/40 p-1">
                            <div className="text-[8px] uppercase font-bold text-white/80">Neto {showAllHistory ? 'Percibido' : 'del Año'}</div>
                            <div className="text-lg font-black text-white">{formatMoney(stats.tNet, baseCurrency)}</div>
                        </div>
                    </div>
                </div>

                <div className="h-[400px] w-full">
                    <SimpleChart type="bar" data={chartDataMonthly} title={showAllHistory ? "Distribución Mensual (Acumulado Histórico)" : `Cobro Mensual Dividendos ${selectedYear}`} height={400} color="#10b981" />
                </div>
                <div className="h-[400px] w-full">
                    <SimpleChart type="bar" data={stats.tickerChartData} title={showAllHistory ? "Acumulado por Ticker (Toda la Vida)" : `Dividendos por Ticker ${selectedYear}`} height={400} color="#3b82f6" />
                </div>
                <div className="h-[400px] w-full">
                    <SimpleChart type="bar" data={stats.annualChartData} title="Histórico de Dividendos Netos por Año" height={400} color="#a855f7" />
                </div>
            </div>
        </div>
    );
};




const SettingsTab = ({ apiKey, setApiKey, _x_stat, _x_act, baseCurrency, setBaseCurrency, refreshInterval, setRefreshInterval, portfolio, setPortfolio, onForceBackup, gScriptUrl, setGScriptUrl, resultsData, appPin, setAppPin, _x_lim, _x_trig }) => {
    const [localLic, setLocalLic] = useState(''); 
    const [showKey, setShowKey] = useState(false); 
    const [testStatus, setTestStatus] = useState(null); 
    const [errorDetail, setErrorDetail] = useState(''); 
    const [ioStatus, setIoStatus] = useState('idle');
    const [showUrl, setShowUrl] = useState(false); 
    
    // ESTADOS PARA IMPORTACIÓN
    const [importMethod, setImportMethod] = useState('pdf'); 
    const [pdfFile, setPdfFile] = useState(null); 
    const [rawTextData, setRawTextData] = useState('');
    const [pdfPrompt, setPdfPrompt] = useState('Analiza este listado y extrae las operaciones de compra/venta.'); 
    const [importing, setImporting] = useState(false); 
    const [importResult, setImportResult] = useState(null);

    // ESTADOS PARA PIN (NUEVO)
    const [tempPin, setTempPin] = useState(appPin || '');
    const [pinVisible, setPinVisible] = useState(false);

    const simpleEncrypt = (text) => { if(!text) return ''; try { return btoa(text.split('').map((c, i) => String.fromCharCode(c.charCodeAt(0) + (i % 5))).join('')); } catch { return text; } };
    const simpleDecrypt = (text) => { if(!text) return ''; try { return atob(text).split('').map((c, i) => String.fromCharCode(c.charCodeAt(0) - (i % 5))).join(''); } catch { return text; } };

    const sanitizeAndParseJSON = (text) => { 
        try {
            let clean = text.replace(/```json/g, '').replace(/```/g, '').trim();
            const firstBracket = clean.indexOf('[');
            const lastBracket = clean.lastIndexOf(']');
            
            if (firstBracket !== -1 && lastBracket !== -1) {
                clean = clean.substring(firstBracket, lastBracket + 1);
                return JSON.parse(clean);
            }
            return JSON.parse(clean);
        } catch (e) { 
            console.error("Raw AI Response:", text);
            throw new Error("La IA no devolvió un JSON válido. Ver detalles en consola."); 
        } 
    };

    const testConnection = async () => { if(!apiKey) return alert("Introduce una clave primero."); setTestStatus('loading'); setErrorDetail(''); try { await askGemini(apiKey, "Test conexión"); setTestStatus('success'); } catch(e) { setTestStatus('error'); setErrorDetail(e.message); } };
    
    const handleRunExport = () => { 
        setIoStatus('processing'); 
        try { 
            const data = { portfolio, apiKey, baseCurrency, refreshInterval, version: 3, resultsData, appPin }; // Incluimos PIN en backup
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"}); 
            const url = URL.createObjectURL(blob); 
            const a = document.createElement('a'); a.href = url; a.download = `BoardingGate_Backup_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); setIoStatus('success'); setTimeout(() => setIoStatus('idle'), 2000); 
        } catch (e) { alert("Error: " + e.message); setIoStatus('error'); } 
    };
    
    const handleRunImport = (e) => { const file = e.target.files[0]; if (!file) return; if(!confirm("⚠️ IMPORTANTE:\n\nEsta acción reemplazará TODA tu cartera y configuración actual.\n\n¿Estás seguro de continuar?")) { e.target.value = null; return; } setIoStatus('processing'); const reader = new FileReader(); reader.onload = (ev) => { try { const d = JSON.parse(ev.target.result); if (d.portfolio) setPortfolio(d.portfolio); if (d.apiKey) setApiKey(d.apiKey); if (d.baseCurrency) setBaseCurrency(d.baseCurrency); if (d.refreshInterval) setRefreshInterval(d.refreshInterval); if(d.appPin) setAppPin(d.appPin); setIoStatus('success'); alert("✅ Restauración completada correctamente."); window.location.reload(); } catch (err) { alert("Archivo inválido o corrupto."); setIoStatus('error'); } }; reader.readAsText(file); };
    
    const handleAiImport = async () => { 
        if (!apiKey) return alert("Falta API Key"); 
        if (importMethod === 'pdf' && !pdfFile) return alert("Selecciona un PDF");
        if (importMethod === 'text' && !rawTextData.trim()) return alert("Pega el texto de tus acciones");

        setImporting(true); 
        setImportResult(null); 

        try { 
            let dataToAnalyze = "";
            if (importMethod === 'pdf') {
                try { dataToAnalyze = await readPdfText(pdfFile); } catch (pdfErr) { throw new Error("No se pudo leer el PDF. Es posible que sea una imagen escaneada o esté protegido."); }
            } else { dataToAnalyze = rawTextData; }

            const truncatedText = dataToAnalyze.substring(0, 50000); 
            const prompt = `
              ROLE: Data Extraction Expert.
              GOAL: Convert the following unstructured financial text into a Strict JSON Array.
              INSTRUCTIONS: "${pdfPrompt}"
              INPUT DATA: """${truncatedText}"""
              OUTPUT REQUIREMENTS:
              1. Return ONLY a JSON Array. No markdown formatting, no intro text.
              2. Use this schema for each item:
              [{
                  "ticker": "SYMBOL (e.g., AAPL, SAN.MC)",
                  "name": "Company Name",
                  "shares": number (positive integer),
                  "buyPrice": number (price per share),
                  "buyDate": "YYYY-MM-DD" (guess if missing, default to 2024-01-01),
                  "stockCurrency": "USD/EUR/GBP",
                  "buyFx": number (exchange rate to base currency, default 1),
                  "fees": number (total transaction fees),
                  "sellDate": "YYYY-MM-DD" (ONLY if it's a SELL operation, else null),
                  "sellPrice": number (price per share if sold, else 0),
                  "sellFx": number (default 1),
                  "sellFees": number
              }]
              3. If a row represents a SELL, populate 'sellDate' and 'sellPrice'. If it's a BUY or currently held, keep sellDate null.
              4. Ignore headers, totals, or footer text.
            `;

            const res = await askGemini(apiKey, prompt); 
            const extractedData = sanitizeAndParseJSON(res); 

            if (Array.isArray(extractedData)) { 
                // AQUI SE COMPRUEBA EL LIMITE DE ACCIONES (5 SIN REGISTRO)
                if ((portfolio.length + extractedData.length) > _x_lim) {
                    throw new Error("CAPACITY_OVERFLOW_EXCEPTION"); 
                }

                setPortfolio(prev => { 
                    const newItems = extractedData.map(item => ({ 
                        ...item, 
                        id: Date.now() + Math.random(), 
                        group: 'Importado IA', 
                        isActive: true, 
                        dividends: [], 
                        adjustments: 0, 
                        buyPE: 0, 
                        currentPE: 0, 
                        annualDividend: 0, 
                        currentPrice: item.sellDate ? 0 : item.buyPrice, 
                        currentFx: item.buyFx 
                    })); 
                    return [...prev, ...newItems]; 
                }); 
                setImportResult({ success: true, count: extractedData.length, rawResponse: null }); 
            } else { 
                throw new Error("La IA respondió, pero no devolvió una lista (Array)."); 
            } 
        } catch (e) { 
            if (e.message === "CAPACITY_OVERFLOW_EXCEPTION") _x_trig(true);
                setImportResult({ success: false, error: e.message === "CAPACITY_OVERFLOW_EXCEPTION" ? "Error de Capacidad IO." : e.message, rawResponse: null }); 
            } finally { 
                setImporting(false); 
                setPdfFile(null); 
                } 
            };

    return (
        <div className="h-full p-6 flex flex-col items-center justify-start fade-in overflow-y-auto custom-scrollbar">
            {importing && <div className="absolute inset-0 z-50 bg-black/80 backdrop-blur-sm flex flex-col items-center justify-center fade-in"><Icons.Loader size={60} className="text-purple-500 mb-4 animate-spin" /><div className="text-xl font-bold text-white animate-pulse">Analizando Datos...</div><div className="text-xs text-slate-400 mt-2">La IA está leyendo tu documento</div></div>}
            
            {importResult && ( 
                <div className="absolute inset-0 z-[60] bg-black/90 flex items-center justify-center p-4 fade-in"> 
                    <div className="bg-slate-900 border border-slate-700 p-6 rounded-xl max-w-lg w-full text-center shadow-2xl"> 
                        {importResult.success ? ( 
                            <> <div className="text-green-500 mb-4 mx-auto"><Icons.CheckCircle size={50}/></div> <h3 className="text-xl font-bold text-white mb-2">Importación Completada</h3> <p className="text-slate-400 text-sm mb-6">Se han añadido <strong>{importResult.count}</strong> registros a tu cartera.</p> </> 
                        ) : ( 
                            <> 
                              <div className="text-red-500 mb-4 mx-auto"><Icons.AlertCircle size={50}/></div> 
                              <h3 className="text-xl font-bold text-white mb-2">Error de Importación</h3> 
                              <p className="text-red-300 text-sm mb-4 font-bold">{importResult.error}</p>
                              <div className="text-left bg-black p-2 rounded border border-slate-800 text-[10px] font-mono text-slate-400 max-h-32 overflow-y-auto mb-4">
                                  {importResult.rawResponse || "Sin detalles adicionales."}
                              </div>
                              <p className="text-slate-500 text-xs italic">Consejo: Si el PDF falla, prueba a copiar el texto del PDF y usar la opción "Pegar Texto".</p>
                            </> 
                        )} 
                        <button onClick={()=>setImportResult(null)} className="bg-slate-700 px-6 py-2 rounded-lg font-bold text-white hover:bg-slate-600 border border-slate-600">Cerrar</button> 
                    </div> 
                </div> 
            )}

            {/* --- SECCIÓN NUEVA: SEGURIDAD PIN --- */}
            <div className="max-w-2xl w-full bg-slate-900/80 border border-slate-800 rounded-2xl p-8 shadow-2xl mb-8">
                <div className="flex items-center gap-4 mb-6 border-b border-slate-700 pb-4">
                    <div className="p-3 bg-red-500/20 rounded-xl text-red-400"><Icons.EyeOff size={32} /></div>
                    <div><h2 className="text-2xl font-bold text-white">Seguridad de Acceso</h2><p className="text-slate-400 text-sm">Protege tu cartera con un PIN</p></div>
                </div>
                <div className="bg-slate-950/50 p-4 rounded-xl border border-slate-700 flex flex-col gap-4">
                    <label className="block text-xs font-bold text-slate-400 uppercase tracking-wider">PIN de 4 Dígitos (Dejar vacío para desactivar)</label>
                    <div className="flex gap-4">
                        <div className="relative flex-1">
                            <input type={pinVisible ? "text" : "password"} value={tempPin} onChange={(e) => { const val = e.target.value.replace(/[^0-9]/g, '').slice(0,4); setTempPin(val); }} placeholder="----" className="w-full bg-slate-800 border border-slate-600 rounded-xl p-3 text-white text-center font-mono text-xl tracking-[1em] focus:border-red-500 focus:outline-none"/>
                            <button onClick={() => setPinVisible(!pinVisible)} className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-500 hover:text-white"><Icons.Eye size={18}/></button>
                        </div>
                        <button onClick={() => { setAppPin(tempPin); alert("Configuración de PIN guardada."); }} className="bg-red-600 hover:bg-red-500 text-white px-6 rounded-xl font-bold uppercase text-xs">Guardar PIN</button>
                    </div>
                    <p className="text-[10px] text-slate-500 italic">Si defines un PIN, se te pedirá cada vez que recargues la página.</p>
                </div>
            </div>
            
            {/* PREFERENCIAS GENERALES */}
            <div className="max-w-2xl w-full bg-slate-900/80 border border-slate-800 rounded-2xl p-8 shadow-2xl mb-8">
                <div className="flex items-center gap-4 mb-6 border-b border-slate-700 pb-4"><div className="p-3 bg-blue-500/20 rounded-xl text-blue-400"><Icons.Settings size={32} /></div><div><h2 className="text-2xl font-bold text-white">Preferencias Generales</h2><p className="text-slate-400 text-sm">Personalización de la cartera</p></div></div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label className="block text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider">Divisa Base (Totales)</label><select value={baseCurrency} onChange={(e) => setBaseCurrency(e.target.value)} className="w-full bg-slate-800 border border-slate-600 rounded-xl p-3 text-white text-sm focus:outline-none focus:border-blue-500">{CURRENCIES.map(c => <option key={c.code} value={c.code}>{c.code} - {c.name}</option>)}</select><p className="text-[10px] text-slate-500 mt-2">Moneda para mostrar resultados globales.</p></div><div><label className="block text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider">Refresco Automático</label><div className="bg-slate-800 p-3 rounded-xl border border-slate-600 flex items-center gap-4"><input type="range" min="5" max="60" step="5" value={refreshInterval} onChange={(e) => setRefreshInterval(parseInt(e.target.value))} className="flex-1 accent-blue-500 h-2 bg-slate-600 rounded-lg appearance-none cursor-pointer" /><div className="font-mono font-bold text-blue-400 w-16 text-right">{refreshInterval} min</div></div><p className="text-[10px] text-slate-500 mt-2">Frecuencia de actualización de precios.</p></div></div>
            </div>

           {/* CONFIGURACIÓN IA */}
            <div className="max-w-2xl w-full bg-slate-900/80 border border-slate-800 rounded-2xl p-8 shadow-2xl mb-8">
                <div className="flex items-center gap-4 mb-6 border-b border-slate-700 pb-4"><div className="p-3 bg-purple-500/20 rounded-xl text-purple-400"><Icons.Wand size={32} /></div><div><h2 className="text-2xl font-bold text-white">Configuración IA</h2><p className="text-slate-400 text-sm">Conexión con Google Gemini</p></div></div>
                <div className="space-y-6">
                    <div><label className="block text-sm font-bold text-slate-300 mb-2">Google Gemini API Key</label><div className="relative mb-4"><input type={showKey ? "text" : "password"} value={apiKey} onChange={(e) => setApiKey(e.target.value)} placeholder="AIzaSy..." className="w-full bg-black/50 border border-slate-600 rounded-xl p-4 pr-12 text-white focus:border-purple-500 focus:outline-none font-mono"/><button onClick={() => setShowKey(!showKey)} className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-500 hover:text-slate-300">{showKey ? <Icons.EyeOff size={20}/> : <Icons.Eye size={20}/>}</button></div><div className="flex justify-end gap-3 items-center"><button onClick={testConnection} className={`h-[40px] px-6 rounded-xl border font-bold text-sm flex items-center gap-2 ${testStatus === 'success' ? 'bg-green-600 border-green-500 text-white' : testStatus === 'error' ? 'bg-red-600 border-red-500 text-white' : 'bg-slate-700 border-slate-600 text-slate-300'}`}>{testStatus === 'loading' ? <Icons.Loader/> : testStatus === 'success' ? <Icons.CheckCircle size={18}/> : 'PROBAR CONEXIÓN'}</button></div>{testStatus === 'error' && <div className="mt-4 p-4 bg-red-900/30 border border-red-500/50 rounded-xl text-red-200 text-xs font-mono whitespace-pre-wrap">{errorDetail}</div>}
                        <div className="mt-6 p-6 bg-[#1e293b] border border-[#334155] rounded-xl relative overflow-hidden"><h4 className="text-lg font-bold text-blue-400 mb-4 flex items-center gap-2"><Icons.HelpCircle size={20} /> Gestión de la API Key (Gratis vs Pago)</h4><div className="mb-6 border-b border-slate-700 pb-6"><h5 className="text-sm font-bold text-white mb-3 flex items-center gap-2"><span className="bg-green-500/20 text-green-400 px-2 py-0.5 rounded text-[10px] uppercase border border-green-500/30">Opción Gratuita</span><span className="text-slate-400 text-xs font-normal">Ideal para uso básico</span></h5><ol className="list-decimal list-inside text-xs text-slate-300 space-y-2 mb-4 leading-relaxed"><li>Accede a <a href="https://aistudio.google.com/app/apikey" target="_blank" className="text-blue-400 hover:underline font-bold">Google AI Studio</a>.</li><li>Haz clic en <strong>"Get API key"</strong> (arriba izquierda) y luego en <strong>"Create API key in new project"</strong>.</li><li>Copia la clave y pégala arriba.</li></ol><p className="text-[10px] text-slate-400 bg-slate-900/50 p-3 rounded border border-slate-700"><strong>Límites actuales:</strong> 15 peticiones/minuto (RPM) y 1.500/día. Si la IA falla o tarda mucho, es probable que hayas superado este límite temporalmente.</p></div><div><h5 className="text-sm font-bold text-white mb-3 flex items-center gap-2"><span className="bg-blue-500/20 text-blue-400 px-2 py-0.5 rounded text-[10px] uppercase border border-blue-500/30">Opción Ilimitada (Pay-as-you-go)</span><span className="text-slate-400 text-xs font-normal">Para uso intensivo</span></h5><p className="text-xs text-slate-300 mb-3 leading-relaxed">Si actualizas precios de muchos valores frecuentemente o realizas análisis complejos, te conviene activar la facturación para eliminar esperas.</p><ol className="list-decimal list-inside text-xs text-slate-300 space-y-2 mb-6 leading-relaxed"><li>Ve a la <a href="https://console.cloud.google.com/billing" target="_blank" className="text-blue-400 hover:underline font-bold">Consola de Google Cloud Billing</a>.</li><li>Selecciona el <strong>mismo proyecto</strong> que se creó automáticamente en AI Studio (suele llamarse "Generative Language Client").</li><li>Haz clic en <strong>"Vincular una cuenta de facturación"</strong> e introduce tu tarjeta.</li><li><strong>Coste:</strong> Es extremadamente barato (aprox. $0.35 por millón de tokens). Actualizar una cartera consume centavos.</li></ol><div className="flex gap-3"><a href="https://aistudio.google.com/app/apikey" target="_blank" className="flex-1 text-center py-2.5 bg-slate-700 hover:bg-slate-600 text-white text-xs font-bold rounded-lg transition-colors flex items-center justify-center gap-2 border border-slate-600"><Icons.ExternalLink size={14}/> Obtener Key (AI Studio)</a><a href="https://console.cloud.google.com/billing" target="_blank" className="flex-1 text-center py-2.5 bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold rounded-lg transition-colors flex items-center justify-center gap-2 border border-blue-500"><Icons.ExternalLink size={14}/> Activar Facturación (Cloud)</a></div></div></div>
                    </div>
                </div>
            </div>


            {/* COPIA DE SEGURIDAD Y CLOUD */}
            <div className="max-w-2xl w-full bg-slate-900/80 border border-slate-800 rounded-2xl p-8 shadow-2xl mb-8">
                <div className="flex items-center gap-4 mb-6 border-b border-slate-700 pb-4"><div className="p-3 bg-cyan-500/20 rounded-xl text-cyan-400"><Icons.Upload size={32} className="rotate-180" /></div><div><h2 className="text-2xl font-bold text-white">Copia de Seguridad y Cloud</h2><p className="text-slate-400 text-sm">Exporta tu configuración y conecta Google Drive</p></div></div>
                <div className="bg-yellow-900/20 border border-yellow-600/30 rounded-xl p-4 mb-6"><h4 className="text-yellow-500 font-bold text-sm mb-2 flex items-center gap-2"><Icons.AlertCircle size={16}/> Información Importante</h4><p className="text-sm text-slate-300 leading-relaxed">El archivo de exportación contiene <strong>toda tu configuración, claves, y cartera de inversiones</strong>. Guárdalo en un lugar seguro.</p></div>
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4"><button onClick={handleRunExport} disabled={ioStatus === 'processing'} className={`flex items-center justify-center gap-2 py-4 px-6 rounded-xl border transition-all font-bold ${ioStatus === 'success' ? 'bg-green-600 border-green-500 text-white' : 'bg-slate-800 border-slate-600 hover:bg-slate-700 text-white'}`}>{ioStatus === 'processing' ? <Icons.Loader size={20}/> : <Icons.Upload size={20} className="rotate-180" />} EXPORTAR (LOCAL)</button><label className={`cursor-pointer flex items-center justify-center gap-2 py-4 px-6 rounded-xl border transition-all font-bold ${ioStatus === 'processing' ? 'bg-slate-800 opacity-50 cursor-not-allowed' : 'bg-blue-600 border-blue-500 hover:bg-blue-500 text-white'}`}><input type="file" accept=".json" className="hidden" onChange={handleRunImport} disabled={ioStatus === 'processing'} /><Icons.Upload size={20} /> RESTAURAR (LOCAL)</label></div>
                
                <div className="mt-8 border-t border-slate-700 pt-6">
                    <h4 className="text-sm font-bold text-blue-400 mb-4 uppercase tracking-widest flex items-center gap-2"><Icons.Globe size={16}/> Copia Automática (Google Apps Script)</h4>
                    <div><label className="block text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider">URL de la Aplicación Web (Script)</label><div className="flex items-end gap-2 mb-4"><div className="relative flex-1"><input type={showUrl ? "text" : "password"} value={simpleDecrypt(gScriptUrl)} onChange={(e) => setGScriptUrl(simpleEncrypt(e.target.value))} placeholder="https://script.google.com/macros/s/..." className="w-full bg-black/50 border border-slate-600 rounded-xl p-3 pr-12 text-white focus:border-green-500 focus:outline-none font-mono text-xs"/><button onClick={() => setShowUrl(!showUrl)} className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-500 hover:text-slate-300">{showUrl ? <Icons.EyeOff size={16}/> : <Icons.Eye size={16}/>}</button></div><button onClick={onForceBackup} className="bg-blue-600 hover:bg-blue-500 text-white px-4 py-3 rounded-xl font-bold text-xs flex items-center gap-2 transition-colors shadow-lg whitespace-nowrap"><Icons.Refresh size={16} className="shrink-0"/> FORZAR COPIA</button></div></div>
                    
                    {/* PARTE RESTAURADA COMPLETA */}
                    <div className="bg-slate-950/50 border border-slate-700 rounded-xl p-4"><h5 className="text-xs font-bold text-white mb-3 flex items-center gap-2"><Icons.HelpCircle size={14}/> Guía de Configuración (Script de Google)</h5><ol className="list-decimal list-inside text-[10px] text-slate-300 space-y-2 leading-relaxed font-sans"><li>Ve a <a href="https://script.google.com/home/start" target="_blank" className="text-blue-400 font-bold hover:underline">Google Apps Script</a> y haz clic en <strong>"Nuevo Proyecto"</strong>.</li><li>Borra todo el código del editor y pega este bloque tal cual:<pre className="bg-black text-green-400 p-2 rounded mt-1 mb-1 border border-slate-800 overflow-x-auto text-[9px] font-mono select-all">{`function doPost(e) {
var lock = LockService.getScriptLock(); lock.tryLock(10000);
try {
var data = JSON.parse(e.postData.contents);
var files = DriveApp.getFilesByName("BOARDINGGATE_DB.json");
var file = files.hasNext() ? files.next() : DriveApp.createFile("BOARDINGGATE_DB.json", "", MimeType.PLAIN_TEXT);
file.setContent(JSON.stringify(data));
return ContentService.createTextOutput(JSON.stringify({ status: "success", timestamp: data.timestamp })).setMimeType(ContentService.MimeType.JSON);
} catch(e) { return ContentService.createTextOutput(JSON.stringify({error:e.toString()})).setMimeType(ContentService.MimeType.JSON); }
finally { lock.releaseLock(); }
}

function doGet(e) {
try {
var files = DriveApp.getFilesByName("BOARDINGGATE_DB.json");
if (files.hasNext()) return ContentService.createTextOutput(files.next().getBlob().getDataAsString()).setMimeType(ContentService.MimeType.JSON);
return ContentService.createTextOutput(JSON.stringify({timestamp:0})).setMimeType(ContentService.MimeType.JSON);
} catch(e) { return ContentService.createTextOutput(JSON.stringify({error:e.toString()})).setMimeType(ContentService.MimeType.JSON); }
}`}</pre></li><li>Pulsa el botón azul <strong>"Implementar"</strong> (arriba dcha) {'>'} <strong>"Nueva implementación"</strong>.</li><li>En la rueda dentada (tipo), selecciona <strong>"Aplicación web"</strong>.</li><li>En "Quién tiene acceso", selecciona <strong>"Cualquier usuario"</strong> (Esto permite que la app guarde sin pedir login cada vez).</li><li>Pulsa "Implementar", autoriza el acceso a Drive, copia la URL que te dan ("Aplicación web") y pégala arriba.</li></ol></div>
                </div>
            </div>

            {/* IMPORTACIÓN MASIVA IA */}
            <div className="max-w-2xl w-full bg-slate-900/80 border border-slate-800 rounded-2xl p-8 shadow-2xl mb-8">
                 <div className="flex items-center gap-4 mb-6 border-b border-slate-700 pb-4">
                    <div className="p-3 bg-pink-500/20 rounded-xl text-pink-400"><Icons.Upload size={32} /></div>
                    <div><h2 className="text-2xl font-bold text-white">Importación Masiva IA</h2><p className="text-slate-400 text-sm">Carga de datos inteligente (PDF o Texto)</p></div>
                 </div>
                 
                 {/* Selector de Método */}
                 <div className="flex bg-slate-950 p-1 rounded-xl mb-4 border border-slate-700">
                     <button onClick={() => setImportMethod('pdf')} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-colors flex items-center justify-center gap-2 ${importMethod === 'pdf' ? 'bg-slate-800 text-white shadow' : 'text-slate-500 hover:text-white'}`}>
                         <Icons.Upload size={14}/> SUBIR PDF
                     </button>
                     <button onClick={() => setImportMethod('text')} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-colors flex items-center justify-center gap-2 ${importMethod === 'text' ? 'bg-slate-800 text-white shadow' : 'text-slate-500 hover:text-white'}`}>
                         <Icons.Copy size={14}/> PEGAR TEXTO / CSV
                     </button>
                 </div>

                 <div className="flex flex-col gap-4">
                     <div className="w-full">
                         <label className="block text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider">Instrucciones para la IA</label>
                         <input type="text" value={pdfPrompt} onChange={e=>setPdfPrompt(e.target.value)} className="w-full bg-slate-950 border border-slate-700 rounded-xl px-4 py-3 text-sm text-slate-300 mb-2" placeholder="Ej: Las ventas tienen precio negativo en la columna Importe..." />
                     </div>
                     
                     {/* ZONA DE ENTRADA SEGUN METODO */}
                     {importMethod === 'pdf' ? (
                         <label className="w-full cursor-pointer bg-slate-800 border border-slate-600 hover:bg-slate-700 text-white px-4 py-8 rounded-xl text-sm font-bold flex flex-col items-center justify-center gap-2 transition-colors border-dashed border-2">
                             <input type="file" accept="application/pdf" className="hidden" onChange={e => setPdfFile(e.target.files[0])} />
                             <Icons.Upload size={32} className="text-slate-500"/>
                             {pdfFile ? <span className="text-green-400 truncate">{pdfFile.name}</span> : <span className="text-slate-400">Haz clic para seleccionar tu PDF</span>}
                         </label>
                     ) : (
                         <textarea 
                             value={rawTextData} 
                             onChange={e => setRawTextData(e.target.value)} 
                             className="w-full h-40 bg-slate-950 border border-slate-700 rounded-xl p-4 text-xs font-mono text-slate-300 focus:border-pink-500 focus:outline-none custom-scrollbar"
                             placeholder="Pega aquí el contenido de tu tabla (Excel, CSV, o texto copiado del PDF)..."
                         />
                     )}

                     <button onClick={handleAiImport} disabled={importing || (importMethod==='pdf' && !pdfFile) || (importMethod==='text' && !rawTextData)} className="w-full bg-pink-600 hover:bg-pink-500 disabled:opacity-50 text-white px-4 py-4 rounded-xl text-sm font-black flex items-center justify-center gap-2 shadow-lg shadow-pink-900/20 transition-colors uppercase tracking-wider">
                         <Icons.Wand size={18}/> {importing ? 'Analizando...' : 'Procesar Datos con IA'}
                     </button>
                 </div>
            </div>

            {/* REGISTRO Y LICENCIA */}
            <div className="max-w-2xl w-full bg-slate-900/80 border border-slate-800 rounded-2xl p-8 shadow-2xl mb-20">
                <div className="flex items-center gap-4 mb-6 border-b border-slate-700 pb-4">
                    <div className={`p-3 rounded-xl ${_x_stat ? 'bg-green-500/20 text-green-400' : 'bg-blue-500/20 text-blue-400'}`}><Icons.CheckCircle size={32} /></div>
                    <div><h2 className="text-2xl font-bold text-white">Estado del Sistema</h2><p className="text-slate-400 text-sm">Verificación de entorno</p></div>
                </div>
                <div className="space-y-6">
                    <div className="bg-black/30 border border-slate-700 rounded-xl p-5">
                        <label className="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wider">Hash de Instalación</label>
                        <div className="flex gap-3">
                            <input type="text" value={localLic} onChange={(e) => setLocalLic(e.target.value.toUpperCase())} placeholder="XXXX-XXXX" className={`flex-1 bg-slate-900 border ${_x_stat ? 'border-green-600' : 'border-slate-600'} rounded-lg p-3 text-white font-mono focus:outline-none`} />
                            <button onClick={() => _x_act(localLic)} className="px-6 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold text-xs">VERIFICAR</button>
                        </div>
                        {_x_stat && <div className="mt-3 text-center text-green-400 text-xs font-bold uppercase tracking-widest">● SISTEMA VALIDADO</div>}
                    </div>
                    {!_x_stat && <p className="text-xs text-slate-500 text-center italic">El entorno opera actualmente en modo restringido.</p>}
                </div>
            </div>

            <div className="text-center bg-slate-800/50 p-4 rounded-xl max-w-2xl w-full mb-10">
                        <p className="text-xs text-slate-400 mb-4 leading-relaxed">Esta plataforma es un proyecto independiente que se sustenta exclusivamente mediante un modelo de <strong className="text-slate-300">crowdfunding</strong> y las aportaciones directas de sus usuarios. Tu registro ayuda a mantener los costes de desarrollo y mantenimiento. <span className="text-orange-400 font-bold">Sin registro, la aplicación está limitada a la gestión de 5 acciones.</span></p>
                        <p className="text-xs text-slate-400 mb-2 border-t border-slate-700 pt-4">Para obtener tu Nº de registro o colaborar con el crowdfunding:</p>
                        <a href="https://x.com/BoardingGate" target="_blank" className="inline-flex items-center gap-2 text-blue-400 hover:text-blue-300 font-bold transition-colors"><Icons.Globe size={16}/> @BoardingGate en X (Twitter)</a>
            </div>
     </div>
    
     );
};
   


const PortfolioTab = ({ portfolio, setPortfolio, apiKey, baseCurrency, refreshInterval, lastUpdate, setLastUpdate, resultsData, syncStatus, onManualSync, isAppReady, _x_lim, _x_trig, globalNotes, setGlobalNotes, onAnalyze }) => {
    // --- ESTADOS PERSISTENTES PARA FILTROS ---
    const [isNotesModalOpen, setIsNotesModalOpen] = useState(false);
    const [filterText, setFilterText] = usePersistentState('bg_port_filter_text', '');
    const [filterDateStart, setFilterDateStart] = usePersistentState('bg_port_filter_start', '');
    const [filterDateEnd, setFilterDateEnd] = usePersistentState('bg_port_filter_end', '');
    const [filterType, setFilterType] = usePersistentState('bg_port_filter_type', 'active'); 
    const [sortConfig, setSortConfig] = usePersistentState('bg_port_sort_config', { key: 'date', direction: 'desc' });
    
    // --- ESTADO PERSISTENTE PARA VISIBILIDAD DE SECCIONES ---
    const [visibleSections, setVisibleSections] = usePersistentState('bg_visible_sections', { table: true, diverging: true, stats: true, charts: true });

    const [updating, setUpdating] = useState(false);
    const [analyzing, setAnalyzing] = useState(false);
    const [fetchingSingle, setFetchingSingle] = useState(false);
    const [analysisResult, setAnalysisResult] = useState(null);
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [isSellModalOpen, setIsSellModalOpen] = useState(false);
    const [isAnalysisModalOpen, setIsAnalysisModalOpen] = useState(false);
    const [confirmModal, setConfirmModal] = useState({ isOpen: false, title: '', msg: '', onConfirm: null });
    const [infoModal, setInfoModal] = useState({ isOpen: false, title: '', msg: '', type: 'info' });
    const [noteToast, setNoteToast] = useState(null);
    const [editingId, setEditingId] = useState(null);
    const [sellItem, setSellItem] = useState(null);
    const [form, setForm] = useState({ ticker: '', name: '', group: '', notes: '', customOrder: '', isIndex: false, indexDivisor: 1, shares: 0, buyPrice: 0, buyDate: '', stockCurrency: 'USD', buyFx: 1, fees: 0, adjustments: 0, feesIncludedInPrice: false, buyPE: 0, annualDividend: 0, sellPrice: 0, sellDate: '', sellFx: 1, sellFees: 0, sellAdjustments: 0, sellFeesIncludedInPrice: false, currentPE: 0, dividends: [] });
    const [sellForm, setSellForm] = useState({ sharesToSell: 0, sellPrice: 0, sellDate: new Date().toISOString().slice(0,10), sellFx: 1, sellFees: 0, sellAdjustments: 0, sellFeesIncludedInPrice: false });

    const r2 = (n) => Math.round((parseFloat(n) || 0) * 100) / 100;
    const formatDateES = (d) => { if(!d) return ''; const date = new Date(d); return `${date.getDate().toString().padStart(2,'0')}-${(date.getMonth()+1).toString().padStart(2,'0')}-${date.getFullYear()}`; };
    const cleanVal = (v) => { if (typeof v === 'number') return v; const n = parseFloat(String(v).replace(/[^0-9.-]/g, '')); return isNaN(n) ? 0 : n; };
    const getRegion = (ticker) => { if (!ticker) return 'S/D'; if (ticker.includes(':')) return ticker.split(':')[0].toUpperCase(); const t = ticker.toUpperCase(); if (t.endsWith('.MC')) return 'BME (ES)'; if (t.endsWith('.DE')) return 'XETRA (DE)'; if (t.endsWith('.PA')) return 'EURONEXT (FR)'; if (t.endsWith('.L')) return 'LSE (UK)'; return 'US/OTROS'; };

    const toggleView = (key) => setVisibleSections(prev => ({...prev, [key]: !prev[key]}));

    useEffect(() => { if (noteToast) { const timer = setTimeout(() => setNoteToast(null), 30000); return () => clearTimeout(timer); } }, [noteToast]);
    const requestSort = (key) => { let direction = 'desc'; if (sortConfig.key === key && sortConfig.direction === 'desc') { direction = 'asc'; } setSortConfig({ key, direction }); };

    const handleYearJump = (direction) => {
        let targetYear;
        const currentYear = new Date().getFullYear();
        if (direction === -1) {
            const refYear = filterDateStart ? parseInt(filterDateStart.split('-')[0]) : currentYear;
            targetYear = refYear - 1;
        } else {
            const refYear = filterDateEnd ? parseInt(filterDateEnd.split('-')[0]) : (filterDateStart ? parseInt(filterDateStart.split('-')[0]) : currentYear);
            targetYear = refYear + 1;
        }
        setFilterDateStart(`${targetYear}-01-01`);
        setFilterDateEnd(`${targetYear}-12-31`);
    };

    const filteredPortfolio = useMemo(() => {
        let list = portfolio.filter(p => { if (filterType === 'active' && p.sellDate) return false; if (filterType === 'sold' && !p.sellDate) return false; if (filterText) { const txt = filterText.toUpperCase(); const matchTicker = p.ticker.toUpperCase().includes(txt); const matchName = (p.name || '').toUpperCase().includes(txt); const matchGroup = (p.group || '').toUpperCase().includes(txt); if (!matchTicker && !matchName && !matchGroup) return false; } if (filterDateStart || filterDateEnd) { let dateToCheck = p.buyDate; if (filterType === 'sold') dateToCheck = p.sellDate; else if (filterType === 'all') dateToCheck = p.sellDate || p.buyDate; if (filterDateStart && dateToCheck < filterDateStart) return false; if (filterDateEnd && dateToCheck > filterDateEnd) return false; } return true; });
        return list.sort((a, b) => { const dir = sortConfig.direction === 'asc' ? 1 : -1; 
          if (sortConfig.key === 'customOrder') { const aOrd = a.customOrder || ''; const bOrd = b.customOrder || ''; return aOrd.localeCompare(bOrd, undefined, { numeric: true, sensitivity: 'base' }) * (sortConfig.direction === 'asc' ? 1 : -1); }
          if (sortConfig.key === 'yield') { const getPL = (p) => { const cost = (p.buyPrice * p.shares * p.buyFx) + (p.feesIncludedInPrice ? 0 : (p.fees || 0)) + (p.adjustments || 0); const isS = !!p.sellDate; const curP = isS ? p.sellPrice : (p.isIndex ? p.currentPrice / p.indexDivisor : p.currentPrice); const curF = isS ? p.sellFx : p.currentFx; const vF = (curP * p.shares * curF) - (isS ? (p.sellFeesIncludedInPrice ? 0 : (p.sellFees || 0)) + (p.sellAdjustments || 0) : 0); return vF - cost; }; return (getPL(a) - getPL(b)) * dir; } 
          if (sortConfig.key === 'percent') { const getPct = (p) => { const cost = (p.buyPrice * p.shares * p.buyFx) + (p.feesIncludedInPrice ? 0 : (p.fees || 0)) + (p.adjustments || 0); const isS = !!p.sellDate; const curP = isS ? p.sellPrice : (p.isIndex ? p.currentPrice / p.indexDivisor : p.currentPrice); const curF = isS ? p.sellFx : p.currentFx; const vF = (curP * p.shares * curF) - (isS ? (p.sellFeesIncludedInPrice ? 0 : (p.sellFees || 0)) + (p.sellAdjustments || 0) : 0); const ds = (p.dividends || []).reduce((acc,d)=>acc+d.net,0); const days = calculateDays(p.buyDate, p.sellDate || new Date()); return calcReturns(cost, vF + ds, days).simple; }; return (getPct(a) - getPct(b)) * dir; } 
          if (sortConfig.key === 'value') { return a.ticker.localeCompare(b.ticker) * dir; } 
          if (filterType === 'all') { const aSold = !!a.sellDate; const bSold = !!b.sellDate; if (aSold !== bSold) return (aSold ? 1 : -1) * dir; if (!aSold) return (new Date(b.buyDate) - new Date(a.buyDate)) * dir; else return (new Date(b.sellDate) - new Date(a.sellDate)) * dir; } 
          if (filterType === 'active') return (new Date(b.buyDate) - new Date(a.buyDate)) * dir; 
          if (filterType === 'sold') return (new Date(b.sellDate) - new Date(a.sellDate)) * dir; 
          return 0; });
    }, [portfolio, filterText, filterDateStart, filterDateEnd, filterType, sortConfig]);

    const visiblePortfolio = useMemo(() => filteredPortfolio.filter(p => p.isActive !== false), [filteredPortfolio]);

    const [analyzingNews, setAnalyzingNews] = useState(false);
    const [newsResult, setNewsResult] = useState(null);
    const [isNewsModalOpen, setIsNewsModalOpen] = useState(false);
    const [isNewsSelectionModalOpen, setIsNewsSelectionModalOpen] = useState(false);

    // FUNCIÓN PARA OBTENER NOTICIAS
    const fetchNews = async (type) => {
        setIsNewsSelectionModalOpen(false); 
        
        const now = new Date();
        // Formato: "17 de febrero de 2026"
        const todayStr = now.toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' });
        // Formato para límites: "15/02/2026"
        const limit48h = new Date(now.getTime() - (48 * 60 * 60 * 1000)).toLocaleDateString('es-ES');
        const limit7d = new Date(now.getTime() - (7 * 24 * 60 * 60 * 1000)).toLocaleDateString('es-ES');

        let prompt = "";

        if (type === 'portfolio') {
            const activeTickers = activeFilteredPortfolio
                .filter(p => !p.sellDate && p.isActive !== false)
                .map(p => `${p.ticker} (${p.name})`);

            if (activeTickers.length === 0) {
                return setInfoModal({ isOpen: true, title: 'Aviso', msg: 'No hay acciones activas para buscar noticias.', type: 'info' });
            }

            prompt = `
                SISTEMA: ROL ANALISTA DE INTELIGENCIA FINANCIERA.
                FECHA ACTUAL DE REFERENCIA: ${todayStr}.
                INSTRUCCIÓN DE BÚSQUEDA: Busca activamente en Internet noticias publicadas ÚNICAMENTE entre el ${limit7d} y HOY (${todayStr}).
                
                TAREA: Resumir noticias relevantes para estos valores: ${activeTickers.join(', ')}.
                
                REQUISITOS ESTRICTOS:
                1. Idioma: Castellano.
                2. AGNOSIA TEMPORAL: Ignora cualquier noticia anterior al ${limit7d}. Si no hay nada nuevo, indica "Sin noticias recientes".
                3. ESTRUCTURA: Agrupar por TICKER (usar <h3> para el ticker).
                4. CADA NOTICIA: Fecha exacta, Titular, Resumen de 3 frases y enlace URL directo a la fuente.
              
                
                FORMATO: Responde solo con etiquetas HTML (h3, div, p, a).
            `;
        } else {
            prompt = `
                SISTEMA: ROL ANALISTA MACROECONÓMICO SENIOR.
                FECHA ACTUAL DE REFERENCIA: ${todayStr}.
                INSTRUCCIÓN DE BÚSQUEDA: Busca en Internet noticias de Bolsa y Economía Global publicadas en las ÚLTIMAS 48 HORAS (desde el ${limit48h} hasta hoy ${todayStr}).
                
                REQUISITOS ESTRICTOS:
                1. Idioma: Castellano.
                2. FILTRO DE ACTUALIDAD: No menciones nada que tenga más de 48 horas de antigüedad.
                3. ESTRUCTURA: Agrupar por CATEGORÍAS (Macro, Tecnología, Banca, etc. Usar <h3>).
                4. CADA NOTICIA: Hora/Fecha, Titular, Resumen del impacto esperado en los mercados y enlace URL a la fuente.
                
                FORMATO: Responde solo con etiquetas HTML (h3, div, p, a).
            `;
        }

        setAnalyzingNews(true);
        try {
            const res = await askGemini(apiKey, prompt);
            // Limpieza y validación de respuesta
            let cleanHtml = res.trim();
            cleanHtml = cleanHtml.replace(/```html/g, '').replace(/```/g, '');
            const startIdx = cleanHtml.indexOf('<');
            const endIdx = cleanHtml.lastIndexOf('>');
            if (startIdx !== -1 && endIdx !== -1) {
                cleanHtml = cleanHtml.substring(startIdx, endIdx + 1);
            }

            if (!cleanHtml || cleanHtml.length < 50) throw new Error("La IA no encontró resultados válidos.");

            setNewsResult(cleanHtml);
            setIsNewsModalOpen(true);
        } catch (e) {
            setInfoModal({ 
                isOpen: true, 
                title: 'Error de Rastreo', 
                msg: 'Fallo al obtener noticias: ' + e.message + '\n\nInténtalo de nuevo en unos segundos.', 
                type: 'error' 
            });
        } finally {
            setAnalyzingNews(false);
        }
    };    

  
    // FUNCIÓN PARA IMPRIMIR NOTICIAS
    const handlePrintNews = () => {
        const printWindow = window.open('', '', 'height=800,width=800');
        const time = new Date().toLocaleString();
        let html = `<html><head><title>Noticias Semanales</title><style>
            body { font-family: sans-serif; padding: 30px; color: #000; }
            h1 { border-bottom: 3px solid #1e3a8a; color: #1e3a8a; text-transform: uppercase; }
            h3 { color: #1e3a8a; border-bottom: 1px solid #ccc; margin-top: 25px; padding-bottom: 5px; }
            .news-item { margin-bottom: 15px; border-left: 3px solid #eee; padding-left: 10px; }
            .date { font-size: 0.8rem; color: #666; font-weight: bold; }
            .source { font-size: 0.8rem; color: #2563eb; }
            a { text-decoration: none; color: #2563eb; }
        </style></head><body>
            <h1>Radar de Noticias: Últimos 7 Días</h1>
            <p>Emisión: ${time}</p>
            <div>${newsResult}</div>
        </body></html>`;
        printWindow.document.write(html);
        printWindow.document.close();
        printWindow.focus();
        setTimeout(() => printWindow.print(), 500);
    };


    const gridTotals = useMemo(() => {
        let tFx = 0, tCost = 0, tVal = 0, tRes = 0;
        let sumBuyPE = 0, countBuyPE = 0;
        let sumCurPE = 0, countCurPE = 0;

        visiblePortfolio.forEach(p => {
            const isS = !!p.sellDate;
            const curP = isS ? p.sellPrice : (p.isIndex ? p.currentPrice / (p.indexDivisor || 1) : p.currentPrice);
            const curF = isS ? p.sellFx : (p.isIndex ? p.buyFx : p.currentFx);
            const cost = (p.buyPrice * p.shares * p.buyFx) + (p.feesIncludedInPrice ? 0 : (p.fees || 0)) + (p.adjustments || 0);
            const val = (curP * p.shares * curF) - (isS ? (p.sellFeesIncludedInPrice ? 0 : (p.sellFees || 0)) + (p.sellAdjustments || 0) : 0);
            const fxVal = (p.isIndex ? 0 : (p.shares * (isS ? p.sellPrice : p.currentPrice) * (curF - p.buyFx)));
            const divs = (p.dividends || []).reduce((a,b)=>a+b.net,0);
            tFx += fxVal; tCost += cost; tVal += val; tRes += (val - cost) + divs;
            
            if (p.buyPE > 0) { sumBuyPE += p.buyPE; countBuyPE++; }
            if (p.currentPE > 0) { sumCurPE += p.currentPE; countCurPE++; }
        });
        const tPct = tCost > 0 ? (tRes / tCost) * 100 : 0;
        const avgBuyPE = countBuyPE > 0 ? sumBuyPE / countBuyPE : 0;
        const avgCurPE = countCurPE > 0 ? sumCurPE / countCurPE : 0;

        return { tFx, tCost, tVal, tRes, tPct, avgBuyPE, avgCurPE };
    }, [visiblePortfolio]);

    const stats = useMemo(() => {
        const hasDeepFilters = filterText || filterDateStart || filterDateEnd;
        const sourceData = hasDeepFilters ? visiblePortfolio : portfolio.filter(p => p.isActive !== false); 
        const calc = (items) => { let inv = 0, cur = 0, divN = 0, fX = 0, weightedDays = 0; items.forEach(p => { const d = calculateDays(p.buyDate, p.sellDate || new Date()); const costT = (p.buyPrice * p.shares * p.buyFx) + (p.feesIncludedInPrice ? 0 : (p.fees || 0)) + (p.adjustments || 0); const isS = !!p.sellDate; const eP = isS ? p.sellPrice : (p.isIndex ? p.currentPrice / p.indexDivisor : p.currentPrice); const eF = isS ? p.sellFx : p.currentFx; const vN = (eP * p.shares * eF) - (isS ? (p.sellFeesIncludedInPrice ? 0 : (p.sellFees || 0)) + (p.sellAdjustments || 0) : 0); inv += costT; cur += vN; weightedDays += (d * costT); fX += (eP * p.shares * eF) - (eP * p.shares * p.buyFx); (p.dividends || []).forEach(dv => divN += dv.net); }); const avgD = inv > 0 ? weightedDays / inv : 0; const plP = cur - inv; const plT = (cur + divN) - inv; const rP = calcReturns(inv, cur, avgD); const rT = calcReturns(inv, cur + divN, avgD); return { num: items.length, inv, cur, divN, fX, plPrice: plP, plTotal: plT, plP_S: rP.simple, plP_A: rP.annual, plT_S: rT.simple, plT_A: rT.annual }; };
        return { active: calc(sourceData.filter(p => !p.sellDate)), sold: calc(sourceData.filter(p => !!p.sellDate)), total: calc(sourceData) };
    }, [filteredPortfolio, portfolio, filterText, filterDateStart, filterDateEnd, baseCurrency]);

    const historicalStats = useMemo(() => {
        const activeP = portfolio.filter(p => !p.sellDate && p.isActive !== false);
        const soldP = portfolio.filter(p => !!p.sellDate && p.isActive !== false);
        const allP = portfolio.filter(p => p.isActive !== false);
        
        const calcAvgCapital = (items) => {
            if (items.length === 0) return { avgCap: 0, profit: 0, first: null, last: null, diffDays: 0 };
            const sortedByBuy = [...items].sort((a,b) => new Date(a.buyDate) - new Date(b.buyDate));
            const firstDate = new Date(sortedByBuy[0].buyDate);
            let lastDate = new Date();
            if (items.every(p => p.sellDate)) {
                const sortedBySell = [...items].sort((a,b) => new Date(b.sellDate) - new Date(a.sellDate));
                lastDate = new Date(sortedBySell[0].sellDate);
            }
            const totalPeriodDays = Math.max(1, (lastDate - firstDate) / (1000 * 60 * 60 * 24));
            let weightedSum = 0;
            let totalProfit = 0;
            items.forEach(p => {
                const cost = (p.buyPrice * p.shares * p.buyFx) + (p.feesIncludedInPrice ? 0 : (p.fees || 0)) + (p.adjustments || 0);
                const endDate = p.sellDate ? new Date(p.sellDate) : new Date();
                const daysHeld = Math.max(0, (endDate - new Date(p.buyDate)) / (1000 * 60 * 60 * 24));
                weightedSum += (cost * daysHeld);
                const isS = !!p.sellDate;
                const curP = isS ? p.sellPrice : (p.isIndex ? p.currentPrice / (p.indexDivisor || 1) : p.currentPrice);
                const curF = isS ? p.sellFx : (p.isIndex ? p.buyFx : p.currentFx);
                const vF = (curP * p.shares * curF) - (isS ? (p.sellFeesIncludedInPrice ? 0 : (p.sellFees || 0)) + (p.sellAdjustments || 0) : 0);
                const divs = (p.dividends || []).reduce((acc,d) => acc+d.net, 0);
                totalProfit += (vF - cost) + divs;
            });
            const avgCap = weightedSum / totalPeriodDays;
            return { avgCap, profit: totalProfit, first: firstDate, last: lastDate, diffDays: totalPeriodDays };
        };

        const allOps = [];
        allP.forEach(p => {
            allOps.push({ d: new Date(p.buyDate).getTime(), type: 'buy' });
            if(p.sellDate) allOps.push({ d: new Date(p.sellDate).getTime(), type: 'sell' });
        });
        allOps.sort((a,b) => a.d - b.d);
        let diffSum = 0;
        for(let i=1; i<allOps.length; i++) {
            diffSum += (allOps[i].d - allOps[i-1].d);
        }
        const avgIntervalDays = allOps.length > 1 ? (diffSum / (allOps.length - 1)) / (1000 * 60 * 60 * 24) : 0;
        const firstEver = allOps.length > 0 ? allOps[0].d : Date.now();
        const lastEver = allOps.length > 0 ? allOps[allOps.length-1].d : Date.now();
        const totalTimeSpan = Math.max(1, (lastEver - firstEver)/(1000*60*60*24));
        let totalDaysOpenAccum = 0;
        allP.forEach(p => {
            const end = p.sellDate ? new Date(p.sellDate) : new Date();
            totalDaysOpenAccum += Math.max(0, (end - new Date(p.buyDate))/(1000*60*60*24));
        });
        const avgPositions = totalTimeSpan > 0 ? totalDaysOpenAccum / totalTimeSpan : 0;

        return { consolidated: calcAvgCapital(allP), closed: calcAvgCapital(soldP), active: calcAvgCapital(activeP), avgIntervalDays, avgPositions };
    }, [portfolio]);

    const activeFilteredPortfolio = useMemo(() => { return visiblePortfolio; }, [visiblePortfolio]); 
   
   const chartsData = useMemo(() => { 
        const distribution = activeFilteredPortfolio.filter(p => !p.sellDate).map(p => ({ label: p.ticker, value: ((p.currentPrice / (p.isIndex ? p.indexDivisor||1 : 1)) * p.shares * (p.isIndex ? p.buyFx : p.currentFx)) })).sort((a,b) => b.value - a.value); 
        const geoMap = {}; 
        activeFilteredPortfolio.filter(p => !p.sellDate).forEach(p => { const region = getRegion(p.ticker); const val = ((p.currentPrice / (p.isIndex ? p.indexDivisor||1 : 1)) * p.shares * (p.isIndex ? p.buyFx : p.currentFx)); geoMap[region] = (geoMap[region] || 0) + val; }); 
        const geoDiversification = Object.keys(geoMap).map(k => ({ label: k, value: geoMap[k] })).sort((a,b) => b.value - a.value); 
        const events = activeFilteredPortfolio.map(p => { const isSold = !!p.sellDate; const date = isSold ? p.sellDate : p.buyDate; const cost = (p.buyPrice * p.shares * p.buyFx) + (p.feesIncludedInPrice ? 0 : (p.fees || 0)) + (p.adjustments || 0); const curP = isSold ? p.sellPrice : (p.isIndex ? p.currentPrice / (p.indexDivisor||1) : p.currentPrice); const curF = isSold ? p.sellFx : (p.isIndex ? p.buyFx : p.currentFx); const value = isSold ? (((p.sellPrice * p.shares * p.sellFx) - (p.sellFeesIncludedInPrice ? 0 : (p.sellFees || 0)) - (p.sellAdjustments || 0)) - cost) : ((curP * p.shares * curF) - cost); return { date, value, cost, label: p.ticker }; }).sort((a,b) => new Date(a.date) - new Date(b.date)); 
        let accVal = 0; let accCost = 0; 
        const evolution = events.map(e => { accVal += e.value; accCost += e.cost; const roi = accCost !== 0 ? ((accVal) / accCost) * 100 : 0; return { label: e.date, value: accVal, extraPct: r2(roi) }; }); 
        return { distribution, geoDiversification, evolution }; 
    }, [activeFilteredPortfolio]);

    const divergingData = useMemo(() => { return activeFilteredPortfolio.map(p => { const cost = (p.buyPrice * p.shares * p.buyFx) + (p.feesIncludedInPrice ? 0 : (p.fees || 0)) + (p.adjustments || 0); const isS = !!p.sellDate; const curP = isS ? p.sellPrice : (p.isIndex ? p.currentPrice/p.indexDivisor : p.currentPrice); const curF = isS ? p.sellFx : p.currentFx; const val = (curP * p.shares * curF) - (isS ? (p.sellFeesIncludedInPrice ? 0 : (p.sellFees || 0)) + (p.sellAdjustments || 0) : 0); const pl = val - cost; const pct = cost !== 0 ? (pl/cost)*100 : 0; return { ticker: p.ticker, shares: p.shares, dates: `${formatDateES(p.buyDate)}${isS ? ' → '+formatDateES(p.sellDate) : ''}`, value: pl, pct: pct }; }).sort((a,b) => b.value - a.value); }, [activeFilteredPortfolio]);
    const taxSum = useMemo(() => { if(!resultsData) return 0; return Object.values(resultsData).reduce((acc, y) => acc + (y.tax || 0), 0); }, [resultsData]);

    useEffect(() => { 
    if (!isAppReady) return;
    const now = Date.now();
    const last = lastUpdate ? new Date(lastUpdate).getTime() : 0;
    const intervalMs = (refreshInterval || 10) * 60 * 1000;
    
    if (apiKey && portfolio.length > 0 && (now - last > intervalMs)) {
        updatePrices(true);
    }
   
    if (!refreshInterval || refreshInterval < 1) return; 
    const interval = setInterval(() => updatePrices(true), refreshInterval * 60 * 1000); 
    return () => clearInterval(interval); 
}, [apiKey, refreshInterval, isAppReady]);     

    const fetchTickerData = async () => { if (!form.ticker) return setInfoModal({ isOpen: true, title: 'Error', msg: 'Introduce un Ticker.', type: 'error' }); setFetchingSingle(true); try { const prompt = `Actúa como API financiera. Busca "${form.ticker}" (${form.stockCurrency}). Responde SOLO JSON: {"n":"nombre empresa","p":precio_numero,"fx":cambio_a_${baseCurrency},"pe":per_numero,"div":dividendo_anual_importe_numero}. USA PUNTO DECIMAL. SIN SIMBOLOS. Si no hay dividendo pon 0.`; const res = await askGemini(apiKey, prompt); const json = extractJSON(res); if (json) { setForm(prev => ({ ...prev, name: json.n || prev.name, buyPrice: cleanVal(json.p) || prev.buyPrice, buyFx: cleanVal(json.fx) || prev.buyFx, buyPE: cleanVal(json.pe) || prev.buyPE, annualDividend: cleanVal(json.div) || prev.annualDividend })); } } catch (e) { setInfoModal({ isOpen: true, title: 'Fallo', msg: `No localizado: ${form.ticker}.`, type: 'error' }); } finally { setFetchingSingle(false); } };

    const updatePrices = async (isAuto = false) => { const active = portfolio.filter(p => !p.sellDate && p.isActive !== false); if (!isAuto && !apiKey) return setInfoModal({ isOpen: true, title: 'Error', msg: 'Falta API Key.', type: 'error' }); if (!isAuto && active.length === 0) return; setUpdating(true); let log = { success: [], fail: [] }, newUpdates = []; try { for (const item of active) { const assetDesc = item.isIndex ? "MARKET INDEX (SPOT VALUE)" : "STOCK/EQUITY"; const prompt = `ROLE: Financial Data API. TASK: Get data for Ticker: "${item.ticker}". TYPE: ${assetDesc}. REQUIREMENTS: 1. "p": Current Price in its NATIVE currency (${item.stockCurrency}). STRICT RULE: DO NOT convert the price to ${baseCurrency}. Return it as it quotes in the market. 2. "fx": Exchange rate to convert from ${item.stockCurrency} to ${baseCurrency}. (Example: 1 ${item.stockCurrency} = X ${baseCurrency}). If same, fx = 1. 3. "pe": TTM P/E Ratio (0 if Index). RETURN JSON ONLY: {"p": number, "fx": number, "pe": number}`; try { const res = await askGemini(apiKey, prompt); const json = extractJSON(res); if (json && (json.p || json.p === 0)) { const safeFx = (item.stockCurrency === baseCurrency) ? 1 : cleanVal(json.fx); newUpdates.push({ id: item.id, p: cleanVal(json.p), fx: safeFx, pe: cleanVal(json.pe) }); log.success.push(item.ticker); } else { log.fail.push(item.ticker); } } catch (e) { log.fail.push(item.ticker); } } if (newUpdates.length > 0) { setPortfolio(prev => prev.map(p => { const u = newUpdates.find(x => x.id === p.id); if (u) { return { ...p, currentPrice: u.p, currentFx: u.fx, currentPE: u.pe }; } return p; }), false); setLastUpdate(new Date().toISOString()); } if (!isAuto && log.fail.length > 0) { setInfoModal({ isOpen: true, title: 'Sincronización parcial', msg: `No se pudieron actualizar: ${log.fail.join(', ')}.`, type: 'warning' }); } } catch (e) { if (!isAuto) setInfoModal({ isOpen: true, title: 'Error', msg: e.message, type: 'error' }); } finally { setUpdating(false); } };
    
 // ANALISIS IA MEJORADO Y CORREGIDO (VERSIÓN BLINDADA)
const analyzePortfolio = async () => {
      const dataToAnalyze = visiblePortfolio;
      if (dataToAnalyze.length === 0) return setInfoModal({ isOpen: true, title: 'Info', msg: 'No hay datos visibles para analizar.', type: 'info' });
      
      setAnalyzing(true);
      try {
        const today = new Date().toLocaleString('es-ES');
        
        // 1. Preparación de Datos y Cálculo de Métricas Matemáticas Reales
        let winningTrades = 0, losingTrades = 0;
        let grossProfit = 0, grossLoss = 0;
        let totalReturn = 0, totalInvested = 0;
        let operations = [];
        let firstDate = new Date(); 

        dataToAnalyze.forEach(p => {
             const cost = (p.buyPrice * p.shares * p.buyFx) + (p.feesIncludedInPrice ? 0 : (p.fees || 0)) + (p.adjustments || 0);
             const isS = !!p.sellDate;
             const curP = isS ? p.sellPrice : (p.isIndex ? p.currentPrice / (p.indexDivisor || 1) : p.currentPrice);
             const curF = isS ? p.sellFx : (p.isIndex ? p.buyFx : p.currentFx);
             const value = (curP * p.shares * curF) - (isS ? (p.sellFeesIncludedInPrice ? 0 : (p.sellFees || 0)) + (p.sellAdjustments || 0) : 0);
             const divs = (p.dividends || []).reduce((a,b)=>a+b.net, 0);
             
             const netPL = (value - cost) + divs;
             
             if (netPL > 0) { winningTrades++; grossProfit += netPL; }
             else { losingTrades++; grossLoss += Math.abs(netPL); }
             
             totalReturn += netPL;
             totalInvested += cost;

             if(new Date(p.buyDate) < firstDate) firstDate = new Date(p.buyDate);

             // DATOS ENRIQUECIDOS PARA LA IA: Coste, Valor y Fechas
             const bDate = new Date(p.buyDate).toISOString().split('T')[0];
             const sDate = isS ? new Date(p.sellDate).toISOString().split('T')[0] : 'Actualidad';
             
             operations.push(`- ${p.ticker} (${p.name}): ${isS ? 'CERRADA' : 'ACTIVA'}. Invertido: ${cost.toFixed(0)}. Valor/Liq: ${value.toFixed(0)}. Res: ${netPL.toFixed(0)} (${divs>0?`incl ${divs.toFixed(0)} div`:''}). Fechas: ${bDate} a ${sDate}. Grp: ${p.group || 'N/A'}`);
        });

        const totalTrades = winningTrades + losingTrades;
        const winRate = totalTrades > 0 ? (winningTrades / totalTrades) * 100 : 0;
        const profitFactor = grossLoss > 0 ? (grossProfit / grossLoss) : grossProfit;
        const totalROI = totalInvested > 0 ? (totalReturn / totalInvested) * 100 : 0;
        const yearsActive = Math.max(0.5, (new Date() - firstDate) / (1000 * 60 * 60 * 24 * 365));

        const contextData = `
        METRICAS CALCULADAS (REALES):
        - Total Operaciones: ${totalTrades}
        - Win Rate: ${winRate.toFixed(1)}%
        - Profit Factor: ${profitFactor.toFixed(2)}
        - ROI Total Cartera: ${totalROI.toFixed(2)}%
        - Periodo Actividad: ${yearsActive.toFixed(1)} años (aprox)
        - Listado de Operaciones (Incluye Coste e Importes para ponderar peso en cartera):
        ${operations.join('\n')}
        `;

        const prompt = `
        Contexto: Actúa como un Senior Portfolio Manager de un Hedge Fund en Wall Street. Tu misión es realizar una auditoría técnica y psicológica de mi cartera de inversión basándote en mis operaciones abiertas y cerradas.
        Premisas: da el informe en castellano y sin mensajes de cortesía iniciales (ve al grano). Debes tener en cuenta el contexto actual del mercado a la fecha de emisión (${today}).

        DATOS MATEMÁTICOS PROPORCIONADOS (No los recalcules, úsalos):
        ${contextData}

        INSTRUCCIONES DE ANÁLISIS:
        1. Atribución de Retornos: Identifica qué sectores o activos específicos están "cargando" con el rendimiento (considera el capital invertido, no solo el %).
        2. Análisis de Riesgo: Evalúa la exposición y correlación. Calcula un Drawdown estimado cualitativo.
        3. Auditoría de Sesgos: Analiza operaciones cerradas. ¿Sesgo de disposición? ¿Falta de Stop-Loss?
        4. Costo de Oportunidad: Compara mi ROI (${totalROI.toFixed(2)}%) contra el S&P 500 (SPY) estimado.
        5. Análisis Temporal (Horizonte): Clasifica las inversiones en Corto/Medio vs Largo Plazo (asume > 1 año como Largo Plazo). Evalúa si la estrategia de largo plazo ("Buy & Hold") está siendo exitosa frente al trading de corto plazo.

        ESTRUCTURA OBLIGATORIA DEL INFORME (Formato HTML puro sin markdown):
        <h3>1. EXECUTIVE SUMMARY</h3>
        <p>Diagnóstico de salud financiera en 2 párrafos directos (estilo Wall Street).</p>

        <h3>2. DASHBOARD DE MÉTRICAS</h3>
        <table border="1" style="width:100%; border-collapse: collapse;">
         <tr>
            <td><b>ROI Total</b><br/><span style="font-size:10px;color:#555">Retorno sobre capital invertido</span></td>
            <td>${totalROI.toFixed(2)}%</td>
         </tr>
         <tr>
            <td><b>Win Rate</b><br/><span style="font-size:10px;color:#555">% Operaciones ganadoras</span></td>
            <td>${winRate.toFixed(1)}%</td>
         </tr>
         <tr>
            <td><b>Profit Factor</b><br/><span style="font-size:10px;color:#555">Ganancia Bruta / Pérdida Bruta (>1 es rentable)</span></td>
            <td>${profitFactor.toFixed(2)}</td>
         </tr>
         <tr>
            <td><b>Expectativa Matemática</b><br/><span style="font-size:10px;color:#555">Promedio ganado/perdido por operación</span></td>
            <td>(Calcula tú una frase cualitativa basada en los datos)</td>
         </tr>
        </table>

        <h3>3. ANÁLISIS TEMPORAL Y ESTRATEGIA (CP vs LP)</h3>
        <p>Desglose de la eficiencia de la estrategia según horizonte temporal (Valores >1 año en cartera vs Recientes).</p>

        <h3>4. SEÑALES DE ALERTA Y RIESGOS</h3>
        <ul>
         <li>Riesgo 1: ...</li>
         <li>Riesgo 2: ...</li>
        </ul>

        <h3>5. PROPUESTAS TÁCTICAS Y REVISIÓN DE ACTIVOS</h3>
        <p>5 pasos para optimizar. Luego, lista las posiciones activas más relevantes con veredicto (VENDER / MANTENER / AMPLIAR) y motivo.</p>
        `;

        const res = await askGemini(apiKey, prompt);
        
        let cleanHtml = res.trim();
        cleanHtml = cleanHtml.replace(/```html/g, '').replace(/```/g, '');
        const startIdx = cleanHtml.indexOf('<');
        const endIdx = cleanHtml.lastIndexOf('>');
        if (startIdx !== -1 && endIdx !== -1) {
            cleanHtml = cleanHtml.substring(startIdx, endIdx + 1);
        }

        if (!cleanHtml || cleanHtml.length < 50) throw new Error("La IA devolvió una respuesta vacía o inválida. Inténtalo de nuevo.");

        setAnalysisResult(cleanHtml);
        setIsAnalysisModalOpen(true);
      } catch (e) {
        setInfoModal({ isOpen: true, title: 'Error de Análisis', msg: `Fallo al generar informe: ${e.message}. \n\nConsejo: Verifica tu API Key o reduce el número de activos visibles filtrando la lista.`, type: 'error' });
      } finally {
        setAnalyzing(false);
      }
    };



    const handleSave = () => { if (!editingId && portfolio.length >= _x_lim) { _x_trig(true); return; } const e = { ...form, name: form.name || form.ticker }; if (editingId) setPortfolio(prev => prev.map(p => p.id === editingId ? { ...p, ...e } : p)); else setPortfolio(prev => [...prev, { ...e, id: Date.now(), currentPrice: form.buyPrice, currentFx: form.buyFx, isActive: true, dividends: [] }]); setIsModalOpen(false); }; 
    const handleSellSubmit = () => { const soldR = { ...sellItem, id: Date.now(), shares: sellForm.sharesToSell, isActive: true, sellDate: sellForm.sellDate, sellPrice: sellForm.sellPrice, sellFx: sellForm.sellFx, sellFees: sellForm.sellFees, sellAdjustments: sellForm.sellAdjustments, sellFeesIncludedInPrice: sellForm.sellFeesIncludedInPrice, dividends: [...(sellItem.dividends || [])] }; const updatedP = portfolio.map(p => p.id === sellItem.id ? { ...p, isActive: false, dividends: [] } : p); setPortfolio([...updatedP, soldR]); setIsSellModalOpen(false); };
    const handleClone = (p) => { if (portfolio.length >= _x_lim) { _x_trig(true); return; } const clone = { ...p, id: Date.now(), isActive: false, dividends: [] }; setPortfolio(prev => [...prev, clone]); setInfoModal({ isOpen: true, title: 'Éxito', msg: `Copia creada.`, type: 'info' }); };
    const resetFilters = () => { setFilterText(''); setFilterDateStart(''); setFilterDateEnd(''); setFilterType('active'); setSortConfig({ key: 'date', direction: 'desc' }); };
  
    // --- NUEVA FUNCIÓN IMPRESIÓN IA ACTUALIZADA (CORRECCIÓN COLORES OSCUROS) ---
    const handlePrintAI = () => { 
        const printWindow = window.open('', '', 'height=800,width=800'); 
        const time = new Date().toLocaleString(); 
        let html = `<html><head><title>INFORME ESTADO CARTERA</title><style>
        /* FORZAR NEGRO EN TODO EL CUERPO */
        body { font-family: sans-serif; padding: 30px; font-size: 12px; line-height: 1.5; color: #000000 !important; -webkit-print-color-adjust: exact; } 
        
        h1 { border-bottom: 3px solid #000; padding-bottom: 10px; margin-bottom: 20px; text-transform: uppercase; color: #000 !important; } 
        
        /* Azul oscuro para títulos, legible en papel */
        h3 { color: #1e3a8a !important; border-bottom: 1px solid #666 !important; padding-bottom: 5px; margin-top: 25px; text-transform: uppercase; font-size: 14px; } 
        
        table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 12px; } 
        
        /* Bordes grises oscuros y texto negro en tablas */
        th, td { border: 1px solid #666; padding: 8px; text-align: left; color: #000 !important; } 
        th { background-color: #e5e7eb !important; font-weight: bold; } 
        
        
        /* CORRECCIÓN CAJAS DE MÉTRICAS O VEREDICTOS */
        div[style*="background"], table[border="1"] {
            background-color: #f3f4f6 !important;
            border: 1px solid #000 !important;
            color: #000 !important;
        }

        /* REGLA MAESTRA PARA NEGRO ABSOLUTO */
        p, li, span, div, strong, em, b, i, td, th { color: #000 !important; }
        
        
        .meta { font-size: 10px; color: #333 !important; margin-bottom: 30px; }
        </style></head><body>`; 
        
        html += `<h1>INFORME ESTADO CARTERA</h1>`;
        html += `<div class="meta"><strong>EMISIÓN:</strong> ${time}<br/><strong>AUDITORIA:</strong> iA Hedge Fund Manager (Wall Street Mode)</div>`; 
        html += `<div style="font-size:12px;">${analysisResult}</div></body></html>`; 
        
        printWindow.document.write(html); 
        printWindow.document.close(); 
        printWindow.focus(); 
        setTimeout(()=>printWindow.print(), 500); 
    };
   
    // HANDLE PRINT MEJORADO
const handlePrint = () => { 
        const printWindow = window.open('', '', 'height=800,width=1200'); 
        const typeMap = { 'active': 'CARTERA ACTIVA', 'sold': 'HISTÓRICO VENTAS', 'all': 'INFORME GLOBAL' }; 
        const emissionTime = new Date().toLocaleString(); 
        const filterDetails = [];
        if(filterText) filterDetails.push(`Texto: "${filterText}"`);
        if(filterDateStart) filterDetails.push(`Desde: ${formatDateES(filterDateStart)}`);
        if(filterDateEnd) filterDetails.push(`Hasta: ${formatDateES(filterDateEnd)}`);
        const fullFilterLabel = `${typeMap[filterType]} ${filterDetails.length > 0 ? `[${filterDetails.join(' | ')}]` : ''}`;
        const genStatsBlock = (t, d, c) => { const yieldPct = d.inv > 0 ? (d.divN / d.inv) * 100 : 0; return ` <div style="border:1px solid #ccc; padding:5px; width:32%; border-top: 3px solid ${c}; background:#f9f9f9; font-size: 8px;"> <div style="font-weight:bold; color:#555; text-transform:uppercase; margin-bottom:2px;">${t} (${formatN(d.num, 0)} Val)</div> <table style="width:100%; border:none; margin:0;"> <tr><td>Invertido:</td><td style="text-align:right;"><b>${formatMoney(d.inv, baseCurrency)}</b></td></tr> <tr><td>Valor Act:</td><td style="text-align:right;"><b style="color:${c}">${formatMoney(d.cur, baseCurrency)}</b></td></tr> <tr><td colspan="2" style="text-align:center; padding-top:5px; border-top:1px solid #ddd;"><b>BALANCE: ${formatMoney(d.plPrice, baseCurrency)}</b></td></tr> <tr><td style="color:#666;">Rent. Simple/Anual:</td><td style="text-align:right;">${formatN(d.plP_S)}% / ${formatN(d.plP_A)}%</td></tr> <tr><td>Dividendos:</td><td style="text-align:right; color:#2563eb;">${formatMoney(d.divN, baseCurrency)} [${formatN(yieldPct)}%]</td></tr> <tr><td>FX Total:</td><td style="text-align:right;">${formatMoney(d.fX, baseCurrency)}</td></tr> <tr><td><b>Rdto Total:</b></td><td style="text-align:right;"><b>${formatMoney(d.plTotal, baseCurrency)} [${formatN(d.plT_S)}%]</b></td></tr> </table> </div>`; }; 
        const h = historicalStats; 
        const roiCons = h.consolidated.avgCap > 0 ? (h.consolidated.profit / h.consolidated.avgCap) * 100 : 0; 
        const roiClosed = h.closed.avgCap > 0 ? (h.closed.profit / h.closed.avgCap) * 100 : 0; 
        const historyCardHTML = ` <div style="width: 250px; border: 2px solid #eab308; padding: 8px; background: #fffbeb; font-family:sans-serif;"> <div style="font-size:9px; font-weight:bold; color:#ca8a04; border-bottom:1px solid #eab308; padding-bottom:2px; margin-bottom:5px;">RENTABILIDAD HISTÓRICA (REAL)</div> <table style="width:100%; font-size:8px;"> <tr><td colspan="2" style="font-weight:bold; background:#eab30833;">CONSOLIDADA</td></tr> <tr><td>ROI:</td><td style="text-align:right; font-weight:bold;">${formatN(roiCons)}%</td></tr> <tr><td>Cap. Med:</td><td style="text-align:right;">${formatMoney(h.consolidated.avgCap, baseCurrency)}</td></tr> <tr><td>Beneficio:</td><td style="text-align:right;">${formatMoney(h.consolidated.profit, baseCurrency)}</td></tr> <tr><td colspan="2" style="font-weight:bold; background:#eab30833; padding-top:4px;">CERRADAS</td></tr> <tr><td>ROI:</td><td style="text-align:right; font-weight:bold;">${formatN(roiClosed)}%</td></tr> <tr><td>Cap. Med:</td><td style="text-align:right;">${formatMoney(h.closed.avgCap, baseCurrency)}</td></tr> </table> <div style="font-size:7px; color:#666; margin-top:5px; border-top:1px solid #ccc; padding-top:2px;">Intervalo Op: ${formatN(h.avgIntervalDays, 1)}d | Pos. Media: ${formatN(h.avgPositions, 1)}</div> </div> `; 
        let html = `<html><head><title>Informe Cartera</title>`; html += `<style>@page{size:landscape;margin:10mm;} body{font-family:sans-serif;font-size:7px;} h1{font-size:14px;margin-bottom:2px;} table{width:100%;border-collapse:collapse;margin-top:10px;} th{background:#f1f5f9;text-align:left;padding:3px;border-bottom:1px solid #94a3b8;font-size:6px;text-transform:uppercase;} td{padding:3px;border-bottom:1px solid #e2e8f0;vertical-align:top;font-size:7px;} .num{text-align:right;font-family:monospace;white-space:nowrap;} .center{text-align:center;} .profit{color:#16a34a;font-weight:bold;} .loss{color:#dc2626;font-weight:bold;} .blue{color:#3b82f6;} .orange{color:#f97316;} .total-row td { background: #1e293b; color: white; font-weight: bold; border-top: 2px solid #475569; }</style></head><body>`; html += `<div style="display:flex;justify-content:space-between;border-bottom:2px solid #ccc;padding-bottom:5px;"><div><h1>INFORME DE CARTERA - BoardingGate</h1><div style="font-size:8px;color:#666;">(FILTRO: ${fullFilterLabel})</div></div><div style="font-size:8px;font-weight:bold;">EMISIÓN: ${emissionTime}</div></div>`; html += `<div style="display:flex; gap:5px; margin-top:5px;">`; 
        if (filterType === 'all') { html += genStatsBlock("Cartera Activa", stats.active, "#3b82f6") + genStatsBlock("Posiciones Cerradas", stats.sold, "#f97316") + genStatsBlock("Cartera Global", stats.total, "#a855f7"); } else if (filterType === 'active') { html += genStatsBlock("Cartera Activa (Filtrada)", stats.active, "#3b82f6"); } else { html += genStatsBlock("Ventas (Filtradas)", stats.sold, "#f97316"); } 
        html += `</div>`; html += `<table><thead><tr><th>Valor</th><th class="center">Fechas / Días</th><th class="num">Títulos</th><th class="num">Precios (I/A)</th><th class="center">FX</th><th class="center">Gtos/Adj</th><th class="num">Coste Total</th><th class="num">Valor Final</th><th class="num">Rendimiento (Pre)</th><th class="num">Dividendos</th><th class="num">Resultado Total</th><th class="num">% Total</th><th class="num">% Anual</th></tr></thead><tbody>`; 
        let tDivs = 0;
        visiblePortfolio.forEach(p => { 
            const cost = (p.buyPrice * p.shares * p.buyFx) + (p.feesIncludedInPrice ? 0 : (p.fees || 0)) + (p.adjustments || 0);
            const isS = !!p.sellDate; const curP = isS ? p.sellPrice : (p.isIndex ? p.currentPrice / p.indexDivisor : p.currentPrice); const curF = isS ? p.sellFx : (p.isIndex ? p.buyFx : p.currentFx); 
            const vF = (curP * p.shares * curF) - (isS ? (p.sellFeesIncludedInPrice ? 0 : (p.sellFees || 0)) + (p.sellAdjustments || 0) : 0);
            const ds = (p.dividends || []).reduce((a,b)=>a+b.net,0); 
            const plPrice = vF - cost;
            const plTotal = plPrice + ds; 
            const days = calculateDays(p.buyDate, p.sellDate || new Date()); 
            const rs = calcReturns(cost, vF + ds, days); 
            tDivs += ds;
            html += `<tr><td><b class="${plPrice>=0?'profit':'loss'}">${p.name}</b><br/>${p.ticker}${p.group ? `<br/>[${p.group}]` : ''}</td><td class="center"><span class="blue">${formatDateES(p.buyDate)}</span>${p.sellDate ? `<br/><span class="orange">${formatDateES(p.sellDate)}</span>` : ''}<br/><b>${formatN(days, 0)}d</b></td><td class="num"><b>${formatN(p.shares)}</b></td><td class="num"><b>I:${formatN(p.buyPrice)}</b><br/><b>${isS?'V':'A'}:${formatN(curP)}</b></td><td class="center">${formatN(p.buyFx,4)}<br/>${formatN(curF,4)}</td><td class="center">${formatN(isS?p.sellFees:p.fees)}<br/>${formatN(isS?p.sellAdjustments:p.adjustments)}</td><td class="num"><b>${formatMoney(cost, baseCurrency)}</b></td><td class="num"><b>${formatMoney(vF, baseCurrency)}</b></td><td class="num"><span class="${plPrice>=0?'profit':'loss'}">${formatMoney(plPrice, baseCurrency)}</span></td><td class="num"><span class="blue">${formatMoney(ds, baseCurrency)}</span></td><td class="num"><span class="${plTotal>=0?'profit':'loss'}">${formatMoney(plTotal, baseCurrency)}</span></td><td class="num"><span class="${plTotal>=0?'profit':'loss'}">${formatN(rs.simple)}%</span></td><td class="num">${formatN(rs.annual)}%</td></tr>`; 
        }); 
        html += `<tr class="total-row"><td colspan="6" style="text-align:right; text-transform:uppercase;">TOTALES ACUMULADOS: <b>FX: ${formatMoney(gridTotals.tFx, baseCurrency)}</b></td><td class="num">${formatMoney(gridTotals.tCost, baseCurrency)}</td><td class="num">${formatMoney(gridTotals.tVal, baseCurrency)}</td><td class="num"><span class="${(gridTotals.tVal - gridTotals.tCost)>=0?'profit':'loss'}">${formatMoney(gridTotals.tVal - gridTotals.tCost, baseCurrency)}</span></td><td class="num"><span class="blue">${formatMoney(tDivs, baseCurrency)}</span></td><td class="num"><span class="${gridTotals.tRes>=0?'profit':'loss'}">${formatMoney(gridTotals.tRes, baseCurrency)}</span></td><td class="num"><span class="${gridTotals.tRes>=0?'profit':'loss'}">${formatN(gridTotals.tPct)}%</span></td><td class="center" style="font-size:6px; font-family:monospace;">I: ${formatN(gridTotals.avgBuyPE, 1)}<br/>A: ${formatN(gridTotals.avgCurPE, 1)}</td><td></td></tr>`;
        html += `</tbody></table>`; html += `<div style="display:flex; justify-content:flex-end; margin-top:20px;">${historyCardHTML}</div>`; html += `</body></html>`; 
        printWindow.document.write(html); printWindow.document.close(); printWindow.focus(); setTimeout(() => printWindow.print(), 500); 
    };




    const toggleAllActive = () => { const allActive = filteredPortfolio.every(p => p.isActive !== false); setPortfolio(prev => prev.map(p => { const isVisible = filteredPortfolio.some(fp => fp.id === p.id); return isVisible ? { ...p, isActive: !allActive } : p; })); };
    const yieldOnCost = form.buyPrice > 0 ? (form.annualDividend / form.buyPrice) * 100 : 0;

    const RenderHistoryCard = () => {
        const h = historicalStats;
        const roiCons = h.consolidated.avgCap > 0 ? (h.consolidated.profit / h.consolidated.avgCap) * 100 : 0;
        const roiClosed = h.closed.avgCap > 0 ? (h.closed.profit / h.closed.avgCap) * 100 : 0;
        return ( <div className="glass-panel p-4 rounded-xl border-t-4 border-yellow-500 min-w-[320px] max-w-[400px]"> <div className="flex justify-between items-center mb-2"> <span className="text-[10px] font-black uppercase text-yellow-500 flex items-center gap-2"><Icons.Award size={12}/> RENTABILIDAD HISTÓRICA CARTERA</span> <span className="text-[8px] bg-slate-800 px-1.5 py-0.5 rounded text-slate-400 font-bold">REAL (TIME-WEIGHTED)</span> </div> <div className="grid grid-cols-2 gap-4 mb-3 border-b border-slate-700/50 pb-2"> <div className="bg-slate-900/40 p-2 rounded-lg"> <div className="text-[8px] text-slate-400 uppercase font-bold mb-1">Consolidada (Act+Cerr)</div> <div className={`text-lg font-black ${roiCons>=0?'text-green-400':'text-red-400'}`}>{formatN(roiCons)}%</div> <div className="flex justify-between items-end mt-1"> <div className="text-[8px] text-slate-500">Cap. Medio: <span className="text-slate-300">{formatMoney(h.consolidated.avgCap, baseCurrency)}</span></div> <div className="text-[8px] font-bold text-yellow-500">[{formatMoney(h.consolidated.profit, baseCurrency)}]</div> </div> </div> <div className="bg-slate-900/40 p-2 rounded-lg"> <div className="text-[8px] text-slate-400 uppercase font-bold mb-1">Solo Cerradas</div> <div className={`text-lg font-black ${roiClosed>=0?'text-green-400':'text-red-400'}`}>{formatN(roiClosed)}%</div> <div className="flex justify-between items-end mt-1"> <div className="text-[8px] text-slate-500">Cap. Medio: <span className="text-slate-300">{formatMoney(h.closed.avgCap, baseCurrency)}</span></div> <div className="text-[8px] font-bold text-yellow-500">[{formatMoney(h.closed.profit, baseCurrency)}]</div> </div> </div> </div> <div className="grid grid-cols-2 gap-2 text-[9px] text-slate-400"> <div> <div className="uppercase font-bold text-slate-500 mb-0.5">Fechas Activa</div> <div>{h.active.first ? formatDateES(h.active.first) : '--'} / {h.active.last ? formatDateES(h.active.last) : '--'}</div> <div className="text-blue-400 font-bold">{formatN(h.active.diffDays, 0)} días <span className="text-slate-500 font-normal">[{formatN(h.active.diffDays/365.25, 1)} años]</span></div> </div> <div className="text-right"> <div className="uppercase font-bold text-slate-500 mb-0.5">Fechas Cerrada</div> <div>{h.closed.first ? formatDateES(h.closed.first) : '--'} / {h.closed.last ? formatDateES(h.closed.last) : '--'}</div> <div className="text-orange-400 font-bold">{formatN(h.closed.diffDays, 0)} días <span className="text-slate-500 font-normal">[{formatN(h.closed.diffDays/365.25, 1)} años]</span></div> </div> </div> <div className="mt-2 pt-2 border-t border-slate-800/50 flex justify-between items-center text-[9px]"> <div className="text-slate-500">Intervalo Operaciones: <span className="text-slate-300 font-bold">{formatN(h.avgIntervalDays, 1)} días</span></div> <div className="text-slate-500">Pos. Medias: <span className="text-slate-300 font-bold">{formatN(h.avgPositions, 1)}</span></div> </div> </div> );
    };

    return (
        <div className="w-full p-4 md:p-6 flex flex-col gap-6">
            {analyzing && <div className="absolute inset-0 z-50 bg-black/80 backdrop-blur-sm flex flex-col items-center justify-center fade-in"><Icons.Wand size={60} className="text-purple-500 mb-4 animate-spin" /><div className="text-xl font-bold text-white animate-pulse">Analizando Cartera Global...</div></div>}
            {noteToast && ( <div className="fixed top-20 right-10 z-[100] bg-yellow-900/90 border-l-4 border-yellow-500 p-4 rounded shadow-2xl max-w-sm fade-in backdrop-blur-sm"> <div className="flex justify-between items-start mb-1"> <h4 className="text-yellow-400 font-bold text-xs uppercase flex items-center gap-2"><Icons.MessageCircle size={14}/> Observaciones</h4> <button onClick={()=>setNoteToast(null)} className="text-yellow-200 hover:text-white"><Icons.X size={14}/></button> </div> <p className="text-sm text-yellow-100 italic leading-relaxed">{noteToast}</p> </div> )}
            
            <div className="flex gap-4 overflow-x-auto pb-2 custom-scrollbar shrink-0">
                <StatsBlock title="ACTIVOS FILTRADOS" data={stats.active} color="#22c55e" baseCurrency={baseCurrency} type="active" />
                <StatsBlock title="VENTAS FILTRADAS" data={stats.sold} color="#f97316" baseCurrency={baseCurrency} type="sold" />
                <StatsBlock title="TOTAL FILTRADO" data={stats.total} color="#a855f7" baseCurrency={baseCurrency} type="total" />
                <RenderHistoryCard />
            </div>
            
            <div className="flex flex-col gap-3 shrink-0 bg-slate-900/50 p-3 rounded-xl border border-slate-800">
                <div className="flex justify-between items-center"><div className="flex gap-2 items-start">
                  <div className="flex flex-col">
                      <button onClick={() => updatePrices(false)} disabled={updating} className="bg-slate-800 px-3 h-9 rounded-lg text-[10px] font-bold border border-slate-700 hover:bg-slate-700 transition-colors flex items-center gap-2">{updating ? <Icons.Loader/> : <Icons.Refresh/>} ACTUALIZAR</button>
                      <span className="text-[9px] text-slate-500 mt-1 uppercase font-bold text-center tracking-wider">Sinc: {lastUpdate ? new Date(lastUpdate).toLocaleTimeString() : '--:--'}</span>
                  </div>
                  <button onClick={onManualSync} className={`px-3 h-9 rounded-lg text-[10px] font-bold border flex items-center gap-2 transition-all ${syncStatus === 'unsaved' ? 'bg-orange-600 border-orange-500 text-white animate-pulse' : syncStatus === 'uploading' || syncStatus === 'downloading' ? 'bg-blue-600 border-blue-500 text-white' : 'bg-slate-800 border-slate-700 text-green-400'}`}>
                      {syncStatus === 'uploading' || syncStatus === 'downloading' ? <Icons.Loader/> : <Icons.Upload size={14} className={syncStatus==='unsaved' ? '' : 'text-green-500'}/>} 
                      {syncStatus === 'unsaved' ? 'GUARDAR' : syncStatus === 'uploading' ? 'SUBIENDO...' : syncStatus === 'downloading' ? 'BAJANDO...' : 'SYNC OK'}
                  </button>
                  <button onClick={analyzePortfolio} className="bg-purple-900/80 px-3 h-9 rounded-lg text-[10px] font-bold border border-purple-500/50 hover:bg-purple-800 transition-colors flex items-center gap-2"><Icons.Wand/> INFORME iA</button>
                  <button onClick={() => setIsNewsSelectionModalOpen(true)} className="bg-blue-700 px-3 h-9 rounded-lg text-[10px] font-bold border border-blue-500/50 hover:bg-blue-600 transition-colors flex items-center gap-2">
                        <Icons.Globe size={14}/> NOTICIAS
                  </button>  

                  <button onClick={handlePrint} className="bg-slate-700 px-3 h-9 rounded-lg text-[10px] font-bold border border-slate-600 hover:bg-slate-600 transition-colors flex items-center gap-2 text-white"><Icons.ExternalLink size={14} className="rotate-0"/> IMPRIMIR</button></div><button onClick={() => { setEditingId(null); setForm({ ticker:'', name:'', group: '', notes: '', customOrder:'', isIndex:false, indexDivisor:1, shares:0, buyPrice:0, buyDate:new Date().toISOString().slice(0,10), stockCurrency:'USD', buyFx:1, fees:0, adjustments:0, feesIncludedInPrice: false, buyPE:0, annualDividend:0, sellPrice:0, sellDate:'', sellFx:1, sellFees:0, sellAdjustments:0, sellFeesIncludedInPrice: false, currentPE:0, dividends: [] }); setIsModalOpen(true); }} className="bg-blue-600 px-4 h-9 rounded-lg text-[10px] font-bold flex items-center gap-2 shadow-lg hover:bg-blue-500"><Icons.Plus size={14}/> NUEVA POSICIÓN</button></div>
                
                <div className="flex flex-wrap gap-2 items-center bg-slate-950/50 p-2 rounded-lg border border-slate-800/50">
                    <div className="flex-1 min-w-[150px] relative"><Icons.Search className="absolute left-2 top-2 text-slate-500" size={14}/><input type="text" value={filterText} onChange={e => setFilterText(e.target.value)} placeholder="Filtrar por ticker, nombre o grupo..." className="w-full bg-slate-900 border border-slate-700 h-8 pl-8 pr-2 text-xs rounded focus:border-blue-500 font-bold" /></div>
                    <div className="flex items-center gap-1 bg-slate-900 border border-slate-700 rounded h-8 px-2">
                        <span className="text-[9px] text-slate-500 font-bold uppercase mr-1 tracking-wider">VISTAS:</span>
                        <button onClick={() => toggleView('table')} className={`p-1 rounded hover:bg-slate-700 transition-colors ${visibleSections.table ? 'text-blue-400 bg-slate-800' : 'text-slate-600'}`} title="Listado"><Icons.Briefcase size={14}/></button>
                        <button onClick={() => toggleView('diverging')} className={`p-1 rounded hover:bg-slate-700 transition-colors ${visibleSections.diverging ? 'text-blue-400 bg-slate-800' : 'text-slate-600'}`} title="Gráfico Rendimiento"><Icons.ChartBar size={14}/></button>
                        <button onClick={() => toggleView('stats')} className={`p-1 rounded hover:bg-slate-700 transition-colors ${visibleSections.stats ? 'text-blue-400 bg-slate-800' : 'text-slate-600'}`} title="Estadísticas"><Icons.PieChart size={14}/></button>
                        <button onClick={() => toggleView('charts')} className={`p-1 rounded hover:bg-slate-700 transition-colors ${visibleSections.charts ? 'text-blue-400 bg-slate-800' : 'text-slate-600'}`} title="Gráficas Evolución"><Icons.TrendingUp size={14}/></button>
                    </div>
                    <div className="flex items-center gap-1">
                        <button onClick={() => handleYearJump(-1)} className="h-8 w-8 bg-slate-800 border border-slate-700 rounded text-slate-400 hover:text-white hover:bg-slate-700 font-bold flex items-center justify-center text-lg">-</button>
                        <div className="flex items-center gap-2 bg-slate-900 border border-slate-700 rounded px-2 h-8"><span className="text-[9px] font-bold text-slate-500 uppercase">DESDE</span><input type="date" value={filterDateStart} onChange={e => setFilterDateStart(e.target.value)} className="bg-transparent border-none text-xs text-white p-0 w-[95px] focus:ring-0 font-bold" /></div>
                        <div className="flex items-center gap-2 bg-slate-900 border border-slate-700 rounded px-2 h-8"><span className="text-[9px] font-bold text-slate-500 uppercase">HASTA</span><input type="date" value={filterDateEnd} onChange={e => setFilterDateEnd(e.target.value)} className="bg-transparent border-none text-xs text-white p-0 w-[95px] focus:ring-0 font-bold" /></div>
                        <button onClick={() => handleYearJump(1)} className="h-8 w-8 bg-slate-800 border border-slate-700 rounded text-slate-400 hover:text-white hover:bg-slate-700 font-bold flex items-center justify-center text-lg">+</button>
                    </div>
                    <button onClick={resetFilters} title="Limpiar Filtros" className="h-8 w-8 bg-red-900/30 text-red-400 border border-red-500/30 rounded font-bold hover:bg-red-900/50 flex items-center justify-center transition-colors"><Icons.Trash2 size={16}/></button>
                    <div className="flex bg-slate-900 rounded border border-slate-700 h-8 p-0.5"><button onClick={() => setFilterType('all')} className={`px-3 h-full rounded text-[10px] font-bold transition-all ${filterType === 'all' ? 'bg-slate-600 text-white' : 'text-slate-400 hover:text-white'}`}>TODO</button><button onClick={() => setFilterType('active')} className={`px-3 h-full rounded text-[10px] font-bold transition-all ${filterType === 'active' ? 'bg-blue-600 text-white' : 'text-slate-400 hover:text-white'}`}>ACTIVAS</button><button onClick={() => setFilterType('sold')} className={`px-3 h-full rounded text-[10px] font-bold transition-all ${filterType === 'sold' ? 'bg-orange-600 text-white' : 'text-slate-400 hover:text-white'}`}>VENTAS</button></div>
                    <button onClick={() => setIsNotesModalOpen(true)} className="ml-auto h-8 px-4 bg-slate-800 hover:bg-slate-700 text-yellow-500 border border-slate-700 rounded text-[10px] font-black uppercase flex items-center gap-2 transition-all shadow-lg"><Icons.MessageCircle size={14}/> Block de Notas</button>
                </div>
            </div>
            
            {visibleSections.table && (
                <div className="w-full overflow-x-auto bg-slate-900/50 border border-slate-800 rounded-xl fade-in">
                    <table className="w-full text-left min-w-[1700px] text-sm"><thead className="bg-slate-800 text-slate-400 text-[10px] uppercase font-bold sticky top-0 z-20">
                    <tr>
                    <th className="p-3 w-10 text-center sticky left-0 z-30 bg-slate-900 border-r border-slate-800"><button onClick={toggleAllActive} title="Marcar/Desmarcar Todo"><Icons.CursorClick size={16} className="text-blue-400"/></button></th>
                    <th className={`p-3 cursor-pointer select-none hover:text-white transition-colors group bg-slate-900 border-r border-slate-800 min-w-[180px] sticky left-10 z-30 ${sortConfig.key==='value'?'bg-slate-800 text-white':''}`} onClick={()=>requestSort('value')}><div className="flex items-center gap-1"><Icons.CursorClick size={12} className={`text-blue-400 opacity-40 group-hover:opacity-100 transition-opacity ${sortConfig.key==='value'?'opacity-100':''}`}/> Valor {sortConfig.key==='value' && (sortConfig.direction==='asc'?'▲':'▼')}</div></th>
                    <th className={`p-3 w-14 text-center cursor-pointer select-none hover:text-white border-r border-slate-800 ${sortConfig.key==='customOrder'?'bg-slate-700 text-white':''}`} onClick={()=>requestSort('customOrder')}>Ord {sortConfig.key==='customOrder' && (sortConfig.direction==='asc'?'▲':'▼')}</th>
                    <th className={`p-3 text-center cursor-pointer select-none hover:text-white hover:bg-slate-700 transition-colors group ${sortConfig.key==='date'?'bg-slate-700 text-white':''}`} onClick={()=>requestSort('date')}><div className="flex items-center justify-center gap-1"><Icons.CursorClick size={12} className={`text-blue-400 opacity-40 group-hover:opacity-100 transition-opacity ${sortConfig.key==='date'?'opacity-100':''}`}/> Fechas / Días {sortConfig.key==='date' && (sortConfig.direction==='asc'?'▲':'▼')}</div></th>
                    <th className="p-3 text-right">Títulos</th>
                    <th className="p-3 text-right">Precios (Inv/Act)</th>
                    <th className="p-3 text-center">FX (I/A)</th>
                    <th className="p-3 text-center text-blue-400">FX Desv.</th>
                    <th className="p-3 text-center">Gastos / Adj</th>
                    <th className="p-3 text-right">Coste Total</th>
                    <th className="p-3 text-right text-white font-bold bg-[#161b25] border-l border-slate-700">Valor Final</th>
                    <th className={`p-3 text-right cursor-pointer select-none hover:text-white bg-[#161b25] border-r border-slate-700 transition-colors group ${sortConfig.key==='yield'?'bg-slate-700 text-white':''}`} onClick={()=>requestSort('yield')}><div className="flex items-center justify-end gap-1"><Icons.CursorClick size={12} className={`text-blue-400 opacity-40 group-hover:opacity-100 transition-opacity ${sortConfig.key==='yield'?'opacity-100':''}`}/> RENDIMIENTO {sortConfig.key==='yield' && (sortConfig.direction==='asc'?'▲':'▼')}</div></th>
                    <th className={`p-3 text-right cursor-pointer select-none hover:text-white hover:bg-slate-700 transition-colors group ${sortConfig.key==='percent'?'bg-slate-700 text-white':''}`} onClick={()=>requestSort('percent')}><div className="flex items-center justify-end gap-1"><Icons.CursorClick size={12} className={`text-blue-400 opacity-40 group-hover:opacity-100 transition-opacity ${sortConfig.key==='percent'?'opacity-100':''}`}/> % Ben/Pérd {sortConfig.key==='percent' && (sortConfig.direction==='asc'?'▲':'▼')}</div></th>
                    <th className="p-3 text-center">PER (I/A)</th>
                    <th className="p-3 text-center">Acciones</th>
                    </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-800">
                    {filteredPortfolio.length === 0 ? ( <tr><td colSpan="15" className="p-10 text-center text-slate-500 italic">No hay registros que coincidan con los filtros aplicados.</td></tr> ) : ( filteredPortfolio.map(p => { 
                    const isS = !!p.sellDate;
                    const curP = isS ? p.sellPrice : (p.isIndex ? p.currentPrice / (p.indexDivisor || 1) : p.currentPrice);
                    const curF = isS ? p.sellFx : (p.isIndex ? p.buyFx : p.currentFx);
                    const cost = (p.buyPrice * p.shares * p.buyFx) + (p.feesIncludedInPrice ? 0 : (p.fees || 0)) + (p.adjustments || 0);
                    const vF = (curP * p.shares * curF) - (isS ? (p.sellFeesIncludedInPrice ? 0 : (p.sellFees || 0)) + (p.sellAdjustments || 0) : 0);
                    const ds = (p.dividends || []).reduce((a,b)=>a+b.net,0); 
                    const capitalGain = vF - cost; 
                    const days = calculateDays(p.buyDate, p.sellDate || new Date()); 
                    const rs = calcReturns(cost, vF + ds, days); 

                    return ( 
                        <tr key={p.id} className={`table-row-hover ${p.isActive===false ? 'opacity-40 grayscale' : ''}`} onClick={() => p.notes && setNoteToast(p.notes)}>
                            <td className="p-3 text-center sticky left-0 z-20 bg-slate-900 border-r border-slate-800" onClick={(e) => { e.stopPropagation(); setPortfolio(prev => prev.map(x => x.id === p.id ? {...x, isActive: !x.isActive} : x)); }}><input type="checkbox" checked={p.isActive!==false} readOnly className="custom-checkbox" /></td>
                            <td className="p-3 sticky left-10 z-20 bg-slate-900 border-r border-slate-800 min-w-[180px]">
                                <div className="w-[160px] whitespace-normal break-words leading-tight">
                                    <b className={`text-sm ${capitalGain >= 0 ? 'text-green-400' : 'text-red-400'}`}>{p.name}</b>
                                    {isS && <span className="ml-2 px-1.5 py-0.5 bg-red-900/40 text-red-400 text-[8px] rounded uppercase font-bold border border-red-500/20">VENDIDA</span>}<br/>
                                    <span className="text-[10px] text-slate-400 uppercase">{p.ticker}</span>
                                    {p.group && <span className="text-[10px] text-purple-300 font-bold bg-purple-900/30 px-1 rounded ml-1 inline-block mt-1">Grp: {p.group}</span>}
                                </div>
                            </td>
                            <td className="p-3 text-center border-r border-slate-800 font-mono text-slate-400 text-[10px]">{p.customOrder}</td>
                            <td className="p-3 text-center text-[10px] font-bold"><div className="text-blue-400">{formatDateES(p.buyDate)}</div>{p.sellDate && <div className="text-orange-400">{formatDateES(p.sellDate)}</div>}<div className="text-slate-500 text-[9px] mt-1">{formatN(days, 0)} días</div></td>
                            <td className="p-3 text-right font-mono font-bold text-white">{formatN(p.shares)}</td>
                            <td className="p-3 text-right text-xs font-mono">I: {formatN(p.buyPrice)}<br/><span className="text-blue-400 font-bold">{isS?'V:':'A:'} {formatN(curP, 3)}</span></td>
                            <td className="p-3 text-center text-[10px] font-mono text-slate-400">I: {formatN(p.buyFx, 4)}<br/>A: {formatN(curF, 4)}</td>
                            <td className="p-3 text-center text-[9px] font-mono">
                                {(() => { const fxDevVal = (p.isIndex ? 0 : (p.shares * (isS ? p.sellPrice : p.currentPrice) * (curF - p.buyFx))); return <div className={fxDevVal >= 0 ? 'text-green-500' : 'text-red-500'}>{formatMoney(fxDevVal, baseCurrency)}</div>; })()}
                            </td>
                            <td className="p-3 text-center text-[10px] font-mono text-slate-400">G: {formatN(isS?p.sellFees:p.fees)}<br/>A: {formatN(isS?p.sellAdjustments:p.adjustments)}</td>
                            <td className="p-3 text-right text-slate-400 font-mono">{formatMoney(cost, baseCurrency)}</td>
                            <td className="p-3 text-right font-mono text-white bg-[#161b25] border-l border-slate-800"><div className="font-bold">{formatMoney(vF, baseCurrency)}</div></td>
                            <td className="p-3 text-right font-mono bg-[#161b25] border-r border-slate-800"><div className={`font-bold ${capitalGain >= 0 ? 'text-green-400' : 'text-red-400'}`}>{formatMoney(capitalGain, baseCurrency)}</div>{ds > 0 && <div className="text-[10px] text-blue-300 font-bold mt-0.5">+ {formatMoney(ds, baseCurrency)} (Div)</div>}</td>
                            <td className="p-3 text-right text-xs"><div className={rs.simple>=0?'text-green-400 font-bold':'text-red-400 font-bold'}>{formatN(rs.simple)}%</div><div className="text-[9px] text-slate-500">Anual: {formatN(rs.annual)}%</div></td>
                            <td className="p-3 text-center text-xs font-mono">I: {formatN(p.buyPE, 1)}<br/>A: <span className="text-yellow-500 font-bold">{formatN(p.currentPE, 1)}</span></td>
                            <td className="p-3 text-center flex gap-2 justify-center" onClick={e=>e.stopPropagation()}>
                                {/* BOTÓN IA NUEVO */}
                                <button onClick={() => onAnalyze && onAnalyze(p.ticker)} className="text-purple-400 p-1.5 bg-slate-800 rounded hover:text-white transition-colors" title="Analizar con IA"><Icons.Wand size={14}/></button>
                                {!p.sellDate && <button onClick={() => { setSellItem(p); setSellForm({sharesToSell: p.shares, sellPrice: parseFloat(curP.toFixed(3)), sellDate: new Date().toISOString().slice(0,10), sellFx: p.currentFx, sellFees: 0, sellAdjustments: 0, sellFeesIncludedInPrice: false}); setIsSellModalOpen(true); }} className="bg-green-600/20 text-green-400 border border-green-500/30 px-2 py-1 rounded text-[10px] font-bold hover:bg-green-600/40">VENDER</button>}<button onClick={() => { setForm(p); setEditingId(p.id); setIsModalOpen(true); }} className="text-blue-400 p-1.5 bg-slate-800 rounded hover:text-white transition-colors"><Icons.Edit size={14}/></button><button onClick={() => handleClone(p)} className="text-purple-400 p-1.5 bg-slate-800 rounded hover:text-white transition-colors" title="Clonar Posición"><Icons.Copy size={14}/></button><button onClick={() => setConfirmModal({isOpen:true, title:'Borrado', msg:`¿Eliminar permanentemente?`, onConfirm:()=>{setPortfolio(prev=>prev.filter(x=>x.id!==p.id)); setConfirmModal({isOpen:false})} })} className="text-red-400 p-1.5 bg-slate-800 rounded hover:text-white transition-colors"><Icons.Trash2 size={14}/></button>
                            </td>
                        </tr> 
                    ); 
                    }) )}
                    {filteredPortfolio.length > 0 && (
                    <tr className="bg-slate-900 border-t-2 border-slate-600 font-bold text-white text-[9px] sticky bottom-0 z-30 shadow-2xl">
                        <td className="p-2 sticky left-0 z-40 bg-slate-900 border-r border-slate-800"></td>
                        <td className="p-2 sticky left-10 z-40 bg-slate-900 border-r border-slate-800 text-right uppercase tracking-wider text-slate-400">TOTALES:</td>
                        <td colSpan="5"></td>
                        <td className="p-2 text-center text-slate-300 font-mono">{formatMoney(gridTotals.tFx, baseCurrency)}</td>
                        <td></td>
                        <td className="p-2 text-right font-mono text-slate-300">{formatMoney(gridTotals.tCost, baseCurrency)}</td>
                        <td className="p-2 text-right font-mono bg-[#0f121a] border-l border-slate-800 text-white">{formatMoney(gridTotals.tVal, baseCurrency)}</td>
                        <td className="p-2 text-right font-mono bg-[#0f121a] border-r border-slate-800"><span className={gridTotals.tRes >= 0 ? 'text-green-400' : 'text-red-400'}>{formatMoney(gridTotals.tRes, baseCurrency)}</span></td>
                        <td className="p-2 text-right font-mono"><span className={gridTotals.tPct >= 0 ? 'text-green-400' : 'text-red-400'}>{formatN(gridTotals.tPct)}%</span></td>
                        <td className="p-2 text-center font-mono text-[8px]">
                            <div className="text-slate-400">I: {formatN(gridTotals.avgBuyPE, 1)}</div>
                            <div className="text-yellow-500">A: {formatN(gridTotals.avgCurPE, 1)}</div>
                        </td>
                        <td className="p-2"></td>
                    </tr>
                    )}
                    </tbody>
                    </table>
                </div>
            )}
            {visibleSections.diverging && (<div className="fade-in"><DivergingBarChart data={divergingData} baseCurrency={baseCurrency} /></div>)}
            {visibleSections.stats && (<div className="fade-in"><StatsDashboard portfolio={portfolio} baseCurrency={baseCurrency} taxTotal={taxSum} /></div>)}
            {visibleSections.charts && (<div className="fade-in"><CarouselCharts chartsData={chartsData} /></div>)}
            <Modal isOpen={isModalOpen} title={editingId ? `Ficha de Inversión: ${form.ticker}` : "Apertura de Posición"} onClose={()=>setIsModalOpen(false)}>
                {/* ... (Contenido del Modal de Edición, igual que el original, lo omito por brevedad pero debe ir aquí) ... */}
                <div className="space-y-6"><div className="bg-slate-800/40 border border-slate-700 p-5 rounded-2xl space-y-4"><h4 className="text-[10px] uppercase font-bold text-blue-400 tracking-widest border-b border-slate-700 pb-2">1. Detalles de Entrada (Compra)</h4><div className="grid grid-cols-2 gap-4"><div><label className="text-[10px] uppercase font-bold text-slate-500 mb-1 block">Ticker</label><div className="flex gap-2"><input type="text" value={form.ticker} onChange={e=>setForm({...form, ticker: e.target.value.toUpperCase()})} className="w-full font-bold text-sm bg-slate-900 border-slate-700 text-right uppercase" /><button onClick={fetchTickerData} disabled={fetchingSingle} className="bg-blue-600 text-[10px] px-3 rounded font-black hover:bg-blue-500 transition-colors whitespace-nowrap"><Icons.Search size={14}/></button></div></div><div><label className="text-[10px] uppercase font-bold text-slate-500 mb-1 block">Divisa</label><select value={form.stockCurrency || 'USD'} onChange={e => { const newCurr = e.target.value; const isBase = newCurr === baseCurrency; setForm({...form, stockCurrency: newCurr, buyFx: isBase ? 1 : form.buyFx, currentFx: isBase ? 1 : form.currentFx }); }} className="w-full bg-slate-900 border border-slate-700 text-xs font-bold text-white h-[38px]">{CURRENCIES.map(c => <option key={c.code} value={c.code}>{c.code}</option>)}</select></div></div><div className="grid grid-cols-2 gap-4"><div><label className="text-[10px] uppercase font-bold text-slate-500 mb-1 block">Empresa</label><input type="text" value={form.name} onChange={e=>setForm({...form, name: e.target.value})} className="w-full text-slate-300 font-bold text-sm bg-slate-900 border-slate-700 text-right" /></div><div><label className="text-[10px] uppercase font-bold text-slate-500 mb-1 block">Fecha Compra</label><input type="date" value={form.buyDate} onChange={e=>setForm({...form, buyDate: e.target.value})} className="w-full text-sm font-bold bg-slate-900 border-slate-700 text-right" /></div></div><div className="flex items-center gap-2 bg-slate-900/50 p-2 rounded border border-slate-700 justify-end"><input type="checkbox" id="mIdx" checked={form.isIndex} onChange={e=>setForm({...form, isIndex:e.target.checked})} className="custom-checkbox" /><label htmlFor="mIdx" className="text-[10px] uppercase font-bold text-slate-400">Es Índice / Fondo</label>{form.isIndex && <input type="number" step="0.01" value={form.indexDivisor} onChange={e=>setForm({...form, indexDivisor:parseFloat(e.target.value)})} className="w-16 h-6 py-0 px-1 ml-auto text-xs font-mono text-right" placeholder="Divisor" />}</div><div className="grid grid-cols-3 gap-3"><div><label className="text-[10px] uppercase font-bold text-slate-500 mb-1 block">Títulos</label><input type="number" value={form.shares} onChange={e=>setForm({...form, shares: parseFloat(e.target.value)})} className="w-full font-mono font-bold text-white text-sm bg-slate-900 border-slate-700 text-right" /></div><div><label className="text-[10px] uppercase font-bold text-slate-500 mb-1 block">Precio Uni.</label><input type="number" step="0.01" value={form.buyPrice} onChange={e=>setForm({...form, buyPrice: parseFloat(e.target.value)})} className="w-full font-mono font-bold text-white text-sm bg-slate-900 border-slate-700 text-right" /></div><div><label className="text-[10px] uppercase font-bold text-slate-500 mb-1 block">PER Entrada</label><input type="number" step="0.1" value={form.buyPE} onChange={e=>setForm({...form, buyPE: parseFloat(e.target.value)})} className="w-full font-mono font-bold text-yellow-500 text-sm bg-slate-900 border-slate-700 text-right" /></div></div><div className="grid grid-cols-3 gap-3"><div><label className="text-[10px] uppercase font-bold text-slate-500 mb-1 block">FX Compra</label><input type="number" step="0.0001" value={form.buyFx} onChange={e=>setForm({...form, buyFx: parseFloat(e.target.value)})} disabled={form.stockCurrency === baseCurrency} className={`w-full font-mono text-sm font-bold bg-slate-900 border-slate-700 text-right ${form.stockCurrency === baseCurrency ? 'opacity-50' : ''}`} /></div><div><label className="text-[10px] uppercase font-bold text-slate-500 mb-1 block">Gastos/Fee</label><input type="number" step="0.01" value={form.fees} onChange={e=>setForm({...form, fees: parseFloat(e.target.value)})} className="w-full font-mono text-sm font-bold bg-slate-900 border-slate-700 text-right" /></div><div><label className="text-[10px] uppercase font-bold text-slate-500 mb-1 block">Ajustes</label><input type="number" step="0.01" value={form.adjustments} onChange={e=>setForm({...form, adjustments: parseFloat(e.target.value)})} className="w-full font-mono text-sm font-bold bg-slate-900 border-slate-700 text-right" /></div></div><div className="flex items-center justify-end gap-2 bg-slate-900/30 p-2 rounded-lg border border-slate-700/50"><input type="checkbox" id="feesIncBuy" checked={form.feesIncludedInPrice} onChange={e=>setForm({...form, feesIncludedInPrice: e.target.checked})} className="custom-checkbox" /><label htmlFor="feesIncBuy" className="text-[10px] font-bold text-slate-400 uppercase">Gastos Broker incluidos en el precio</label></div><div className="bg-blue-600/10 border border-blue-500/50 p-4 rounded-xl flex justify-between items-center shadow-lg"><div className="text-[10px] uppercase font-bold text-blue-400 italic font-mono">({formatN(form.shares)} x {formatN(form.buyPrice)} x {formatN(form.buyFx, 4)}) + {formatN((form.feesIncludedInPrice ? 0 : (form.fees||0)) + (form.adjustments||0))}</div><div className="text-right"><div className="text-[8px] text-blue-400 font-black uppercase mb-1">Costo Adquisición</div><div className="text-lg font-black text-white leading-none font-mono">{formatMoney((form.shares * form.buyPrice * form.buyFx) + (form.feesIncludedInPrice ? 0 : (form.fees||0)) + (form.adjustments||0), baseCurrency)}</div></div></div></div>{editingId && portfolio.find(x=>x.id===editingId)?.sellDate ? (<div className="bg-orange-900/10 border border-orange-500/30 p-5 rounded-2xl space-y-4 shadow-xl"><h4 className="text-[10px] uppercase font-bold text-orange-400 tracking-widest border-b border-orange-500/20 pb-2">2. Detalles de Liquidación (Venta)</h4><div className="grid grid-cols-2 gap-4"><div><label className="text-[10px] uppercase font-bold text-slate-500 mb-1 block">Fecha Venta</label><input type="date" value={form.sellDate} onChange={e=>setForm({...form, sellDate: e.target.value})} className="w-full font-bold text-sm bg-slate-900 border-slate-700 text-right" /></div><div><label className="text-[10px] uppercase font-bold text-slate-500 mb-1 block">Precio Venta</label><input type="number" step="0.001" value={form.sellPrice} onChange={e=>setForm({...form, sellPrice: parseFloat(e.target.value)})} className="w-full font-mono font-bold text-white text-sm bg-slate-900 border-slate-700 text-right" /></div></div><div className="grid grid-cols-3 gap-3"><div><label className="text-[10px] uppercase font-bold text-slate-500 mb-1 block">FX Venta</label><input type="number" step="0.0001" value={form.sellFx} onChange={e=>setForm({...form, sellFx: parseFloat(e.target.value)})} disabled={form.stockCurrency === baseCurrency} className="w-full font-mono text-sm font-bold bg-slate-900 border-slate-700 text-right" /></div><div><label className="text-[10px] uppercase font-bold text-slate-500 mb-1 block">Gtos Venta</label><input type="number" step="0.01" value={form.sellFees} onChange={e=>setForm({...form, sellFees: parseFloat(e.target.value)})} className="w-full font-mono text-sm font-bold bg-slate-900 border-slate-700 text-right" /></div><div><label className="text-[10px] uppercase font-bold text-slate-500 mb-1 block">Adj. Venta</label><input type="number" step="0.01" value={form.sellAdjustments} onChange={e=>setForm({...form, sellAdjustments: parseFloat(e.target.value)})} className="w-full font-mono text-sm font-bold bg-slate-900 border-slate-700 text-right" /></div></div><div className="flex items-center justify-end gap-2 bg-slate-900/30 p-2 rounded-lg border border-slate-700/50"><input type="checkbox" id="feesIncSell" checked={form.sellFeesIncludedInPrice} onChange={e=>setForm({...form, sellFeesIncludedInPrice: e.target.checked})} className="custom-checkbox" /><label htmlFor="feesIncSell" className="text-[10px] font-bold text-slate-400 uppercase">Gastos Broker incluidos en el precio</label></div><div className="bg-orange-600/20 border-2 border-orange-500 p-4 rounded-xl flex justify-between items-center shadow-lg"><div className="text-[10px] uppercase font-bold text-orange-400 italic font-mono">({formatN(form.shares)} x {formatN(form.sellPrice, 3)} x {formatN(form.sellFx, 4)}) - {formatN((form.sellFeesIncludedInPrice ? 0 : (form.sellFees||0)) + (form.sellAdjustments||0))}</div><div className="text-right"><div className="text-[8px] text-orange-400 font-black uppercase mb-1">Monto Liquidación</div><div className="text-lg font-black text-white leading-none font-mono">{formatMoney((form.shares * form.sellPrice * form.sellFx) - (form.sellFeesIncludedInPrice ? 0 : (form.sellFees || 0)) - (form.sellAdjustments || 0), baseCurrency)}</div></div></div></div>) : (<div className="bg-slate-800/40 border border-slate-700 p-5 rounded-2xl space-y-4"><h4 className="text-[10px] uppercase font-bold text-purple-400 tracking-widest border-b border-slate-700 pb-2">2. Situación Actual (Mercado)</h4><div className="grid grid-cols-3 gap-3"><div><label className="text-[10px] uppercase font-bold text-slate-500 mb-1 block">Precio Actual</label><input type="number" step="0.01" value={form.currentPrice} onChange={e=>setForm({...form, currentPrice: parseFloat(e.target.value)})} className="w-full font-mono font-bold text-white text-sm bg-slate-900 border-slate-700 text-right" /></div><div><label className="text-[10px] uppercase font-bold text-slate-500 mb-1 block">FX Actual</label><input type="number" step="0.0001" value={form.currentFx} onChange={e=>setForm({...form, currentFx: parseFloat(e.target.value)})} disabled={form.stockCurrency === baseCurrency} className={`w-full font-mono text-sm font-bold bg-slate-900 border-slate-700 text-right ${form.stockCurrency === baseCurrency ? 'opacity-50' : ''}`} /></div><div><label className="text-[10px] uppercase font-bold text-slate-500 mb-1 block">PER Actual</label><input type="number" step="0.1" value={form.currentPE} onChange={e=>setForm({...form, currentPE: parseFloat(e.target.value)})} className="w-full font-mono font-bold text-yellow-500 text-sm bg-slate-900 border-slate-700 text-right" /></div></div><div className="bg-purple-600/10 border border-purple-500/50 p-4 rounded-xl flex justify-between items-center shadow-lg"><div className="text-[10px] uppercase font-bold text-purple-400 italic font-mono">{formatN(form.shares)} x {formatN(form.currentPrice)} x {formatN(form.currentFx, 4)}</div><div className="text-right"><div className="text-[8px] text-purple-400 font-black uppercase mb-1">Valoración Actual</div><div className="text-lg font-black text-white leading-none font-mono">{formatMoney(form.shares * form.currentPrice * form.currentFx, baseCurrency)}</div></div></div></div>)}<div className="bg-slate-950/50 border border-slate-700 p-5 rounded-2xl"><h4 className="text-[10px] uppercase font-bold text-white tracking-widest border-b border-slate-700 pb-2 mb-3">3. Métricas de Rendimiento</h4>{(() => { const isSold = editingId && portfolio.find(x=>x.id===editingId)?.sellDate; const cost = (form.shares * form.buyPrice * form.buyFx) + (form.feesIncludedInPrice?0:(form.fees||0)) + (form.adjustments||0); const curP = isSold ? form.sellPrice : (form.isIndex ? form.currentPrice/(form.indexDivisor||1) : form.currentPrice); const curF = isSold ? form.sellFx : (form.isIndex ? form.buyFx : form.currentFx); const val = (curP * form.shares * curF) - (isSold ? (form.sellFeesIncludedInPrice?0:(form.sellFees||0))+(form.sellAdjustments||0) : 0); const days = calculateDays(form.buyDate, form.sellDate || new Date()); const pl = val - cost; const returns = calcReturns(cost, val, days); return (<div className="grid grid-cols-4 gap-4 text-center"><div><div className="text-[8px] text-slate-500 uppercase font-bold">Días</div><div className="text-lg font-bold text-white">{formatN(days, 0)}</div></div><div><div className="text-[8px] text-slate-500 uppercase font-bold">Resultado</div><div className={`text-lg font-bold ${pl>=0?'text-green-400':'text-red-400'}`}>{formatMoney(pl, baseCurrency)}</div></div><div><div className="text-[8px] text-slate-500 uppercase font-bold">% Simple</div><div className={`text-lg font-bold ${returns.simple>=0?'text-green-400':'text-red-400'}`}>{formatN(returns.simple)}%</div></div><div><div className="text-[8px] text-slate-500 uppercase font-bold">% Anual</div><div className={`text-lg font-bold ${returns.annual>=0?'text-green-400':'text-red-400'}`}>{formatN(returns.annual)}%</div></div></div>); })()}</div><div className="bg-slate-800/40 border border-slate-700 p-5 rounded-2xl space-y-4"><h4 className="text-[10px] uppercase font-bold text-green-400 tracking-widest border-b border-slate-700 pb-2">4. Dividendos y Retorno</h4><div className="flex items-center gap-4"><div className="flex-1"><label className="text-[10px] uppercase font-bold text-green-400 mb-1 block">Dividendo Anual (Est.)</label><input type="number" step="0.01" value={form.annualDividend} onChange={e=>setForm({...form, annualDividend: parseFloat(e.target.value)})} className="w-full font-mono text-sm font-bold bg-slate-900 border-green-600/50 text-right text-green-400" /></div><div className="bg-green-900/30 px-3 py-2 rounded border border-green-600/30 text-center"><div className="text-[8px] text-green-300 uppercase font-bold">Rent. s/ Coste</div><div className="text-sm font-bold text-white">{formatN(yieldOnCost)}%</div></div></div>{form.dividends && form.dividends.length > 0 && (() => { const totalDivs = form.dividends.reduce((acc, d) => ({ net: acc.net + (d.net||0), org: acc.org + (d.taxOrigin||0), dst: acc.dst + (d.taxDest||0) }), {net:0, org:0, dst:0}); return (<div className="grid grid-cols-3 gap-2 bg-slate-900 p-2 rounded-lg border border-slate-800 mt-2 text-center"><div><div className="text-[8px] text-green-400 uppercase font-bold">Total Neto</div><div className="text-xs font-mono font-bold text-white">{formatMoney(totalDivs.net, baseCurrency)}</div></div><div className="border-l border-slate-800"><div className="text-[8px] text-red-400 uppercase font-bold">Ret. Origen</div><div className="text-xs font-mono font-bold text-slate-300">{formatMoney(totalDivs.org, baseCurrency)}</div></div><div className="border-l border-slate-800"><div className="text-[8px] text-red-400 uppercase font-bold">Ret. Destino</div><div className="text-xs font-mono font-bold text-slate-300">{formatMoney(totalDivs.dst, baseCurrency)}</div></div></div>); })()}</div><div className="bg-slate-800/40 border border-slate-700 p-5 rounded-2xl space-y-4"><h4 className="text-[10px] uppercase font-bold text-slate-400 tracking-widest border-b border-slate-700 pb-2">5. Clasificación y Notas</h4><div className="grid grid-cols-2 gap-4"><div><label className="text-[10px] uppercase font-bold text-slate-500 mb-1 block">Nº Ordenamiento</label><input type="text" value={form.customOrder || ''} onChange={e=>setForm({...form, customOrder: e.target.value})} placeholder="Ej: 01, A, 10..." className="w-full text-sm bg-slate-900 border-slate-700" /></div><div><label className="text-[10px] uppercase font-bold text-slate-500 mb-1 block">Grupo / Estrategia</label><input type="text" value={form.group} onChange={e=>setForm({...form, group: e.target.value})} placeholder="Ej: Tecnológicas, Dividendos..." className="w-full text-sm bg-slate-900 border-slate-700" /></div></div><div><label className="text-[10px] uppercase font-bold text-slate-500 mb-1 block">Observaciones</label><textarea value={form.notes} onChange={e=>setForm({...form, notes: e.target.value})} className="w-full h-20 text-xs bg-slate-900 border-slate-700 custom-scrollbar" placeholder="Notas sobre la tesis de inversión..."></textarea></div></div><button onClick={handleSave} className="w-full bg-blue-600 py-4 rounded-2xl font-black uppercase shadow-2xl hover:bg-blue-500 transition-all text-sm tracking-widest border-t-2 border-white/20">Guardar Registro</button></div>
            </Modal>  
            <Modal isOpen={isSellModalOpen} title={`Liquidación: ${sellItem?.ticker}`} onClose={()=>setIsSellModalOpen(false)}>
                 {/* ... (Contenido del Modal de Venta, igual que el original) ... */}
                 <div className="space-y-4"><div className="bg-blue-900/10 p-4 rounded-xl text-[11px] text-blue-300 border border-blue-500/20 font-bold">Se generará un registro histórico de venta con dividendos traspasados.</div><div className="grid grid-cols-2 gap-4"><div><label className="text-[10px] uppercase font-bold text-slate-500">Fecha Venta</label><input type="date" value={sellForm.sellDate} onChange={e=>setSellForm({...sellForm, sellDate: e.target.value})} className="w-full font-bold text-sm bg-slate-900 border-slate-700 text-right" /></div><div><label className="text-[10px] uppercase font-bold text-slate-500">Acciones</label><input type="number" value={sellForm.sharesToSell} readOnly className="w-full font-bold text-sm bg-slate-900 border-slate-700 text-right opacity-60" /></div></div><div className="grid grid-cols-2 gap-4"><div><label className="text-[10px] uppercase font-bold text-slate-500">Precio Venta</label><input type="number" step="0.001" value={sellForm.sellPrice} onChange={e=>setSellForm({...sellForm, sellPrice: parseFloat(e.target.value)})} className="w-full font-mono text-white text-sm font-bold bg-slate-900 border-slate-700 text-right" /></div><div><label className="text-[10px] uppercase font-bold text-slate-500">FX Venta</label><input type="number" step="0.0001" value={sellForm.sellFx} onChange={e=>setSellForm({...sellForm, sellFx: parseFloat(e.target.value)})} className="w-full font-mono text-white text-sm font-bold bg-slate-900 border-slate-700 text-right" /></div></div><div className="grid grid-cols-2 gap-4"><div><label className="text-[10px] uppercase font-bold text-slate-500">Gastos Broker</label><input type="number" step="0.01" value={sellForm.sellFees} onChange={e=>setSellForm({...sellForm, sellFees: parseFloat(e.target.value)})} className="w-full font-mono text-white text-sm font-bold bg-slate-900 border-slate-700 text-right" /></div><div><label className="text-[10px] uppercase font-bold text-slate-500">Ajustes Venta</label><input type="number" step="0.01" value={sellForm.sellAdjustments} onChange={e=>setSellForm({...sellForm, sellAdjustments: parseFloat(e.target.value)})} className="w-full font-mono text-white text-sm font-bold bg-slate-900 border-slate-700 text-right" /></div></div><div className="flex items-center justify-end gap-2 bg-slate-900/30 p-2 rounded-lg border border-slate-700/50"><input type="checkbox" id="feesIncSellFast" checked={sellForm.sellFeesIncludedInPrice} onChange={e=>setSellForm({...sellForm, sellFeesIncludedInPrice: e.target.checked})} className="custom-checkbox" /><label htmlFor="feesIncSellFast" className="text-[10px] font-bold text-slate-400 uppercase">Gastos Broker incluidos en el precio</label></div><button onClick={handleSellSubmit} className="w-full bg-green-600 py-4 rounded-xl font-black uppercase shadow-lg text-xs tracking-widest border-t-2 border-white/10">Ejecutar Cierre Posición</button></div>
            </Modal>
            <Modal isOpen={confirmModal.isOpen} title={confirmModal.title} onClose={()=>setConfirmModal({isOpen:false})} size="sm"><div className="text-center space-y-4"><div className="bg-red-500/10 p-4 rounded-full w-16 h-16 flex items-center justify-center mx-auto text-red-500 border border-red-500/20"><Icons.Trash2 size={30}/></div><p className="text-slate-300 text-sm font-bold">{confirmModal.msg}</p><div className="flex gap-2"><button onClick={()=>setConfirmModal({isOpen:false})} className="flex-1 bg-slate-700 py-3 rounded-xl font-bold uppercase text-[10px]">Cancelar</button><button onClick={confirmModal.onConfirm} className="flex-1 bg-red-600 py-3 rounded-xl font-bold text-white uppercase text-[10px]">Eliminar</button></div></div></Modal>
            <Modal isOpen={infoModal.isOpen} title={infoModal.title} onClose={()=>setInfoModal({...infoModal, isOpen:false})} size="sm"><div className="text-center space-y-4"><div className={`p-4 rounded-full w-16 h-16 flex items-center justify-center mx-auto border ${infoModal.type==='error'?'bg-red-500/10 text-red-500 border-red-500/20':infoModal.type==='warning'?'bg-yellow-500/10 text-yellow-500 border-yellow-500/20':'bg-blue-500/10 text-blue-500 border-blue-500/20'}`}>{infoModal.type==='error'?<Icons.AlertCircle size={30}/>:infoModal.type==='warning'?<Icons.AlertCircle size={30}/>:<Icons.CheckCircle size={30}/>}</div><p className="text-slate-300 text-sm font-medium whitespace-pre-wrap leading-relaxed">{infoModal.msg}</p><button onClick={()=>setInfoModal({...infoModal, isOpen:false})} className="w-full bg-slate-700 py-3 rounded-xl font-bold uppercase text-[10px]">Cerrar</button></div></Modal>
        
            <Modal isOpen={isAnalysisModalOpen} title="Informe Estado Cartera" onClose={()=>setIsAnalysisModalOpen(false)} size="lg"> 
                <div className="space-y-4 p-2 max-h-[75vh] overflow-y-auto custom-scrollbar"> 
                    <div 
                        className="prose-content text-sm leading-relaxed font-sans text-slate-200 
                                   [&_p]:text-slate-300 [&_li]:text-slate-300 [&_strong]:text-white 
                                   [&_h3]:text-blue-400 [&_h3]:border-slate-700 
                                   [&_td]:border-slate-700 [&_td]:text-slate-300 [&_th]:bg-slate-800 [&_th]:text-white" 
                        dangerouslySetInnerHTML={{__html: analysisResult}}
                    ></div> 
                </div>
                <div className="flex justify-end pt-4 border-t border-slate-700"> 
                    <button onClick={handlePrintAI} className="bg-slate-700 px-4 py-2 rounded-lg text-xs font-bold text-white flex items-center gap-2 hover:bg-slate-600"><Icons.ExternalLink size={14}/> IMPRIMIR</button> 
                </div> 
            </Modal>

            <Modal isOpen={isNotesModalOpen} title="Block de Notas de la Cartera" onClose={() => setIsNotesModalOpen(false)} size="md">
                <div className="flex flex-col gap-4"><p className="text-[10px] text-slate-400 uppercase font-bold tracking-wider">Notas Generales, Estrategia o Recordatorios:</p><textarea value={globalNotes} onChange={(e) => setGlobalNotes(e.target.value)} placeholder="Escribe aquí tus notas..." className="w-full h-80 bg-slate-950 border border-slate-700 rounded-xl p-4 text-sm text-slate-200 font-sans leading-relaxed focus:border-yellow-500/50 focus:outline-none custom-scrollbar shadow-inner"/><div className="flex justify-between items-center bg-slate-800/30 p-3 rounded-lg border border-slate-700"><span className="text-[9px] text-slate-500 italic">* Estas notas se sincronizan automáticamente con tu copia en la nube.</span><button onClick={() => { onManualSync(); setIsNotesModalOpen(false); }} className="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-lg font-bold text-[10px] uppercase transition-colors">Guardar y Sincronizar</button></div></div>
            </Modal>

             {/* --- MODAL DE NOTICIAS --- */}
            <Modal isOpen={isNewsModalOpen} title="Radar de Noticias (Últimos 7 días)" onClose={() => setIsNewsModalOpen(false)} size="lg">
                <div className="space-y-4 p-2 max-h-[70vh] overflow-y-auto custom-scrollbar">
                    <div 
                        className="prose-content text-sm leading-relaxed font-sans text-slate-200 
                                   [&_h3]:text-blue-400 [&_h3]:mt-6 [&_h3]:border-slate-700 
                                   [&_a]:text-blue-400 [&_a]:underline"
                        dangerouslySetInnerHTML={{__html: newsResult}}
                    ></div>
                </div>
                <div className="flex justify-end pt-4 border-t border-slate-700 mt-4">
                    <button onClick={handlePrintNews} className="bg-slate-700 px-4 py-2 rounded-lg text-xs font-bold text-white flex items-center gap-2 hover:bg-slate-600">
                        <Icons.ExternalLink size={14}/> IMPRIMIR NOTICIAS
                    </button>
                </div>
            </Modal>
            
            {/* --- OVERLAY DE CARGA PARA NOTICIAS --- */}
            {analyzingNews && (
                <div className="fixed inset-0 z-[200] bg-black/80 backdrop-blur-sm flex flex-col items-center justify-center fade-in">
                    <Icons.Globe size={60} className="text-blue-500 mb-4 animate-spin" />
                    <div className="text-xl font-bold text-white animate-pulse">Rastreando noticias globales...</div>
                    <div className="text-xs text-slate-400 mt-2">Buscando eventos de los últimos 7 días en la red</div>
                </div>
            )}


            <Modal isOpen={isNewsSelectionModalOpen} title="¿Qué noticias deseas consultar?" onClose={() => setIsNewsSelectionModalOpen(false)} size="sm">
            <div className="flex flex-col gap-4 p-2">
                <button 
                    onClick={() => fetchNews('portfolio')}
                    className="group flex items-center gap-4 p-4 bg-slate-800 hover:bg-blue-900/40 border border-slate-700 rounded-xl transition-all text-left"
                >
                    <div className="p-3 bg-blue-500/20 rounded-lg text-blue-400 group-hover:scale-110 transition-transform"><Icons.Briefcase size={24}/></div>
                    <div>
                        <div className="text-sm font-bold text-white uppercase">Activos en Cartera</div>
                        <div className="text-[10px] text-slate-400">Rastreo específico de tus valores (Últimos 7 días)</div>
                    </div>
                </button>
        
                <button 
                    onClick={() => fetchNews('general')}
                    className="group flex items-center gap-4 p-4 bg-slate-800 hover:bg-purple-900/40 border border-slate-700 rounded-xl transition-all text-left"
                >
                    <div className="p-3 bg-purple-500/20 rounded-lg text-purple-400 group-hover:scale-110 transition-transform"><Icons.TrendingUp size={24}/></div>
                    <div>
                        <div className="text-sm font-bold text-white uppercase">Mercado General (48h)</div>
                        <div className="text-[10px] text-slate-400">Noticias macro, economía y bolsa mundial reciente</div>
                    </div>
                </button>
            </div>
        </Modal>

{/* --- MODAL DE RESULTADOS DE NOTICIAS --- */}
<Modal isOpen={isNewsModalOpen} title="Radar de Noticias iA" onClose={() => setIsNewsModalOpen(false)} size="lg">
    <div className="space-y-4 p-2 max-h-[70vh] overflow-y-auto custom-scrollbar">
        <div 
            className="prose-content text-sm leading-relaxed font-sans text-slate-200 
                       [&_h3]:text-blue-400 [&_h3]:mt-6 [&_h3]:border-slate-700 [&_h3]:uppercase [&_h3]:text-xs [&_h3]:tracking-widest
                       [&_a]:text-blue-400 [&_a]:underline [&_a]:font-bold"
            dangerouslySetInnerHTML={{__html: newsResult}}
        ></div>
    </div>
    <div className="flex justify-end pt-4 border-t border-slate-700 mt-4">
        <button onClick={handlePrintNews} className="bg-slate-700 px-4 py-2 rounded-lg text-xs font-bold text-white flex items-center gap-2 hover:bg-slate-600">
            <Icons.ExternalLink size={14}/> IMPRIMIR INFORME
        </button>
    </div>
</Modal>
   
        </div>
    );
};


const AnalysisTab = ({ apiKey, baseCurrency, setPortfolio, initialTicker }) => {
    // --- ESTADOS NAVEGACIÓN Y ESTUDIO ---
    const [activeSubTab, setActiveSubTab] = useState('estudio');
    const [ticker, setTicker] = useState(initialTicker || ''); 
    const [question, setQuestion] = useState(''); 
    const [loading, setLoading] = useState(false); 
    const [data, setData] = useState(null); 
    const [specificAnswer, setSpecificAnswer] = useState(null); 
    const [suggestedQuestions, setSuggestedQuestions] = useState(["Competencia directa", "Historial de dividendos", "Nivel de deuda", "Directivos y Salarios", "Escándalos recientes", "Previsión próximos resultados"]);

    // --- ESTADOS PESTAÑA RASTREO (ORIGINAL) ---
    const [exchange, setExchange] = useState('USA');
    const [maxResults, setMaxResults] = useState(10);
    const [screenerResults, setScreenerResults] = useState([]);
    const [screenerSort, setScreenerSort] = useState({ key: 'ticker', direction: 'asc' });
    const [statusModal, setStatusModal] = useState({ isOpen: false, title: '', msg: '', type: 'info' });

    // Configuración de Parámetros RASTREO (ORIGINAL)
    const [params, setParams] = useState({
        per: { val: 25, active: true, label: 'PER Máximo', min: 5, max: 100, step: 1, help: 'Veces que el precio cubre el beneficio. <15: Barata, >25: Crecimiento/Cara.' },
        peg: { val: 1.5, active: true, label: 'PEG Máximo', min: 0.1, max: 5, step: 0.1, help: 'PER ajustado al crecimiento. <1: Infravalorada, >2: Sobrevalorada.' },
        roi: { val: 10, active: true, label: 'ROI Mínimo %', min: 1, max: 50, step: 1, help: 'Retorno sobre inversión. >15% indica gran ventaja competitiva (Moat).' },
        divYield: { val: 2, active: true, label: 'Div. Yield Mín %', min: 0, max: 15, step: 0.5, help: 'Rentabilidad por dividendo. >4% suele ser defensiva o madura.' },
        pb: { val: 3, active: false, label: 'P/B Máximo', min: 0.1, max: 10, step: 0.1, help: 'Precio/Valor Contable. <1: Cotiza bajo valor de liquidación teórico.' },
        debtEquity: { val: 1.5, active: false, label: 'Deuda/Equity Máx', min: 0, max: 5, step: 0.1, help: 'Apalancamiento. >1.5 implica riesgo alto si suben tipos de interés.' }
    });

    const EXCHANGES = [
        { id: 'USA', name: 'EE.UU. (NYSE / NASDAQ)', country: 'USA' },
        { id: 'SPAIN', name: 'España (Mercado Continuo / IBEX)', country: 'España' },
        { id: 'UK', name: 'Reino Unido (LSE)', country: 'UK' },
        { id: 'GERMANY', name: 'Alemania (XETRA)', country: 'Alemania' },
        { id: 'FRANCE', name: 'Francia (Euronext Paris)', country: 'Francia' },
        { id: 'JAPAN', name: 'Japón (Tokyo Stock Exchange)', country: 'Japón' },
        { id: 'CHINA_HK', name: 'China / Hong Kong (HKEX)', country: 'China' },
        { id: 'CANADA', name: 'Canadá (TSX)', country: 'Canadá' },
        { id: 'AUSTRALIA', name: 'Australia (ASX)', country: 'Australia' },
        { id: 'ITALY', name: 'Italia (Borsa Italiana)', country: 'Italia' },
        { id: 'SWITZERLAND', name: 'Suiza (SIX)', country: 'Suiza' },
        { id: 'NETHERLANDS', name: 'Holanda (Euronext Amsterdam)', country: 'Holanda' }
    ];

    
    
    const REPORT_TITLES = {
        ITEM_1: "ANÁLISIS FINANCIERO INTEGRAL 360º",
        ITEM_2: "ANÁLISIS DE ESTADOS FINANCIEROS (BALANCE Y CUENTA)",
        ITEM_3: "REVISIÓN DE RESULTADOS TRIMESTRALES (EARNINGS)",
        ITEM_4: "COMPARATIVA SECTORIAL Y COMPETENCIA",
        ITEM_5: "MODELOS DE VALORACIÓN (DCF Y MÚLTIPLOS)",
        ITEM_6: "INFORME DE RIESGOS, ALERTAS Y CATALIZADORES",
        ITEM_7: "HISTORIA, IDENTIDAD Y RANKING DE MERCADO",
        ITEM_8: "INFORME INSTITUCIONAL COMPLETO (SENIOR ANALYST)"
    };

    const handleScreenerClick = (rowTicker) => {
        // Mapeo de prefijos según el ID del exchange seleccionado en el estado 'exchange'
        const prefixMap = {
            'USA': 'NYSE:', // Por defecto para USA, Gemini suele entenderlo o corregirlo a NASDAQ si es necesario
            'SPAIN': 'BME:',
            'UK': 'LSE:',
            'GERMANY': 'XETRA:',
            'FRANCE': 'EPA:',
            'JAPAN': 'TYO:',
            'CHINA_HK': 'HKG:',
            'CANADA': 'TSE:',
            'AUSTRALIA': 'ASX:',
            'ITALY': 'BIT:',
            'SWITZERLAND': 'SWX:',
            'NETHERLANDS': 'AMS:'
        };

        const prefix = prefixMap[exchange] || ''; 
        // Si el ticker ya trae dos puntos (raro en este output pero posible), no ponemos prefijo
        const cleanTicker = rowTicker.includes(':') ? rowTicker : `${prefix}${rowTicker}`;

        setTicker(cleanTicker); // Actualiza el input del buscador en la pestaña Estudio
        setActiveSubTab('estudio'); // Cambia la vista automáticamente
        
        // Opcional: Limpiar resultados previos de estudio para forzar una nueva búsqueda limpia
        setSpecificAnswer(null);
        setData(null);
    };

    useEffect(() => { if (initialTicker) setTicker(initialTicker); }, [initialTicker]);

  // --- PROMPTS ORIGINALES COMPLETOS (RESTAURADOS ÍNTEGRAMENTE) ---
  const HTML_TEMPLATES = {
        ITEM_1: `
            <div style="color: #000000;">
                <h3 style="color: #1e3a8a; border-bottom: 1px solid #ccc; text-transform: uppercase; margin-top: 20px;">1. Descripción General y Modelo de Negocio</h3>
                <p><strong>Actividad Principal:</strong> [Dato Real] (Fuente: [Fuente], Fecha: [Dato])</p>
                <p><strong>Segmentos de Ingresos (%):</strong> [Dato Real] (Fuente: [Fuente], Fecha: [Dato])</p>
                <p><strong>Ventaja Competitiva (Moat):</strong> [Dato Real] (Fuente: [Fuente], Fecha: [Dato])</p>

                <h3 style="color: #1e3a8a; border-bottom: 1px solid #ccc; text-transform: uppercase; margin-top: 15px;">2. Datos Financieros Clave (Cifras TTM y Último Reporte)</h3>
                <table style="width:100%; border-collapse: collapse; font-size: 11px; color: #000;">
                    <tr style="background:#f1f5f9; color:#000;">
                        <th style="border:1px solid #ccc; padding:4px; text-align:left;">Métrica Financiera</th>
                        <th style="border:1px solid #ccc; padding:4px; text-align:right;">Valor Real</th>
                        <th style="border:1px solid #ccc; padding:4px; text-align:left;">Fuente / Fecha</th>
                    </tr>
                    <tr><td style="border:1px solid #ccc; padding:4px;">Ingresos (Revenue) TTM</td><td style="border:1px solid #ccc; padding:4px; text-align:right; font-weight:bold;">[Dato Real]</td><td style="border:1px solid #ccc; padding:4px;">[Fuente/Fecha]</td></tr>
                    <tr><td style="border:1px solid #ccc; padding:4px;">Ingreso Neto / BPA (EPS)</td><td style="border:1px solid #ccc; padding:4px; text-align:right; font-weight:bold;">[Dato Real]</td><td style="border:1px solid #ccc; padding:4px;">[Fuente/Fecha]</td></tr>
                    <tr><td style="border:1px solid #ccc; padding:4px;">Ratio P/E / P/E Forward</td><td style="border:1px solid #ccc; padding:4px; text-align:right; font-weight:bold;">[Dato Real]</td><td style="border:1px solid #ccc; padding:4px;">[Fuente/Fecha]</td></tr>
                    <tr><td style="border:1px solid #ccc; padding:4px;">Ratio P/S / Ratio PEG</td><td style="border:1px solid #ccc; padding:4px; text-align:right; font-weight:bold;">[Dato Real]</td><td style="border:1px solid #ccc; padding:4px;">[Fuente/Fecha]</td></tr>
                    <tr><td style="border:1px solid #ccc; padding:4px;">Deuda Total / Ratio D-E</td><td style="border:1px solid #ccc; padding:4px; text-align:right; font-weight:bold;">[Dato Real]</td><td style="border:1px solid #ccc; padding:4px;">[Fuente/Fecha]</td></tr>
                    <tr><td style="border:1px solid #ccc; padding:4px;">Flujo de Caja Libre (FCF)</td><td style="border:1px solid #ccc; padding:4px; text-align:right; font-weight:bold;">[Dato Real]</td><td style="border:1px solid #ccc; padding:4px;">[Fuente/Fecha]</td></tr>
                </table>

                <h3 style="color: #1e3a8a; border-bottom: 1px solid #ccc; text-transform: uppercase; margin-top: 15px;">3. Rendimiento de la Acción vs Índices</h3>
                <ul>
                    <li><strong>Precio: 1m / 3m / 6m:</strong> [Dato Real %] (Fuente: [Fuente])</li>
                    <li><strong>Precio: 1 año / YTD:</strong> [Dato Real %] (Fuente: [Fuente])</li>
                    <li><strong>Vs S&P 500 (Mismos periodos):</strong> [Dato Real %] (Fuente: [Fuente])</li>
                    <li><strong>Máximo / Mínimo 52 semanas:</strong> [Dato Real] (Fecha: [Dato])</li>
                </ul>

                <h3 style="color: #1e3a8a; border-bottom: 1px solid #ccc; text-transform: uppercase; margin-top: 15px;">4. Consenso y Actividad Institucional</h3>
                <p><strong>Analistas (Buy/Hold/Sell):</strong> [Distribución Real] (Fuente: [Fuente], Fecha: [Dato])</p>
                <p><strong>Precio Objetivo (Medio/Alto/Bajo):</strong> [Dato Real] (Fuente: [Fuente], Fecha: [Dato])</p>
                <p><strong>Top 5 Inversores Institucionales:</strong> [Lista Real y cambios] (Fuente: [Fuente], Fecha: [Dato])</p>
            </div>`,

        ITEM_2: `
            <div style="color: #000000;">
                <h3 style="color: #1e3a8a; border-bottom: 1px solid #ccc; text-transform: uppercase;">1. Análisis del Estado de Resultados (Últimos 4 Trimestres)</h3>
                <table style="width:100%; border-collapse: collapse; font-size: 10px; margin-bottom: 10px; color: #000;">
                    <tr style="background:#f1f5f9; color:#000;">
                        <th style="border:1px solid #ccc; padding:4px;">Trimestre</th><th style="border:1px solid #ccc; padding:4px;">Ingresos</th><th style="border:1px solid #ccc; padding:4px;">Crec. YoY</th><th style="border:1px solid #ccc; padding:4px;">Margen Bruto</th><th style="border:1px solid #ccc; padding:4px;">Margen Neto</th>
                    </tr>
                    <tr><td style="border:1px solid #ccc; padding:4px;">[Q-Reciente]</td><td style="border:1px solid #ccc; padding:4px; text-align:right;">[Dato]</td><td style="border:1px solid #ccc; padding:4px; text-align:right;">[Dato %]</td><td style="border:1px solid #ccc; padding:4px; text-align:right;">[Dato %]</td><td style="border:1px solid #ccc; padding:4px; text-align:right;">[Dato %]</td></tr>
                    <tr><td style="border:1px solid #ccc; padding:4px;">[Q-Previo 1]</td><td style="border:1px solid #ccc; padding:4px; text-align:right;">[Dato]</td><td style="border:1px solid #ccc; padding:4px; text-align:right;">[Dato %]</td><td style="border:1px solid #ccc; padding:4px; text-align:right;">[Dato %]</td><td style="border:1px solid #ccc; padding:4px; text-align:right;">[Dato %]</td></tr>
                </table>
                <p><strong>Tendencia de Márgenes:</strong> [Análisis Real] (Fuente: [Fuente])</p>

                <h3 style="color: #1e3a8a; border-bottom: 1px solid #ccc; text-transform: uppercase; margin-top: 15px;">2. Salud del Balance General</h3>
                <ul>
                    <li><strong>Activos vs Pasivos Totales:</strong> [Cifras Reales] (Fuente: [Fuente])</li>
                    <li><strong>Ratio Corriente / Rápido:</strong> [Cifras Reales] (Fuente: [Fuente])</li>
                    <li><strong>Efectivo e Inversiones CP:</strong> [Dato Real] (Fuente: [Fuente], Fecha: [Dato])</li>
                    <li><strong>Calendario de Vencimiento de Deuda:</strong> [Detalle Real] (Fuente: [Fuente])</li>
                    <li><strong>Fondo de Comercio (Goodwill):</strong> [Dato Real % sobre Activos] (Fuente: [Fuente])</li>
                </ul>

                <h3 style="color: #1e3a8a; border-bottom: 1px solid #ccc; text-transform: uppercase; margin-top: 15px;">3. Verificación de Flujo de Caja (Cash Flow)</h3>
                <p><strong>Flujo Operativo vs Gastos Capital (CapEx):</strong> [Cifras Reales] (Fuente: [Fuente])</p>
                <p><strong>Free Cash Flow (TTM):</strong> [Dato Real] (Margen FCF: [Dato %])</p>
                <p><strong>Uso del Efectivo:</strong> [¿Recompras, Dividendos o Deuda?] (Fuente: [Fuente])</p>

                <h3 style="color: #1e3a8a; border-bottom: 1px solid #ccc; text-transform: uppercase; margin-top: 15px;">4. Señales de Alerta y Comparativa</h3>
                <p><strong>Red Flags (Cuentas por cobrar, Inventarios):</strong> [Análisis Real] (Fuente: [Fuente])</p>
                <p><strong>Comparativa Márgenes vs 3 Competidores:</strong> [Tabla o Lista Real] (Fuente: [Fuente])</p>
                <div style="background:#f1f5f9; padding:10px; border-radius:6px; color:#000; font-size:11px; border: 1px solid #ccc;">
                    <strong>VEREDICTO FINANCIERO:</strong> [¿Fortaleciéndose o Debilitándose? Resumen Real]
                </div>
            </div>`,

        ITEM_3: `
            <div style="color: #000000;">
                <h3 style="color: #1e3a8a; border-bottom: 1px solid #ccc; text-transform: uppercase;">1. Análisis de Resultados Recientes (Earnings Report)</h3>
                <table style="width:100%; border-collapse: collapse; font-size: 11px; color: #000;">
                    <tr style="background:#f1f5f9; color:#000;">
                        <th style="border:1px solid #ccc; padding:4px;">Concepto</th><th style="border:1px solid #ccc; padding:4px;">Cifra Real</th><th style="border:1px solid #ccc; padding:4px;">Estimación</th><th style="border:1px solid #ccc; padding:4px;">Sorpresa (%)</th>
                    </tr>
                    <tr><td style="border:1px solid #ccc; padding:4px;">Ingresos</td><td style="border:1px solid #ccc; padding:4px; text-align:right;">[Dato]</td><td style="border:1px solid #ccc; padding:4px; text-align:right;">[Dato]</td><td style="border:1px solid #ccc; padding:4px; text-align:right;">[Dato %]</td></tr>
                    <tr><td style="border:1px solid #ccc; padding:4px;">BPA (EPS)</td><td style="border:1px solid #ccc; padding:4px; text-align:right;">[Dato]</td><td style="border:1px solid #ccc; padding:4px; text-align:right;">[Dato]</td><td style="border:1px solid #ccc; padding:4px; text-align:right;">[Dato %]</td></tr>
                </table>
                <p><strong>Partidas Extraordinarias / Ajustes GAAP:</strong> [Detalle Real] (Fuente: [Fuente])</p>

                <h3 style="color: #1e3a8a; border-bottom: 1px solid #ccc; text-transform: uppercase; margin-top: 15px;">2. Guía Futura (Guidance) y Segmentos</h3>
                <p><strong>Guía Próximo Trimestre / Año Completo:</strong> [Cifras y Rangos] (Fuente: [Fuente])</p>
                <p><strong>Tono de la Dirección:</strong> [Cita u Opinión Real] (Fuente: [Fuente])</p>
                <p><strong>Desempeño por Segmentos/Geografía:</strong> [Detalle de crecimiento real] (Fuente: [Fuente])</p>

                <h3 style="color: #1e3a8a; border-bottom: 1px solid #ccc; text-transform: uppercase; margin-top: 15px;">3. Reacción del Mercado y Catalizadores</h3>
                <ul>
                    <li><strong>Movimiento del Precio (Post-After Hours):</strong> [Dato Real %]</li>
                    <li><strong>Cambios de Recomendación (Post-Earnings):</strong> [Firma y Nuevo Objetivo] (Fuente: [Fuente])</li>
                    <li><strong>Temas Clave Q&A Analistas:</strong> [Resumen de 2 puntos reales] (Fuente: [Fuente])</li>
                </ul>
                <div style="border-left: 4px solid #1e3a8a; background: #f1f5f9; padding-left:10px; margin-top:10px; color:#000;">
                    <strong>EL VEREDICTO:</strong> [Número más importante y por qué] (Fecha: [Dato])
                </div>
            </div>`,

        ITEM_4: `
            <div style="color: #000000;">
                <h3 style="color: #1e3a8a; border-bottom: 1px solid #ccc; text-transform: uppercase;">1. Tabla Comparativa del Sector</h3>
                <table style="width:100%; border-collapse: collapse; font-size: 10px; color: #000;">
                    <tr style="background:#f1f5f9; color:#000;">
                        <th style="border:1px solid #ccc; padding:4px;">Empresa</th><th style="border:1px solid #ccc; padding:4px;">Market Cap</th><th style="border:1px solid #ccc; padding:4px;">Crec. Rev.</th><th style="border:1px solid #ccc; padding:4px;">PER / PEG</th><th style="border:1px solid #ccc; padding:4px;">Margen Neto</th><th style="border:1px solid #ccc; padding:4px;">Deuda/Eq.</th>
                    </tr>
                    <tr style="background:#e2e8f0; font-weight:bold;"><td><strong>${ticker}</strong></td><td>[Dato]</td><td>[Dato %]</td><td>[Dato]</td><td>[Dato %]</td><td>[Dato]</td></tr>
                    <tr><td>[Competidor 1]</td><td>[Dato]</td><td>[Dato %]</td><td>[Dato]</td><td>[Dato %]</td><td>[Dato]</td></tr>
                    <tr><td>[Competidor 2]</td><td>[Dato]</td><td>[Dato %]</td><td>[Dato]</td><td>[Dato %]</td><td>[Dato]</td></tr>
                </table>

                <h3 style="color: #1e3a8a; border-bottom: 1px solid #ccc; text-transform: uppercase; margin-top: 15px;">2. Posicionamiento y Cuota de Mercado</h3>
                <p><strong>Ventaja Competitiva vs Pares:</strong> [Análisis Real] (Fuente: [Fuente])</p>
                <p><strong>Ranking de Cuota de Mercado:</strong> [Posición Real] (Fuente: [Fuente], Fecha: [Dato])</p>

                <h3 style="color: #1e3a8a; border-bottom: 1px solid #ccc; text-transform: uppercase; margin-top: 15px;">3. Análisis de Riesgos Comparados</h3>
                <p><strong>Mayor Riesgo Individual:</strong> [Dato Real por empresa] (Fuente: [Fuente])</p>
                <p><strong>¿Quién tiene mejor Balance?:</strong> [Nombre y Razón Real] (Fuente: [Fuente])</p>

                <h3 style="color: #1e3a8a; border-bottom: 1px solid #ccc; text-transform: uppercase; margin-top: 15px;">4. El Ranking Final</h3>
                <p><strong>Mejor Valor / Crecimiento / Seguridad:</strong> [Elección Real del Analista] (Fuente: [Fuente])</p>
            </div>`,

        ITEM_5: `
            <div style="color: #000000;">
                <h3 style="color: #1e3a8a; border-bottom: 1px solid #ccc; text-transform: uppercase;">1. Valoración por Flujo de Caja Descontado (DCF)</h3>
                <ul>
                    <li><strong>FCF Inicial y Tasa Crecimiento (5A):</strong> [Dato Real %] (Fuente: [Fuente])</li>
                    <li><strong>Tasa de Descuento (WACC):</strong> [Dato Real %] (Fuente: [Fuente])</li>
                    <li><strong>Valor Intrínseco calculado:</strong> [Precio Real] (Fuente: [Fuente])</li>
                </ul>
                <p><strong>Sensibilidad (WACC vs Crecimiento):</strong> [Resumen de sensibilidad Real] (Fecha: [Dato])</p>

                <h3 style="color: #1e3a8a; border-bottom: 1px solid #ccc; text-transform: uppercase; margin-top: 15px;">2. Valoración por Múltiplos Históricos</h3>
                <p><strong>P/E Actual vs Media 5 Años:</strong> [Dato Real] (Fuente: [Fuente])</p>
                <p><strong>Comparativa EV/EBITDA y P/S:</strong> [Cifras Reales] (Fuente: [Fuente])</p>

                <h3 style="color: #1e3a8a; border-bottom: 1px solid #ccc; text-transform: uppercase; margin-top: 15px;">3. Precios Objetivo de Analistas</h3>
                <p><strong>Mediano / Alto / Bajo (Últimos 90 días):</strong> [Precios Reales] (Fuente: [Fuente])</p>

                <h3 style="color: #1e3a8a; border-bottom: 2px solid #ccc; text-transform: uppercase; margin-top: 15px;">4. Tres Escenarios de Inversión</h3>
                <table style="width:100%; border-collapse: collapse; font-size: 11px; color: #000;">
                    <tr style="background:#f1f5f9; color:#000;"><th>Escenario</th><th>Precio Estimado</th><th>Upside/Downside (%)</th></tr>
                    <tr style="color:#15803d; font-weight:bold;"><td>Caso Alcista (Bull)</td><td>[Precio]</td><td>[Dato %]</td></tr>
                    <tr style="color:#1e40af; font-weight:bold;"><td>Caso Base (Base)</td><td>[Precio]</td><td>[Dato %]</td></tr>
                    <tr style="color:#b91c1c; font-weight:bold;"><td>Caso Bajista (Bear)</td><td>[Precio]</td><td>[Dato %]</td></tr>
                </table>
                <div style="background:#f1f5f9; padding:15px; border-radius:8px; text-align:center; margin-top:10px; border:1px solid #1e3a8a; color: #000;">
                    <strong style="color:#1e3a8a;">VEREDICTO: [Infravalorada / Justa / Sobrevalorada]</strong>
                </div>
            </div>`,

        ITEM_6: `
            <div style="color: #000000;">
                <h3 style="color: #1e3a8a; border-bottom: 1px solid #ccc; text-transform: uppercase;">1. Resumen Ejecutivo de Tesis</h3>
                <p><strong>Elevator Pitch:</strong> [Resumen de 30 segundos basado en datos reales] (Fuente: [Fuente])</p>
                <p><strong>Recomendación y Convicción:</strong> [Strong Buy/Buy/Hold/Sell] (Nivel: [Alto/Medio])</p>

                <h3 style="color: #1e3a8a; border-bottom: 1px solid #ccc; text-transform: uppercase; margin-top: 15px;">2. Análisis Profundo de Riesgos (Top 5)</h3>
                <ul>
                    <li><strong>Riesgo 1 (Probabilidad/Impacto):</strong> [Detalle Real] (Fuente: [Fuente])</li>
                    <li><strong>Riesgo 2 (Probabilidad/Impacto):</strong> [Detalle Real] (Fuente: [Fuente])</li>
                    <li><strong>Riesgo 3 (Específico Sector):</strong> [Detalle Real] (Fuente: [Fuente])</li>
                    <li><strong>Short Interest y Actividad Insiders:</strong> [Dato Real] (Fuente: [Fuente])</li>
                </ul>

                <h3 style="color: #1e3a8a; border-bottom: 1px solid #ccc; text-transform: uppercase; margin-top: 15px;">3. Calendario de Catalizadores (Próximos 12 meses)</h3>
                <table style="width:100%; border-collapse: collapse; font-size: 11px; color: #000;">
                    <tr style="background:#f1f5f9; color:#000;"><th>Fecha Estimada</th><th>Evento / Catalizador</th><th>Fuente</th></tr>
                    <tr><td>[Fecha]</td><td>Próximo Informe Resultados (Q)</td><td>[Fuente]</td></tr>
                    <tr><td>[Fecha]</td><td>Lanzamiento Producto / Evento</td><td>[Fuente]</td></tr>
                    <tr><td>[Fecha]</td><td>Decisión Regulatoria / Otros</td><td>[Fuente]</td></tr>
                </table>

                <h3 style="color: #1e3a8a; border-bottom: 1px solid #ccc; text-transform: uppercase; margin-top: 15px;">4. Análisis de Crecimiento (TAM y Cuota)</h3>
                <p><strong>Mercado Total Direccionable (TAM):</strong> [Cifra Real] (Fuente: [Fuente])</p>
                <p><strong>Motores de Crecimiento 3-5 años:</strong> [Detalle Real] (Fuente: [Fuente])</p>
            </div>`,

            ITEM_7: `
            <div style="color: #000000; font-family: sans-serif;">
                <div style="border-bottom: 3px solid #059669; padding-bottom: 10px; margin-bottom: 20px;">
                    <h2 style="color: #059669; font-size: 20px; text-transform: uppercase; margin: 0;">CORPORATE IDENTITY & MARKET RANKING</h2>
                    <p style="font-size: 11px; color: #555; margin-top: 5px;"><strong>ENFOQUE:</strong> Datos Reales, Historia y Auditoría de Mercado (No estimaciones)</p>
                </div>

                <!-- 1. FICHA IDENTIDAD -->
                <div style="background-color: #f0fdf4; border: 1px solid #059669; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="color: #047857; margin-top: 0; border-bottom: 1px solid #86efac; font-size: 14px;">1. FICHA DE IDENTIDAD (DATOS VIVOS)</h3>
                    <ul style="list-style: none; padding: 0; font-size: 12px;">
                        <li style="margin-bottom: 6px;"><strong>Sede Central:</strong> [Ciudad, País Exacto]</li>
                        <li style="margin-bottom: 6px;"><strong>Fundadores:</strong> [Nombres] (Año: [Año])</li>
                        <li style="margin-bottom: 6px;"><strong>Estructura Legal:</strong> [Tipo de Sociedad Actual]</li>
                        <li style="margin-bottom: 6px;"><strong>Web Oficial:</strong> [URL Principal]</li>
                    </ul>
                    <div style="text-align: right; font-size: 9px; color: #065f46;">(Fuente: [Web/Registro] | Fecha: [Hoy])</div>
                </div>

                <!-- 2. MODELO DE NEGOCIO -->
                <h3 style="color: #059669; border-bottom: 2px solid #ccc; text-transform: uppercase; font-size: 14px; margin-top: 20px;">2. MODELO DE NEGOCIO Y GEOGRAFÍA</h3>
                <p style="font-size: 12px;"><strong>Generación de Ingresos (Hoy):</strong> [Descripción precisa de cómo hacen dinero actualmente]</p>
                <p style="font-size: 12px;"><strong>Ámbito Geográfico:</strong> [Países clave donde operan activamente]</p>
                <p style="font-size: 12px; margin-bottom: 5px;"><strong>Sectores Específicos:</strong> [Industria y Nicho]</p>
                <div style="font-size: 9px; color: #555;">(Fuente: [Reporte Anual/Web] | Fecha: [Dato])</div>

                <!-- 3. PORTAFOLIO Y PRECIOS -->
                <h3 style="color: #059669; border-bottom: 2px solid #ccc; text-transform: uppercase; font-size: 14px; margin-top: 20px;">3. MARCAS, PRODUCTOS Y PRECIOS REALES</h3>
                <p style="font-size: 11px; font-style: italic; color: #444;">Busca en la web oficial precios actuales de referencia (en moneda local, EUR o USD):</p>
                <table style="width:100%; border-collapse: collapse; font-size: 11px; margin-top: 5px; border: 1px solid #ddd;">
                    <tr style="background:#ecfdf5;"><th>Producto / Marca Principal</th><th>Precio Ref. Actual</th><th>Fuente Directa</th></tr>
                    <tr><td>[Producto Estrella 1]</td><td>[Precio Real]</td><td>[Web Oficial/Retailer]</td></tr>
                    <tr><td>[Producto Estrella 2]</td><td>[Precio Real]</td><td>[Web Oficial/Retailer]</td></tr>
                    <tr><td>[Servicio/Suscripción]</td><td>[Precio Real]</td><td>[Web Oficial]</td></tr>
                </table>

                <!-- 4. CÚPULA DIRECTIVA -->
                <h3 style="color: #059669; border-bottom: 2px solid #ccc; text-transform: uppercase; font-size: 14px; margin-top: 20px;">4. CÚPULA DIRECTIVA (VERIFICADA HOY)</h3>
                <ul style="font-size: 12px;">
                    <li><strong>CEO:</strong> [Nombre] (En el cargo desde: [Año])</li>
                    <li><strong>CFO:</strong> [Nombre] (Confirmado en cargo: Sí/No)</li>
                    <li><strong>Clave (CTO/COO):</strong> [Nombre] ([Cargo])</li>
                </ul>
                <div style="font-size: 9px; color: #555;">(Verificación: [Fuente corporativa/Linkedin] | Fecha: [Hoy])</div>

                <!-- 5. CRONOLOGÍA / HITOS -->
                <h3 style="color: #059669; border-bottom: 2px solid #ccc; text-transform: uppercase; font-size: 14px; margin-top: 20px;">5. HITOS HISTÓRICOS Y M&A RECIENTE</h3>
                <ul style="font-size: 11px;">
                    <li><strong>[Año]:</strong> [Fundación / Hito Origen]</li>
                    <li><strong>[Año]:</strong> [Hito de expansión clave]</li>
                    <li><strong>[Hace <24 meses]:</strong> [Adquisición o evento reciente importante]</li>
                    <li><strong>[Hace <12 meses]:</strong> [Último gran hito reportado]</li>
                </ul>

                <!-- 6. RANKING SECTORIAL (LA PARTE CLAVE) -->
                <div style="background-color: #fffbeb; border: 2px solid #d97706; padding: 15px; border-radius: 8px; margin-top: 25px;">
                    <h3 style="color: #b45309; margin-top: 0; border-bottom: 1px solid #fcd34d; font-size: 14px; text-transform: uppercase;">6. RANKING SECTORIAL REAL (TOP 5)</h3>
                    <p style="font-size: 11px; margin-bottom: 10px;"><strong>Fuente del Ranking:</strong> [Forbes / Fortune / Statista / Gartner] (Año: [Año])</p>
                    
                    <table style="width:100%; border-collapse: collapse; font-size: 11px;">
                        <tr style="border-bottom: 1px solid #d97706;">
                            <th style="text-align:left;">#</th>
                            <th style="text-align:left;">Empresa Líder</th>
                            <th style="text-align:right;">Cuota / Ingresos (Ref)</th>
                        </tr>
                        <tr><td>1</td><td>[Líder 1]</td><td style="text-align:right;">[Dato]</td></tr>
                        <tr><td>2</td><td>[Líder 2]</td><td style="text-align:right;">[Dato]</td></tr>
                        <tr><td>3</td><td>[Líder 3]</td><td style="text-align:right;">[Dato]</td></tr>
                        <tr><td>4</td><td>[Líder 4]</td><td style="text-align:right;">[Dato]</td></tr>
                        <tr><td>5</td><td>[Líder 5]</td><td style="text-align:right;">[Dato]</td></tr>
                    </table>

                    <div style="margin-top: 15px; padding-top: 10px; border-top: 1px dashed #d97706;">
                        <strong>POSICIÓN DE [EMPRESA]:</strong> 
                        <span style="font-weight: bold; font-size: 14px; color: #b45309;">[Posición Exacta o "Fuera del Top 5"]</span>
                        <br/>
                        <span style="font-size: 11px;">Contexto: [Cuota de mercado comparativa o razón de su posición]</span>
                    </div>
                </div>

                <div style="margin-top: 30px; font-size: 9px; color: #666; text-align: center; border-top: 1px solid #ccc; padding-top: 10px;">
                    Informe generado mediante búsqueda web activa en tiempo real. Verifique precios y cargos directivos en fuentes oficiales.
                </div>
            </div>`,

            ITEM_8: `
            <div style="color: #000000; font-family: 'Times New Roman', serif;">
                <!-- ENCABEZADO TIPO INFORME BANCA INVERSION -->
                <div style="border-bottom: 4px solid #1e3a8a; padding-bottom: 10px; margin-bottom: 20px;">
                    <h1 style="color: #1e3a8a; font-size: 24px; text-transform: uppercase; margin: 0;">Equity Research: Coverage Initiation</h1>
                    <p style="font-size: 12px; color: #555; margin-top: 5px;"><strong>ANALISTA SENIOR:</strong> iA Hedge Fund Manager | <strong>FUENTES:</strong> SEC Filings, Earnings Call, Market Data</p>
                </div>

                <!-- SECCIÓN 1: RESUMEN EJECUTIVO Y TESIS -->
                <div style="background-color: #f8fafc; border: 1px solid #1e3a8a; padding: 15px; margin-bottom: 20px;">
                    <h3 style="color: #1e3a8a; margin-top: 0; border-bottom: 1px solid #ccc;">1. RESUMEN EJECUTIVO Y TESIS DE INVERSIÓN</h3>
                    <p><strong>Recomendación:</strong> [Strong Buy / Buy / Hold / Sell] | <strong>Convicción:</strong> [Alta/Media/Baja]</p>
                    <p><strong>Precio Objetivo (12 meses):</strong> [Precio] (Upside/Downside: [%])</p>
                    <p><strong>Elevator Pitch (La Tesis en 3 frases):</strong> [Resumen contundente]</p>
                    <p><strong>Catalizador Principal:</strong> [Motivo principal de compra]</p>
                    <p><strong>Riesgo Principal (Bear Case):</strong> [Motivo principal de venta]</p>
                </div>

                <!-- SECCIÓN 2: DESCRIPCIÓN DEL NEGOCIO -->
                <h3 style="color: #1e3a8a; border-bottom: 2px solid #ccc; text-transform: uppercase; margin-top: 25px;">2. FUNDAMENTOS DEL NEGOCIO</h3>
                <p><strong>Modelo de Negocio:</strong> [Explicación sencilla]</p>
                <p><strong>Desglose de Ingresos (%):</strong> [Segmentos / Geografía]</p>
                <p><strong>Ventaja Competitiva (Moat):</strong> [Frase única definitoria]</p>

                <!-- SECCIÓN 3: DATOS FINANCIEROS CLAVE -->
                <h3 style="color: #1e3a8a; border-bottom: 2px solid #ccc; text-transform: uppercase; margin-top: 25px;">3. SNAPSHOT FINANCIERO (TTM y Último Q)</h3>
                <table style="width:100%; border-collapse: collapse; font-size: 11px; border: 1px solid #999;">
                    <tr style="background:#e2e8f0; font-weight:bold;"><th>Métrica</th><th>Valor Real</th><th>Fuente/Fecha</th></tr>
                    <tr><td>Ingresos (Revenue)</td><td>[Dato] (Crecimiento YoY: [%])</td><td>[Cita]</td></tr>
                    <tr><td>Ingreso Neto & EPS</td><td>[Dato]</td><td>[Cita]</td></tr>
                    <tr><td>Ratios Valoración (P/E, Forward P/E, PEG)</td><td>[Datos]</td><td>[Cita]</td></tr>
                    <tr><td>Deuda Total & Ratio D/E</td><td>[Datos]</td><td>[Cita]</td></tr>
                    <tr><td>Free Cash Flow (TTM)</td><td>[Dato]</td><td>[Cita]</td></tr>
                </table>

                <!-- SECCIÓN 4: RENDIMIENTO Y CONSENSO -->
                <h3 style="color: #1e3a8a; border-bottom: 2px solid #ccc; text-transform: uppercase; margin-top: 25px;">4. MERCADO Y CONSENSO</h3>
                <div style="display: flex; gap: 15px;">
                    <div style="flex: 1;">
                        <strong>Performance vs S&P 500:</strong>
                        <ul style="font-size: 11px;">
                            <li>1 Mes / 3 Meses: [Dato] / [Dato]</li>
                            <li>YTD / 1 Año: [Dato] / [Dato]</li>
                            <li>Vs Benchmark: [Mejor/Peor por %]</li>
                            <li>Rango 52 Semanas: [Min - Max]</li>
                        </ul>
                    </div>
                    <div style="flex: 1;">
                        <strong>Consenso Wall Street:</strong>
                        <ul style="font-size: 11px;">
                            <li>Analistas: [Num] (Buy: X | Hold: X | Sell: X)</li>
                            <li>Precio Objetivo: [Bajo] - [Medio] - [Alto]</li>
                            <li>Última Revisión: [Firma y Fecha]</li>
                        </ul>
                    </div>
                </div>
                <div style="margin-top: 10px; font-size: 11px;">
                    <strong>Actividad Institucional:</strong> [Top 5 inversores y cambios recientes (Hedge Funds)]
                </div>

                <!-- SECCIÓN 5: ANÁLISIS PROFUNDO ESTADOS FINANCIEROS (EL CORE) -->
                <h3 style="color: #1e3a8a; border-bottom: 2px solid #ccc; text-transform: uppercase; margin-top: 25px;">5. ANÁLISIS DE ESTADOS FINANCIEROS (DEEP DIVE)</h3>
                
                <h4 style="margin-bottom: 5px; color: #444;">A. Cuenta de Resultados (Income Statement)</h4>
                <p style="font-size: 11px;"><strong>Tendencia Márgenes (Bruto/Operativo/Neto):</strong> [¿Expansión o Contracción? Datos Q a Q]</p>
                <p style="font-size: 11px;"><strong>Gasto I+D (si aplica):</strong> [% sobre ingresos]</p>

                <h4 style="margin-bottom: 5px; color: #444;">B. Salud del Balance (Balance Sheet)</h4>
                <ul style="font-size: 11px;">
                    <li><strong>Liquidez:</strong> Ratio Corriente [X] | Ratio Rápido [X] | Caja Disponible [X]</li>
                    <li><strong>Deuda:</strong> Total [X] | <strong>Calendario Vencimientos:</strong> [¿Cuándo vence la deuda principal?]</li>
                    <li><strong>Intangibles:</strong> Fondo de Comercio (Goodwill) vs Activos Totales: [%] (Alerta si >30%)</li>
                </ul>

                <h4 style="margin-bottom: 5px; color: #444;">C. Calidad del Flujo de Caja (Cash Flow)</h4>
                <ul style="font-size: 11px;">
                    <li><strong>OCF vs CapEx = FCF:</strong> [Dato OCF] - [Dato CapEx] = [Dato FCF]</li>
                    <li><strong>Margen FCF:</strong> [%]</li>
                    <li><strong>Uso del Efectivo:</strong> [¿Recompras, Dividendos o M&A?]</li>
                </ul>

                <!-- SECCIÓN 6: SEÑALES DE ALERTA (RED FLAGS) -->
                <div style="background-color: #fef2f2; border: 1px solid #ef4444; padding: 10px; margin-top: 15px;">
                    <h4 style="color: #b91c1c; margin: 0 0 5px 0; text-transform: uppercase;">⚠️ Auditoría de Riesgos (Red Flags Check)</h4>
                    <ul style="font-size: 11px; margin: 0; padding-left: 20px; color: #7f1d1d;">
                        <li>¿Ingresos suben pero Flujo de Caja baja?: <strong>[SÍ/NO y Análisis]</strong></li>
                        <li>¿Deuda creciendo más rápido que ingresos?: <strong>[SÍ/NO y Análisis]</strong></li>
                        <li>¿Cuentas por cobrar > Crecimiento Ventas?: <strong>[SÍ/NO y Análisis]</strong></li>
                        <li>¿Inventarios acumulándose?: <strong>[SÍ/NO y Análisis]</strong></li>
                        <li>¿Ganancias Ajustadas (Non-GAAP) muy lejos de GAAP?: <strong>[Análisis]</strong></li>
                    </ul>
                </div>

                <!-- SECCIÓN 7: RESULTADOS TRIMESTRALES (EARNINGS) -->
                <h3 style="color: #1e3a8a; border-bottom: 2px solid #ccc; text-transform: uppercase; margin-top: 25px;">6. REVISIÓN DE RESULTADOS (EARNINGS)</h3>
                <table style="width:100%; border-collapse: collapse; font-size: 11px;">
                    <tr style="border-bottom: 1px solid #ccc;"><td><strong>Sorpresa (Beat/Miss):</strong></td><td>Ingresos: [Dato] | EPS: [Dato]</td></tr>
                    <tr style="border-bottom: 1px solid #ccc;"><td><strong>Guía (Guidance):</strong></td><td>[¿Elevada/Reducida? Rango próximo Q/Año]</td></tr>
                    <tr style="border-bottom: 1px solid #ccc;"><td><strong>Segmentos:</strong></td><td>[Ganadores vs Perdedores]</td></tr>
                </table>
                <p style="font-size: 11px; margin-top: 5px;"><strong>Mensaje Directiva (Tono/Transcript):</strong> "[Cita clave CEO/CFO sobre estrategia/riesgo]"</p>
                <p style="font-size: 11px;"><strong>Reacción Mercado:</strong> [Movimiento After-hours/Día siguiente]</p>

                <!-- SECCIÓN 8: CONTEXTO COMPETITIVO -->
                <h3 style="color: #1e3a8a; border-bottom: 2px solid #ccc; text-transform: uppercase; margin-top: 25px;">7. COMPARATIVA SECTORIAL (PEER ANALYSIS)</h3>
                <table style="width:100%; border-collapse: collapse; font-size: 10px; border: 1px solid #ccc; text-align: center;">
                    <tr style="background:#e2e8f0; font-weight:bold;">
                        <th style="text-align: left;">Empresa</th><th>Mkt Cap</th><th>Crecimiento</th><th>Márgenes (Op/Net)</th><th>P/E</th><th>EV/EBITDA</th><th>Deuda/Eq</th>
                    </tr>
                    <tr style="font-weight:bold; background: #eff6ff;"><td style="text-align: left;">[ESTA EMPRESA]</td><td>[Dato]</td><td>[Dato]</td><td>[Dato]</td><td>[Dato]</td><td>[Dato]</td><td>[Dato]</td></tr>
                    <tr><td style="text-align: left;">[Competidor 1]</td><td>[Dato]</td><td>[Dato]</td><td>[Dato]</td><td>[Dato]</td><td>[Dato]</td><td>[Dato]</td></tr>
                    <tr><td style="text-align: left;">[Competidor 2]</td><td>[Dato]</td><td>[Dato]</td><td>[Dato]</td><td>[Dato]</td><td>[Dato]</td><td>[Dato]</td></tr>
                    <tr><td style="text-align: left;">[Competidor 3]</td><td>[Dato]</td><td>[Dato]</td><td>[Dato]</td><td>[Dato]</td><td>[Dato]</td><td>[Dato]</td></tr>
                </table>
                <p style="font-size: 11px; margin-top: 5px;"><strong>Ranking Competitivo:</strong> [¿Quién gana cuota de mercado? ¿Líder de costes o diferenciación?]</p>

                <!-- SECCIÓN 9: VALORACIÓN Y ESCENARIOS -->
                <h3 style="color: #1e3a8a; border-bottom: 2px solid #ccc; text-transform: uppercase; margin-top: 25px;">8. MODELO DE VALORACIÓN (DCF & MÚLTIPLOS)</h3>
                <div style="background-color: #f8fafc; padding: 10px; border: 1px solid #ccc;">
                    <p><strong>1. DCF (Descuento Flujos Caja):</strong> WACC [X%] | Tasa Terminal [X%] | Crecimiento Est. [X%]</p>
                    <p style="font-size: 14px; font-weight: bold; color: #1e3a8a;">→ VALOR INTRÍNSECO ESTIMADO: [PRECIO]</p>
                    <p><strong>2. Comparativa Histórica:</strong> P/E Actual vs Media 5 años [Dato]. [¿Prima o Descuento?]</p>
                </div>
                
                <h4 style="margin-top: 10px; margin-bottom: 5px;">Análisis de Escenarios (Precio Objetivo):</h4>
                <table style="width:100%; border-collapse: collapse; font-size: 11px; border: 1px solid #ccc;">
                    <tr style="background:#f1f5f9;"><th>Escenario</th><th>Precio Obj.</th><th>Upside/Downside</th><th>Supuestos Clave</th></tr>
                    <tr style="color:#166534;"><td><strong>CASO ALCISTA (Bull)</strong></td><td>[Precio]</td><td>[%]</td><td>[Crecimiento acelerado, expansión márgenes]</td></tr>
                    <tr style="color:#1e40af; font-weight:bold;"><td><strong>CASO BASE</strong></td><td>[Precio]</td><td>[%]</td><td>[Consenso y supuestos actuales]</td></tr>
                    <tr style="color:#991b1b;"><td><strong>CASO BAJISTA (Bear)</strong></td><td>[Precio]</td><td>[%]</td><td>[Desaceleración, compresión múltiplos, riesgos]</td></tr>
                </table>

                <!-- SECCIÓN 10: RIESGOS Y CONCLUSIÓN -->
                <h3 style="color: #1e3a8a; border-bottom: 2px solid #ccc; text-transform: uppercase; margin-top: 25px;">9. RIESGOS Y VEREDICTO FINAL</h3>
                <ul style="font-size: 11px;">
                    <li><strong>Riesgo 1 (Probabilidad/Impacto):</strong> [Detalle]</li>
                    <li><strong>Riesgo 2 (Probabilidad/Impacto):</strong> [Detalle]</li>
                    <li><strong>Short Interest:</strong> [% del Float] | <strong>Insider Trading:</strong> [Compras/Ventas recientes]</li>
                </ul>
                <div style="background-color: #eff6ff; border-left: 5px solid #1e3a8a; padding: 15px; margin-top: 20px;">
                    <h4 style="margin: 0; color: #1e3a8a;">VEREDICTO FINAL DEL ANALISTA</h4>
                    <p style="margin-top: 5px;"><strong>[Resumen final de la recomendación con nivel de convicción, ponderando el valor intrínseco calculado frente a los riesgos detectados]</strong></p>
                </div>

                <div style="margin-top: 30px; font-size: 9px; color: #666; text-align: center; border-top: 1px solid #ccc; padding-top: 10px;">
                    Documento generado por IA. Las cifras citadas provienen de informes públicos (SEC/CNMV) y bases de datos financieras. Verifique siempre con fuentes oficiales.
                </div>
            </div>`
    };


    // --- FUNCIONES DE SOPORTE ---
    const askGemini = async (key, prompt) => {
        if (!key) throw new Error("Falta API Key");
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=${key}`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], tools: [{ google_search: {} }] })
        });
        const data = await response.json();
        if (data.error) throw new Error(data.error.message);
        return data.candidates?.[0]?.content?.parts?.[0]?.text || "";
    };

    // UTILIDAD DE EXTRACCIÓN (RESTAURADA ORIGINAL PARA EVITAR ERRORES EN SCREENER)
    const extractJSON = (text) => { 
        if (!text) return null;
        try {
            const match = text.match(/(\{[\s\S]*\}|\[[\s\S]*\])/);
            if (match && match[0]) {
                return JSON.parse(match[0]);
            }
            throw new Error("No se encontró una estructura JSON válida en la respuesta.");
        } catch (e) { 
            console.error("EXTRACT JSON ERROR. Raw Text:", text);
            return null; 
        } 
    };

    const formatN = (v, dec = 2) => {
        let n = parseFloat(v) || 0;
        return n.toFixed(dec).replace('.', ',');
    };

    const checkCriteria = (paramKey, value) => {
        const p = params[paramKey];
        if (!p.active) return "text-slate-400";
        const val = parseFloat(value);
        if (paramKey === 'roi' || paramKey === 'divYield') return val >= p.val ? "text-green-400 font-bold" : "text-red-400 font-bold";
        return val <= p.val ? "text-green-400 font-bold" : "text-red-400 font-bold";
    };

    const rotateSuggestions = (currentQ) => { 
        const base = ["Impacto en valoración", "Riesgos asociados", "Comparativa sectorial", "Proyección futura", "Movimientos Insider", "Análisis Técnico Profundo", "Catalizadores próximos"]; 
        const filtered = base.filter(q => q !== currentQ); 
        const randomSelection = filtered.sort(() => 0.5 - Math.random()).slice(0, 4); 
        setSuggestedQuestions(randomSelection); 
    };

    const cleanAIResponse = (text) => {
        if (!text) return "";
        let clean = text.trim();
        
        clean = clean.replace(/```html/g, '').replace(/```/g, '');

        const headerIndex = clean.indexOf('<h');
        const anyTagIndex = clean.indexOf('<');

        if (headerIndex !== -1) {
            return clean.substring(headerIndex);
        } else if (anyTagIndex !== -1) {
            return clean.substring(anyTagIndex);
        }

        return clean;
    };
    
    // ANÁLISIS SIMPLE Y PREGUNTA LIBRE (RESTAURADA LÓGICA ORIGINAL)
    const analyze = async () => { 
        if (!apiKey) return setStatusModal({ isOpen: true, title: 'Error', msg: 'Falta API Key', type: 'error' }); 
        if (!ticker) return setStatusModal({ isOpen: true, title: 'Aviso', msg: 'Introduce un Ticker', type: 'info' }); 
        setLoading(true); setSpecificAnswer(null); setData(null); 
        try { 
            if (question.trim()) { 
                const today = new Date().toLocaleString('es-ES');
                const prompt = `ROL: ERES UN ANALISTA SENIOR BURSÁTIL DE WALL STREET. LENGUAJE DE SALIDA: SOLO ESPAÑOL(CASTELLANO), SI EL CONTENIDO ESTÁ EN OTRO IDIOMA TRADÚCELO. NO GENERES PREÁMBULOS NI MENSAJES DE CORTESÍA INICIALES.JAMÁS INVENTES DATOS, UTILIZA LA BÚSQUEDA ACTIVA EN INTERNET
                FECHA ACTUAL (úsala para buscar los datos más recientes): ${today}. 
                PREGUNTA: Answer "${question}" about "${ticker}". 
                FORMATO: HTML (<h3>, <ul>, <p>). COMIENZA DIRECTAMENTE EN LOS HTML TAGS (<).`; 
                const res = await askGemini(apiKey, prompt); 
                setSpecificAnswer(cleanAIResponse(res)); 
                rotateSuggestions(question); 
            } else { 
                const prompt = `ROL: Analista Senior de Wall Street. TASK: Genera un informe comprensible de investimiento para el ticker "${ticker}" buscando de forma activa en Internet. SALIDA: JSON Solo en formato estricto. LANGUAGE: ESPAÑOL. Traduce todo los términos anglosajones al Castellano (e.g., Yield -> Rentabilidad, Hold -> Mantener). 
                JSON STRUCTURE: { 
                    "company": "Name", "current_price": number, "intrinsic_value": number, "forecast_1y": number, "forecast_5y": number, "valuation_status": "Infravalorada/Sobrevalorada/Justa", "investment_verdict": "Detailed professional verdict (approx 60 words).", 
                    "technical_analysis": { "trend_short": "Alcista/Bajista/Lateral", "trend_long": "Alcista/Bajista", "supports": ["Price 1", "Price 2"], "resistances": ["Price 1", "Price 2"], "commentary": "Brief technical insight" }, 
                    "dividend_data": { "yield_percent": "x.xx%", "amount": "currency x.xx", "payout_ratio": "x%", "ex_date": "YYYY-MM-DD", "payment_date": "YYYY-MM-DD", "growth_streak": "x Years", "safety": "Alta/Media/Baja" }, 
                    "financial_health": { "revenue_growth_3y": "x%", "net_margin": "x%", "roe": "x%", "debt_to_equity": number, "free_cash_flow": "String (e.g. 2B)" }, 
                    "management": {"ceo": "Name", "ownership": "% Held"}, 
                    "capital": {"market_cap": "String", "shares_outstanding": "String"}, 
                    "competitors": { "per": {"stock": num, "industry": num}, "yield": {"stock": num, "industry": num} }, 
                    "fundamentals": {"per": num, "eps": num, "beta": num}, 
                    "pros_cons": { "pros": ["txt1", "txt2"], "cons": ["txt1", "txt2"] }, 
                    "peers": ["TICKER1", "TICKER2"], "suggested_questions": ["q1","q2","q3"] 
                }`; 
                const res = await askGemini(apiKey, prompt); 
                const json = extractJSON(res); 
                if(!json) throw new Error("La IA no devolvió un JSON válido. Revisa la consola para ver el texto crudo.");
                setData(json); 
                if(json.suggested_questions) setSuggestedQuestions(json.suggested_questions); 
            } 
        } catch (e) { setStatusModal({ isOpen: true, title: 'Error iA', msg: e.message, type: 'error' }); } finally { setLoading(false); } 
    };

    const handleFixedAnalysis = async (promptId) => {
        if (!apiKey) return setStatusModal({ isOpen: true, title: 'Error', msg: 'Falta API Key', type: 'error' }); 
        if (!ticker) return setStatusModal({ isOpen: true, title: 'Aviso', msg: 'Introduce un Ticker', type: 'info' }); 
        
        setLoading(true); 
        setSpecificAnswer(null); 
        setData(null);

        try {
            const today = new Date().toLocaleString('es-ES');
            
            // 1. Obtener precio (Llamada rápida)
            const priceFetchPrompt = `BUSCA EN INTERNET: Precio real actual de ${ticker}. Responde solo: "Precio: [X] [Divisa] | Fecha: [Fecha]"`;
            let priceInfo = "Buscando precio actualizado...";
            try { 
                const pRes = await askGemini(apiKey, priceFetchPrompt);
                priceInfo = pRes || "Precio no disponible";
            } catch(e) { priceInfo = "Error al conectar con el servidor de precios"; }

            const templateCode = HTML_TEMPLATES[promptId];
            
            // 2. Informe con Protocolo de Integridad
            const prompt = `
            SISTEMA: ROL ANALISTA SENIOR DE BOLSA EN WALL STREET. RECABA LOS DATOS DE FORMA ACTIVA EN INTERNET.
            TAREA: Auditar el ticker ${ticker}, a FECHA MÁS PRÓXIMA A (${today}), CON PRECIO ACTUAL DE ${priceInfo}.
            ESTILO: Se conciso pero a su vez explicando bien cada apartado con un lenguaje que una persona no muy experimentada en bolsa comprenda.
            
            FUENTES DE BÚSQUEDA PREFERIBLES (puedes usar otras):
            Investor Relations (Webs oficiales), Investing, marketscreener, MarketWatch, Google Finance, SEC.gov, Yahoo Finance, Finviz y SeekingAlpha.
            
            PREMISAS OBLIGATORIAS:
            1. PROHIBIDO INVENTAR: No uses valores de ejemplo.
            2. SI UN DATO NO SE LOCALIZA: Escribe "No encontré datos" y las URLs deben ser ejecutables al pinchar en ellas.
            3. TRADUCCIÓN: Todo el informe debe estar en ESPAÑOL.
            4. LOS CONCEPTOS TÉCNICOS (ROI, PER, PEG, etc) DEBEN SER EXPLICADOS PARA QUE ALGUIEN SIN CONOCIMIENTOS LOS COMPRENDA PREFERIBLENTE CERCA DE DONDE SE CITAN Y EN LETRA MÁS PEQUEÑA CON UN (*)
            
            DATOS CARTERA:
            ${templateCode}
            
            FORMATO: Responde solo con código HTML (h3, ul, li, p).
        `;

            const res = await askGemini(apiKey, prompt);
            
            const cleanBody = res.trim().replace(/```html/g, '').replace(/```/g, ''); 
            if (!cleanBody || cleanBody.length < 50) throw new Error("La IA no devolvió un informe válido.");

            const reportTitle = REPORT_TITLES[promptId] || "INFORME FINANCIERO";
            
            // Construcción del HTML final (FONDO BLANCO / TEXTO NEGRO / TÍTULO AZUL)
            const finalHtml = `
                <div style="background-color: #ffffff; color: #000000; padding: 0px;">
                    <div style="border-bottom: 3px solid #1e3a8a; padding-bottom: 10px; margin-bottom: 20px;">
                        <h2 style="color: #1e3a8a; margin: 0; font-size: 1.5rem; text-transform: uppercase;">${reportTitle}</h2>
                        <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-top: 8px;">
                            <div>
                                <span style="font-size: 1.2rem; font-weight: bold; color: #000;">${ticker}</span>
                            </div>
                            <div style="text-align: right; font-size: 0.75rem; color: #000; font-family: monospace;">
                                <div>${priceInfo}</div>
                                <div>GENERADO EL: ${today}</div>
                            </div>
                        </div>
                    </div>
                    <div class="report-body" style="color: #000000 !important;">
                        ${cleanBody}
                    </div>
                </div>
            `;
            
            setSpecificAnswer(finalHtml); 
        } catch (e) { 
            setStatusModal({ isOpen: true, title: 'Error Análisis', msg: e.message, type: 'error' }); 
        } finally { 
            setLoading(false); 
        }
    };

    // --- RASTREO (SCREENER) RESTAURADO AL ORIGINAL ---
    const runScreener = async () => {
        if (!apiKey) return setStatusModal({ isOpen: true, title: 'Error', msg: 'Falta API Key', type: 'error' });
        
        const marketObj = EXCHANGES.find(e => e.id === exchange);
        const marketDesc = marketObj ? marketObj.name : exchange;

        const activeFilters = Object.entries(params)
            .filter(([_, p]) => p.active)
            .map(([k, p]) => {
                if (k === 'roi') return `ROI > ${p.val}%`;
                if (k === 'divYield') return `Dividend Yield > ${p.val}%`;
                if (k === 'per') return `PER < ${p.val}`;
                if (k === 'peg') return `PEG < ${p.val}`;
                if (k === 'pb') return `P/B < ${p.val}`;
                if (k === 'debtEquity') return `Debt/Equity < ${p.val}`;
                return '';
            })
            .join(', ');

        if (!activeFilters) return setStatusModal({ isOpen: true, title: 'Aviso', msg: 'Por favor, activa al menos un parámetro.', type: 'info' });

        setLoading(true);
        try {
            const prompt = `
            YOU ARE A JSON GENERATOR MACHINE. YOU DO NOT SPEAK. YOU ONLY OUTPUT DATA.
            TASK: Generate a JSON Array of ${maxResults} stocks in "${marketDesc}" matching: ${activeFilters}.
            STRICT RULES:
            1. Use your knowledge to estimate current data.
            2. If exact matches are rare, include closest matches.
            3. OUTPUT MUST START WITH '[' AND END WITH ']'.
            4. NO PREAMBLE. NO EXPLANATIONS.
            OUTPUT FORMAT:
            [{"ticker":"SYM","name":"Name","price":1.0,"per":1.0,"peg":1.0,"roi":1.0,"divYield":1.0,"pb":1.0,"debtEquity":1.0}]
            `;
            
            const res = await askGemini(apiKey, prompt);
            const results = extractJSON(res);
            
            if (!results || !Array.isArray(results) || results.length === 0) {
                console.error("Failed to parse JSON array from:", res);
                throw new Error("Error leyendo datos. La IA devolvió texto en lugar de datos estructurados.");
            }
            setScreenerResults(results);
        } catch (e) {
            setStatusModal({ isOpen: true, title: 'Error de Rastreo', msg: e.message, type: 'error' });
        } finally { setLoading(false); }
    };

    const sortedScreenerResults = useMemo(() => {
        return [...screenerResults].sort((a, b) => {
            const dir = screenerSort.direction === 'asc' ? 1 : -1;
            const valA = a[screenerSort.key] || 0; const valB = b[screenerSort.key] || 0;
            if (typeof valA === 'string') return valA.localeCompare(valB) * dir;
            return (valA - valB) * dir;
        });
    }, [screenerResults, screenerSort]);

    const handlePrintScreener = () => {
        const printWindow = window.open('', '', 'height=800,width=1100');
        let html = `<html><head><title>Rastreo iA</title><style>body{font-family:sans-serif;padding:20px;font-size:10px;} h1{border-bottom:2px solid #333;} table{width:100%;border-collapse:collapse;margin-top:10px;} th,td{border:1px solid #ddd;padding:6px;text-align:right;} th{background:#f1f5f9;text-align:center;text-transform:uppercase;font-size:8px;} .left{text-align:left;}</style></head><body>`;
        html += `<h1>RASTREO DE ACTIVOS: ${EXCHANGES.find(e=>e.id===exchange)?.name || exchange}</h1><p><b>Filtros Activos:</b> ${Object.entries(params).filter(([_,p])=>p.active).map(([_,p])=>`${p.label}(${p.val})`).join(' | ')}</p><p>Fecha: ${new Date().toLocaleString()}</p>`;
        html += `<table><thead><tr><th>Ticker</th><th class="left">Nombre</th><th>Precio</th><th>PER</th><th>PEG</th><th>ROI</th><th>Yield</th><th>P/B</th><th>D/E</th></tr></thead><tbody>`;
        sortedScreenerResults.forEach(r => { html += `<tr><td><b>${r.ticker}</b></td><td class="left">${r.name}</td><td>${formatN(r.price)}</td><td>${r.per}</td><td>${r.peg}</td><td>${r.roi}%</td><td>${r.divYield}%</td><td>${r.pb}</td><td>${r.debtEquity}</td></tr>`; });
        html += `</tbody></table></body></html>`;
        printWindow.document.write(html); printWindow.document.close(); printWindow.print();
    };

    const handlePrintEstudio = () => { 
        const printWindow = window.open('', '', 'height=800,width=800'); 
        let html = `<html><head><title>Estudio Valor</title><style>
        body { font-family: sans-serif; padding: 20px; font-size: 10px; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        h1 { border-bottom: 2px solid #333; }
        /* Estilos específicos para el HTML generado por IA */
        h3 { color: #2563eb !important; border-bottom: 1px solid #ccc !important; padding-bottom: 5px; margin-top: 20px; text-transform: uppercase; font-size: 12px; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 9px; }
        th, td { border: 1px solid #ddd; padding: 6px; text-align: left; }
        th { background-color: #f1f5f9 !important; font-weight: bold; }
        ul { padding-left: 20px; margin-top:0; } li { margin-bottom: 4px; } b { color: #0f172a; }
        .ai-content { font-size: 11px; line-height: 1.5; }
        .grid { display: flex; gap: 10px; } .col { flex: 1; }
        </style></head><body>`; 
        
        html += `<h1>ESTUDIO: ${data ? data.company : ticker}</h1>`; 
        
        if(specificAnswer) {
            html += `<div class="ai-content">${specificAnswer}</div>`; 
        } else if(data) { 
            html += `<div style="border:1px solid #ddd; padding:10px; margin-bottom:10px;">PRECIO: <b>${data.current_price}</b> | VALOR: <b>${data.intrinsic_value}</b> | STATUS: <b>${data.valuation_status}</b><br/><br/>VEREDICTO: ${data.investment_verdict}</div>`; 
            html += `<div class="grid"><div class="col"><h3>Fundamental</h3><ul><li>PER: ${data.fundamentals?.per}</li><li>EPS: ${data.fundamentals?.eps}</li><li>Beta: ${data.fundamentals?.beta}</li></ul></div><div class="col"><h3>Dividendo</h3><ul><li>Yield: ${data.dividend_data?.yield_percent}</li><li>Payout: ${data.dividend_data?.payout_ratio}</li></ul></div></div>`;
            html += `<h3>Pros / Contras</h3><div class="grid"><div class="col"><ul>${(data.pros_cons?.pros||[]).map(p=>`<li>${p}</li>`).join('')}</ul></div><div class="col"><ul>${(data.pros_cons?.cons||[]).map(p=>`<li>${p}</li>`).join('')}</ul></div></div>`;
        } 
        html += `</body></html>`; 
        printWindow.document.write(html); printWindow.document.close(); setTimeout(() => printWindow.print(), 500); 
    };

    const ParamCard = ({ id, config }) => (
        <div className={`flex flex-col gap-2 p-4 rounded-2xl border transition-all ${config.active ? 'bg-slate-900/60 border-blue-500/50 shadow-lg shadow-blue-900/10' : 'bg-slate-900/20 border-slate-800 opacity-60 grayscale'}`}>
            <div className="flex justify-between items-center pb-2 border-b border-white/5">
                <div className="flex items-center gap-2">
                    <input type="checkbox" checked={config.active} onChange={() => setParams(prev => ({...prev, [id]: {...config, active: !config.active}}))} className="custom-checkbox w-4 h-4" />
                    <span className={`text-[10px] font-black uppercase ${config.active ? 'text-blue-300' : 'text-slate-500'}`}>{config.label}</span>
                </div>
                {config.active && <span className="text-sm font-mono font-black text-white">{config.val}{config.label.includes('%') ? '%' : ''}</span>}
            </div>
            {config.active && (
                <div className="flex items-center gap-3 my-1">
                    <button onClick={() => setParams(prev => ({...prev, [id]: {...config, val: Math.max(config.min, Number((config.val - config.step).toFixed(2)))}}))} className="w-8 h-8 bg-slate-800 rounded-lg hover:bg-slate-700 text-white font-bold shadow-inner flex items-center justify-center">-</button>
                    <input type="range" min={config.min} max={config.max} step={config.step} value={config.val} onChange={e => setParams(prev => ({...prev, [id]: {...config, val: parseFloat(e.target.value)}}))} className="flex-1 accent-blue-500 h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer" />
                    <button onClick={() => setParams(prev => ({...prev, [id]: {...config, val: Math.min(config.max, Number((config.val + config.step).toFixed(2)))}}))} className="w-8 h-8 bg-slate-800 rounded-lg hover:bg-slate-700 text-white font-bold shadow-inner flex items-center justify-center">+</button>
                </div>
            )}
            <p className="text-[9px] text-slate-500 italic leading-snug mt-1">{config.help}</p>
        </div>
    );

    const calcUpside = (t, c) => (!t || !c) ? 0 : ((t - c) / c) * 100;
    const getComparisonVerdict = (metric, sVal, iVal) => { if(!sVal || !iVal) return ""; if(metric === 'yield') return sVal > iVal ? "✅ Mejor" : "❌ Peor"; return sVal < iVal ? "✅ Mejor" : "❌ Peor"; };

    return (
        <div className="h-full flex flex-col p-4 md:p-6 overflow-y-auto custom-scrollbar relative bg-[#0a0a0a]">
            {loading && <div className="fixed inset-0 z-[150] bg-black/80 backdrop-blur-md flex flex-col items-center justify-center"><Icons.Loader size={60} className="text-blue-500 mb-4 animate-spin" /><div className="text-xl font-bold text-white animate-pulse">Analizando Mercado Global...</div></div>}

            {statusModal.isOpen && (
                <div className="fixed inset-0 z-[200] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 fade-in">
                    <div className="bg-slate-900 border border-slate-700 p-6 rounded-2xl max-w-sm w-full shadow-2xl relative">
                        <div className={`w-12 h-12 rounded-full flex items-center justify-center mb-4 mx-auto ${statusModal.type==='error'?'bg-red-500/20 text-red-500':statusModal.type==='warning'?'bg-yellow-500/20 text-yellow-500':'bg-blue-500/20 text-blue-400'}`}>
                            {statusModal.type==='error'?<Icons.AlertCircle size={28}/>:<Icons.CheckCircle size={28}/>}
                        </div>
                        <h3 className="text-lg font-bold text-center text-white mb-2">{statusModal.title}</h3>
                        <p className="text-sm text-slate-400 text-center mb-6 leading-relaxed whitespace-pre-wrap">{statusModal.msg}</p>
                        <button onClick={() => setStatusModal({isOpen: false})} className="w-full bg-slate-800 hover:bg-slate-700 py-3 rounded-xl font-bold uppercase text-xs text-white transition-colors border border-slate-600">Cerrar</button>
                    </div>
                </div>
            )}

            <div className="flex gap-2 mb-6 bg-slate-900 p-1 rounded-xl border border-slate-800 w-fit shrink-0 shadow-lg">
                <button onClick={() => setActiveSubTab('estudio')} className={`px-8 py-2.5 rounded-lg text-xs font-bold uppercase transition-all ${activeSubTab === 'estudio' ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-500 hover:text-white'}`}>Estudio Individual</button>
                <button onClick={() => setActiveSubTab('rastreo')} className={`px-8 py-2.5 rounded-lg text-xs font-bold uppercase transition-all ${activeSubTab === 'rastreo' ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-500 hover:text-white'}`}>Rastreo de Mercado</button>
            </div>

            {activeSubTab === 'estudio' ? (
                <div className="flex flex-col gap-6 fade-in max-w-6xl mx-auto w-full pb-10">
                    <div className="flex flex-col gap-6 shrink-0 bg-slate-900/50 p-6 rounded-2xl border border-slate-800 shadow-xl">
                        <div className="flex gap-4"><div className="flex-1 relative"><Icons.Search className="absolute left-3 top-3.5 text-slate-500" size={18}/><input type="text" value={ticker} onChange={e => setTicker(e.target.value.toUpperCase())} placeholder="Introduce Ticker (Ej: AAPL, SAN.MC, TSLA...)" className="w-full bg-slate-950 border border-slate-700 rounded-xl py-3.5 pl-10 pr-4 text-white font-bold tracking-widest text-sm" /></div><button onClick={analyze} disabled={loading || !ticker} className="bg-blue-600 px-8 rounded-xl font-black flex items-center gap-2 shadow-lg hover:bg-blue-500 transition-colors text-xs text-white">{loading ? <Icons.Loader/> : <Icons.Wand/>} ANALIZAR</button><button onClick={() => { setTicker(''); setQuestion(''); setData(null); setSpecificAnswer(null); }} className="bg-slate-700 px-4 rounded-xl font-bold text-white hover:bg-slate-600 transition-colors text-xs border border-slate-600">BORRAR</button></div>
                        
                        <div className="relative"><Icons.MessageCircle className="absolute left-3 top-3 text-slate-500" size={18}/><input type="text" value={question} onChange={e => setQuestion(e.target.value)} placeholder="¿Tienes alguna pregunta específica sobre este valor?" className="w-full bg-slate-950 border border-slate-700 rounded-xl py-3 pl-10 pr-4 text-xs text-white" /></div>
                        
                        <div className="flex gap-2 overflow-x-auto pb-2 custom-scrollbar">
                            {suggestedQuestions.map((q, i) => (
                                <button key={i} onClick={() => setQuestion(q)} className="whitespace-nowrap px-4 py-2 bg-slate-800 border border-slate-700 rounded-full text-[10px] text-slate-400 hover:text-white hover:bg-slate-700 transition-colors shadow-sm">{q}</button>
                            ))}
                        </div>
                        
                        <div className="mt-4 pt-4 border-t border-slate-800">
                             <div className="flex justify-between items-end mb-3">
                                <h4 className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Análisis Profundo (Búsqueda Activa en Web)</h4>
                                <span className="text-[9px] text-orange-500 font-bold italic">(*) Si el informe está vacío o es inconsistente, inténtelo de nuevo pasado un minuto.</span>
                             </div>
                             <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                                 <button onClick={() => handleFixedAnalysis('ITEM_1')} className="bg-slate-800 hover:bg-blue-900/40 text-slate-300 hover:text-white border border-slate-700 p-3 rounded-lg text-xs font-bold flex items-center gap-2 transition-all"><Icons.ChartBar size={14}/> Análisis Completo</button>
                                 <button onClick={() => handleFixedAnalysis('ITEM_2')} className="bg-slate-800 hover:bg-blue-900/40 text-slate-300 hover:text-white border border-slate-700 p-3 rounded-lg text-xs font-bold flex items-center gap-2 transition-all"><Icons.PieChart size={14}/> Estados Financieros</button>
                                 <button onClick={() => handleFixedAnalysis('ITEM_3')} className="bg-slate-800 hover:bg-blue-900/40 text-slate-300 hover:text-white border border-slate-700 p-3 rounded-lg text-xs font-bold flex items-center gap-2 transition-all"><Icons.TrendingUp size={14}/> Resultados Trimestrales</button>
                                 <button onClick={() => handleFixedAnalysis('ITEM_4')} className="bg-slate-800 hover:bg-blue-900/40 text-slate-300 hover:text-white border border-slate-700 p-3 rounded-lg text-xs font-bold flex items-center gap-2 transition-all"><Icons.Target size={14}/> Comparativa Sector</button>
                                 <button onClick={() => handleFixedAnalysis('ITEM_5')} className="bg-slate-800 hover:bg-blue-900/40 text-slate-300 hover:text-white border border-slate-700 p-3 rounded-lg text-xs font-bold flex items-center gap-2 transition-all"><Icons.DollarSign size={14}/> Valoración (DCF)</button>
                                 <button onClick={() => handleFixedAnalysis('ITEM_6')} className="bg-slate-800 hover:bg-blue-900/40 text-slate-300 hover:text-white border border-slate-700 p-3 rounded-lg text-xs font-bold flex items-center gap-2 transition-all"><Icons.AlertCircle size={14}/> Riesgos y Alertas</button>
                                 <button onClick={() => handleFixedAnalysis('ITEM_7')} className="col-span-2 md:col-span-3 bg-gradient-to-r from-emerald-900 to-slate-900 hover:from-emerald-800 hover:to-slate-800 text-white border border-emerald-500/50 p-3 rounded-xl text-xs font-black flex items-center justify-center gap-3 transition-all shadow-lg shadow-emerald-900/20 mt-2 uppercase tracking-widest group">
                                     <Icons.Globe size={16} className="text-emerald-300"/> Conoce la Historia de la Empresa
                                 </button>
                                 <button onClick={() => handleFixedAnalysis('ITEM_8')} className="col-span-2 md:col-span-3 bg-gradient-to-r from-[#1e3a8a] to-[#1e293b] hover:from-blue-800 hover:to-slate-800 text-white border border-blue-400/30 p-4 rounded-xl text-sm font-black flex items-center justify-center gap-3 transition-all shadow-xl shadow-blue-900/20 mt-3 uppercase tracking-widest relative overflow-hidden group">
                                     <div className="absolute inset-0 bg-white/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                     <Icons.Globe size={18} className="text-blue-300"/> Informe Libre Extendido (Senior Analyst Deep Dive)
                                 </button>
                            </div>
                        </div>
                    </div>

                       {(specificAnswer || data) && (
                        <div className="mt-6 shadow-2xl rounded-2xl overflow-hidden fade-in relative">
                             {/* CABECERA CON BOTÓN IMPRIMIR */}
                             <div className="bg-slate-800 p-3 flex justify-between items-center border-b border-slate-700">
                                <span className="text-white text-[10px] font-black uppercase tracking-widest flex items-center gap-2">
                                    <Icons.Target size={14} className="text-blue-400"/> 
                                    Resultado del Análisis iA
                                </span>
                                <button onClick={handlePrintEstudio} className="bg-blue-600 hover:bg-blue-500 text-white px-4 py-1.5 rounded text-xs font-bold flex gap-2 items-center transition-colors">
                                    <Icons.ExternalLink size={14}/> IMPRIMIR / PDF
                                </button>
                             </div>

                             {/* CASO 1: RESPUESTA DE LOS 6 BOTONES (BLANCO Y NEGRO PURO) */}
                             {specificAnswer && ( 
                                <div className="bg-white p-6 md:p-10" style={{ backgroundColor: '#ffffff' }}>
                                    {/* CSS PARA ASEGURAR QUE NADA SEA GRIS CLARO */}
                                    <style>{`
                                        .report-container-white * { color: #000000 !important; border-color: #000000 !important; }
                                        .report-container-white h3 { color: #1e3a8a !important; font-size: 1.1rem; font-weight: 700; margin-top: 1.2rem; margin-bottom: 0.5rem; }
                                        .report-container-white p { margin-bottom: 0.8rem; text-align: justify; }
                                        .report-container-white li { margin-bottom: 0.3rem; }
                                    `}</style>
                                    <div 
                                        className="report-container-white" 
                                        dangerouslySetInnerHTML={{__html: specificAnswer}}
                                    ></div> 
                                </div> 
                             )}

                             {/* CASO 2: ANÁLISIS POR DEFECTO / JSON (MANTIENE ESTILO OSCURO) */}
                             {data && !specificAnswer && (
                                  <div className="glass-panel p-6 border-slate-700 bg-slate-900/30">
                                      <div className="space-y-6 pb-2">
                                          <div className="flex justify-between items-start mb-6">
                                              <div>
                                                  <h2 className="text-3xl font-display font-bold text-white mb-1">{data.company}</h2>
                                                  <div className={`inline-block px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-wider ${(data.valuation_status || '').includes('Infra') ? 'bg-green-500/20 text-green-400' : (data.valuation_status || '').includes('Sobre') ? 'bg-red-500/20 text-red-400' : 'bg-yellow-500/20 text-yellow-400'}`}>{data.valuation_status}</div>
                                              </div>
                                              <div className="text-right">
                                                  <div className="text-[9px] text-slate-500 uppercase font-bold">Cotización Actual</div>
                                                  <div className="text-3xl font-black text-white font-mono">{formatN(data.current_price)}</div>
                                              </div>
                                          </div>
                                          
                                          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                              <div className="bg-slate-900/60 p-4 rounded-xl border border-purple-500/30 relative overflow-hidden">
                                                  <div className="absolute top-0 right-0 p-2 opacity-10"><Icons.Target size={40}/></div>
                                                  <div className="text-[9px] text-purple-300 uppercase font-bold mb-1">Valor Intrínseco (Hoy)</div>
                                                  <div className="flex items-baseline gap-2">
                                                      <span className="text-2xl font-black text-purple-400 font-mono">{formatN(data.intrinsic_value)}</span>
                                                      <span className={`text-xs font-bold ${data.intrinsic_value > data.current_price ? 'text-green-400' : 'text-red-400'}`}>
                                                          {calcUpside(data.intrinsic_value, data.current_price) > 0 ? '+' : ''}{formatN(calcUpside(data.intrinsic_value, data.current_price))}%
                                                      </span>
                                                  </div>
                                              </div>
                                              <div className="bg-slate-900/40 p-4 rounded-xl border border-slate-700">
                                                  <div className="text-[9px] text-slate-400 uppercase font-bold mb-1">Estimación 1 Año</div>
                                                  <div className="flex items-baseline gap-2">
                                                      <span className="text-xl font-bold text-slate-200 font-mono">{formatN(data.forecast_1y)}</span>
                                                      <span className={`text-[10px] font-bold ${data.forecast_1y > data.current_price ? 'text-green-500' : 'text-red-500'}`}>
                                                          {calcUpside(data.forecast_1y, data.current_price) > 0 ? '+' : ''}{formatN(calcUpside(data.forecast_1y, data.current_price))}%
                                                      </span>
                                                  </div>
                                              </div>
                                              <div className="bg-slate-900/40 p-4 rounded-xl border border-slate-700">
                                                  <div className="text-[9px] text-slate-400 uppercase font-bold mb-1">Estimación 5 Años</div>
                                                  <div className="flex items-baseline gap-2">
                                                      <span className="text-xl font-bold text-slate-200 font-mono">{formatN(data.forecast_5y)}</span>
                                                      <span className={`text-[10px] font-bold ${data.forecast_5y > data.current_price ? 'text-green-500' : 'text-red-500'}`}>
                                                          {calcUpside(data.forecast_5y, data.current_price) > 0 ? '+' : ''}{formatN(calcUpside(data.forecast_5y, data.current_price))}%
                                                      </span>
                                                  </div>
                                              </div>
                                          </div>

                                          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                              <div className="bg-slate-900/50 border border-slate-800 p-5 rounded-2xl">
                                                  <h3 className="text-sm font-bold text-blue-400 mb-4 flex items-center gap-2"><Icons.DollarSign size={16}/> Dividendos y Rentabilidad</h3>
                                                  <div className="space-y-3">
                                                      <div className="flex justify-between border-b border-slate-800 pb-2"><span className="text-xs text-slate-500 uppercase">Rentabilidad (Yield)</span><span className="text-xs font-bold text-green-400">{data.dividend_data?.yield_percent}</span></div>
                                                      <div className="flex justify-between border-b border-slate-800 pb-2"><span className="text-xs text-slate-500 uppercase">Importe Anual</span><span className="text-xs font-bold text-white">{data.dividend_data?.amount}</span></div>
                                                      <div className="flex justify-between border-b border-slate-800 pb-2"><span className="text-xs text-slate-500 uppercase">Payout Ratio</span><span className={`text-xs font-bold ${parseInt(data.dividend_data?.payout_ratio || 0)>80?'text-red-400':'text-white'}`}>{data.dividend_data?.payout_ratio}</span></div>
                                                      <div className="flex justify-between"><span className="text-xs text-slate-500 uppercase">Racha Crecimiento</span><span className="text-xs font-bold text-yellow-500">{data.dividend_data?.growth_streak}</span></div>
                                                  </div>
                                              </div>
                                              <div className="bg-slate-900/50 border border-slate-800 p-5 rounded-2xl">
                                                  <h3 className="text-sm font-bold text-slate-300 mb-4 flex items-center gap-2"><Icons.Hash size={16}/> Salud Financiera</h3>
                                                  <div className="space-y-3">
                                                      <div className="flex justify-between border-b border-slate-800 pb-2"><span className="text-xs text-slate-500 uppercase">Crec. Ventas (3Y CAGR)</span><span className={`text-xs font-bold ${String(data.financial_health?.revenue_growth_3y || '').includes('-')?'text-red-400':'text-green-400'}`}>{data.financial_health?.revenue_growth_3y}</span></div>
                                                      <div className="flex justify-between border-b border-slate-800 pb-2"><span className="text-xs text-slate-500 uppercase">Margen Neto</span><span className="text-xs font-bold text-white">{data.financial_health?.net_margin}</span></div>
                                                      <div className="flex justify-between border-b border-slate-800 pb-2"><span className="text-xs text-slate-500 uppercase">ROE</span><span className="text-xs font-bold text-blue-400">{data.financial_health?.roe}</span></div>
                                                      <div className="flex justify-between"><span className="text-xs text-slate-500 uppercase">Deuda / Equity</span><span className={`text-xs font-bold ${data.financial_health?.debt_to_equity > 1.5 ? 'text-red-400' : 'text-green-400'}`}>{formatN(data.financial_health?.debt_to_equity)}</span></div>
                                                  </div>
                                              </div>
                                          </div>

                                          <div className="glass-panel p-6 rounded-2xl">
                                              <h3 className="text-lg font-bold text-white mb-2 flex items-center gap-2"><Icons.Award size={18}/> Veredicto de Inversión</h3>
                                              <p className="text-slate-300 text-sm leading-relaxed mb-6">{data.investment_verdict}</p>
                                              <div className="border-t border-slate-700 pt-4"><h4 className="text-xs uppercase font-bold text-slate-500 mb-3">Comparar con Competencia</h4><div className="flex flex-wrap gap-2">{(data.peers || []).map((peer, i) => ( <button key={i} onClick={() => setTicker(peer)} className="px-3 py-1 bg-slate-800 hover:bg-blue-600 hover:text-white rounded-lg text-xs font-bold text-blue-400 transition-colors border border-slate-700">{peer}</button> ))}</div></div>
                                          </div>
                                      </div>
                                  </div>
                              )}
                        </div>
                    )}

                </div>
            ) : (
                /* CONTENIDO RASTREO (SCREENER) RESTAURADO */
                <div className="flex flex-col gap-6 max-w-7xl mx-auto w-full pb-10">
                    <div className="bg-slate-900/50 p-6 rounded-3xl border border-slate-800 space-y-8 shadow-2xl">
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div className="flex flex-col gap-2">
                                <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Bolsa de Valores (Mercado)</label>
                                <select value={exchange} onChange={e=>setExchange(e.target.value)} className="w-full h-12 px-4 bg-slate-950 border border-slate-700 rounded-xl text-xs font-bold text-white">
                                    {EXCHANGES.map(ex => <option key={ex.id} value={ex.id}>{ex.name}</option>)}
                                </select>
                            </div>
                            <div className="flex flex-col gap-2">
                                <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Nº Máximo Resultados</label>
                                <select value={maxResults} onChange={e=>setMaxResults(parseInt(e.target.value))} className="w-full h-12 px-4 bg-slate-950 border border-slate-700 rounded-xl text-xs font-bold text-white">
                                    {[5, 10, 20, 30, 40, 60, 80, 100].map(v => <option key={v} value={v}>{v} Registros</option>)}
                                </select>
                            </div>
                            <div className="flex items-end pb-1"><button onClick={runScreener} className="w-full h-12 bg-blue-600 hover:bg-blue-500 text-white rounded-2xl font-black uppercase text-xs tracking-widest shadow-2xl shadow-blue-900/40 border border-blue-400/20">Iniciar Rastreo Inteligente</button></div>
                        </div>
                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5">
                            {Object.entries(params).map(([id, config]) => <ParamCard key={id} id={id} config={config} />)}
                        </div>
                    </div>

                    {screenerResults.length > 0 && (
                        <div className="bg-slate-900/50 border border-slate-800 rounded-3xl overflow-hidden flex flex-col shadow-2xl">
                            <div className="p-5 bg-slate-800/40 flex justify-between items-center border-b border-slate-700/50">
                                <div className="flex flex-col">
                                    <span className="text-xs font-black uppercase tracking-widest text-white">Oportunidades Localizadas</span>
                                    <span className="text-[9px] text-slate-500 uppercase font-bold">Ordenado por {screenerSort.key} ({screenerSort.direction})</span>
                                </div>
                                <button onClick={handlePrintScreener} className="bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded-xl text-[10px] font-bold border border-slate-600 flex items-center gap-2 text-white transition-colors"><Icons.ExternalLink size={14}/> IMPRIMIR INFORME</button>
                            </div>
                            <div className="overflow-x-auto">
                                <table className="w-full text-left text-xs">
                                    <thead className="bg-slate-950/80 text-slate-500 uppercase text-[9px] font-black sticky top-0">
                                        <tr>
                                            {['ticker', 'name', 'price', 'per', 'peg', 'roi', 'divYield', 'pb', 'debtEquity'].map(k => (
                                                <th key={k} className="p-5 cursor-pointer hover:text-white transition-colors border-b border-slate-800" onClick={()=>setScreenerSort({key:k, direction: screenerSort.direction==='asc'?'desc':'asc'})}>
                                                    <div className="flex items-center gap-1">{k === 'divYield' ? 'Yield' : k === 'debtEquity' ? 'D/E' : k} {screenerSort.key === k && (screenerSort.direction==='asc'?'▲':'▼')}</div>
                                                </th>
                                            ))}
                                        </tr>
                                    </thead>
                                   
                                    <tbody className="divide-y divide-slate-800 font-mono">
                                        {sortedScreenerResults.map((r, i) => (
                                            <tr 
                                                key={i} 
                                                onClick={() => handleScreenerClick(r.ticker)} 
                                                className="hover:bg-blue-600/20 transition-colors group cursor-pointer border-l-4 border-transparent hover:border-blue-500"
                                                title="Clic para analizar en profundidad"
                                            >
                                                <td className="p-5 font-black text-blue-400 text-sm group-hover:text-white transition-colors">
                                                    {r.ticker} <Icons.Search size={10} className="inline ml-1 opacity-0 group-hover:opacity-100"/>
                                                </td>
                                                <td className="p-5 text-slate-300 font-sans font-bold">{r.name}</td>
                                                <td className="p-5 text-white font-bold">{formatN(r.price)}</td>
                                                <td className={`p-5 ${checkCriteria('per', r.per)}`}>{r.per}</td>
                                                <td className={`p-5 ${checkCriteria('peg', r.peg)}`}>{r.peg}</td>
                                                <td className={`p-5 ${checkCriteria('roi', r.roi)}`}>{r.roi}%</td>
                                                <td className={`p-5 ${checkCriteria('divYield', r.divYield)}`}>{r.divYield}%</td>
                                                <td className={`p-5 ${checkCriteria('pb', r.pb)}`}>{r.pb}</td>
                                                <td className={`p-5 ${checkCriteria('debtEquity', r.debtEquity)}`}>{r.debtEquity}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}
                </div>
            )}
        </div>
    );
};



const App = () => {
    const [globalNotes, setGlobalNotes] = usePersistentState('bg_global_notes', '');
    const [activeTab, setActiveTab] = useState('portfolio');
    const [apiKey, setApiKey] = usePersistentState('bg_api_key', '');
    const [baseCurrency, setBaseCurrency] = usePersistentState('bg_base_currency', 'EUR');
    const [refreshInterval, setRefreshInterval] = usePersistentState('bg_refresh_interval', 10);
    const [portfolio, setPortfolio] = usePersistentState('bg_portfolio', []);
    const [resultsData, setResultsData] = usePersistentState('bg_results_data', {});
    const [lastUpdate, setLastUpdate] = usePersistentState('bg_last_update', null);
    const [gScriptUrl, setGScriptUrl] = usePersistentState('bg_g_script_url', '');
    
    // --- ESTADO NUEVO PARA EL ENLACE ENTRE CARTERA Y ANÁLISIS ---
    const [analysisTicker, setAnalysisTicker] = useState(null);

    const [_s_st, _s_set] = usePersistentState(_0xL, '');
    const [localTimestamp, setLocalTimestamp] = usePersistentState('bg_local_ts', 0);
    const [syncStatus, setSyncStatus] = useState('idle'); 
    const [syncMessage, setSyncMessage] = useState('');
    const [conflictModal, setConflictModal] = useState({ isOpen: false, cloudData: null });
    const [isAppReady, setIsAppReady] = useState(false);
    const [appPin, setAppPin] = usePersistentState('bg_app_pin', '');
    const [isPinLocked, setIsPinLocked] = useState(!!appPin);
    const [enteredPin, setEnteredPin] = useState('');
    
    const [blockAction, setBlockAction] = useState(false);
    const _0xAuth = useMemo(() => _s_st === _0xT, [_s_st]);
    const _0xCap = useMemo(() => {
        return _0xAuth ? 99999 : 5;
    }, [_0xAuth]);
    const _0xReg = (v) => {
        if (_0x8f(v)) {
            _s_set(_0xT); 
            alert("R-KEY: OK."); 
        } else {
            _s_set(''); 
            alert("R-KEY: ERR."); 
        }
    };

    useEffect(() => {
        if (blockAction) {
            alert("⚠️ LÍMITE ALCANZADO\n\nEl sistema ha detenido la operación.");
            setBlockAction(false);
        }
    }, [blockAction]);

    const updatePortfolio = (newVal, triggerSync = true) => { 
        setPortfolio(newVal); 
        if (triggerSync) {
            setLocalTimestamp(Date.now()); 
            setSyncStatus('unsaved'); 
        }
    };

    const updateResultsData = (newVal) => { setResultsData(newVal); setLocalTimestamp(Date.now()); setSyncStatus('unsaved'); };

    const uploadToCloud = async () => { const url = simpleDecrypt(gScriptUrl); if (!url) return alert("Configura la URL de Google Script en Ajustes."); setSyncStatus('uploading'); setSyncMessage('Subiendo datos...'); try { const now = Date.now(); const payload = { timestamp: now, portfolio, resultsData, apiKey, baseCurrency, refreshInterval, version: 3, appPin, globalNotes }; await fetch(url, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); setLocalTimestamp(now); setSyncStatus('synced'); setSyncMessage('✅ Sincronizado'); setTimeout(() => setSyncMessage(''), 3000); } catch (e) { console.error(e); setSyncStatus('error'); setSyncMessage('❌ Error al subir'); } };
    const checkForCloudUpdates = async () => { const url = simpleDecrypt(gScriptUrl); if (!url) { setIsAppReady(true); return; } setSyncStatus('checking'); try { const response = await fetch(url); const cloudData = await response.json(); const cloudTS = cloudData.timestamp || 0; const localTS = localTimestamp || 0; if (cloudTS > (localTS + 10000)) { setConflictModal({ isOpen: true, cloudData }); setSyncStatus('idle'); } else { setSyncStatus(localTS > cloudTS ? 'unsaved' : 'synced'); setIsAppReady(true); } } catch (e) { console.error("Error comprobando nube:", e); setSyncStatus('error'); setIsAppReady(true); } };
    const handleApplyCloudData = () => { const data = conflictModal.cloudData; if (!data) return; if (data.globalNotes) setGlobalNotes(data.globalNotes); if (data.portfolio) setPortfolio(data.portfolio); if (data.resultsData) setResultsData(data.resultsData); if (data.apiKey) setApiKey(data.apiKey); if (data.baseCurrency) setBaseCurrency(data.baseCurrency); if (data.appPin) setAppPin(data.appPin); setLocalTimestamp(data.timestamp); setConflictModal({ isOpen: false, cloudData: null }); setSyncStatus('synced'); setSyncMessage('✅ Datos descargados'); setIsAppReady(true); setTimeout(() => setSyncMessage(''), 3000); };
    const handleKeepLocalData = () => { setLocalTimestamp(Date.now()); setConflictModal({ isOpen: false, cloudData: null }); setSyncStatus('unsaved'); setIsAppReady(true); };

    useEffect(() => { if (gScriptUrl) { checkForCloudUpdates(); } else { setIsAppReady(true); } }, []);
    useEffect(() => { if (!gScriptUrl || refreshInterval < 1 || !isAppReady) return; const intervalMs = (refreshInterval + 1) * 60 * 1000; const timer = setInterval(() => { if (syncStatus === 'unsaved') { uploadToCloud(); } }, intervalMs); return () => clearInterval(timer); }, [refreshInterval, gScriptUrl, syncStatus, isAppReady]);
    useEffect(() => { if(appPin && appPin.length === 4) setIsPinLocked(true); else setIsPinLocked(false); }, []);

    const renderConflictModal = () => {
        if (!conflictModal.isOpen) return null;
        const localDate = new Date(localTimestamp).toLocaleString();
        const cloudDate = new Date(conflictModal.cloudData?.timestamp || 0).toLocaleString();
        return (
            <div className="fixed inset-0 bg-black/90 z-[300] flex items-center justify-center p-4 backdrop-blur-sm fade-in">
                <div className="bg-slate-900 border-2 border-orange-500 rounded-2xl max-w-lg w-full p-6 shadow-2xl relative">
                    <div className="text-center mb-6"><div className="mx-auto w-16 h-16 bg-orange-500/20 text-orange-500 rounded-full flex items-center justify-center mb-4 animate-pulse"><Icons.AlertCircle size={40}/></div><h3 className="text-xl font-bold text-white mb-2">¡Datos Desactualizados!</h3><p className="text-sm text-slate-300">Hemos detectado una copia más reciente en Google Drive.</p></div>
                    <div className="grid grid-cols-2 gap-4 mb-8"><div className="bg-slate-800 p-4 rounded-xl border border-slate-700 opacity-60"><div className="text-[10px] text-slate-400 uppercase font-bold mb-1">Este Dispositivo</div><div className="text-sm font-mono text-white font-bold mb-2">{localTimestamp === 0 ? 'Nunca' : localDate}</div></div><div className="bg-blue-900/20 p-4 rounded-xl border-2 border-blue-500 relative overflow-hidden"><div className="absolute top-0 right-0 bg-blue-600 text-white text-[9px] px-2 py-0.5 font-bold uppercase">Más Reciente</div><div className="text-[10px] text-blue-300 uppercase font-bold mb-1">Google Drive (Nube)</div><div className="text-sm font-mono text-white font-bold mb-2">{cloudDate}</div></div></div>
                    <div className="space-y-3"><button onClick={handleApplyCloudData} className="w-full py-4 bg-blue-600 hover:bg-blue-500 text-white rounded-xl font-bold uppercase shadow-lg shadow-blue-900/20 transition-all flex items-center justify-center gap-2"><Icons.Upload className="rotate-180" size={18}/> Descargar versión de la Nube</button><button onClick={handleKeepLocalData} className="w-full py-3 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-xl font-bold uppercase text-xs transition-all">Ignorar y Mantener mi versión local</button></div>
                </div>
            </div>
        );
    };

    if(isPinLocked) {
        return (
            <div className="h-full flex flex-col items-center justify-center bg-[#0a0a0a] text-white p-4">
                <div className="bg-slate-900 border border-slate-800 p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center">
                    <div className="mb-6"><Icons.Briefcase size={40} className="mx-auto text-blue-600 mb-2"/><h2 className="text-2xl font-display font-bold">Boarding<span className="text-blue-600">Gate</span></h2><p className="text-xs text-slate-400 uppercase tracking-widest">Acceso Restringido</p></div>
                    <input type="password" value={enteredPin} onChange={e => { const val = e.target.value.slice(0,4); setEnteredPin(val); if(val === appPin) setIsPinLocked(false); }} placeholder="PIN" className="w-full bg-black/50 border border-slate-700 rounded-xl p-4 text-center text-3xl font-mono tracking-[1em] text-white focus:border-blue-500 focus:outline-none mb-4" autoFocus />
                    {enteredPin.length > 0 && enteredPin !== appPin && enteredPin.length === 4 && <p className="text-red-500 text-xs font-bold animate-pulse">PIN Incorrecto</p>}
                </div>
            </div>
        );
    }

    return (
        <div className="h-full flex flex-col bg-[#0a0a0a] text-white overflow-hidden relative">
            {renderConflictModal()}
            {syncMessage && <div className="fixed top-6 left-1/2 -translate-x-1/2 z-[200] bg-blue-600/90 text-white px-6 py-3 rounded-full shadow-2xl font-bold text-xs flex items-center gap-2 fade-in backdrop-blur-md border border-white/10">{syncStatus === 'uploading' ? <Icons.Upload className="animate-bounce"/> : syncStatus === 'error' ? <Icons.AlertCircle/> : <Icons.CheckCircle/>} {syncMessage}</div>}
            {!isAppReady && !conflictModal.isOpen && <div className="fixed inset-0 z-[250] bg-black flex flex-col items-center justify-center"><Icons.Loader size={40} className="text-blue-500 animate-spin mb-4"/><div className="text-slate-400 text-xs uppercase font-bold tracking-widest animate-pulse">Sincronizando con la Nube...</div></div>}
            <header className="shrink-0 bg-slate-900 border-b border-slate-800 px-6 py-4 flex justify-between items-center z-50"><div><h1 className="text-2xl font-display font-bold">Boarding<span className="text-blue-600">Gate</span></h1><p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Gestor de Cartera de Valores iA</p></div><nav className="flex bg-slate-800 rounded-lg p-1 gap-1 border border-slate-700 overflow-x-auto whitespace-nowrap custom-scrollbar"><button onClick={() => setActiveTab('portfolio')} className={`px-4 py-2 rounded-md text-[10px] font-bold uppercase flex items-center gap-2 transition-all ${activeTab === 'portfolio' ? 'bg-blue-600 text-white' : 'text-slate-400'}`}><Icons.Briefcase size={14}/> Cartera</button><button onClick={() => setActiveTab('dividends')} className={`px-4 py-2 rounded-md text-[10px] font-bold uppercase flex items-center gap-2 transition-all ${activeTab === 'dividends' ? 'bg-blue-600 text-white' : 'text-slate-400'}`}><Icons.DollarSign size={14}/> Dividendos</button><button onClick={() => setActiveTab('results')} className={`px-4 py-2 rounded-md text-[10px] font-bold uppercase flex items-center gap-2 transition-all ${activeTab === 'results' ? 'bg-blue-600 text-white' : 'text-slate-400'}`}><Icons.ChartBar size={14}/> Resultados</button><button onClick={() => setActiveTab('analysis')} className={`px-4 py-2 rounded-md text-[10px] font-bold uppercase flex items-center gap-2 transition-all ${activeTab === 'analysis' ? 'bg-blue-600 text-white' : 'text-slate-400'}`}><Icons.Search size={14}/> Estudio</button><button onClick={() => setActiveTab('settings')} className={`px-4 py-2 rounded-md text-[10px] font-bold uppercase flex items-center gap-2 transition-all ${activeTab === 'settings' ? 'bg-blue-600 text-white' : 'text-slate-400'}`}><Icons.Settings size={14}/> Ajustes</button></nav></header>
            <main className="flex-1 overflow-y-auto bg-[#0a0a0a] relative custom-scrollbar">
                {activeTab === 'portfolio' && (
                    <PortfolioTab 
                        portfolio={portfolio} 
                        setPortfolio={updatePortfolio} 
                        apiKey={apiKey} 
                        baseCurrency={baseCurrency} 
                        refreshInterval={refreshInterval} 
                        lastUpdate={lastUpdate} 
                        setLastUpdate={setLastUpdate} 
                        resultsData={resultsData} 
                        syncStatus={syncStatus} 
                        onManualSync={uploadToCloud} 
                        isAppReady={isAppReady} 
                        _x_lim={_0xCap} 
                        _x_trig={setBlockAction} 
                        globalNotes={globalNotes} 
                        setGlobalNotes={setGlobalNotes}
                        // PASAMOS LA FUNCIÓN PARA ACTIVAR EL ANÁLISIS
                        onAnalyze={(ticker) => {
                            setAnalysisTicker(ticker);
                            setActiveTab('analysis');
                        }}
                    />
                )}
                {activeTab === 'dividends' && <DividendTab portfolio={portfolio} setPortfolio={updatePortfolio} baseCurrency={baseCurrency} syncStatus={syncStatus} onManualSync={uploadToCloud} />}
                {activeTab === 'results' && <ResultsTab portfolio={portfolio} resultsData={resultsData} setResultsData={updateResultsData} baseCurrency={baseCurrency} syncStatus={syncStatus} onManualSync={uploadToCloud} />}
                
                {activeTab === 'analysis' && (
                    <AnalysisTab 
                        apiKey={apiKey} 
                        baseCurrency={baseCurrency} 
                        setPortfolio={updatePortfolio}
                        // PASAMOS EL TICKER INICIAL
                        initialTicker={analysisTicker}
                    />
                )}
                
                {activeTab === 'settings' && <SettingsTab apiKey={apiKey} setApiKey={setApiKey} _x_stat={_0xAuth} _x_act={_0xReg} baseCurrency={baseCurrency} setBaseCurrency={setBaseCurrency} refreshInterval={refreshInterval} setRefreshInterval={setRefreshInterval} portfolio={portfolio} setPortfolio={updatePortfolio} onForceBackup={uploadToCloud} gScriptUrl={gScriptUrl} setGScriptUrl={setGScriptUrl} resultsData={resultsData} appPin={appPin} setAppPin={setAppPin} />}
             </main>
            <footer className="shrink-0 bg-slate-900 border-t border-slate-800 py-1 px-6 flex justify-between items-center text-[8px] text-slate-600 font-bold uppercase"><div>BoardingGate 3.3 (Secure PIN)</div><div className="flex gap-4"><span>Estado: {syncStatus === 'synced' ? 'Sincronizado' : syncStatus === 'unsaved' ? 'Cambios sin guardar' : 'Comprobando...'}</span><span>Ult. Mod: {localTimestamp > 0 ? new Date(localTimestamp).toLocaleTimeString() : 'N/A'}</span></div></footer>
        </div>
    );
};

      createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
