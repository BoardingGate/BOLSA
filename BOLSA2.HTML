
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>BoardingGate - CIO Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="//cdn.jsdelivr.net/npm/eruda"></script>
    <script>eruda.init();</script>

    <style>
      html, body { margin: 0; padding: 0; width: 100%; height: 100dvh; overflow: hidden; background-color: #0a0a0a; font-family: 'Inter', sans-serif; color: #e5e5e5; }
      #root { height: 100%; width: 100%; display: flex; flex-direction: column; }
      .font-display { font-family: 'Orbitron', sans-serif; }
      .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: #111; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background: #444; border-radius: 10px; }
      .glass-panel { background: rgba(30, 41, 59, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); }
      .fade-in { animation: fadeIn 0.4s ease-out; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
      .table-row-hover:hover { background-color: rgba(59, 130, 246, 0.1); cursor: pointer; }
      input, select { background: #1e293b; border: 1px solid #334155; color: white; border-radius: 6px; padding: 8px; transition: all 0.2s; font-size: 14px; }
      input:focus, select:focus { border-color: #3b82f6; outline: none; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }
      .custom-checkbox { accent-color: #3b82f6; width: 18px; height: 18px; cursor: pointer; }

      /* ESTILOS INFORME IA */
      .prose-content h3 { font-size: 1.1rem; font-weight: 700; color: #60a5fa; margin-top: 1.5rem; margin-bottom: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid #334155; padding-bottom: 0.25rem; }
      .prose-content h4 { font-size: 0.95rem; font-weight: 700; color: #e2e8f0; margin-top: 1rem; margin-bottom: 0.5rem; }
      .prose-content p { font-size: 0.9rem; line-height: 1.6; color: #cbd5e1; margin-bottom: 1rem; text-align: justify; }
      .prose-content ul { list-style-type: none; padding-left: 0; margin-bottom: 1rem; }
      .prose-content li { position: relative; padding-left: 1.25rem; margin-bottom: 0.5rem; font-size: 0.9rem; color: #cbd5e1; }
      .prose-content li::before { content: "‚Ä¢"; position: absolute; left: 0; color: #3b82f6; font-weight: bold; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useMemo, useRef } = React;
      const { createRoot } = ReactDOM;

      const _0x7a2=k=>{let x=Object.values(new Intl.DateTimeFormat('es').formatToParts(new Date())).filter(p=>['year','month','day'].includes(p.type)).reduce((a,c)=>a+~~c.value,0)*new Date().getDate();return k==x||k==x.toString(16).toUpperCase()};

      // --- FORMATO NUM√âRICO (Manual Regex) ---
      const formatN = (v, dec = 2) => {
          let n = parseFloat(v) || 0;
          let parts = n.toFixed(dec).split('.');
          parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ".");
          return parts.join(',');
      };

      const formatMoney = (v, c = 'EUR') => {
          let n = parseFloat(v) || 0;
          let base = n.toFixed(2).replace('.', ','); 
          while (base.match(/\d{4,}/)) { base = base.replace(/(\d)(\d{3}[,.])/, '$1.$2'); }
          let parts = base.split(',');
          parts[0] = parts[0].replace(/\./g, '').replace(/\B(?=(\d{3})+(?!\d))/g, ".");
          base = parts.join(',');
          if (c === 'USD') return `$ ${base}`; if (c === 'GBP') return `¬£ ${base}`;
          if (c === 'JPY') return `¬• ${base}`; if (c === 'CHF') return `Fr ${base}`;
          return `${base} ‚Ç¨`;
      };
      
      const calculateDays = (d1, d2 = new Date()) => Math.max(1, Math.ceil(Math.abs(new Date(d2) - new Date(d1)) / (1000 * 60 * 60 * 24)));
      const extractJSON = (t) => { try { const m = t.match(/(\{[\s\S]*\}|\[[\s\S]*\])/); return m ? JSON.parse(m[0]) : null; } catch { return null; } };

      const usePersistentState = (key, initialValue) => {
        const [state, setState] = useState(() => { try { const item = window.localStorage.getItem(key); return item ? JSON.parse(item) : initialValue; } catch { return initialValue; } });
        useEffect(() => { window.localStorage.setItem(key, JSON.stringify(state)); }, [key, state]);
        return [state, setState];
      };

      const CURRENCIES = [{ code: 'EUR', name: 'Euro' }, { code: 'USD', name: 'D√≥lar USA' }, { code: 'GBP', name: 'Libra Est.' }, { code: 'CHF', name: 'Franco Suizo' }, { code: 'JPY', name: 'Yen Jap.' }, { code: 'CAD', name: 'D√≥lar Can.' }];
      const MONTHS = ["ENERO", "FEBRE", "MARZO", "ABRIL", "MAYO", "JUNIO", "JULIO", "AGOST", "SEPTIE", "OCTUB", "NOVIEM", "DICIE"];

      // --- ICONOS ---
      const Icons = {
        Briefcase: (p) => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>,
        DollarSign: (p) => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>,
        Search: (p) => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>,
        Settings: (p) => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09"/></svg>,
        Plus: (p) => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
        Edit: (p) => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15"/></svg>,
        Trash2: (p) => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/></svg>,
        Refresh: (p) => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={p.className}><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36"/></svg>,
        Loader: (p) => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>,
        Wand: (p) => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M15 4V2"/><path d="M15 16v-2"/><path d="M8 9h2"/><path d="M20 9h2"/><path d="M3 21l9-9"/></svg>,
        Target: (p) => <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>,
        X: (p) => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
        EyeOff: (p) => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8"/><line x1="1" y1="1" x2="23" y2="23"/></svg>,
        Eye: (p) => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>,
        HelpCircle: (p) => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/></svg>,
        CheckCircle: (p) => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/></svg>,
        BarChart: (p) => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>,
        Hash: (p) => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><line x1="4" y1="9" x2="20" y2="9"/><line x1="4" y1="15" x2="20" y2="15"/></svg>,
        Award: (p) => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23"/></svg>,
        Upload: (p) => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
        AlertCircle: (p) => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>,
        ExternalLink: (p) => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>,
        ThumbsUp: (p) => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"/></svg>,
        ThumbsDown: (p) => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h2.67A2.31 2.31 0 0 1 22 4v7a2.31 2.31 0 0 1-2.33 2H17"/></svg>,
        MessageCircle: (p) => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>,
        Globe: (p) => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
      };

      const askGemini = async (apiKey, prompt) => {
          if (!apiKey) throw new Error("Falta API Key");
          const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
              method: 'POST', headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], tools: [{ google_search: {} }] })
          });
          const data = await response.json();
          if (data.error) throw new Error(data.error.message);
          return data.candidates?.[0]?.content?.parts?.[0]?.text || "";
      };

      const Modal = ({ isOpen, title, onClose, children, size = "md" }) => {
          if (!isOpen) return null;
          return (
              <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4 fade-in backdrop-blur-sm" onClick={onClose}>
                  <div className={`bg-slate-900 border border-slate-700 w-full ${size === 'lg' ? 'max-w-6xl' : 'max-w-xl'} rounded-2xl flex flex-col max-h-[90vh] shadow-2xl fade-in`} onClick={e => e.stopPropagation()}>
                      <div className="p-4 border-b border-slate-800 flex justify-between items-center bg-slate-900/50 rounded-t-2xl">
                          <h3 className="text-lg font-bold font-display text-white">{title}</h3>
                          <button onClick={onClose} className="text-slate-400 hover:text-white"><Icons.X size={22}/></button>
                      </div>
                      <div className="p-6 overflow-y-auto custom-scrollbar flex-1">{children}</div>
                  </div>
              </div>
          );
      };

      // --- GR√ÅFICOS SVG NATIVOS ---
      const SVGCharts = ({ type, data, title, id }) => {
          const printChart = () => {
              const svg = document.getElementById(id).outerHTML;
              const w = window.open('', '', 'width=800,height=600');
              w.document.write(`<html><head><title>Gr√°fico</title></head><body style="font-family:sans-serif;text-align:center;"><h2>${title}</h2>${svg}<script>setTimeout(()=>window.print(),500)<\/script></body></html>`);
              w.document.close();
          };

          if (type === 'pie') {
              const total = data.reduce((a, b) => a + b.val, 0);
              let cumPercent = 0;
              const slices = data.map((d, i) => {
                  const percent = d.val / total;
                  const start = cumPercent;
                  cumPercent += percent;
                  const x1 = Math.cos(2 * Math.PI * start) * 100 + 150, y1 = Math.sin(2 * Math.PI * start) * 100 + 150;
                  const x2 = Math.cos(2 * Math.PI * cumPercent) * 100 + 150, y2 = Math.sin(2 * Math.PI * cumPercent) * 100 + 150;
                  const largeArc = percent > 0.5 ? 1 : 0;
                  const color = `hsl(${(i * 360) / data.length}, 70%, 60%)`;
                  return { path: `M 150 150 L ${x1} ${y1} A 100 100 0 ${largeArc} 1 ${x2} ${y2} Z`, color, label: d.label, percent: (percent * 100).toFixed(1) };
              });
              return (
                  <div className="bg-slate-900/50 border border-slate-800 p-4 rounded-xl relative">
                      <div className="flex justify-between mb-2"><h4 className="text-xs font-bold uppercase text-slate-400">{title}</h4><button onClick={printChart} className="text-blue-400 hover:text-white"><Icons.ExternalLink size={14}/></button></div>
                      <div className="flex items-center gap-4">
                          <svg id={id} viewBox="0 0 300 300" width="150" height="150" className="shrink-0">{slices.map((s, i) => <path key={i} d={s.path} fill={s.color} stroke="#0f172a" strokeWidth="2" />)}</svg>
                          <div className="flex-1 overflow-y-auto max-h-[150px] custom-scrollbar space-y-1">{slices.map((s, i) => <div key={i} className="flex justify-between text-[9px]"><span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full" style={{backgroundColor:s.color}}></span> {s.label}</span><span className="font-bold text-white">{s.percent}%</span></div>)}</div>
                      </div>
                  </div>
              );
          }
          if (type === 'bar') {
              const max = Math.max(...data.map(d => d.val));
              return (
                  <div className="bg-slate-900/50 border border-slate-800 p-4 rounded-xl relative flex-1 min-w-[300px]">
                      <div className="flex justify-between mb-4"><h4 className="text-xs font-bold uppercase text-slate-400">{title}</h4><button onClick={printChart} className="text-blue-400 hover:text-white"><Icons.ExternalLink size={14}/></button></div>
                      <svg id={id} width="100%" height="150" viewBox={`0 0 ${data.length * 40} 150`}>
                          {data.map((d, i) => {
                              const h = (d.val / max) * 120;
                              return ( <g key={i}>
                                  <rect x={i * 40 + 5} y={130 - h} width="30" height={h} fill="#3b82f6" rx="2" />
                                  <text x={i * 40 + 20} y={145} textAnchor="middle" fill="#94a3b8" fontSize="10">{d.label}</text>
                                  <text x={i * 40 + 20} y={125 - h} textAnchor="middle" fill="#fff" fontSize="9" fontWeight="bold">{formatN(d.val,0)}</text>
                              </g> );
                          })}
                      </svg>
                  </div>
              );
          }
          return null;
      };

      // --- ESTADISTICAS REDISE√ëADAS ---
      const StatsBlock = ({ title, data, color, baseCurrency }) => (
          <div className="glass-panel p-3 rounded-xl border-t-4 flex-1 min-w-[280px]" style={{borderTopColor: color}}>
              <div className="flex justify-between items-center mb-2">
                 <span className="text-[9px] font-bold text-slate-500 uppercase">{title}</span>
                 <span className="text-[8px] bg-slate-800 px-1.5 py-0.5 rounded text-slate-400 font-bold">{formatN(data.num, 0)} VALORES</span>
              </div>
              <div className="grid grid-cols-2 gap-2 mb-3">
                  <div>
                      <div className="text-[8px] text-slate-500 uppercase">Invertido</div>
                      <div className="text-[13px] font-black text-white">{formatMoney(data.inv, baseCurrency)}</div>
                  </div>
                  <div className="text-right">
                      <div className="text-[8px] text-slate-500 uppercase">Valor Actual</div>
                      <div className="text-[13px] font-bold" style={{color: color}}>{formatMoney(data.cur, baseCurrency)}</div>
                  </div>
              </div>
              <div className="bg-slate-950/50 p-2 rounded-lg border border-slate-800/50 text-center mb-3">
                  <div className="text-[8px] text-slate-500 uppercase font-black mb-0.5">BALANCE (Resultado)</div>
                  <div className={`text-xl font-black ${data.plPrice >= 0 ? 'text-green-400' : 'text-red-400'}`}>{formatMoney(data.plPrice, baseCurrency)}</div>
                  <div className="text-[8px] text-slate-400 flex justify-center gap-2 mt-1"><span>Simple: {formatN(data.plP_S)}%</span><span className="text-slate-600">|</span><span>Anual: {formatN(data.plP_A)}%</span></div>
              </div>
              <div className="grid grid-cols-2 gap-2 pt-2 border-t border-slate-800/30">
                  <div><div className="text-[8px] text-blue-400 uppercase font-bold">Dividendos</div><div className="text-xs font-bold text-blue-300">{formatMoney(data.divN, baseCurrency)}</div></div>
                  <div className="text-right"><div className="text-[8px] text-slate-500 uppercase">Desv. Divisa</div><div className={`text-xs font-bold ${data.fX>=0?'text-green-500':'text-red-500'}`}>{formatMoney(data.fX, baseCurrency)}</div></div>
              </div>
          </div>
      );

      const AnalysisTab = ({ apiKey, baseCurrency }) => {
          const [ticker, setTicker] = useState('');
          const [question, setQuestion] = useState('');
          const [loading, setLoading] = useState(false);
          const [data, setData] = useState(null);
          const [specificAnswer, setSpecificAnswer] = useState(null);
          const [suggestedQuestions, setSuggestedQuestions] = useState(["Competencia directa", "Historial de dividendos", "Nivel de deuda", "Directivos y Salarios", "Esc√°ndalos recientes", "Previsi√≥n pr√≥ximos resultados"]);

          const sanitizeAndParseJSON = (text) => { try { const match = text.match(/(\{[\s\S]*\})/); if (match) return JSON.parse(match[0]); return JSON.parse(text); } catch (e) { throw new Error("La IA no devolvi√≥ un formato de datos v√°lido. Int√©ntalo de nuevo."); } };

          const updateSuggestions = (askedQ) => {
              const pool = ["Impacto tipos inter√©s", "Moat (Ventaja competitiva)", "Insider Trading reciente", "Riesgos regulatorios", "Evoluci√≥n m√°rgenes", "Plan recompras", "Litigios pendientes"];
              setSuggestedQuestions(prev => {
                  const filtered = prev.filter(q => q !== askedQ);
                  const newQ = pool.find(q => !filtered.includes(q) && q !== askedQ);
                  return newQ ? [newQ, ...filtered] : filtered;
              });
          };

          const analyze = async () => {
              if (!apiKey) return alert("Falta API Key"); if (!ticker) return alert("Introduce Ticker");
              setLoading(true); setSpecificAnswer(null); setData(null);
              try {
                  if (question.trim()) {
                      const prompt = `CRITICAL: Act as Senior Investment Officer. Output ONLY HTML.
                      Task: Answer regarding "${ticker}": "${question}".
                      Style: Professional Spanish (Espa√±a). Use <h3>, <p>, <ul>. Be concise, data-driven.`;
                      const res = await askGemini(apiKey, prompt); 
                      setSpecificAnswer(res.replace(/```html/g, '').replace(/```/g, '').trim());
                      updateSuggestions(question);
                  } else {
                      const prompt = `CRITICAL: You are a Wall Street Analyst targeting Spanish Pros. Output ONLY JSON.
                      Task: Deep Analysis of "${ticker}". 
                      REQUIREMENTS: Translate ALL terms to Spanish (Yield->Rentabilidad, etc). 
                      JSON: { 
                          "company": "Name", "current_price": num, "intrinsic_value": num, "forecast_1y": num, "forecast_5y": num, "valuation_status": "Infra/Sobre", 
                          "investment_verdict": "Detailed Spanish verdict (min 50 words)",
                          "technical_analysis": { "trend_short": "Alcista/Bajista", "trend_long": "Alcista/Bajista", "supports": ["120.5", "115"], "resistances": ["135", "142"] },
                          "dividend_data": { "yield_percent": "x.x%", "amount": "x.xx", "payout_ratio": "x%", "ex_date": "YYYY-MM-DD", "payment_date": "YYYY-MM-DD", "growth_streak": "x Years" },
                          "financial_health": { "revenue_growth_3y": "x%", "net_margin": "x%", "roe": "x%", "debt_to_equity": num, "free_cash_flow": "String" },
                          "management": {"ceo": "Name", "ownership": "% Held"}, "capital": {"market_cap": "String", "shares_outstanding": "String"},
                          "competitors": { "per": {"stock": num, "industry": num}, "yield": {"stock": num, "industry": num} }, 
                          "fundamentals": {"per": num, "eps": num, "beta": num}, 
                          "pros_cons": { "pros": ["txt"], "cons": ["txt"] }, "peers": ["TICKER"] 
                      }`;
                      const res = await askGemini(apiKey, prompt); const json = sanitizeAndParseJSON(res); 
                      setData(json);
                  }
              } catch (e) { alert("Error: " + e.message); } finally { setLoading(false); }
          };

          const handlePrint = () => {
              const w = window.open('', '', 'height=800,width=800');
              w.document.write(`<html><head><title>Informe</title><style>body{font-family:sans-serif;padding:20px;font-size:11px} h1{border-bottom:2px solid #333} h3{color:#2563eb;border-bottom:1px solid #ccc;margin-top:15px} .grid{display:flex;gap:10px} .col{flex:1} .label{font-weight:bold;color:#555}</style></head><body><h1>AN√ÅLISIS: ${data?.company || ticker}</h1>${specificAnswer || (data ? `<p><strong>Veredicto:</strong> ${data.investment_verdict}</p><div class="grid"><div class="col"><h3>Datos</h3><ul><li><span class="label">CEO:</span> ${data.management?.ceo}</li><li><span class="label">Cap:</span> ${data.capital?.market_cap}</li></ul></div><div class="col"><h3>Finanzas</h3><ul><li><span class="label">Deuda/Eq:</span> ${formatN(data.financial_health?.debt_to_equity)}</li><li><span class="label">FCF:</span> ${data.financial_health?.free_cash_flow}</li></ul></div></div><h3>T√©cnico</h3><p>Sop: ${data.technical_analysis?.supports.join(', ')} | Res: ${data.technical_analysis?.resistances.join(', ')}</p>` : '')}</body></html>`);
              w.document.close(); w.focus(); setTimeout(()=>w.print(),500);
          };

          return (
              <div className="h-full flex flex-col p-6 overflow-hidden">
                  <div className="flex flex-col gap-3 mb-6 shrink-0 bg-slate-900/50 p-4 rounded-xl border border-slate-800">
                       <div className="flex gap-4">
                           <div className="flex-1 relative"><Icons.Search className="absolute left-3 top-3 text-slate-500" size={18}/><input type="text" value={ticker} onChange={e => setTicker(e.target.value.toUpperCase())} placeholder="Ticker (ej. MSFT)" className="w-full bg-slate-950 border border-slate-700 rounded-xl py-3 pl-10 pr-4 text-white font-bold tracking-wider" /></div>
                           <button onClick={analyze} disabled={loading || !ticker} className="bg-blue-600 px-6 rounded-xl font-bold flex items-center gap-2 shadow-lg hover:bg-blue-500 text-sm">{loading ? <Icons.Loader/> : <Icons.Wand/>} ANALIZAR</button>
                       </div>
                       <div className="relative"><Icons.MessageCircle className="absolute left-3 top-3 text-slate-500" size={18}/><input type="text" value={question} onChange={e => setQuestion(e.target.value)} placeholder="¬øPregunta espec√≠fica?" className="w-full bg-slate-950 border border-slate-700 rounded-xl py-3 pl-10 pr-4 text-xs text-white" /></div>
                       <div className="flex gap-2 overflow-x-auto pb-1 custom-scrollbar">{suggestedQuestions.map((q,i) => ( <button key={i} onClick={()=>setQuestion(q)} className="whitespace-nowrap px-3 py-1 bg-slate-800 border border-slate-700 rounded-lg text-[10px] text-slate-400 hover:text-white transition-colors">{q}</button> ))}</div>
                  </div>
                  <div className="flex-1 overflow-y-auto custom-scrollbar">
                      {(specificAnswer || data) && (
                          <div className="glass-panel p-6 rounded-2xl fade-in relative">
                              <button onClick={handlePrint} className="absolute top-4 right-4 bg-slate-700 px-3 py-1 rounded text-xs font-bold text-white flex gap-2 items-center hover:bg-slate-600"><Icons.ExternalLink size={12}/> IMPRIMIR</button>
                              {specificAnswer && ( <> <h3 className="text-lg font-bold text-blue-400 mb-4 flex items-center gap-2"><Icons.Target/> Respuesta iA</h3> <div className="prose-content" dangerouslySetInnerHTML={{__html: specificAnswer}}></div> </> )}
                              {data && !specificAnswer && (
                                  <div className="space-y-6 pb-10">
                                      <div className="flex justify-between items-start mb-6"><div><h2 className="text-3xl font-display font-bold text-white mb-1">{data.company}</h2><div className={`inline-block px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-wider ${data.valuation_status?.includes('Infra') ? 'bg-green-500/20 text-green-400' : 'bg-yellow-500/20 text-yellow-400'}`}>{data.valuation_status}</div></div><div className="text-right"><div className="text-[9px] text-slate-500 uppercase font-bold">Cotizaci√≥n</div><div className="text-3xl font-black text-white font-mono">{formatN(data.current_price)}</div></div></div>
                                      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                          <div className="bg-slate-900/60 p-4 rounded-xl border border-purple-500/30"><div className="text-[9px] text-purple-300 uppercase font-bold mb-1">Valor Intr√≠nseco</div><div className="text-2xl font-black text-purple-400 font-mono">{formatN(data.intrinsic_value)}</div></div>
                                          <div className="bg-slate-900/40 p-4 rounded-xl border border-slate-700"><div className="text-[9px] text-slate-400 uppercase font-bold mb-1">Obj. 1 A√±o</div><div className="text-xl font-bold text-slate-200 font-mono">{formatN(data.forecast_1y)}</div></div>
                                          <div className="bg-slate-900/40 p-4 rounded-xl border border-slate-700"><div className="text-[9px] text-slate-400 uppercase font-bold mb-1">Obj. 5 A√±os</div><div className="text-xl font-bold text-slate-200 font-mono">{formatN(data.forecast_5y)}</div></div>
                                      </div>
                                      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                          <div className="space-y-4">
                                              <div className="bg-slate-900/50 border border-slate-800 p-5 rounded-2xl"><h3 className="text-sm font-bold text-blue-400 mb-4 flex items-center gap-2"><Icons.DollarSign size={16}/> Dividendos</h3><div className="space-y-2 text-xs">
                                                  <div className="flex justify-between"><span>Yield</span><span className="font-bold text-green-400">{data.dividend_data?.yield_percent}</span></div>
                                                  <div className="flex justify-between"><span>Payout</span><span className="font-bold text-white">{data.dividend_data?.payout_ratio}</span></div>
                                                  <div className="flex justify-between"><span>Ex-Date</span><span className="font-bold text-blue-300">{data.dividend_data?.ex_date}</span></div>
                                                  <div className="flex justify-between"><span>Pago</span><span className="font-bold text-slate-300">{data.dividend_data?.payment_date}</span></div>
                                              </div></div>
                                              <div className="bg-blue-900/10 p-3 rounded-xl border border-blue-500/20"><div className="text-[9px] uppercase text-blue-400 font-bold mb-1">T√©cnico</div><div className="text-xs font-mono text-slate-200"><b>Sop:</b> {(data.technical_analysis?.supports||[]).join(' / ')}<br/><b>Res:</b> {(data.technical_analysis?.resistances||[]).join(' / ')}</div></div>
                                          </div>
                                          <div className="bg-slate-900/50 border border-slate-800 p-5 rounded-2xl"><h3 className="text-sm font-bold text-slate-300 mb-4 flex items-center gap-2"><Icons.Hash size={16}/> Fundamental</h3><div className="space-y-2 text-xs">
                                              <div className="flex justify-between"><span>CEO</span><span className="font-bold text-white">{data.management?.ceo} ({data.management?.ownership})</span></div>
                                              <div className="flex justify-between"><span>Cap. Mercado</span><span className="font-bold text-white">{data.capital?.market_cap}</span></div>
                                              <div className="flex justify-between"><span>Deuda/Eq</span><span className="font-bold text-white">{formatN(data.financial_health?.debt_to_equity)}</span></div>
                                              <div className="flex justify-between"><span>FCF</span><span className="font-bold text-white">{data.financial_health?.free_cash_flow}</span></div>
                                              <div className="flex justify-between"><span>ROE</span><span className="font-bold text-blue-400">{data.financial_health?.roe}</span></div>
                                          </div></div>
                                      </div>
                                      <div className="glass-panel p-6 rounded-2xl"><h3 className="text-lg font-bold text-white mb-2 flex items-center gap-2"><Icons.Award size={18}/> Veredicto</h3><p className="text-slate-300 text-sm leading-relaxed">{data.investment_verdict}</p></div>
                                  </div>
                              )}
                          </div>
                      )}
                  </div>
              </div>
          );
      };

      const ResultsTab = ({ portfolio, resultsData, setResultsData, baseCurrency }) => {
          const r2 = (num) => Math.round((parseFloat(num) || 0) * 100) / 100;
          const yearsToShow = (() => {
              const yearsSet = new Set();
              if (portfolio.length === 0) return [new Date().getFullYear()];
              portfolio.forEach(p => { if (p.buyDate) yearsSet.add(new Date(p.buyDate).getFullYear()); if (p.sellDate) yearsSet.add(new Date(p.sellDate).getFullYear()); if (p.dividends) p.dividends.forEach(d => yearsSet.add(d.year)); });
              return Array.from(yearsSet).sort((a, b) => a - b);
          })();

          useEffect(() => {
              const newData = { ...resultsData };
              yearsToShow.forEach(y => { if (!newData[y]) newData[y] = { locked: false, soldCount: 0, uniqueCount: 0, profitPrice: 0, dividends: 0, lossPrice: 0, fees: 0, resNoDiv: 0, resWithDiv: 0, tax: 0, accumulated: 0, rentaResNoDiv: 0, rentaFees: 0, rentaAdj: 0, rentaBase: 0 }; });
              setResultsData(newData);
          }, [portfolio.length]);

          const handleRecalculate = () => {
              const newData = { ...resultsData };
              let runningAccum = 0;
              yearsToShow.forEach(y => {
                  if (!newData[y]) newData[y] = {};
                  if (newData[y].locked) { runningAccum = r2(runningAccum + newData[y].resWithDiv); newData[y].accumulated = runningAccum; return; }
                  let yearProfitPrice = 0, yearLossPrice = 0, yearFees = 0, lotesTotal = 0; const uniqueTickers = new Set();
                  const sales = portfolio.filter(p => p.sellDate && new Date(p.sellDate).getFullYear() === y && p.isActive !== false);
                  lotesTotal = sales.length;
                  sales.forEach(p => { uniqueTickers.add(p.ticker); const cost = r2((p.buyPrice * p.shares * p.buyFx) + (p.fees || 0) + (p.adjustments || 0)); const revenueNet = r2((p.sellPrice * p.shares * p.sellFx) - (p.sellFees || 0) - (p.sellAdjustments || 0)); const pl = r2(revenueNet - cost); if (pl >= 0) yearProfitPrice += pl; else yearLossPrice += Math.abs(pl); yearFees += r2((p.fees || 0) + (p.adjustments || 0) + (p.sellFees || 0) + (p.sellAdjustments || 0)); });
                  let yearDivs = 0; portfolio.forEach(p => { if (p.isActive !== false && p.dividends) { p.dividends.forEach(d => { if (d.year === y) yearDivs += d.net; }); } });
                  const resNoDiv = r2(yearProfitPrice - yearLossPrice); const resWithDiv = r2(resNoDiv + yearDivs);
                  runningAccum = r2(runningAccum + resWithDiv);
                  newData[y] = { ...newData[y], soldCount: lotesTotal, uniqueCount: uniqueTickers.size, profitPrice: r2(yearProfitPrice), dividends: r2(yearDivs), lossPrice: r2(yearLossPrice), fees: r2(yearFees), resNoDiv, resWithDiv, tax: resNoDiv > 0 ? r2(resNoDiv * 0.19) : 0, accumulated: runningAccum, rentaBase: resNoDiv };
              });
              setResultsData(newData);
          };

          const handleEdit = (year, field, val) => { if (resultsData[year]?.locked && !field.startsWith('renta')) return; const v = parseFloat(val); setResultsData(prev => ({ ...prev, [year]: { ...prev[year], [field]: isNaN(v) ? 0 : r2(v) } })); };
          const toggleLock = (year) => { setResultsData(prev => ({ ...prev, [year]: { ...prev[year], locked: !prev[year].locked } })); };
          
          const chartData = yearsToShow.map(y => ({ label: y.toString(), val: resultsData[y]?.resWithDiv || 0 }));

          return (
              <div className="h-full flex flex-col p-6 overflow-hidden fade-in">
                   <div className="flex justify-between items-center mb-4 bg-slate-900/80 p-4 rounded-xl border border-slate-800 shrink-0">
                      <div><h2 className="text-xl font-display font-bold text-white">Resultados</h2><p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Consolidaci√≥n Anual</p></div>
                      <div className="flex gap-2"><button onClick={handleRecalculate} className="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded-lg text-xs font-bold uppercase"><Icons.Refresh size={14}/> Recalcular</button></div>
                   </div>
                   <div className="flex-1 overflow-auto custom-scrollbar border border-slate-800 rounded-xl bg-slate-950 mb-4">
                       <table className="w-full text-sm border-collapse min-w-[1500px]">
                           <thead className="sticky top-0 z-20 bg-slate-800 text-[10px] uppercase font-bold text-slate-400"><tr><th className="p-2 w-10 sticky left-0 z-30 bg-slate-900">üîí</th><th className="p-2 w-16">A√±o</th><th className="p-2 text-right text-green-400">Beneficio</th><th className="p-2 text-right text-blue-400">Dividendos</th><th className="p-2 text-right text-red-400">P√©rdida</th><th className="p-2 text-right text-white font-bold bg-slate-800/30">Neto Total</th><th className="p-2 text-right text-yellow-500">Acumulado</th></tr></thead>
                           <tbody className="divide-y divide-slate-800 font-mono text-xs">{yearsToShow.map(year => { const d = resultsData[year] || {}; return ( <tr key={year}><td className="p-2 text-center sticky left-0 z-20 bg-slate-900"><input type="checkbox" checked={d.locked} onChange={()=>toggleLock(year)} className="custom-checkbox"/></td><td className="p-2 text-center text-white font-bold">{year}</td><td className="p-2"><input value={d.profitPrice||0} onChange={e=>handleEdit(year,'profitPrice',e.target.value)} disabled={d.locked} className="w-full bg-transparent text-right text-green-500"/></td><td className="p-2"><input value={d.dividends||0} onChange={e=>handleEdit(year,'dividends',e.target.value)} disabled={d.locked} className="w-full bg-transparent text-right text-blue-400"/></td><td className="p-2"><input value={d.lossPrice||0} onChange={e=>handleEdit(year,'lossPrice',e.target.value)} disabled={d.locked} className="w-full bg-transparent text-right text-red-500"/></td><td className="p-2 bg-slate-900/20"><input value={d.resWithDiv||0} onChange={e=>handleEdit(year,'resWithDiv',e.target.value)} disabled={d.locked} className="w-full bg-transparent text-right text-white font-bold"/></td><td className="p-2 text-right text-yellow-500 font-bold">{formatMoney(d.accumulated, baseCurrency)}</td></tr> ); })}</tbody>
                       </table>
                   </div>
                   <div className="h-48 shrink-0"><SVGCharts type="bar" data={chartData} title="Evoluci√≥n Resultados Anuales" id="chart-res"/></div>
              </div>
          );
      };

      const DividendTab = ({ portfolio, setPortfolio, baseCurrency }) => {
          const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());
          
          const filtered = useMemo(() => {
              // FILTRO: Solo valores que PAGAN dividendos (divAnual > 0) O que ya tienen cobros registrados
              return portfolio.filter(p => {
                  const bY = new Date(p.buyDate).getFullYear();
                  const sY = p.sellDate ? new Date(p.sellDate).getFullYear() : 9999;
                  const hasHistory = (p.dividends||[]).some(d => d.year === selectedYear && d.net > 0);
                  const isDividendPayer = p.dividendYieldAnnual > 0 || hasHistory;
                  return bY <= selectedYear && sY >= selectedYear && isDividendPayer;
              }).sort((a,b) => (!!a.sellDate - !!b.sellDate) || (new Date(a.buyDate) - new Date(b.buyDate)));
          }, [portfolio, selectedYear]);
          
          const handleDivChange = (id, month, field, val) => { const numVal = parseFloat(val) || 0; setPortfolio(prev => prev.map(p => { if (p.id !== id) return p; let divs = [...(p.dividends || [])]; const idx = divs.findIndex(d => d.year === selectedYear && d.month === month); if (idx >= 0) divs[idx][field] = numVal; else divs.push({ id: Date.now(), year: selectedYear, month, net: field === 'net' ? numVal : 0, taxOrigin: field === 'taxOrigin' ? numVal : 0, taxDest: field === 'taxDest' ? numVal : 0 }); return { ...p, dividends: divs }; })); };
          
          const stats = useMemo(() => {
              let tBruto = 0, tNet = 0; const monthlyT = Array(12).fill(0);
              const rows = filtered.map(p => {
                  const ds = (p.dividends || []).filter(d => d.year === selectedYear);
                  const n = ds.reduce((a, b) => a + b.net, 0);
                  const b = n + ds.reduce((a, b) => a + b.taxOrigin + b.taxDest, 0);
                  tBruto += b; tNet += n;
                  ds.forEach(d => monthlyT[d.month] += d.net);
                  return { id: p.id, name: p.name, n, b };
              });
              return { rows, tBruto, tNet, monthlyT };
          }, [filtered, selectedYear]);

          return (
              <div className="h-full flex flex-col p-4 overflow-hidden fade-in">
                  <div className="flex justify-between items-center mb-4 bg-slate-900/80 p-4 rounded-xl border border-slate-800 shrink-0">
                      <div className="flex items-center gap-4"><button onClick={() => setSelectedYear(y => y - 1)} className="p-2 bg-slate-800 rounded">‚Üê</button><span className="text-2xl font-bold font-display text-blue-400">{selectedYear}</span><button onClick={() => setSelectedYear(y => y + 1)} className="p-2 bg-slate-800 rounded">‚Üí</button></div>
                      <div className="text-right"><div className="text-[10px] text-green-400 uppercase font-bold">Total Netos</div><div className="text-xl font-bold text-green-400">{formatMoney(stats.tNet, baseCurrency)}</div></div>
                  </div>
                  <div className="flex-1 overflow-auto custom-scrollbar border border-slate-800 rounded-xl bg-slate-950 mb-4">
                      <table className="w-full text-[10px] border-collapse min-w-[1200px]"><thead className="sticky top-0 z-20 bg-slate-900 border-b border-slate-700 uppercase"><tr><th className="p-2 w-[180px] text-left sticky left-0 bg-slate-900 z-30">VALOR</th>{MONTHS.map(m => <th key={m} className="p-1 w-[80px] text-center text-slate-500">{m.substring(0,3)}</th>)}<th className="p-2 text-right bg-slate-800">TOTAL</th></tr></thead>
                          <tbody>{stats.rows.map(r => ( <tr key={r.id} className="hover:bg-white/5 border-b border-slate-800"><td className="p-2 sticky left-0 bg-slate-950 border-r border-slate-800 font-bold text-green-400">{r.name}</td>{MONTHS.map((_, i) => { const d = (portfolio.find(x=>x.id===r.id).dividends || []).find(dv => dv.year === selectedYear && dv.month === i); return ( <td key={i} className="p-1 border-l border-slate-800"><input type="number" step="0.01" value={d?.net || ''} onChange={e => handleDivChange(r.id, i, 'net', e.target.value)} className="w-full text-center text-green-400 bg-transparent border-none p-0 focus:ring-0" placeholder="-" /></td> ); })}<td className="p-2 text-right font-bold text-white bg-slate-900/30">{formatN(r.n)}</td></tr> ))}</tbody></table>
                  </div>
                  <div className="h-48 shrink-0"><SVGCharts type="bar" data={stats.monthlyT.map((v,i)=>({label:MONTHS[i].substring(0,3), val:v}))} title="Dividendos Mensuales (Neto)" id="chart-div"/></div>
              </div>
          );
      };

      const PortfolioTab = ({ portfolio, setPortfolio, apiKey, baseCurrency, refreshInterval, lastUpdate, setLastUpdate }) => {
          const [filterType, setFilterType] = useState('active');
          const [analyzing, setAnalyzing] = useState(false);
          const [analysisResult, setAnalysisResult] = useState(null);
          const [isModalOpen, setIsModalOpen] = useState(false);
          const [isAnalysisModalOpen, setIsAnalysisModalOpen] = useState(false);
          const [form, setForm] = useState({ ticker: '', name: '', shares: 0, buyPrice: 0, buyDate: '', buyFx: 1, dividendYieldAnnual: 0 }); // Nuevo campo
          const [editingId, setEditingId] = useState(null);

          const calcReturns = (startVal, endVal, days) => {
              if (startVal === 0) return { simple: 0, annual: 0 };
              const simple = ((endVal - startVal) / startVal) * 100;
              const d = Math.max(days, 1);
              // FORMULA SOLICITADA: (Simple / Dias) * 365
              const annual = (simple / d) * 365;
              return { simple, annual };
          };

          const stats = useMemo(() => {
              const active = portfolio.filter(p => !p.sellDate);
              const sold = portfolio.filter(p => !!p.sellDate);
              const calc = (items) => {
                  let inv = 0, cur = 0, divN = 0, fX = 0, weightedDays = 0;
                  items.forEach(p => {
                      const d = calculateDays(p.buyDate, p.sellDate || new Date());
                      const cT = p.buyPrice * p.shares * p.buyFx;
                      const vF = (p.sellDate ? p.sellPrice : p.currentPrice) * p.shares * (p.sellDate ? p.sellFx : p.currentFx);
                      inv += cT; cur += vF; weightedDays += (d * cT);
                      fX += vF - (p.sellDate ? p.sellPrice : p.currentPrice) * p.shares * p.buyFx;
                      (p.dividends || []).forEach(dv => divN += dv.net);
                  });
                  const avgD = inv > 0 ? weightedDays / inv : 0;
                  const plP = cur - inv;
                  const rs = calcReturns(inv, cur, avgD);
                  return { num: items.length, inv, cur, divN, fX, plPrice: plP, plTotal: plP + divN, plP_S: rs.simple, plP_A: rs.annual, plT_S: calcReturns(inv, cur + divN, avgD).simple };
              };
              return { active: calc(active), sold: calc(sold), total: calc(portfolio) };
          }, [portfolio]);

          const fetchTickerData = async () => {
              if (!form.ticker || !apiKey) return alert("Faltan datos");
              try {
                  const prompt = `JSON ONLY: Data for "${form.ticker}" (USD). { "n": "Name", "p": price, "fx": rate_to_${baseCurrency}, "dy": annual_dividend_amount_num }`;
                  const res = await askGemini(apiKey, prompt); const json = extractJSON(res);
                  if (json) setForm(prev => ({ ...prev, name: json.n, buyPrice: json.p, buyFx: json.fx, dividendYieldAnnual: json.dy || 0 }));
              } catch (e) { alert("Error buscando"); }
          };

          const analyzePortfolio = async () => {
              setAnalyzing(true);
              try {
                  const prompt = `Output HTML ONLY. Analyze this portfolio: ${JSON.stringify(portfolio.map(p=>({t:p.ticker, r:p.shares})))}. Report in Spanish.`;
                  const res = await askGemini(apiKey, prompt);
                  setAnalysisResult(res.replace(/```html/g, '').replace(/```/g, '').trim());
                  setIsAnalysisModalOpen(true);
              } catch (e) { alert(e.message); } finally { setAnalyzing(false); }
          };

          const pieData = useMemo(() => {
              const active = portfolio.filter(p => !p.sellDate);
              const total = active.reduce((a,b) => a + (b.currentPrice*b.shares*b.currentFx), 0);
              return active.map(p => ({ label: p.ticker, val: (p.currentPrice*p.shares*p.currentFx) })).sort((a,b)=>b.val-a.val);
          }, [portfolio]);

          return (
              <div className="h-full flex flex-col p-4 md:p-6 overflow-hidden">
                  <div className="flex gap-4 mb-4 overflow-x-auto pb-2 custom-scrollbar shrink-0">
                      <StatsBlock title="Cartera Activa" data={stats.active} color="#3b82f6" baseCurrency={baseCurrency} />
                      <StatsBlock title="Posiciones Cerradas" data={stats.sold} color="#f97316" baseCurrency={baseCurrency} />
                      <StatsBlock title="Total Global" data={stats.total} color="#a855f7" baseCurrency={baseCurrency} />
                  </div>
                  <div className="flex justify-between items-center mb-4 bg-slate-900/50 p-3 rounded-xl border border-slate-800">
                      <div className="flex gap-2">
                          <button onClick={()=>setFilterType('active')} className={`px-3 py-1 rounded text-xs font-bold ${filterType==='active'?'bg-blue-600 text-white':'bg-slate-800 text-slate-400'}`}>Activas</button>
                          <button onClick={()=>setFilterType('sold')} className={`px-3 py-1 rounded text-xs font-bold ${filterType==='sold'?'bg-orange-600 text-white':'bg-slate-800 text-slate-400'}`}>Cerradas</button>
                      </div>
                      <div className="flex gap-2">
                          <button onClick={analyzePortfolio} className="bg-purple-900/80 px-3 py-2 rounded-lg text-xs font-bold flex gap-2 items-center border border-purple-500/50 hover:bg-purple-800 transition-colors">
                              {analyzing ? <Icons.Loader/> : <Icons.Wand/>} INFORME IA
                          </button>
                          <button onClick={()=>{setForm({ticker:'', name:'', shares:0, buyPrice:0, buyDate:'', buyFx:1, dividendYieldAnnual:0}); setIsModalOpen(true);}} className="bg-blue-600 px-3 py-2 rounded-lg text-xs font-bold flex gap-2 items-center"><Icons.Plus size={14}/> NUEVA</button>
                      </div>
                  </div>
                  <div className="flex-1 overflow-auto custom-scrollbar bg-slate-900/50 border border-slate-800 rounded-xl mb-4">
                      <table className="w-full text-left text-sm min-w-[1000px]"><thead className="bg-slate-800 text-slate-400 text-[10px] uppercase font-bold sticky top-0 z-10"><tr><th className="p-3">Valor</th><th className="p-3 text-right">T√≠tulos</th><th className="p-3 text-right">Precio</th><th className="p-3 text-right">Inv.</th><th className="p-3 text-right">Valor</th><th className="p-3 text-right">Resultado</th><th className="p-3 text-right">% Simple</th><th className="p-3 text-right">% Anual</th></tr></thead>
                          <tbody className="divide-y divide-slate-800">{portfolio.filter(p => filterType==='active'?!p.sellDate:!!p.sellDate).map(p => { 
                              const cT = p.buyPrice * p.shares * p.buyFx; 
                              const vF = (p.sellDate ? p.sellPrice : p.currentPrice) * p.shares * (p.sellDate ? p.sellFx : p.currentFx);
                              const pl = vF - cT; const days = calculateDays(p.buyDate, p.sellDate); const rs = calcReturns(cT, vF, days);
                              return ( <tr key={p.id} className="table-row-hover"><td className="p-3 font-bold">{p.ticker}<div className="text-[9px] text-slate-500">{p.name}</div></td><td className="p-3 text-right">{formatN(p.shares)}</td><td className="p-3 text-right">{formatN(p.sellDate?p.sellPrice:p.currentPrice)}</td><td className="p-3 text-right text-slate-400">{formatMoney(cT, baseCurrency)}</td><td className="p-3 text-right text-white font-bold">{formatMoney(vF, baseCurrency)}</td><td className={`p-3 text-right font-bold ${pl>=0?'text-green-400':'text-red-400'}`}>{formatMoney(pl, baseCurrency)}</td><td className={`p-3 text-right ${rs.simple>=0?'text-green-400':'text-red-400'}`}>{formatN(rs.simple)}%</td><td className="p-3 text-right text-slate-300">{formatN(rs.annual)}%</td></tr> ); 
                          })}</tbody></table>
                  </div>
                  <div className="h-48 shrink-0 flex gap-4">
                      <div className="w-1/3"><SVGCharts type="pie" data={pieData} title="Diversificaci√≥n" id="chart-pie"/></div>
                      <div className="w-2/3"><SVGCharts type="bar" data={pieData.slice(0,10)} title="Top 10 Valor" id="chart-bar"/></div>
                  </div>
                  <Modal isOpen={isModalOpen} title="Nueva Posici√≥n" onClose={()=>setIsModalOpen(false)}>
                      <div className="space-y-4">
                          <div className="flex gap-2"><input placeholder="Ticker" value={form.ticker} onChange={e=>setForm({...form, ticker:e.target.value.toUpperCase()})} className="w-24"/><button onClick={fetchTickerData} className="bg-blue-600 px-4 rounded font-bold text-xs">BUSCAR</button></div>
                          <input placeholder="Nombre" value={form.name} onChange={e=>setForm({...form, name:e.target.value})} className="w-full"/>
                          <div className="grid grid-cols-2 gap-4">
                              <div><label className="text-xs text-slate-500">Acciones</label><input type="number" value={form.shares} onChange={e=>setForm({...form, shares:parseFloat(e.target.value)})} className="w-full"/></div>
                              <div><label className="text-xs text-slate-500">Precio</label><input type="number" step="0.01" value={form.buyPrice} onChange={e=>setForm({...form, buyPrice:parseFloat(e.target.value)})} className="w-full"/></div>
                          </div>
                          <div><label className="text-xs text-slate-500">Div. Anual Esperado (Total)</label><input type="number" step="0.01" value={form.dividendYieldAnnual} onChange={e=>setForm({...form, dividendYieldAnnual:parseFloat(e.target.value)})} className="w-full text-green-400 font-bold"/></div>
                          <button onClick={()=>{setPortfolio(prev=>[...prev, {...form, id:Date.now(), currentPrice:form.buyPrice, currentFx:form.buyFx}]); setIsModalOpen(false);}} className="w-full bg-blue-600 py-3 rounded font-bold">GUARDAR</button>
                      </div>
                  </Modal>
                  <Modal isOpen={isAnalysisModalOpen} title="Informe iA" onClose={()=>setIsAnalysisModalOpen(false)} size="lg"><div className="prose-content" dangerouslySetInnerHTML={{__html: analysisResult}}/></Modal>
              </div>
          );
      };

      const SettingsTab = ({ apiKey, setApiKey, baseCurrency, setBaseCurrency }) => (
          <div className="p-6"><h2 className="text-xl text-white font-bold mb-4">Configuraci√≥n</h2><input value={apiKey} onChange={e=>setApiKey(e.target.value)} placeholder="API Key" className="w-full bg-slate-800 p-3 rounded text-white mb-4"/><select value={baseCurrency} onChange={e=>setBaseCurrency(e.target.value)} className="w-full bg-slate-800 p-3 rounded text-white">{CURRENCIES.map(c=><option key={c.code} value={c.code}>{c.name}</option>)}</select></div>
      );

      const App = () => {
          const [activeTab, setActiveTab] = useState('portfolio');
          const [apiKey, setApiKey] = usePersistentState('bg_api_key', '');
          const [baseCurrency, setBaseCurrency] = usePersistentState('bg_base_currency', 'EUR');
          const [refreshInterval, setRefreshInterval] = usePersistentState('bg_refresh_interval', 10);
          const [portfolio, setPortfolio] = usePersistentState('bg_portfolio', []);
          const [resultsData, setResultsData] = usePersistentState('bg_results_data', {});
          const [lastUpdate, setLastUpdate] = usePersistentState('bg_last_update', null);

          return (
              <div className="h-full flex flex-col bg-[#0a0a0a] text-white">
                  <header className="shrink-0 bg-slate-900 border-b border-slate-800 px-6 py-4 flex justify-between items-center z-50">
                      <div><h1 className="text-2xl font-display font-bold">Boarding<span className="text-blue-600">Gate</span></h1><p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest">CIO Edition</p></div>
                      <nav className="flex bg-slate-800 rounded-lg p-1 gap-1 border border-slate-700 overflow-x-auto max-w-[60vw]">
                          {['portfolio','dividends','results','analysis','settings'].map(t => ( <button key={t} onClick={()=>setActiveTab(t)} className={`px-4 py-2 rounded-md text-[10px] font-bold uppercase flex items-center gap-2 whitespace-nowrap ${activeTab===t?'bg-blue-600 text-white':'text-slate-400'}`}>{t}</button> ))}
                      </nav>
                  </header>
                  <main className="flex-1 overflow-hidden relative">
                      {activeTab === 'portfolio' && <PortfolioTab portfolio={portfolio} setPortfolio={setPortfolio} apiKey={apiKey} baseCurrency={baseCurrency} refreshInterval={refreshInterval} lastUpdate={lastUpdate} setLastUpdate={setLastUpdate} />}
                      {activeTab === 'dividends' && <DividendTab portfolio={portfolio} setPortfolio={setPortfolio} baseCurrency={baseCurrency} />}
                      {activeTab === 'results' && <ResultsTab portfolio={portfolio} resultsData={resultsData} setResultsData={setResultsData} baseCurrency={baseCurrency} />}
                      {activeTab === 'analysis' && <AnalysisTab apiKey={apiKey} baseCurrency={baseCurrency} />}
                      {activeTab === 'settings' && <SettingsTab apiKey={apiKey} setApiKey={setApiKey} baseCurrency={baseCurrency} setBaseCurrency={setBaseCurrency} />}
                  </main>
                  <footer className="shrink-0 bg-slate-900 border-t border-slate-800 py-1 px-6 flex justify-between items-center text-[8px] text-slate-600 font-bold uppercase"><div>BoardingGate 3.0</div><div>Sinc: {lastUpdate ? new Date(lastUpdate).toLocaleString() : '--'}</div></footer>
              </div>
          );
      };

      createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
